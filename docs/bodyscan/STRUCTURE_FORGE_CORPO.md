# TwinForge — Body Forge Project Structure

**Version:** 1.0 • **Status:** Functional • **Last Update:** January 2025

Complete documentation of the file and folder organization for the **Body Forge** (3D avatar generation and morphological analysis system) of TwinForge.

---

## 📋 Table of Contents

- [Body Forge Overview](#body-forge-overview)
- [Feature Architecture](#feature-architecture)
- [Page Structure](#page-structure)
- [Components by Category](#components-by-category)
- [Hooks and Business Logic](#hooks-and-business-logic)
- [Utilities and Helpers](#utilities-and-helpers)
- [Edge Functions](#edge-functions)
- [Profile Integration](#profile-integration)
- [Configuration Files](#configuration-files)
- [Database](#database)

---

## 🎯 Body Forge Overview

The **Body Forge** is TwinForge's advanced 3D avatar generation and morphological analysis system, transforming 2 photos into personalized 3D avatars with comprehensive morphological insights through AI-powered analysis.

### Objectives
- **3D Avatar Generation** from 2 photos (front + profile) with realistic morphology
- **Morphological Analysis** using advanced AI algorithms and archetype matching
- **Personalized Insights** generated by GPT-5 Mini with morphological expertise
- **Real-time 3D Visualization** with interactive avatar viewer
- **Historical Tracking** of body composition changes over time

### Role in TwinForge Ecosystem
- **Core Identity System**: Provides visual representation for all health modules
- **Morphological Foundation**: Enables personalized nutrition and fitness recommendations
- **Progress Tracking**: Visual comparison of body changes over time
- **Motivation Engine**: Gamified avatar evolution based on health goals

---

## 🏗️ Feature Architecture

### Tech Stack
- **Frontend:** React 18 + TypeScript + Three.js + Framer Motion
- **State Management:** Zustand (scan pipeline) + React Query (network cache)
- **Backend:** Supabase Edge Functions (Deno) + PostgreSQL
- **Spatial Forge:** OpenAI GPT-4o Vision + GPT-5 Mini for analysis
- **3D Rendering:** Three.js + WebGL with optimized materials and lighting
- **Database:** PostgreSQL with RLS, triggers, and vector embeddings

### Data Flow
```
User (2 Photos: Front + Profile)
    ↓
Frontend (Photo Capture + Validation)
    ↓
Edge Function: scan-estimate (GPT-4o Vision + Measurements)
    ↓
Edge Function: scan-semantic (GPT-5 Mini + Classification)
    ↓
Edge Function: scan-match (Archetype Selection + K=5 Envelope)
    ↓
Edge Function: scan-refine-morphs (GPT-4o + Morphological Refinement)
    ↓
Edge Function: scan-commit (3D Avatar Generation + Profile Update)
    ↓
Edge Function: generate-morph-insights (GPT-5 Mini + Personalized Analysis)
    ↓
Frontend (3D Avatar Viewer + Insights Dashboard)
```

---

## 📁 Page Structure

### Main Pages
```
src/app/pages/
├─ Avatar/
│  └─ AvatarPage.tsx            # Main avatar page with 4 tabs (Scan CTA, Avatar, Insights, History)
├─ BodyScan.tsx                 # Body scan orchestrator page
├─ BodyScan/
│  ├─ BodyScanCapture.tsx       # Photo capture pipeline
│  ├─ BodyScanReview.tsx        # Scan results review and avatar generation
│  └─ BodyScanCelebrationStep.tsx # Success celebration with avatar reveal
├─ FaceScanPage.tsx             # Face scan main page
└─ FaceScan/
   ├─ FaceScanPhotoCaptureStep.tsx # Face photo capture
   ├─ FaceScanReviewPage.tsx    # Face scan review
   └─ FaceScanCelebrationStep.tsx # Face scan completion
```

---

## 🧩 Components by Category

### 📁 Complete Component Structure
```
src/app/pages/Avatar/tabs/
├─ ScanCTA.tsx                  # Call-to-action for new scans
├─ AvatarTab.tsx                # 3D avatar viewer and controls
├─ InsightsTab.tsx              # Morphological insights dashboard
└─ HistoryTab.tsx               # Historical scans and comparisons

src/app/pages/BodyScan/
├─ BodyScanCapture/
│  ├─ BodyScanCapture.tsx       # Main capture orchestrator
│  ├─ BodyScanPhotoCaptureStep.tsx # Photo capture step
│  ├─ components/
│  │  ├─ PhotoCard.tsx          # Individual photo display
│  │  ├─ PhotoCaptureControls.tsx # Capture controls
│  │  ├─ PhotoCaptureStatus.tsx # Capture status indicator
│  │  ├─ CapturedPhotoDisplay.tsx # Captured photo preview
│  │  ├─ ImmersivePhotoAnalysis.tsx # AI analysis visualization
│  │  └─ ReadyForProcessingCard.tsx # Processing readiness indicator
│  ├─ hooks/
│  │  └─ useBodyScanCaptureFlow.ts # Capture flow state management
│  ├─ services/
│  │  └─ scanProcessingService.ts # Scan processing logic
│  └─ utils/
│     ├─ dataExtractors.ts      # Data extraction utilities
│     └─ insightGenerator.ts    # Insight generation helpers
├─ BodyScanReview/
│  ├─ BodyScanReview.tsx        # Main review orchestrator
│  ├─ components/
│  │  ├─ ActionButtons.tsx      # Review action buttons
│  │  ├─ MeasurementsCard.tsx   # Measurements display
│  │  └─ MorphAdjustmentControls.tsx # Morph adjustment interface
│  ├─ hooks/
│  │  └─ useReviewState.ts      # Review state management
│  └─ utils/
│     └─ avatarActions.ts       # Avatar generation actions
├─ components/
│  ├─ CameraInterface/
│  │  ├─ CameraInterface.tsx    # Camera interface wrapper
│  │  ├─ CameraControls.tsx     # Camera control buttons
│  │  └─ CameraOverlayGuides.tsx # Photo guidance overlays
│  └─ PhotoGuideOverlay.tsx     # Photo positioning guides
└─ constants.ts                 # Body scan constants

src/components/3d/Avatar3DViewer/
├─ Avatar3DViewer.tsx           # Main 3D viewer component
├─ core/
│  ├─ modelLoader.ts            # 3D model loading
│  ├─ morphApplier.ts           # Morphological transformations
│  ├─ sceneManager.ts           # Three.js scene management
│  └─ materialConfigurator.ts   # Material and texture configuration
├─ components/
│  ├─ DebugInfo.tsx             # Debug information overlay
│  ├─ ErrorOverlay.tsx          # Error state display
│  ├─ LoadingOverlay.tsx        # Loading state animation
│  └─ ViewerControls.tsx        # 3D viewer controls
├─ hooks/
│  ├─ useModelLifecycle.ts      # Model loading lifecycle
│  ├─ useMorphLifecycle.ts      # Morphology application lifecycle
│  ├─ useMaterialLifecycle.ts   # Material configuration lifecycle
│  ├─ useSceneLifecycle.ts      # Scene management lifecycle
│  └─ useAvatarViewerOrchestrator.ts # Main orchestrator hook
└─ utils/
   ├─ viewerTypes.ts            # TypeScript definitions
   └─ payloadProcessor.ts       # Payload processing utilities
```

### 📝 Category Descriptions

**Avatar Tabs:** Main tabs of AvatarPage
- `ScanCTA`: Dynamic call-to-action for initiating new body scans
- `AvatarTab`: Interactive 3D avatar viewer with morphology controls
- `InsightsTab`: AI-generated morphological insights and recommendations
- `HistoryTab`: Historical scan comparison and progress tracking

**Body Scan Pipeline:** Complete scan processing workflow
- `BodyScanCapture`: Photo capture with real-time validation
- `BodyScanReview`: Results review and avatar generation
- `BodyScanCelebration`: Success celebration with avatar reveal

**3D Avatar System:** Advanced 3D rendering and interaction
- `Avatar3DViewer`: Main 3D viewer with Three.js integration
- `ModelLoader`: Optimized 3D model loading and caching
- `MorphApplier`: Real-time morphological transformations
- `MaterialConfigurator`: PBR material and texture management

**Camera Interface:** Photo capture system
- `CameraInterface`: WebRTC camera integration
- `CameraControls`: Capture controls and settings
- `PhotoGuideOverlay`: Visual guidance for optimal photo positioning

**Insights System:** AI-powered analysis and recommendations
- `InsightsTab`: Comprehensive morphological analysis dashboard
- `InsightCard`: Individual insight cards with actionable recommendations
- `SummaryDashboard`: Overview of morphological metrics and trends

---

## 🎣 Hooks and Business Logic

### 📁 Specialized Hooks
```
src/app/pages/BodyScan/BodyScanCapture/hooks/
└─ useBodyScanCaptureFlow.ts    # Capture flow state management

src/app/pages/BodyScan/BodyScanReview/hooks/
└─ useReviewState.ts            # Review state and avatar generation

src/app/pages/Profile/hooks/
└─ useProfileAvatarData.ts      # Profile avatar data integration

src/components/3d/Avatar3DViewer/hooks/
├─ useModelLifecycle.ts         # 3D model loading and management
├─ useMorphLifecycle.ts         # Morphology application and updates
├─ useMaterialLifecycle.ts      # Material and texture lifecycle
├─ useSceneLifecycle.ts         # Three.js scene management
└─ useAvatarViewerOrchestrator.ts # Main 3D viewer orchestration

src/app/pages/Avatar/tabs/insights/
└─ insightsService.ts           # AI insights generation and caching
```

### 📝 Hook Responsibilities

**`useBodyScanCaptureFlow`** - Photo capture orchestration
- **Multi-step pipeline**: Setup → Front Photo → Profile Photo → Processing
- **Real-time validation**: Photo quality, pose detection, lighting analysis
- **Error handling**: Retry mechanisms and user guidance
- **State persistence**: Survives navigation and page reloads

**`useReviewState`** - Scan results and avatar generation
- **Results processing**: Measurements, morphology, and avatar data
- **Avatar generation**: 3D model creation and optimization
- **User feedback**: Rating and adjustment capabilities
- **Profile integration**: Automatic profile updates with scan data

**`useProfileAvatarData`** - Profile avatar integration
- **Avatar synchronization**: Profile ↔ Avatar data consistency
- **Historical tracking**: Avatar evolution over time
- **Preference management**: Avatar display and privacy settings
- **Data validation**: Ensures avatar data integrity

**`useAvatarViewerOrchestrator`** - 3D viewer orchestration
- **Scene management**: Three.js scene setup and optimization
- **Model lifecycle**: Loading, morphing, and disposal
- **Performance optimization**: LOD, culling, and memory management
- **User interaction**: Camera controls, morphology adjustments

**`insightsService`** - AI insights generation
- **Intelligent caching**: Avoids redundant AI calls (input hash-based)
- **Morphological analysis**: Body composition and shape analysis
- **Personalized recommendations**: Goal-based advice and action items
- **Progress tracking**: Comparative analysis with historical data

---

## 🛠️ Utilities and Helpers

### 📁 Body Forge Utilities
```
src/lib/utils/
└─ photoUtils.ts                # Photo processing and validation

src/lib/morph/
├─ blend.ts                     # Morphological blending algorithms
├─ constraints.ts               # Morphological constraints and validation
├─ preparePayload.ts            # Payload preparation for Edge Functions
└─ payload/
   ├─ payloadBuilder.ts         # Structured payload construction
   ├─ payloadClamping.ts        # Value clamping and validation
   ├─ payloadConverters.ts      # Data format conversions
   └─ payloadValidators.ts      # Payload validation logic

src/lib/3d/
├─ setup/
│  └─ lightingSetup.ts          # Three.js lighting configuration
├─ materials/
│  ├─ applySkinTone.ts          # Skin tone application
│  └─ materialConfigurator.ts   # PBR material setup
├─ bones/
│  ├─ boneMapping.ts            # Bone hierarchy mapping
│  ├─ applyLimbMassToBones.ts   # Limb mass to bone transformations
│  └─ core/
│     ├─ boneScaling.ts         # Bone scaling algorithms
│     ├─ boneDiscovery.ts       # Bone structure discovery
│     └─ interplayEvaluator.ts  # Bone interaction evaluation
└─ camera/
   └─ OrbitTouchControls.ts     # Touch-optimized camera controls

src/lib/scan/
├─ normalizeSkinTone.ts         # Skin tone normalization
└─ normalizeLimbMasses.ts       # Limb mass normalization

src/lib/image/
└─ skinToneExtractor.ts         # Advanced skin tone extraction
```

### 📝 Key Utility Functions

**`photoUtils.ts`** - Photo processing and validation
- `validatePhotoQuality()`: Blur, brightness, and exposure analysis
- `detectPoseCompliance()`: Pose validation against requirements
- `extractPhotoMetadata()`: EXIF data extraction and analysis
- `optimizePhotoForUpload()`: Compression and format optimization

**`blend.ts`** - Morphological blending
- `blendMorphTargets()`: Weighted morphological target blending
- `interpolateLimbMasses()`: Smooth limb mass interpolation
- `validateMorphBounds()`: Morphological constraint validation
- `optimizeBlendWeights()`: Performance-optimized blending

**`payloadBuilder.ts`** - Structured data construction
- `buildScanEstimatePayload()`: Payload for scan estimation
- `buildSemanticAnalysisPayload()`: Payload for semantic analysis
- `buildMorphRefinementPayload()`: Payload for morphological refinement
- `validatePayloadIntegrity()`: Comprehensive payload validation

**`materialConfigurator.ts`** - 3D material management
- `configurePBRMaterials()`: Physically-based rendering setup
- `applySkinToneToMaterial()`: Dynamic skin tone application
- `optimizeMaterialPerformance()`: Performance optimization
- `updateMaterialProperties()`: Real-time material updates

**`boneMapping.ts`** - Skeletal system management
- `mapLimbMassesToBones()`: Limb mass to bone transformations
- `validateBoneHierarchy()`: Skeletal structure validation
- `optimizeBoneTransforms()`: Performance-optimized transformations
- `calculateBoneInfluences()`: Bone influence calculations

---

## ⚡ Edge Functions

### 📁 Serverless Functions
```
supabase/functions/
├─ scan-estimate/               # Stage 1: Photo analysis and measurements
│  └─ index.ts                  # GPT-4o Vision + measurement extraction
├─ scan-semantic/               # Stage 2: Semantic classification
│  └─ index.ts                  # GPT-5 Mini + morphological classification
├─ scan-match/                  # Stage 3: Archetype matching
│  └─ index.ts                  # GPT-5 Mini + K=5 envelope selection
├─ scan-refine-morphs/          # Stage 4: AI morphological refinement
│  └─ index.ts                  # GPT-4o + precise morphological adjustments
├─ scan-commit/                 # Stage 5: Avatar generation and storage
│  └─ index.ts                  # 3D processing + profile updates
├─ generate-morph-insights/     # Stage 6: Personalized insights
│  └─ index.ts                  # GPT-5 Mini + morphological expertise
├─ face-estimate/               # Face scan: Photo analysis
│  └─ index.ts                  # GPT-4o Vision + facial measurements
├─ face-semantic/               # Face scan: Semantic classification
│  └─ index.ts                  # GPT-5 Mini + facial feature classification
├─ face-match/                  # Face scan: Archetype matching
│  └─ index.ts                  # Vector similarity + archetype selection
├─ face-refine-morphs/          # Face scan: AI refinement
│  └─ index.ts                  # GPT-4o + facial morphological refinement
└─ face-commit/                 # Face scan: Face avatar generation
   └─ index.ts                  # 3D face processing + profile updates
```

### 📝 Edge Function Specialties

**`scan-estimate`** - Photo analysis and measurements
- **Model**: GPT-4o Vision optimized for body measurement extraction
- **Specialties**: Anthropometric measurements, pose analysis, photo quality
- **Average cost**: ~$0.0015 - $0.008 per scan (varies by photo complexity)
- **Duration**: ~15-30 seconds
- **Output**: Raw measurements, keypoints, skin tone, quality metrics

**`scan-semantic`** - Morphological classification
- **Model**: GPT-5 Mini optimized for body shape classification
- **Specialties**: Body type classification, muscularity assessment, adiposity analysis
- **Average cost**: ~$0.002 - $0.012 per analysis
- **Duration**: ~10-25 seconds
- **Output**: Semantic profile (obesity, muscularity, level, morphotype)

**`scan-match`** - Archetype selection and envelope generation
- **Model**: GPT-5 Mini + database archetype matching algorithms
- **Specialties**: K=5 archetype selection, morphological envelope generation
- **Average cost**: ~$0.001 - $0.005 per matching (mostly algorithmic)
- **Duration**: ~5-15 seconds
- **Output**: Selected archetypes, blended morphology, limb masses

**`scan-refine-morphs`** - AI morphological refinement
- **Model**: GPT-4o optimized for morphological precision
- **Specialties**: Fine-tuned morphological adjustments, constraint validation
- **Average cost**: ~$0.015 - $0.025 per refinement (highest cost due to complexity)
- **Duration**: ~20-45 seconds
- **Output**: Refined morphology, validated parameters, confidence scores

**`scan-commit`** - Avatar generation and storage
- **Model**: Processing-only (no AI model)
- **Specialties**: 3D avatar generation, profile updates, data persistence
- **Average cost**: ~$0.001 - $0.005 per commit (computational only)
- **Duration**: ~10-20 seconds
- **Output**: 3D avatar data, updated profile, scan history

**`generate-morph-insights`** - Personalized morphological insights
- **Model**: GPT-5 Mini with morphological expertise
- **Specialties**: Body composition analysis, personalized recommendations
- **Average cost**: ~$0.0025 - $0.015 per insight generation
- **Duration**: ~15-35 seconds
- **Output**: Morphological insights, recommendations, progress analysis

---

## 👤 Profile Integration

### 📁 Integration Files
```
src/app/pages/Profile/ProfileAvatarTab.tsx     # Avatar configuration in profile
src/app/pages/Profile/ProfileHealthTab.tsx    # Health metrics integration
src/system/store/userStore.ts                 # Profile data synchronization
src/system/store/profileRepository.ts         # Profile data persistence
```

### 📝 Profile Fields Used

**Critical Fields (Required for Body Forge):**
- `sex`: Gender-specific morphological constraints and archetype selection
- `height_cm`: Scale calibration and anthropometric validation
- `weight_kg`: BMI calculation and morphological consistency checks
- `birthdate`: Age-based morphological adjustments and recommendations
- `objective`: Goal-oriented avatar evolution and insight personalization

**Avatar Configuration:**
- `avatar_status`: Current avatar generation status (none, pending, ready, error)
- `avatar_url`: Generated 3D avatar model URL
- `avatar_generation_stage`: Current generation stage tracking
- `avatar_onboarding_completed`: First-time setup completion status
- `active_face_profile_id`: Active face profile for combined body+face avatars

**Morphological Data:**
- `hip_mass`: Hip region morphological mass (0.5-2.5 range)
- `shoulder_mass`: Shoulder region morphological mass (0.5-2.5 range)
- `skin_tone`: RGB skin tone values extracted from photos
- `facial_keypoints`: Facial landmark data for face-body integration

**Optimizing Fields:**
- `body_fat_perc`: Body composition validation and insight generation
- `activity_level`: Morphological recommendations based on fitness level
- `target_weight_kg`: Goal-oriented avatar evolution tracking
- `health`: Medical conditions affecting morphological analysis

### 📝 Scan Data Profile Updates

**Automatic Updates After Scan:**
- `avatar_status`: Updated to "ready" after successful generation
- `avatar_url`: Set to generated 3D model URL
- `skin_tone`: Updated with extracted skin tone from photos
- `hip_mass` & `shoulder_mass`: Updated with calculated limb masses
- `last_avatar_regeneration_at`: Timestamp of last avatar update

**Historical Tracking:**
- `avatar_regeneration_count_7_days`: Rate limiting for avatar regenerations
- Scan data stored in `body_scans` table with full morphological parameters
- Avatar evolution tracked through `user_avatars` table updates

---

## ⚙️ Configuration Files

### 📁 Specific Configuration
```
src/config/featureFlags.ts     # Feature flags for Body Forge development
src/config/debugFlags.ts       # Debug flags for 3D rendering and AI
```

### 📝 Available Feature Flags

**Body Forge Feature Flags:**
- `ENABLE_BODY_SCAN`: Enable/disable body scanning functionality
- `ENABLE_FACE_SCAN`: Enable/disable face scanning functionality
- `ENABLE_3D_AVATAR_VIEWER`: Enable/disable 3D avatar visualization
- `ENABLE_MORPHOLOGICAL_INSIGHTS`: Enable/disable AI insights generation
- `MOCK_SCAN_DATA`: Use mock data for development and testing

**Debug Flags:**
- `DEBUG_3D_RENDERING`: Enable Three.js debug information
- `DEBUG_MORPH_CALCULATIONS`: Log morphological calculations
- `DEBUG_AI_PAYLOADS`: Log Edge Function payloads and responses
- `BYPASS_PHOTO_VALIDATION`: Skip photo quality validation (development)
- `ENABLE_PERFORMANCE_MONITORING`: Track 3D rendering performance

---

## 🎨 Styles and Animations

### 📁 Body Forge Specific Styles
```
src/styles/
├─ components/
│  ├─ body-scan.css             # Body scan interface styles
│  ├─ bodyscan/
│  │  ├─ _base.css              # Base body scan styles
│  │  ├─ _capture.css           # Photo capture interface
│  │  ├─ _review.css            # Scan review interface
│  │  ├─ _processing.css        # Processing animations
│  │  ├─ _celebration.css       # Success celebration effects
│  │  └─ _utilities.css         # Body scan utility classes
│  ├─ avatar/
│  │  ├─ _insights.css          # Avatar insights dashboard
│  │  └─ _historical-scan-modal.css # Historical scan modal
│  └─ celebration-animations.css # Avatar reveal animations
├─ glassV2/
│  └─ animations.css            # Glass morphism animations for 3D viewer
└─ effects/
   └─ motion.css                # 3D viewer motion effects
```

### 📝 Body Forge Specific Animations
- **Avatar reveal**: Dramatic 3D avatar appearance with particle effects
- **Morphological transitions**: Smooth morphology changes during refinement
- **Photo capture feedback**: Real-time visual feedback during photo capture
- **Processing indicators**: AI processing visualization with progress indicators
- **3D viewer interactions**: Smooth camera movements and model rotations
- **Insight animations**: Staggered insight card appearances with morphological context

---

## 🗄️ Database

### 📁 Main Tables
```
body_scans                      # User body scan data
├─ id (uuid, PK)
├─ user_id (uuid, FK → users)
├─ timestamp (timestamptz)
├─ metrics (jsonb)              # Raw measurements and analysis
├─ morph3d (jsonb)              # 3D morphological parameters
├─ limb_masses (jsonb)          # Limb mass distributions
├─ skin_tone (jsonb)            # Extracted skin tone data
└─ created_at (timestamptz)

user_avatars                    # Current user avatar state
├─ user_id (uuid, PK, FK → users)
├─ current_scan_id (uuid, FK → body_scans)
├─ morph3d (jsonb)              # Active morphological parameters
├─ limb_masses (jsonb)          # Active limb mass distributions
├─ skin_tone (jsonb)            # Active skin tone configuration
└─ updated_at (timestamptz)

body_scan_history              # Historical scan analysis
├─ id (uuid, PK)
├─ user_id (uuid, FK → users)
├─ scan_id (uuid, FK → body_scans)
├─ metrics_snapshot (jsonb)     # Historical metrics snapshot
├─ temporal_analysis (jsonb)    # Temporal change analysis
├─ outlier_flags (jsonb)        # Outlier detection flags
├─ ema_data (jsonb)             # Exponential moving averages
└─ created_at (timestamptz)

ai_morphology_insights         # AI-generated morphological insights
├─ id (uuid, PK)
├─ scan_id (uuid, FK → body_scans)
├─ user_id (uuid, FK → users)
├─ generated_at (timestamptz)
├─ insights_data (jsonb)        # Generated insights and recommendations
├─ summary_data (jsonb)         # Summary metrics and scores
├─ ai_model_used (text)         # AI model version used
├─ ai_confidence (numeric)      # AI confidence score
└─ input_hash (text, unique)    # Deduplication key

user_face_profiles             # Face scan profiles
├─ id (uuid, PK)
├─ user_id (uuid, FK → users)
├─ active (boolean)             # Active face profile flag
├─ final_face_params (jsonb)    # Final facial parameters
├─ archetype_mix (jsonb)        # Face archetype blend
├─ skin_tone (jsonb)            # Facial skin tone
├─ head_model_url (text)        # 3D head model URL
├─ preview_url (text)           # Face preview image URL
├─ resolved_gender (gender_enum) # Resolved gender from analysis
└─ created_at (timestamptz)

face_archetypes                # Face archetype database
├─ id (text, PK)
├─ name (text)
├─ gender (gender_enum)
├─ face_shape (face_shape_enum)
├─ eye_shape (eye_shape_enum)
├─ nose_type (nose_type_enum)
├─ lip_fullness (lip_fullness_enum)
├─ face_values (jsonb)          # Facial morphological values
├─ face_embedding (vector(256)) # Vector embedding for similarity
└─ preview_path (text)

morph_archetypes               # Body archetype database
├─ id (text, PK)
├─ name (text)
├─ gender (text)
├─ bmi_range (numeric[])        # BMI range for archetype
├─ morph_values (jsonb)         # Morphological parameter values
├─ limb_masses (jsonb)          # Limb mass distributions
├─ obesity (text)               # Obesity classification
├─ muscularity (text)           # Muscularity classification
├─ level (text)                 # Body composition level
└─ morphotype (text)            # Morphological type classification
```

### 📝 Security and Performance

**Row Level Security (RLS):**
- **Enabled** on all user-specific tables (`body_scans`, `user_avatars`, `ai_morphology_insights`)
- **User isolation**: Users can only access their own scan data and avatars
- **Service role bypass**: Edge Functions use service role for cross-user operations

**Optimized Indexes:**
- `body_scans`: Composite index on `(user_id, timestamp DESC)` for historical queries
- `ai_morphology_insights`: Unique index on `input_hash` for deduplication
- `face_archetypes`: Vector index on `face_embedding` for similarity search
- `morph_archetypes`: Composite indexes on gender, BMI range, and semantic categories

**Automatic Triggers:**
- `updated_at` triggers on all tables with timestamp columns
- Avatar regeneration rate limiting triggers
- Scan data validation triggers for morphological constraints

**Vector Operations:**
- **Face similarity**: Cosine similarity search on face embeddings
- **Archetype matching**: Vector-based archetype selection for face scans
- **Performance optimization**: IVFFlat indexes for fast vector queries

---

*This documentation is specific to the Body Forge. Consult other STRUCTURE_*.md files for other features. Last revision: January 2025*