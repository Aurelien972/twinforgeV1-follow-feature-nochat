# Detailed Documentation: The Nutritional Forge (Meal Scanner)

**Version:** 1.0 ‚Ä¢ **Status:** Functional and production-ready ‚Ä¢ **Last update:** September 2025

The Nutritional Forge is TwinForge's meal scanning system, allowing users to capture, analyze and understand their nutritional intake through a complete AI-powered intelligent pipeline.

---

## üìã Table of Contents

- [Overview](#overview)
- [Technical Architecture](#technical-architecture)
- [Detailed User Pipeline](#detailed-user-pipeline)
- [Nutritional Forge Tabs](#nutritional-forge-tabs)
- [User Profile Integration](#user-profile-integration)
- [Data Generated by Spatial Forge](#data-generated-by-spatial-forge)
- [TypeScript Contracts](#typescript-contracts)
- [Detailed Edge Functions](#detailed-edge-functions)
- [Optimizations and Performance](#optimizations-and-performance)
- [Costs and Governance](#costs-and-governance)
- [Observability and Debugging](#observability-and-debugging)
- [Future Integration with Central Brain](#future-integration-with-central-brain)

---

## üéØ Overview

### Objective
Allow users to scan their meals (via photo), obtain detailed nutritional analysis (macros, calories, detected foods) and personalized insights to optimize their diet.

### Added Value
- **Intuitive capture:** Simple photo taking to analyze a meal
- **Advanced AI analysis:** Food identification, quantity estimation and macronutrient/calorie calculation
- **Personalized advice:** Recommendations adapted to the user's profile and nutritional goals
- **Tracking and trends:** Visualization of history and eating patterns

### Role in TwinForge Ecosystem
The Nutritional Forge generates structured data on nutrition that will feed the future "Central Brain" for holistic advice combining nutrition, activity, fasting and morphology.

---

## üèóÔ∏è Technical Architecture

### Technical Stack
- **Frontend:** React 18 + TypeScript + Framer Motion
- **State Management:** Zustand + React Query (with cache persistence)
- **Backend:** Supabase Edge Functions (Deno)
- **Spatial Forge:** OpenAI GPT-5 Vision (Mini/Nano)
- **Database:** PostgreSQL with RLS

### Data Flow
```
User (Photo)
    ‚Üì
Frontend (Capture + Pre-processing)
    ‚Üì
Edge Function: meal-analyzer (GPT-5 Vision)
    ‚Üì
Database (meals table)
    ‚Üì
Edge Functions: daily-nutrition-summary / nutrition-trend-analysis (GPT-5 Mini)
    ‚Üì
Frontend (Visualizations + Insights)
```

---

## üîÑ Detailed User Pipeline

### 1. Meal Capture (`MealPhotoCaptureStep`)

**Objective:** Collect the user's meal photo.

**Input modes:**
- **Camera:** Direct capture via mobile/desktop camera
- **Gallery:** Selection of existing image from gallery

**Frontend Components:**
- `src/app/pages/Meals/MealScanFlowPage.tsx` (Flow orchestrator)
- `src/app/pages/Meals/components/MealPhotoCaptureStep/index.tsx` (Capture step)
- `src/app/pages/Meals/components/MealPhotoCaptureStep/CaptureGuide.tsx` (Visual guide)
- `src/app/pages/Meals/components/MealPhotoCaptureStep/CapturedPhotoDisplay.tsx` (Captured photo display)

**Data Collected:**
- **Photo:** Image file (JPEG/PNG) converted to Base64 for AI
- **Metadata:** `userId`, `clientScanId`, timestamp

**Validations:**
- File format (image), maximum size (10MB)
- Visual validation (if image is clear, well-lit, etc. - handled by AI)

### 2. Meal Analysis (`MealAnalysisProcessingStep`)

**Objective:** Analyze the meal photo to extract nutritional information.

**Frontend Components:**
- `src/app/pages/Meals/components/MealAnalysisProcessingStep/index.tsx` (Processing step)
- `src/app/pages/Meals/components/MealAnalysisProcessingStep/AnalysisViewport.tsx` (Immersive analysis visualization)
- `src/app/pages/Meals/components/MealAnalysisProcessingStep/ProgressDisplay.tsx` (Detailed progress bar)
- `src/app/pages/Meals/components/MealAnalysisProcessingStep/DataFlowVisualization.tsx` (Data flow animations)

**Backend Process:**

#### Phase 1: Vision AI Call
- **Edge Function:** `meal-analyzer`
- **Model:** OpenAI GPT-5 Vision (Mini/Nano)
- **Duration:** ~5-20 seconds (depends on image complexity and model)
- **Output:** Structured data of detected foods, macros, calories, personalized insights

### 3. Results Review (`MealResultsDisplayStep`)

**Objective:** Display analysis results and allow user to save the meal.

**Frontend Components:**
- `src/app/pages/Meals/components/MealResultsDisplayStep/index.tsx` (Results display step)
- `src/app/pages/Meals/components/MealResultsDisplayStep/CalorieHighlightCard.tsx` (Total calories highlight)
- `src/app/pages/Meals/components/MealResultsDisplayStep/MacronutrientsCard.tsx` (Macronutrients summary)
- `src/app/pages/Meals/components/MealResultsDisplayStep/DetectedFoodsCard.tsx` (Detailed detected foods list)
- `src/app/pages/Meals/components/MealResultsDisplayStep/PhotoDisplayCard.tsx` (Analyzed photo display)
- `src/app/pages/Meals/components/MealResultsDisplayStep/ActionButtons.tsx` (Save, retake, new scan buttons)

**Features:**
- **Detailed display:** Calories, proteins, carbs, fats, fiber for each food
- **Personalized insights:** Recommendations based on analysis and user profile
- **Save:** Record meal in database
- **Options:** Retake photo, start new scan

**Save:**
- **Table:** `meals` with RLS
- **Photo storage:** `meal-photos` Supabase Storage bucket
- **Cache invalidation:** React Query for real-time update of "Today", "Insights", "Progression", "History" tabs

---

## üìä Nutritional Forge Tabs

### üåÖ Today (`DailyRecapTab`)

**File:** `src/app/pages/Meals/DailyRecapTab.tsx`

**Objective:** Display daily nutritional intake summary and encourage action.

**Key Components:**
- `DailyStatsGrid`: Daily metrics (calories, meals, last activity)
- `CalorieProgressCard`: Progress towards daily caloric goal (adapted according to `profile.objective`)
- `MacronutrientsCard`: Daily macronutrients summary
- `RecentMealsCard`: Today's meals list with deletion option
- `DynamicScanCTA`: Adaptive call-to-action according to nutritional progress state
- `ProfileCompletenessAlert`: Alert if profile is incomplete for tracking

**Data Logic:**
- **Source:** `meals` table filtered by `user_id` and today's date
- **Real-time calculations:** Aggregation of calories, macros, number of meals
- **Dynamic goals:** Based on `profile.objective`, `profile.weight_kg`, `profile.nutrition.proteinTarget_g`
- **AI call:** `daily-nutrition-summary` Edge Function for narrative summary

### üí° Insights (`MealInsightsTab`)

**File:** `src/app/pages/Meals/MealInsightsTab.tsx`

**Objective:** Present trend analysis and personalized advice generated by Spatial Forge.

**Key Components:**
- `MacroDistributionChart`: Macronutrient distribution over a period
- `NutritionHeatmap`: Nutritional activity calendar with visual intensity
- `InsightCards`: Individual insight cards with actionable actions

**Data Logic:**
- **Source:** `nutrition-trend-analysis` Edge Function
- **Intelligent cache:** Server-side with invalidation based on new meals
- **Adaptive thresholds:** Analysis over 7 or 30 days
- **Graceful fallback:** Basic data even in case of Spatial Forge error

### üìà Progression (`ProgressionTab`)

**File:** `src/app/pages/Meals/ProgressionTab.tsx`

**Objective:** Visualize trends, distributions and long-term nutritional activity patterns.

**Key Components:**
- `ProgressionMetrics`: Key progression metrics (caloric adherence, protein, regularity)
- `CalorieTrendChart`: Daily calorie evolution chart over 14 days
- `NutritionHeatmap`: (Shared with Insights) Tracking regularity visualization

**Data Logic:**
- **Source:** `meals` table for raw data, frontend calculations for metrics
- **Visualizations:** Based on aggregated meal data

### üìö History (`MealHistoryTab`)

**File:** `src/app/pages/Meals/MealHistoryTab.tsx`

**Objective:** Browse complete meal history with details and management options.

**Key Components:**
- `MealDetailModal`: Detail modal with deletion option
- Daily grouping with daily totals
- Deletion interface with confirmation

**Data Logic:**
- **Source:** `meals` table with pagination and filtering by `user_id`
- **Grouping:** By date with daily total calculations
- **Actions:** Detailed consultation, deletion with cache invalidation

---

## üë§ User Profile Integration

### Profile Fields Used

**Critical Fields (Required for functionality):**
- `weight_kg`: Calculation of caloric and protein needs
- `sex`: Adjustment of metabolic estimates
- `height_cm`: BMI calculation

**Optimizing Fields (Improve precision and personalization):**
- `birthdate`: Age calculation for metabolic adjustments
- `objective`: Advice adaptation (`fat_loss`, `muscle_gain`, `recomp`)
- `activity_level`: Influence on TDEE (Total Daily Energy Expenditure)
- `nutrition.diet`: For dietary compliance (e.g., vegetarian, ketogenic)
- `nutrition.allergies`: To avoid allergenic food recommendations
- `nutrition.intolerances`: To avoid intolerable food recommendations
- `nutrition.proteinTarget_g`: Personalized protein target
- `nutrition.fastingWindow`: Context for meal timing advice
- `emotions.chronotype`: For meal timing suggestions adapted

### Profile Impact

**Automatic update:**
- `nutrition.proteinTarget_g` can be calculated automatically

**Bidirectional synchronization:**
- Profile changes ‚Üí Recalculation of goals and nutritional advice
- Meal data ‚Üí Profile improvement suggestions (e.g., goal adjustment)

---

## ü§ñ Data Generated by Spatial Forge

### Structured Raw Data

**From `meal-analyzer`:**
```typescript
// src/system/data/repositories/mealsRepo.ts
export interface MealItem {
  name: string;
  confidence: number;
  calories: number;
  proteins: number;
  carbs: number;
  fats: number;
  fiber?: number;
  sugar?: number;
  sodium?: number;
  portion_size?: string;
  category?: string;
}

export interface MealAnalysisResponse {
  success: boolean;
  analysis_id: string;
  meal_name: string;
  total_calories: number;
  macronutrients: {
    proteins: number;
    carbs: number;
    fats: number;
    fiber: number;
    sugar: number;
    sodium: number;
  };
  detected_foods: MealItem[];
  meal_type: string;
  confidence: number;
  analysis_metadata: {
    processing_time_ms: number;
    model_version: string;
    quality_score: number;
    image_quality: number;
    ai_model_used: string;
    tokens_used?: { input: number; output: number; };
  };
  personalized_insights: PersonalizedRecommendation[];
  objective_alignment: {
    calories_vs_target: number;
    macros_balance: {
      proteins_status: 'low' | 'optimal' | 'high';
      carbs_status: 'low' | 'optimal' | 'high';
      fats_status: 'low' | 'optimal' | 'high';
    };
    meal_timing_feedback?: string;
  }
  ai_powered: boolean;
  error?: string;
}

export interface PersonalizedRecommendation {
  type: 'suggestion' | 'warning' | 'alert' | 'insight';
  category: 'nutrition' | 'health' | 'fitness' | 'timing' | 'balance';
  message: string;
  reasoning: string;
  priority: 'low' | 'medium' | 'high';
  actionable?: string;
}
```

### Advanced Analysis Data

**From `daily-nutrition-summary`:**
```typescript
// src/system/data/repositories/mealsRepo.ts
export interface DailySummary {
  summary: string;
  highlights: string[];
  improvements: string[];
  proactive_alerts: string[];
  overall_score: number;
  recommendations: string[];
  generated_at: string;
  analysis_system: 'advanced';
}
```

**From `nutrition-trend-analysis`:**
```typescript
// src/system/data/repositories/mealsRepo.ts
export interface TrendAnalysis {
  trends: Array<{
    pattern: string;
    description: string;
    impact: 'positive' | 'negative' | 'neutral';
    confidence: number;
    recommendations: string[];
  }>;
  strategic_advice: Array<{
    category: 'nutrition' | 'timing' | 'balance' | 'goals';
    advice: string;
    priority: 'low' | 'medium' | 'high';
    timeframe: 'immediate' | 'short_term' | 'long_term';
  }>;
  meal_classifications: Array<{
    meal_id: string;
    classification: 'balanced' | 'protein_rich' | 'needs_improvement' | 'excellent';
    reasoning: string;
    score: number;
  }>;
  diet_compliance: {
    overall_score: number;
    compliance_rate: number;
    deviations: string[];
    suggestions: string[];
  };
  generated_at: string;
  analysis_system: 'advanced' | 'standard';
}
```

---

## üìã TypeScript Contracts

### Main Interfaces

```typescript
// src/system/data/repositories/mealsRepo.ts
// (Complete interface definitions above)
export interface MealItem { /* ... */ }
export interface MealData { /* ... */ } // Meal saved in DB
export interface MealAnalysisRequest { /* ... */ }
export interface MealAnalysisResponse { /* ... */ }
export interface DailySummary { /* ... */ }
export interface TrendAnalysis { /* ... */ }
export interface UserProfileContext { /* ... */ } // User context for AI
```

---

## ‚öôÔ∏è Detailed Edge Functions

### üçΩÔ∏è `meal-analyzer`

**Role:** Meal image analysis and nutritional data extraction.

**Models:**
- **OpenAI GPT-5 Vision (Mini/Nano)**: Visual image analysis

**Specialties:**
- Food detection and identification
- Quantity estimation and calorie/macronutrient calculation
- Personalized insight generation based on user profile
- Error handling and fallback to simplified estimation if AI fails

**Performance:**
- **Duration:** 5-20 seconds
- **Cost:** ~$0.00025 - $0.0025 per analysis (depends on model and complexity)
- **Confidence:** 80% average

### üìà `daily-nutrition-summary`

**Role:** Daily nutritional intake summary generation.

**Model:** GPT-5 Mini

**Specialties:**
- Daily meal synthesis
- Identification of strengths and improvement areas
- Proactive alerts and personalized recommendations
- Global nutritional day score

**Intelligent Cache:**
- **Validity:** 24 hours
- **Invalidation:** Automatic if new meals are added or cache expires

**Performance:**
- **Duration:** 3-10 seconds
- **Cost:** ~$0.00025 - $0.0025 per generation
- **Confidence:** 85% average

### üìä `nutrition-trend-analysis`

**Role:** Nutritional trend analysis over longer periods (7/30 days).

**Model:** GPT-5 Mini

**Specialties:**
- Detection of recurring eating patterns
- Analysis of declared diet compliance
- Strategic advice for long-term optimization
- Individual meal classification

**Intelligent Cache:**
- **Validity:** 24 hours (for 7-day analysis), 7 days (for 30-day analysis)
- **Invalidation:** Automatic if new meals are added or cache expires

**Performance:**
- **Duration:** 8-25 seconds
- **Cost:** ~$0.0005 - $0.005 per generation
- **Confidence:** 80% average

---

## üéØ Optimizations and Performance

### Frontend
- **React Query:** Intelligent cache with adaptive `staleTime` and **persistence in `localStorage`** to avoid re-requests after application restart
- **Zustand:** Optimized state management
- **Framer Motion:** Conditional animations (`prefers-reduced-motion`)
- **Image optimization:** Client-side compression before sending to AI

### Backend
- **Server cache:** `ai_daily_summaries` and `ai_trend_analyses` tables with intelligent invalidation
- **Rate limiting:** Protection against excessive AI API calls
- **Retry logic:** Temporary error handling with fallback to cheaper models or fallback
- **Intelligent fallback:** Provides estimates even in case of AI failure

### Database
- **RLS:** Row-level security for meal data
- **Indexes:** Optimized for frequent queries (`user_id`, `timestamp`)
- **Triggers:** Automatic `updated_at`

---

## üí∞ Costs and Governance

### Costs per Component
- **Meal Analysis:** ~$0.00025 - $0.0025 per session (GPT-5 Vision)
- **Daily Summary:** ~$0.00025 - $0.0025 per generation (GPT-5 Mini)
- **Trend Analysis:** ~$0.0005 - $0.005 per generation (GPT-5 Mini)

### Cost Optimizations
- **Intelligent cache:** Avoids unnecessary AI analysis regenerations
- **Intelligent fallback:** Uses local estimates in case of AI failure, avoiding API costs
- **User quotas:** Ability to limit number of analyses per period to control expenses
- **Token monitoring:** Precise tracking of token consumption per model

### Governance
- **User quotas:** Configurable limits for AI analyses
- **Audit trail:** Complete traceability of AI calls and associated costs
- **Alerts:** Notification in case of predefined cost threshold exceeded

---

## üîç Observability and Debugging

### Structured Logs
```typescript
// Example meal analysis log
{
  level: 'info',
  message: 'Meal analysis completed successfully',
  context: {
    userId: 'uuid',
    analysisId: 'meal_scan_123',
    totalCalories: 550,
    detectedFoodsCount: 3,
    confidence: 0.92,
    aiModelUsed: 'gpt-5-mini',
    tokensUsed: { input: 1200, output: 300, total: 1500, cost_estimate_usd: 0.0003 },
    processingTime: 8500,
    philosophy: 'meal_analysis_audit'
  },
  timestamp: '2025-09-24T14:30:00.000Z'
}
```

### Key Metrics
- **E2E SLO:** < 30 seconds (capture + analysis + results display)
- **Success rate:** > 95% for each pipeline step
- **Average confidence:** > 80% for food analyses
- **Cache hit rate:** > 70% for summaries and trend analyses

### Debugging
- **`clientScanId`:** End-to-end meal scan tracking
- **Correlation IDs:** Frontend and backend request linking
- **Error boundaries:** Graceful error handling in user interface
- **Fallback strategies:** Progressive experience degradation in case of AI problem

---

## üß† Future Integration with Central Brain

### Exportable Data

**Quantitative Metrics:**
- `total_kcal`, `macronutrients` per meal
- `DailySummary`: `overall_score`, `highlights`, `improvements`
- `TrendAnalysis`: `trends`, `diet_compliance`, `strategic_advice`

**Qualitative Insights:**
- `personalized_insights` per meal
- `meal_classifications` for each meal

**Behavioral Patterns:**
- Meal frequency, timing, dominant food types
- Adherence to specific diets

### Future Correlations

**With Energy Forge:**
- Correlation between nutritional intake and activity performance/recovery
- Macro optimization based on energy expenditure

**With Time Forge:**
- Impact of meal timing on fasting windows
- Intake optimization during eating windows

**With TwinVision:**
- Correlation between diet and body composition/morphology evolution
- Nutritional recommendations adapted to physical transformation goals

### Central Brain Architecture

**Data Sources:**
```typescript
interface CentralBrainInput {
  // Nutritional Forge
  mealData: MealData[];
  dailySummaries: DailySummary[];
  trendAnalyses: TrendAnalysis[];
  
  // Energy Forge (already functional)
  activitySummary: ActivitySummary;
  activityInsights: ActivityInsight[];
  activityPatterns: TimePatterns[];
  
  // Time Forge (future)
  fastingSummary: FastingSummary;
  fastingCompliance: FastingCompliance;
  
  // TwinVision (future)
  morphologyData: MorphologyData;
  bodyComposition: BodyComposition;
  
  // User Profile
  userProfile: UserProfile;
  userGoals: UserGoals;
}
```

**Expected Output:**
```typescript
interface HolisticRecommendations {
  globalScore: number;                    // Global wellness score
  priorityActions: PriorityAction[];      // Priority actions
  correlationInsights: Correlation[];     // Cross insights
  weeklyPlan: WeeklyPlan;                // Optimized weekly plan
  longTermStrategy: LongTermStrategy;     // Long-term strategy
}
```

---

## üîß Maintenance and Evolution

### Extension Points
- **New AI models:** Integration of more performant or specialized models
- **Utensil/portion recognition:** Improvement of estimation accuracy
- **External integrations:** Connection with third-party food databases
- **Specific diet analysis:** Enhanced support for complex diets

### Continuous Monitoring
- **Performance:** SLO and response time monitoring
- **Costs:** Continuous optimization of AI API calls
- **Quality:** User feedback on analysis accuracy
- **Evolution:** Adaptation according to usage patterns and feedback

---

## üìû Support and Contribution

For any technical questions or improvement suggestions regarding the Nutritional Forge, consult this document or contact the development team.

**Key files to consult:**
- Pipeline: `src/app/pages/Meals/MealScanFlowPage.tsx`
- Data hooks: `src/system/data/repositories/mealsRepo.ts`
- Edge Functions: `supabase/functions/meal-analyzer`, `supabase/functions/daily-nutrition-summary`, `supabase/functions/nutrition-trend-analysis`

---

*This documentation is kept up to date with each evolution of the Nutritional Forge. Last revision: September 2025*