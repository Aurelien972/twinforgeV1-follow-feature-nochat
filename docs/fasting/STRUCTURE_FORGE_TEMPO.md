# TwinForge — Time Forge Project Structure

**Version:** 1.0 • **Status:** Functional • **Last Update:** January 2025

Complete documentation of the file and folder organization for the **Time Forge** (intermittent fasting system) of TwinForge.

---

## 📋 Table of Contents

- [Time Forge Overview](#time-forge-overview)
- [Feature Architecture](#feature-architecture)
- [Page Structure](#page-structure)
- [Components by Category](#components-by-category)
- [Hooks and Business Logic](#hooks-and-business-logic)
- [Utilities and Helpers](#utilities-and-helpers)
- [Edge Functions](#edge-functions)
- [Profile Integration](#profile-integration)
- [Configuration Files](#configuration-files)
- [Database](#database)

---

## 🎯 Time Forge Overview

The **Time Forge** is TwinForge's intermittent fasting system, allowing users to start, track, and analyze their fasting sessions through a complete intelligent pipeline with personalized AI analyses.

### Objectives
- **Real-time tracking** of fasting sessions with precise timer
- **Automatic detection** of metabolic phases
- **Personalized AI analyses** generated by GPT-5 Mini
- **Rich visualizations** (heatmaps, charts, trends)
- **Intelligent cache** for cost optimization

---

## 🏗️ Feature Architecture

### Tech Stack
- **Frontend:** React 18 + TypeScript + Framer Motion
- **State Management:** Zustand (persistent pipeline) + React Query (network cache)
- **Backend:** Supabase Edge Functions (Deno)
- **Spatial Forge:** OpenAI GPT-5 Mini for analyses and recommendations
- **Timer System:** JavaScript intervals with performance optimizations
- **Database:** PostgreSQL with RLS and automatic triggers

### Data Flow
```
User (Start/Stop Fasting)
    ↓
Frontend (Zustand Pipeline + Real-time Timer)
    ↓
Database (fasting_sessions table)
    ↓
Edge Function: fasting-insights-generator (GPT-5 Mini + Cache)
    ↓
Edge Function: fasting-progression-analyzer (GPT-5 Mini + Metrics)
    ↓
Frontend (Visualizations + AI Advice)
```

---

## 📁 Page Structure

### Main Page
```
src/app/pages/
├─ FastingPage.tsx              # Main page with 4 tabs (Daily, Insights, Progression, History)
└─ Fasting/
   └─ FastingInputPage.tsx      # Pipeline for start/stop sessions (Setup → Active → Completion)
```

---

## 🧩 Components by Category

### 📁 Complete Component Structure
```
src/app/pages/Fasting/
├─ components/
│  ├─ index.ts                  # Centralized export
│  ├─ Tabs/
│  │  ├─ FastingDailyTab.tsx    # Today: current status & daily summary
│  │  ├─ FastingInsightsTab.tsx # Insights: AI pattern analysis
│  │  ├─ FastingProgressionTab.tsx # Progression: metrics & trends
│  │  └─ FastingHistoryTab.tsx  # History: complete sessions
│  ├─ Stages/
│  │  ├─ FastingSetupStage.tsx  # Protocol configuration
│  │  ├─ FastingActiveStage.tsx # Real-time tracking
│  │  └─ FastingCompletionStage.tsx # Session finalization
│  ├─ Cards/
│  │  ├─ DynamicFastingCTA.tsx  # Adaptive call-to-action
│  │  ├─ FastingCurrentSessionCard.tsx # Active session details
│  │  ├─ FastingDailySummaryCard.tsx # Daily summary
│  │  ├─ FastingMetabolicPhasesCard.tsx # Metabolic phases
│  │  ├─ FastingProtocolInfoCard.tsx # Protocol information
│  │  ├─ FastingTipsCard.tsx    # Fasting tips
│  │  ├─ FastingAchievementsCard.tsx # Achievements
│  │  └─ FastingSessionSummaryCard.tsx # Session summary
│  ├─ Shared/
│  │  ├─ FastingProgressHeader.tsx # Progress header
│  │  ├─ FastingPeriodSelector.tsx # Period selector
│  │  └─ FastingDataCompletenessAlert.tsx # Data alerts
│  ├─ Insights/
│  │  ├─ FastingInsightsLoadingSkeleton.tsx # AI loading animation
│  │  ├─ FastingInsightsSummaryCard.tsx # AI insights summary
│  │  └─ FastingInsightCard.tsx # Individual insight cards
│  ├─ Progression/
│  │  ├─ FastingProgressionLoadingSkeleton.tsx # Progression loading
│  │  ├─ FastingProgressionSummaryCard.tsx # Progression metrics
│  │  ├─ FastingConsistencyChart.tsx # Consistency chart
│  │  ├─ FastingDurationTrendChart.tsx # Duration trends
│  │  └─ FastingHeatmap.tsx     # GitHub-style heatmap
│  └─ History/
│     ├─ FastingHistoryFilters.tsx # Filter interface
│     ├─ FastingHistoryStatsCard.tsx # Global statistics
│     ├─ FastingSessionCard.tsx # Session cards
│     └─ FastingHistoryLoadingSkeleton.tsx # History loading
├─ hooks/
│  ├─ useFastingPipeline.ts     # Pipeline state management
│  ├─ useFastingInsightsGenerator.ts # AI insight generation
│  ├─ useFastingProgressionData.ts # Progression data with AI
│  ├─ useFastingHistory.ts      # History management
│  └─ useTodayFastingSessions.ts # Today's sessions
├─ utils/
│  └─ fastingUtils.ts           # Utilities (formatting, calculations)
└─ FastingInputPage.tsx         # Main pipeline page
```

### 📝 Category Descriptions

**Tabs:** Main tabs of FastingPage
- `FastingDailyTab`: Current status and today's sessions
- `FastingInsightsTab`: AI analysis of fasting patterns
- `FastingProgressionTab`: Progression metrics and trends
- `FastingHistoryTab`: Complete history with filters

**Stages:** FastingInputPage pipeline steps
- `FastingSetupStage`: Fasting protocol configuration
- `FastingActiveStage`: Real-time tracking of active session
- `FastingCompletionStage`: Finalization and save

**Cards:** Reusable content components
- `DynamicFastingCTA`: Adaptive call-to-action based on state
- `FastingCurrentSessionCard`: Active session details with metabolic phases
- `FastingDailySummaryCard`: Today's session summary
- `FastingMetabolicPhasesCard`: Real-time metabolic phases
- `FastingProtocolInfoCard`: Protocol information
- `FastingTipsCard`: Practical fasting tips
- `FastingAchievementsCard`: Achievements and encouragements
- `FastingSessionSummaryCard`: Detailed session summary

**Shared:** Components shared between tabs
- `FastingProgressHeader`: Real-time progress header
- `FastingPeriodSelector`: Analysis period selector
- `FastingDataCompletenessAlert`: Missing data alerts

**Insights:** AI analysis specific components
- `FastingInsightsLoadingSkeleton`: AI loading animation
- `FastingInsightsSummaryCard`: Narrative summary with global score
- `FastingInsightCard`: Individual insights with actions

**Progression:** Trend visualization components
- `FastingProgressionLoadingSkeleton`: Progression analysis loading
- `FastingProgressionSummaryCard`: Metrics with AI narrative analysis
- `FastingConsistencyChart`: Consistency chart
- `FastingDurationTrendChart`: Duration evolution
- `FastingHeatmap`: GitHub-style activity calendar

**History:** History management components
- `FastingHistoryFilters`: Advanced filtering interface
- `FastingHistoryStatsCard`: Global statistics
- `FastingSessionCard`: Individual session cards
- `FastingHistoryLoadingSkeleton`: History loading animation

---

## 🎣 Hooks and Business Logic

### 📁 Specialized Hooks
```
src/app/pages/Fasting/hooks/
├─ useFastingPipeline.ts        # Pipeline state management (persistent Zustand)
├─ useFastingInsightsGenerator.ts # AI insight generation with cache
├─ useFastingProgressionData.ts # Progression data with AI
├─ useFastingHistory.ts         # History management with filters
└─ useTodayFastingSessions.ts   # Today's sessions in real-time
```

### 📝 Hook Responsibilities

**`useFastingPipeline`** - Feature core
- **Persistent state**: Survives reloads (Zustand + localStorage)
- **Global timer**: Real-time updates every second
- **Actions**: `startFasting()`, `stopFasting()`, `saveFastingSession()`
- **Dynamic selectors**: `useFastingElapsedSeconds()`, `useFastingProgressPercentage()`

**`useFastingInsightsGenerator`** - AI pattern analysis
- **Intelligent cache**: Avoids redundant AI calls (24h)
- **Adaptive thresholds**: 3/8/20 sessions depending on period
- **Graceful fallback**: Encouragement messages if insufficient data
- **Navigation protection**: Blocks exit during AI generation

**`useFastingProgressionData`** - Metrics and trends
- **Local calculations**: Basic metrics always available
- **Conditional AI**: Narrative analysis if sufficient data
- **Visualizations**: Data for heatmap, charts, trends
- **Server cache**: Cost optimization with deduplication

**`useFastingHistory`** - History management
- **Advanced filtering**: Status, protocol, duration, dates
- **Global statistics**: Calculations on all sessions
- **Secure deletion**: RLS + user confirmation
- **Pagination**: Support for large data volumes

**`useTodayFastingSessions`** - Daily sessions
- **Real-time**: Automatic refetch every minute
- **Daily statistics**: Total fasted, sessions, averages
- **Consistency**: Daily performance evaluation
- **Motivational messages**: Personalized encouragements

---

## 🛠️ Utilities and Helpers

### 📁 Time Forge Utilities
```
src/app/pages/Fasting/utils/
└─ fastingUtils.ts              # Utilities (formatting, calculations, outcomes)

src/lib/nutrition/
├─ fastingPhases.ts             # Metabolic phase definitions
├─ fastingProtocols.ts          # Fasting protocols (16:8, 18:6, etc.)
└─ proteinCalculator.ts         # Protein target calculations

src/system/data/
└─ mockFastingSessions.ts       # Test data generation
```

### 📝 Key Utility Functions

**`fastingUtils.ts`** - Formatting and calculations
- `formatElapsedTime()`: Seconds → "16h 45m 30s" conversion
- `calculateFastingProgress()`: Progress percentage
- `determineSessionOutcome()`: success/partial/missed classification
- `getOutcomeTheme()`: Colors and content based on outcome

**`fastingPhases.ts`** - Metabolic phases
- `getCurrentFastingPhase()`: Current phase based on elapsed time
- `getPhaseProgress()`: Progress within current phase
- `getNextFastingPhase()`: Next phase to reach
- `estimateCaloriesBurnedInPhase()`: Calorie estimation by phase and weight
- `getMotivationalMessage()`: Contextual encouragement messages

**`fastingProtocols.ts`** - Predefined protocols
- `getProtocolById()`: Protocol retrieval by ID
- `suggestFastingTimes()`: Suggested times by chronotype
- `calculateCustomFastingWindow()`: Custom window calculation
- `validateFastingWindow()`: Time consistency validation

**`mockFastingSessions.ts`** - Test data
- `generateMockSessions()`: Realistic session generation
- `createMockFastingSessions()`: Database insertion for tests
- `clearMockFastingSessions()`: Test data cleanup

---

## ⚡ Edge Functions

### 📁 Serverless Functions
```
supabase/functions/
├─ fasting-insights-generator/  # Agent 1: Pattern analysis
│  └─ index.ts                  # GPT-5 Mini + Intelligent cache
└─ fasting-progression-analyzer/ # Agent 2: Progression analysis
   └─ index.ts                  # GPT-5 Mini + Advanced metrics
```

### 📝 Edge Function Specialties

**`fasting-insights-generator`** - Pattern detection
- **Model**: GPT-5 Mini optimized for behavioral analysis
- **Specialties**: Temporal patterns, actionable recommendations
- **Cache**: 24h with SHA256 key of input data
- **Average cost**: ~$0.00076 USD (2659 tokens)
- **Duration**: ~15-45 seconds

**`fasting-progression-analyzer`** - Narrative analysis
- **Model**: GPT-5 Mini optimized for temporal data analysis
- **Specialties**: Trends, strategic recommendations, coaching
- **Cache**: 24h with advanced deduplication
- **Average cost**: ~$0.00076 USD (2683 tokens)
- **Duration**: ~20-60 seconds

---

## 👤 Profile Integration

### 📁 Integration Files
```
src/app/pages/Profile/ProfileNutritionTab.tsx # Fasting configuration in profile
src/system/store/userStore.ts                 # Profile data synchronization
```

### 📝 Profile Fields Used

**Critical Fields (Required for AI):**
- `weight_kg`: Calorie calculation burned per metabolic phase
- `height_cm`: BMR calculations and metabolic adjustments
- `objective`: Advice adaptation (fat_loss, muscle_gain, recomp)
- `activity_level`: Recommendation personalization

**Fasting Configuration:**
- `nutrition.fastingWindow.protocol`: Preferred protocol (16:8, 18:6, etc.)
- `nutrition.fastingWindow.start`: Usual start time
- `nutrition.fastingWindow.end`: Usual end time
- `nutrition.fastingWindow.windowHours`: Custom duration
- `nutrition.fastingWindow.mealsPerDay`: Number of meals in window

**Optimizing Fields:**
- `emotions.chronotype`: Optimal time suggestions
- `emotions.stress`: Adaptation according to stress level
- `emotions.sleepHours`: Correlation with performance

---

## ⚙️ Configuration Files

### 📁 Specific Configuration
```
src/config/featureFlags.ts     # Feature flags for testing and development
```

### 📝 Available Feature Flags
- `MOCK_FASTING_DATA`: Test data generation
- `BYPASS_MIN_DATA_FOR_AI`: AI threshold bypass (development)
- `FASTING_CACHE_DURATION`: Cache duration (default 24h)

---

## 🎨 Styles and Animations

### 📁 Time Forge Specific Styles
```
src/styles/
├─ components/
│  └─ celebration-animations.css # Success celebration animations
├─ glassV2/
│  └─ animations.css            # Breathing, pulse, and timer animations
└─ effects/
   └─ motion.css                # Spatial icon animations and transitions
```

### 📝 Fasting-Specific Animations
- **Breathing icons**: For active session indicators
- **Progress animations**: Smooth progress bar updates
- **Celebration effects**: Success completion animations
- **Timer pulsing**: Visual feedback for active sessions
- **Phase transitions**: Smooth metabolic phase changes

---

## 🗄️ Database

### 📁 Main Tables
```
fasting_sessions                # User fasting sessions
├─ id (uuid, PK)
├─ user_id (uuid, FK → users)
├─ start_time (timestamptz)
├─ end_time (timestamptz, nullable)
├─ target_hours (integer)
├─ actual_duration_hours (numeric, nullable)
├─ protocol_id (text, nullable)
├─ status (text: active|completed|cancelled)
├─ notes (text, nullable)
└─ created_at (timestamptz)

ai_analysis_jobs                # AI analysis cache
├─ id (uuid, PK)
├─ user_id (uuid, FK → users)
├─ analysis_type (enum: fasting_insights|fasting_progression)
├─ status (enum: pending|processing|completed|failed)
├─ input_hash (text) # Deduplication key
├─ request_payload (jsonb)
├─ result_payload (jsonb)
└─ created_at (timestamptz)
```

### 📝 Security and Performance
- **RLS enabled** on all tables
- **Optimized indexes** for queries by user_id and timestamp
- **Automatic triggers** for updated_at
- **Validation constraints** on durations and statuses

---

*This documentation is specific to the Time Forge. Consult other STRUCTURE_*.md files for other features. Last revision: January 2025*