import{u as ue,r as x,j as e,R as re}from"./vendor-ZbFMzY-i.js";import{n as ye}from"./utils-CUtLAp28.js";import{u as fe,N as j,Q as he,S as A,I as C,G as U,t as _e,R as ve,o as oe}from"./ui-components-OHztaiDj.js";import{u as H}from"./useBodyScanPerformance-CZTD3PbH.js";import{t as J,a as we}from"./stores-ZZM8MTtI.js";import{l as c,s as je,u as se}from"./page-fridge-C1QVLxk9.js";import{g as Ce,P as Se}from"./signedUrlService-DzLcvpbH.js";import{g as Y}from"./page-fridge-scan-C_CisW7P.js";import{createCompleteSkinTone as le}from"./normalizeSkinTone---q_oCYc.js";import{m as X,A as ce}from"./motion-HGAT--uT.js";import{E as ae,L as te}from"./index-B1aqsbWO.js";import{B as Ae}from"./BodyScanProgressHeader-DadWtsli.js";import"./supabase-8_3juhcZ.js";import"./date-utils-BlBdbPk_.js";import"./page-profile-C7_QN5um.js";import"./forms-CBZzt5O6.js";const Z=new Map;function K(a,i={}){const n=i.scan_id||i.session_id||"unknown",t=`${a}_${n}`,s=Date.now(),o=Z.get(t);if(o&&s-o<5e3){c.debug("Analytics Event deduplicated",{event:a,scanId:n,reason:"recent_duplicate",timeSinceLastMs:s-o});return}Z.set(t,s);for(const[l,p]of Z.entries())s-p>3e4&&Z.delete(l);const r={event:a,properties:{...i,scan_id:n,timestamp:Date.now(),session_id:Ie(),user_agent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}},timestamp:Date.now()};ke(r)}const Ne={captureStarted:a=>{K("scan.capture_started",a)},photoTaken:a=>{K("scan.photo_taken",a)},photoRetake:a=>{K("scan.photo_retake_reason",a)},captureCompleted:a=>{K("scan.capture_completed",a)},processingStarted:a=>{K("scan.processing_started",a)},processingCompleted:a=>{K("scan.processing_completed",a)}};function Ie(){let a=sessionStorage.getItem("scan_session_id");return a||(a=`scan_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("scan_session_id",a)),a}function ke(a){try{const i=localStorage.getItem("scan_analytics_events"),n=i?JSON.parse(i):[];n.push(a),n.length>100&&n.splice(0,n.length-100),localStorage.setItem("scan_analytics_events",JSON.stringify(n))}catch(i){console.warn("Failed to store analytics event:",i)}}async function Pe(a,i,n,t){c.info("PHOTO_UPLOAD_SERVICE","Starting photo upload",{clientScanId:i,userId:a.substring(0,8)+"...",photosCount:n.length});const s=await Promise.all(n.map(async(o,r)=>{try{const p=await(await fetch(o.url)).blob(),m=new File([p],`scan-${i}-${o.type}.jpg`,{type:"image/jpeg"}),h=`scans/${a}/${i}/${o.type}.jpg`,{data:g,error:u}=await je.storage.from("body-scans").upload(h,m,{cacheControl:"3600",upsert:!1});if(u)throw new Error(`Upload failed for ${o.type}: ${u.message}`);const f=await Ce(Se.BODY_SCANS,h);if(!f)throw new Error(`Failed to get signed URL for ${o.type}`);return c.info("PHOTO_UPLOAD_SERVICE",`Photo uploaded: ${o.type}`,{clientScanId:i,view:o.type,urlLength:f.length}),{view:o.type,url:f,report:o.captureReport}}catch(l){throw c.error("PHOTO_UPLOAD_SERVICE",`Failed to upload ${o.type} photo`,{clientScanId:i,view:o.type,error:l instanceof Error?l.message:"Unknown error"}),l}}));return c.info("PHOTO_UPLOAD_SERVICE","Photo upload completed",{clientScanId:i,uploadedCount:s.length,views:s.map(o=>o.view)}),s}async function Ee(a,i,n,t,s){c.info("EDGE_FUNCTION_CLIENT","Calling scan-estimate",{clientScanId:s,userId:a.substring(0,8)+"...",photosCount:i.length,userMetrics:n});const o={user_id:a,photos:i,user_declared_height_cm:n.height_cm,user_declared_weight_kg:n.weight_kg,user_declared_gender:t,clientScanId:s,resolvedGender:t},r=await Y.estimate(o);return c.info("EDGE_FUNCTION_CLIENT","scan-estimate completed",{clientScanId:s,hasExtractedData:!!r.extracted_data,confidence:r.extracted_data?.processing_confidence,hasSkinTone:!!r.extracted_data?.skin_tone,measurementsKeys:r.extracted_data?.raw_measurements?Object.keys(r.extracted_data.raw_measurements):[]}),r}async function Fe(a,i,n,t,s){c.info("EDGE_FUNCTION_CLIENT","Calling scan-semantic",{clientScanId:s,userId:a.substring(0,8)+"...",hasExtractedData:!!n.extracted_data,estimatedBMI:n.extracted_data?.estimated_bmi});const o={user_id:a,photos:i,extracted_data:n.extracted_data,user_declared_gender:t,clientScanId:s,resolvedGender:t},r=await Y.semantic(o);return c.info("EDGE_FUNCTION_CLIENT","scan-semantic completed",{clientScanId:s,hasSemanticProfile:!!r.semantic_profile,semanticConfidence:r.semantic_confidence,adjustmentsMade:r.adjustments_made?.length||0,semanticClasses:r.semantic_profile?{obesity:r.semantic_profile.obesity,muscularity:r.semantic_profile.muscularity,level:r.semantic_profile.level,morphotype:r.semantic_profile.morphotype}:null}),r}async function Te(a,i,n,t,s){c.info("EDGE_FUNCTION_CLIENT","Calling scan-match",{clientScanId:s,userId:a.substring(0,8)+"...",userBMICalculated:i.extracted_data?.estimated_bmi,semanticClassification:{obesity:n.semantic_profile?.obesity,muscularity:n.semantic_profile?.muscularity,level:n.semantic_profile?.level,morphotype:n.semantic_profile?.morphotype}});const o={user_id:a,extracted_data:i.extracted_data,semantic_profile:n.semantic_profile,user_semantic_indices:{morph_index:n.semantic_profile.morph_index||0,muscle_index:n.semantic_profile.muscle_index||0},matching_config:{gender:t,limit:5},clientScanId:s,resolvedGender:t},r=await Y.match(o);return c.info("EDGE_FUNCTION_CLIENT","scan-match completed",{clientScanId:s,selectedArchetypesCount:r.selected_archetypes?.length||0,strategyUsed:r.strategy_used,semanticCoherenceScore:r.semantic_coherence_score}),r}async function Me(a,i,n,t,s,o,r,l){c.info("EDGE_FUNCTION_CLIENT","Calling scan-commit",{clientScanId:r,userId:a.substring(0,8)+"...",hasEstimateResult:!!i,hasMatchResult:!!n,hasSemanticResult:!!t,hasAIRefinement:!!n.ai_refinement,hasSkinTone:!!l});const p=n.ai_refinement?.final_shape_params||n.final_shape_params||n.selected_archetypes?.[0]?.morph_values||{},m=n.ai_refinement?.final_limb_masses||n.final_limb_masses||n.selected_archetypes?.[0]?.limb_masses||{},h=n.k5_envelope||null,g={user_id:a,resolvedGender:o,estimate_result:i,match_result:n,morph_bounds:h,semantic_result:t,ai_refinement_result:n.ai_refinement,validation_metadata:{},temporal_analysis:{},smoothing_metadata:{},visionfit_result:{},photos_metadata:s.map(f=>({type:f.type,captureReport:f.captureReport})),final_shape_params:p,final_limb_masses:m,skin_tone:l,resolved_gender:o,mapping_version:"v1.0",gltf_model_id:`${o}_v4.13`,material_config_version:"pbr-v2",avatar_version:"v2.0",clientScanId:r};c.info("EDGE_FUNCTION_CLIENT","Commit request prepared",{clientScanId:r,finalShapeParamsCount:Object.keys(p).length,finalLimbMassesCount:Object.keys(m).length,hasSkinTone:!!l,skinToneSchema:l?.schema,hasK5Envelope:!!h});const u=await Y.commit(g);return c.info("EDGE_FUNCTION_CLIENT","scan-commit completed",{clientScanId:r,serverScanId:u.scan_id,commitSuccess:!!u.success,processingComplete:!!u.processing_complete}),u}async function Oe(a,i,n,t,s,o,r,l){c.info("AI_REFINEMENT_SERVICE","Starting AI morphological refinement",{clientScanId:r,userId:l.substring(0,8)+"...",resolvedGender:o,mappingVersion:"v1.0",blendShapeParamsCount:Object.keys(a.selected_archetypes?.[0]?.morph_values||{}).length});const p=i.map(f=>({view:f.view,url:f.url,report:f.report})),m=a.selected_archetypes?.[0]?.morph_values||{},h=a.selected_archetypes?.[0]?.limb_masses||{},g={height_cm:s.height_cm,weight_kg:s.weight_kg,estimated_bmi:n.extracted_data?.estimated_bmi||s.weight_kg/Math.pow(s.height_cm/100,2),raw_measurements:{waist_cm:n.extracted_data?.raw_measurements?.waist_cm||80,chest_cm:n.extracted_data?.raw_measurements?.chest_cm||95,hips_cm:n.extracted_data?.raw_measurements?.hips_cm||100}};let u;try{return u=await Y.refine({scan_id:r,user_id:l,resolvedGender:o,photos:p,blend_shape_params:m,blend_limb_masses:h,k5_envelope:a.k5_envelope,vision_classification:t.semantic_profile,mapping_version:"v1.0",user_measurements:g}),c.info("AI_REFINEMENT_SERVICE","AI refinement completed successfully",{clientScanId:r,resolvedGender:o,aiRefine:u.ai_refine,finalShapeParamsCount:Object.keys(u.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(u.final_limb_masses||{}).length,clampedKeysCount:u.clamped_keys?.length||0,outOfRangeCount:u.out_of_range_count||0,activeKeysCount:u.active_keys_count||0,aiConfidence:u.ai_confidence,topDeltas:u.refinement_deltas?.top_10_shape_deltas?.slice(0,3)||[]}),{...a,ai_refinement:u,final_shape_params:u.final_shape_params,final_limb_masses:u.final_limb_masses}}catch(f){return c.warn("AI_REFINEMENT_SERVICE","AI refinement failed, using blend fallback",{clientScanId:r,resolvedGender:o,error:f instanceof Error?f.message:"Unknown error"}),{...a,ai_refinement:{ai_refine:!1,error:f instanceof Error?f.message:"Unknown error",fallback_used:!0}}}}function Re(a,i,n){const t=[],s=a?.extracted_data?.processing_confidence||0;if(s>.8?t.push({id:"high-confidence",type:"achievement",title:"Analyse de Haute Qualit√©",description:`Votre scan a √©t√© analys√© avec ${Math.round(s*100)}% de confiance.`,category:"morphology",priority:"high",confidence:s,source:"ai_analysis",color:"#22C55E"}):s>.6&&t.push({id:"medium-confidence",type:"observation",title:"Analyse Standard",description:`Votre scan a √©t√© analys√© avec ${Math.round(s*100)}% de confiance.`,category:"morphology",priority:"medium",confidence:s,source:"ai_analysis",color:"#F59E0B"}),n?.selected_archetypes?.length>0){const r=n.selected_archetypes[0];t.push({id:"archetype-match",type:"observation",title:"Profil Morphologique",description:`Votre morphologie correspond au profil "${r.name}".`,category:"morphology",priority:"medium",confidence:.8,source:"archetype",color:"#8B5CF6"})}if(i?.semantic_profile){const r=i.semantic_profile;t.push({id:"semantic-classification",type:"observation",title:"Classification Morphologique",description:`Profil: ${r.obesity} ‚Ä¢ ${r.muscularity} ‚Ä¢ ${r.morphotype}`,category:"morphology",priority:"medium",confidence:i.semantic_confidence||.6,source:"semantic",color:"#06B6D4"})}n?.ai_refinement?.ai_refine&&t.push({id:"ai-refinement",type:"achievement",title:"Affinement IA",description:`Votre avatar a √©t√© affin√© par IA avec ${Math.round((n.ai_refinement.ai_confidence||.85)*100)}% de confiance.`,category:"morphology",priority:"high",confidence:n.ai_refinement.ai_confidence||.85,source:"ai_refinement",color:"#10B981"});const o=a?.extracted_data?.estimated_bmi;if(o){let r="",l="",p="observation";o<18.5?(r="Insuffisance pond√©rale",l="#3B82F6",p="recommendation"):o<25?(r="Poids normal",l="#22C55E",p="achievement"):o<30?(r="Surpoids",l="#F59E0B",p="observation"):(r="Ob√©sit√©",l="#EF4444",p="recommendation"),t.push({id:"bmi-analysis",type:p,title:"Indice de Masse Corporelle",description:`IMC: ${o.toFixed(1)} - ${r}`,category:"health",priority:"medium",confidence:.9,source:"anthropometry",color:l})}return c.info("INSIGHTS_GENERATOR","Generated insights",{totalInsights:t.length,categories:[...new Set(t.map(r=>r.category))],priorities:[...new Set(t.map(r=>r.priority))]}),{items:t,source:"generated",confidence:s||.8}}function De(a,i,n){c.info("DATA_EXTRACTORS","Extracting skin tone from Vision AI analysis",{clientScanId:n,hasEstimateResult:!!i,hasExtractedData:!!i?.extracted_data,philosophy:"vision_ai_exclusive_extraction"});const t=i?.extracted_data?.skin_tone;if(t&&typeof t=="object"){if(t.schema==="v2"&&t.rgb)return c.info("DATA_EXTRACTORS","Found V2 skin tone from Vision AI",{clientScanId:n,skinTone:`rgb(${t.rgb.r}, ${t.rgb.g}, ${t.rgb.b})`,hex:t.hex,confidence:t.confidence,source:t.source||"vision_ai"}),t;if(typeof t.r=="number"&&typeof t.g=="number"&&typeof t.b=="number")return c.info("DATA_EXTRACTORS","Converting legacy Vision AI skin tone to V2",{clientScanId:n,skinTone:`rgb(${t.r}, ${t.g}, ${t.b})`,confidence:t.confidence||.85}),le(t.r,t.g,t.b,"vision_ai_analysis",t.confidence||.85,t.pixelCount)}return c.error("DATA_EXTRACTORS","Vision AI failed to provide skin tone - this should not happen",{clientScanId:n,hasEstimateResult:!!i,hasExtractedData:!!i?.extracted_data,extractedSkinToneType:typeof t,philosophy:"vision_ai_extraction_failure"}),le(153,108,78,"emergency_fallback",.3)}function ze(a,i){if(c.info("DATA_EXTRACTORS","Starting user profile extraction from sources",{hasProfile:!!a,profileKeys:a?Object.keys(a):[],source:"user_profile_extraction"}),!a?.sex||!a?.height_cm||!a?.weight_kg){c.warn("DATA_EXTRACTORS","Profile incomplete - missing required fields",{hasSex:!!a?.sex,hasHeight:!!a?.height_cm,hasWeight:!!a?.weight_kg,source:"user_profile_extraction"});return}const n={sex:a.sex,height_cm:a.height_cm,weight_kg:a.weight_kg};return c.info("DATA_EXTRACTORS","User profile extracted from sources",{extractedProfile:n,source:"user_profile_extraction"}),n}function Be(a,i,n,t){if(c.info("DATA_EXTRACTORS","Starting gender resolution from sources",{hasProfile:!!a,profileSex:a?.sex,source:"gender_resolution"}),a?.sex){const o=a.sex==="male"?"masculine":"feminine";return c.info("DATA_EXTRACTORS","Gender resolved from user profile",{profileSex:a.sex,resolvedGender:o,source:"user_profile_sex"}),o}const s="masculine";return c.warn("DATA_EXTRACTORS","Using fallback gender",{fallbackGender:s,reason:"no_valid_sex_found_in_profile",source:"fallback"}),s}function $e(a,i,n){c.info("SCAN_DATA_EXTRACTOR","Starting limb masses extraction from scan data",{clientScanId:n,hasMatchResult:!!a,hasEstimateResult:!!i,matchResultKeys:a?Object.keys(a):[]});const t=a?.blended_limb_masses||a?.advanced_matching?.blending?.blended_limb_masses;if(t&&typeof t=="object"&&Object.keys(t).length>0)return c.info("SCAN_DATA_EXTRACTOR","Found limb masses from match result blending",{clientScanId:n,limbMassesKeys:Object.keys(t),sampleValues:Object.entries(t).slice(0,3).map(([r,l])=>({key:r,value:l})),source:"match_result_blended"}),t;const s=a?.ai_refinement?.final_limb_masses;if(s&&typeof s=="object"&&Object.keys(s).length>0)return c.info("SCAN_DATA_EXTRACTOR","Found limb masses from AI refinement",{clientScanId:n,limbMassesKeys:Object.keys(s),sampleValues:Object.entries(s).slice(0,3).map(([r,l])=>({key:r,value:l})),source:"ai_refinement"}),s;const o=a?.selected_archetypes;if(o&&Array.isArray(o)&&o.length>0){const r=o[0],l=r?.limb_masses;if(l&&typeof l=="object"&&Object.keys(l).length>0)return c.info("SCAN_DATA_EXTRACTOR","Found limb masses from primary archetype",{clientScanId:n,archetypeId:r.id,archetypeName:r.name,limbMassesKeys:Object.keys(l),sampleValues:Object.entries(l).slice(0,3).map(([p,m])=>({key:p,value:m})),source:"primary_archetype"}),l}return Ve(i,n)}function Ve(a,i){const n=a?.extracted_data?.estimated_bmi||22,t=a?.extracted_data?.estimated_body_fat_perc||15,s=Math.max(.7,Math.min(1.4,n/22)),o=Math.max(.8,Math.min(1.3,t/15)),r={gate:1,armMass:1+(s-1)*.3+(o-1)*.2,calfMass:1+(s-1)*.25+(o-1)*.15,neckMass:1+(s-1)*.2+(o-1)*.1,thighMass:1+(s-1)*.4+(o-1)*.3,torsoMass:1+(s-1)*.5+(o-1)*.4,forearmMass:1+(s-1)*.25+(o-1)*.15};return Object.keys(r).forEach(l=>{l!=="gate"&&(r[l]=Math.max(.6,Math.min(1.6,r[l])))}),c.info("SCAN_DATA_EXTRACTOR","Generated intelligent limb masses fallback",{clientScanId:i,estimatedBMI:n.toFixed(2),bodyFatPerc:t.toFixed(1),bmiFactor:s.toFixed(3),fatFactor:o.toFixed(3),generatedMasses:Object.entries(r).map(([l,p])=>({key:l,value:p.toFixed(3)})),source:"intelligent_fallback"}),r}async function Le(a){const{userId:i,clientScanId:n,capturedPhotos:t,stableScanParams:s,resolvedGender:o}=a,r=J.getState();c.info("SCAN_ORCHESTRATOR","Starting complete pipeline processing",{clientScanId:n,userId:i.substring(0,8)+"...",photosCount:t.length,userProfile:s,resolvedGender:o,timestamp:new Date().toISOString()}),r.setOverallProgress(52,"Pr√©paration des donn√©es","T√©l√©chargement s√©curis√© de vos photos...");const l=setInterval(()=>{r.incrementProgress(1,"Pr√©paration des donn√©es","T√©l√©chargement s√©curis√© de vos photos...")},200),p=await Pe(i,n,t);clearInterval(l),c.info("SCAN_ORCHESTRATOR","Starting dynamic processing progression",{clientScanId:n,startPercentage:52,endPercentage:92,totalSteps:17}),r.startDynamicProcessing(52,92);const m=await Ee(i,p,s,o,n),h=await Fe(i,p,m,o,n),g=await Te(i,m,h,o,n),u=await Oe(g,p,m,h,s,o,n,i);c.info("SCAN_ORCHESTRATOR","Stopping dynamic processing before commit",{clientScanId:n}),r.stopDynamicProcessing(),r.setOverallProgress(92,"Sauvegarde des Donn√©es","Persistance de votre avatar personnalis√©...");const f=t.map(I=>({view:I.type,url:I.url,report:I.captureReport})),_=De(f,m,n);c.info("SCAN_ORCHESTRATOR","Skin tone extracted before commit",{clientScanId:n,hasSkinTone:!!_,skinToneSchema:_?.schema,skinToneRGB:_?.rgb?`rgb(${_.rgb.r}, ${_.rgb.g}, ${_.rgb.b})`:"unknown"});const v=await Me(i,m,u,h,t,o,n,_);v.scan_id&&r.setServerScanId(v.scan_id),r.setProcessingStep("model_loading"),r.setOverallProgress(95,"Finalisation","Pr√©paration de votre avatar 3D..."),await new Promise(I=>setTimeout(I,800)),r.setProcessingStep("model_loaded"),r.setOverallProgress(98,"Pr√™t","Tout est pr√™t !");const w=Ue(m,h,u,v,p,s,o,n,i,_);return c.info("SCAN_ORCHESTRATOR","Complete pipeline processing finished successfully",{clientScanId:n,serverScanId:v.scan_id,hasAllResults:!!(w.estimate&&w.semantic&&w.match&&w.commit),finalConfidence:w.estimate?.extracted_data?.processing_confidence||0,aiRefined:!!u.ai_refinement?.ai_refine,aiConfidence:u.ai_refinement?.ai_confidence,insightsCount:w.insights?.items?.length||0,timestamp:new Date().toISOString()}),r.setComplete(),r.setOverallProgress(100,"Termin√©","Traitement complet !"),c.info("SCAN_ORCHESTRATOR","Processing state marked as complete",{clientScanId:n,serverScanId:v.scan_id}),{estimate:m,semantic:h,match:u,commit:v,completeResults:w}}function Ue(a,i,n,t,s,o,r,l,p,m){return c.info("SCAN_ORCHESTRATOR","Building complete results with pre-extracted skin tone",{clientScanId:l,hasPreExtractedSkinTone:!!m,skinToneSchema:m?.schema}),{resolvedGender:r,estimate:a,semantic:i,match:n,commit:t,userId:p,serverScanId:t.scan_id,userProfile:{...o,sex:r},insights:Re(a,i,n),clientScanId:l,skin_tone:m,limb_masses:$e(n,a,l)}}async function He(a){return c.info("SCAN_PROCESSING_SERVICE","Delegating to refactored orchestrator",{clientScanId:a.clientScanId,userId:a.userId.substring(0,8)+"...",photosCount:a.capturedPhotos.length,architecture:"modular_v2"}),await Le(a)}function qe(a={}){const{profile:i,sessionInfo:n}=we(),t=ue(),{showToast:s}=fe(),{success:o}=se(),[r,l]=x.useState("front-photo"),[p,m]=x.useState([]),[h,g]=x.useState(null),[u,f]=x.useState(!1),[_,v]=x.useState(null),[w,I]=x.useState(!1),d=x.useRef(!1),b=x.useMemo(()=>n?.userId||i?.userId||null,[n?.userId,i?.userId]),E=x.useMemo(()=>{const M=ze(i);return c.info("BODY_SCAN_CAPTURE_FLOW","Extracting scan parameters from profile",{hasProfile:!!i,profileKeys:i?Object.keys(i):[],profileIdentityFields:i?{displayName:i.displayName,sex:i.sex,height_cm:i.height_cm,weight_kg:i.weight_kg,target_weight_kg:i.target_weight_kg,activity_level:i.activity_level,objective:i.objective,birthdate:i.birthdate}:null,extractedParams:M,extractedKeys:M?Object.keys(M):[],philosophy:"scan_params_extraction"}),M},[i?.sex,i?.height_cm,i?.weight_kg]),B=x.useMemo(()=>!!E,[E]);return{currentStep:r,capturedPhotos:p,scanResults:h,showValidationResults:u,validationSummary:_,userId:b,isProfileComplete:B,stableScanParams:E,processingGuardRef:d,isProcessing:w,setCapturedPhotos:m,setCurrentStep:l,setScanResults:g,setShowValidationResults:f,setValidationSummary:v,handleStartCapture:()=>{l("front-photo"),m([]),g(null),f(!1),v(null)},onProceedToProcessing:async()=>{const M=Be(E,null,!1,a.scanId);if(d.current){c.warn("BODY_SCAN_CAPTURE_FLOW","Processing already in progress, ignoring duplicate request",{clientScanId:a.scanId});return}if(p.length!==2){s({type:"error",title:"Photos manquantes",message:"Veuillez capturer les deux photos avant de continuer",duration:4e3});return}if(!E||!b){s({type:"error",title:"Param√®tres manquants",message:"Profil utilisateur incomplet",duration:4e3});return}if(!a.scanId){c.error("BODY_SCAN_CAPTURE_FLOW","No scanId provided to processing flow"),s({type:"error",title:"Erreur syst√®me",message:"Identifiant de scan manquant",duration:4e3});return}d.current=!0,I(!0),l("processing");const k=a.scanId;try{Ne.processingStarted({photos_count:p.length,scan_id:k});const{completeResults:y}=await He({userId:b,clientScanId:k,capturedPhotos:p,stableScanParams:E,resolvedGender:M});g(y),l("results"),c.info("BODY_SCAN_CAPTURE_FLOW","Processing complete, preparing for celebration",{clientScanId:k,serverScanId:y.serverScanId,hasResults:!!y,hasEstimate:!!y.estimate,hasSemantic:!!y.semantic,hasMatch:!!y.match,hasCommit:!!y.commit,aiRefined:!!y.match?.ai_refinement?.ai_refine,processingComplete:!0,philosophy:"verify_complete_before_celebration"}),o(),setTimeout(()=>{c.info("BODY_SCAN_CAPTURE_FLOW","Navigating to celebration with verified complete scan data",{clientScanId:k,serverScanId:y.serverScanId,resultsKeys:y?Object.keys(y):[],navigationDelay:"1000ms",timestamp:new Date().toISOString(),philosophy:"safe_navigation_after_complete_processing"}),t("/body-scan/celebration",{state:{scanResults:y,processingComplete:!0},replace:!1})},1e3)}catch(y){const P=y instanceof Error?y.message:"Erreur inconnue";c.error("BODY_SCAN_CAPTURE_FLOW","Processing pipeline failed",{clientScanId:k,error:P,stack:y instanceof Error?y.stack:void 0,step:"pipeline_processing",timestamp:new Date().toISOString()}),s({type:"error",title:"Erreur de traitement",message:P,duration:4e3}),l("profile-photo")}finally{d.current=!1,I(!1)}}}}const Ge={male:{front:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/homme-face.png",profile:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/homme-profil.png"},female:{front:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/femme-face.png",profile:"https://kwipydbtjagypocpvbwn.supabase.co/storage/v1/object/public/app-images/femme-profil.png"}};function Ke(a,i){return Ge[a==="female"?"female":"male"][i]}const We=({type:a,isFaceScan:i=!1,gender:n})=>{const t=H(),s=Ke(n,a);return e.jsxs("div",{className:"flex items-center gap-8",children:[e.jsx("div",{className:"relative",style:{width:"180px",height:"260px"},children:e.jsxs("div",{className:"w-full h-full border-2 rounded-3xl flex items-center justify-center relative overflow-hidden",style:{borderColor:a==="front"?"color-mix(in srgb, var(--color-plasma-cyan) 50%, transparent)":"color-mix(in srgb, #A855F7 50%, transparent)",background:a==="front"?`
                radial-gradient(circle at center, color-mix(in srgb, var(--color-plasma-cyan) 12%, transparent) 0%, transparent 70%),
                rgba(255, 255, 255, 0.05)
              `:`
                radial-gradient(circle at center, color-mix(in srgb, #A855F7 12%, transparent) 0%, transparent 70%),
                rgba(255, 255, 255, 0.05)
              `,backdropFilter:"blur(8px) saturate(120%)",boxShadow:a==="front"?`
                0 0 30px color-mix(in srgb, var(--color-plasma-cyan) 20%, transparent),
                0 8px 32px rgba(0, 0, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `:`
                0 0 30px color-mix(in srgb, #A855F7 20%, transparent),
                0 8px 32px rgba(0, 0, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15)
              `},children:[e.jsxs(j,{className:"absolute inset-2 rounded-2xl overflow-hidden",initial:t.enableInitialAnimations?{opacity:0,scale:.95}:!1,animate:t.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:t.enableFramerMotion?{duration:.8,ease:[.25,.1,.25,1]}:void 0,children:[e.jsx("img",{src:s,alt:`Guide ${a} - ${n==="female"?"Femme":"Homme"}`,className:"w-full h-full object-cover",style:{filter:a==="front"?`
                    brightness(0.7) 
                    contrast(1.1) 
                    saturate(0.8)
                    drop-shadow(0 0 8px color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent))
                  `:`
                    brightness(0.7) 
                    contrast(1.1) 
                    saturate(0.8)
                    drop-shadow(0 0 8px color-mix(in srgb, #A855F7 30%, transparent))
                  `,opacity:.85}}),e.jsx("div",{className:"absolute inset-0",style:{background:a==="front"?`
                    linear-gradient(135deg, 
                      color-mix(in srgb, var(--color-plasma-cyan) 15%, transparent) 0%, 
                      transparent 30%, 
                      color-mix(in srgb, var(--color-plasma-cyan) 8%, transparent) 70%, 
                      transparent 100%
                    )
                  `:`
                    linear-gradient(135deg, 
                      color-mix(in srgb, #A855F7 15%, transparent) 0%, 
                      transparent 30%, 
                      color-mix(in srgb, #A855F7 8%, transparent) 70%, 
                      transparent 100%
                    )
                  `,backdropFilter:"blur(1px)",mixBlendMode:"overlay"}})]}),e.jsx("div",{className:"absolute top-6 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded-lg text-xs font-medium",style:{background:`
                radial-gradient(circle at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%)
              `,backdropFilter:"blur(8px) saturate(120%)",border:a==="front"?"1px solid color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent)":"1px solid color-mix(in srgb, #A855F7 30%, transparent)",color:a==="front"?"var(--color-plasma-cyan)":"#A855F7",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.4)",zIndex:20},children:a==="front"?"Face":"Profil"}),e.jsx("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2 px-3 py-1.5 rounded-lg text-sm font-bold",style:{background:a==="front"?`
                  radial-gradient(circle at center, color-mix(in srgb, var(--color-plasma-cyan) 25%, transparent) 0%, color-mix(in srgb, var(--color-plasma-cyan) 15%, transparent) 100%)
                `:`
                  radial-gradient(circle at center, color-mix(in srgb, #A855F7 25%, transparent) 0%, color-mix(in srgb, #A855F7 15%, transparent) 100%)
                `,border:a==="front"?"1px solid color-mix(in srgb, var(--color-plasma-cyan) 50%, transparent)":"1px solid color-mix(in srgb, #A855F7 50%, transparent)",color:a==="front"?"var(--color-plasma-cyan)":"#A855F7",backdropFilter:"blur(8px) saturate(130%)",boxShadow:a==="front"?`
                  0 4px 12px rgba(0, 0, 0, 0.3),
                  0 0 12px color-mix(in srgb, var(--color-plasma-cyan) 40%, transparent)
                `:`
                  0 4px 12px rgba(0, 0, 0, 0.3),
                  0 0 12px color-mix(in srgb, #A855F7 40%, transparent)
                `,zIndex:20},children:a==="front"?"180¬∞":"90¬∞"})," ",t.enableBreathingAnimations&&e.jsx("div",{className:"absolute inset-0 border-2 border-white/20 rounded-3xl pointer-events-none",style:{animation:"guide-breathing-animation 4s ease-in-out infinite",boxShadow:a==="front"?"inset 0 0 20px color-mix(in srgb, var(--color-plasma-cyan) 10%, transparent)":"inset 0 0 20px color-mix(in srgb, #A855F7 10%, transparent)",zIndex:10}})]})}),e.jsx("div",{className:"flex-1 text-left space-y-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:`text-sm font-medium ${a==="front"?"text-cyan-400":"text-purple-400"}`,children:["Position ",a==="front"?"face":"profil"]}),e.jsx("div",{className:"space-y-1 text-xs text-white/60",children:a==="front"?i?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚Ä¢ Regardez l'objectif"}),e.jsx("p",{children:"‚Ä¢ Visage au centre du cadre"}),e.jsx("p",{children:"‚Ä¢ Expression neutre"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚Ä¢ Regardez l'objectif"}),e.jsx("p",{children:"‚Ä¢ Bras l√©g√®rement d√©coll√©s"}),e.jsx("p",{children:"‚Ä¢ Posture droite"})]}):i?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚Ä¢ Tournez-vous de 90¬∞"}),e.jsx("p",{children:"‚Ä¢ Regardez droit devant"}),e.jsx("p",{children:"‚Ä¢ Visage au centre du cadre"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚Ä¢ Tournez-vous √† 90¬∞"}),e.jsx("p",{children:"‚Ä¢ M√™me distance que face"}),e.jsx("p",{children:"‚Ä¢ Bras visible"})]})})]})})]})},Xe=({photo:a,showSuccessAnimation:i,onRetake:n})=>{const t=H(),{click:s}=se();return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative aspect-[3/4] rounded-xl overflow-hidden",children:[e.jsx(j,{as:"img",src:a.url,alt:`Photo ${a.type}`,className:"w-full h-full object-contain bg-black/20 border border-white/10 photo-processing",initial:t.enableInitialAnimations?{opacity:0,scale:.95}:!1,animate:t.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:t.enableFramerMotion?{duration:.6,ease:"easeOut"}:void 0}),e.jsx(he,{children:i&&e.jsx(j,{className:"absolute inset-0 flex items-center justify-center backdrop-blur-md rounded-xl success-ripple",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.4))",border:"1px solid rgba(34, 197, 94, 0.5)"},initial:t.enableInitialAnimations?{opacity:0,scale:.8}:!1,animate:t.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},exit:t.enableInitialAnimations?{opacity:0,scale:1.1}:void 0,transition:t.enableFramerMotion?{duration:.6,ease:"easeOut"}:void 0,children:e.jsx(j,{className:"w-24 h-24 rounded-full flex items-center justify-center backdrop-blur-sm",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.5))",border:"2px solid rgba(34, 197, 94, 0.6)",boxShadow:"0 0 40px rgba(34, 197, 94, 0.6), inset 0 2px 0 rgba(255,255,255,0.3)"},initial:t.enableInitialAnimations?{scale:0,rotate:-180}:!1,animate:t.enableInitialAnimations?{scale:1,rotate:0}:{scale:1},transition:t.enableFramerMotion?{type:"spring",stiffness:300,damping:20,delay:.2}:void 0,children:e.jsx(A,{Icon:C.Check,size:36,className:"text-green-400"})})})})]}),e.jsx(j,{as:"button",onClick:()=>{s(),n()},className:"w-full btn-glass",whileHover:t.enableWhileHover?{scale:1.02}:void 0,whileTap:t.enableWhileTap?{scale:.98}:void 0,style:{borderRadius:"999px",padding:".5rem 1.5rem",minHeight:"44px",overflow:"hidden"},initial:t.enableInitialAnimations?{opacity:0,y:10}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.4,delay:.2}:void 0,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{Icon:C.RotateCcw,size:14}),e.jsx("span",{children:"Reprendre"})]})})]})},Ye=({photo:a,photoType:i,isValidating:n})=>{const s=i==="front"?"var(--color-nutrition-primary)":"#A855F7";return e.jsx("div",{className:"flex flex-col items-end gap-2",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium",style:{background:a?`color-mix(in srgb, ${s} 15%, transparent)`:"color-mix(in srgb, #60A5FA 15%, transparent)",border:a?`1px solid color-mix(in srgb, ${s} 30%, transparent)`:"1px solid color-mix(in srgb, #60A5FA 30%, transparent)",color:a?s:"#60A5FA",backdropFilter:"blur(8px) saturate(120%)"},children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-current opacity-60 flex items-center justify-center"}),e.jsx("span",{children:a?a.validationResult?.isValid?"Captur√©e & Valid√©e":"Captur√©e":"En attente"})]})})},Qe=({photoType:a,isValidating:i,onCameraCapture:n,onGallerySelect:t,isProgressInitialized:s,fileInputRef:o,onFileSelect:r})=>{const l=H(),p=a==="front"?"var(--color-plasma-cyan)":"#A855F7";c.debug("PHOTO_CONTROLS","state",{photoType:a,isValidating:i,isProgressInitialized:s});const m=i||!s,h=()=>{o?.current?o.current.click():t()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx(j,{as:"button",type:"button",onClick:n,disabled:m,"aria-busy":i,className:"px-6 py-3 rounded-full font-semibold text-white transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60",whileHover:l.enableWhileHover&&!m?{scale:1.02,y:-2}:void 0,whileTap:l.enableWhileTap&&!m?{scale:.98}:void 0,initial:l.enableInitialAnimations?{opacity:0,y:12}:!1,animate:l.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:l.enableFramerMotion?{duration:.25}:void 0,style:{background:`
              linear-gradient(135deg,
                color-mix(in srgb, ${p} 80%, transparent),
                color-mix(in srgb, ${p} 60%, transparent)
              )
            `,border:`2px solid color-mix(in srgb, ${p} 60%, transparent)`,boxShadow:`
              0 8px 32px color-mix(in srgb, ${p} 40%, transparent),
              0 0 40px color-mix(in srgb, ${p} 25%, transparent),
              inset 0 2px 0 rgba(255, 255, 255, 0.30)
            `,backdropFilter:"blur(16px) saturate(150%)",opacity:m?.6:1,cursor:m?"not-allowed":"pointer"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{animate:l.enableLoadingAnimations&&i?{rotate:360}:void 0,transition:l.enableFramerMotion?{duration:2,repeat:1/0,ease:"linear"}:void 0,children:e.jsx(A,{Icon:i?C.Loader2??C.Camera:C.Camera,size:16,color:"white",glowColor:p,variant:"pure"})}),e.jsx("span",{children:i?"Validation‚Ä¶":"Cam√©ra"})]})}),e.jsx(j,{as:"button",type:"button",onClick:h,disabled:m,className:"px-6 py-3 rounded-full font-medium text-white/90 transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40",whileHover:l.enableWhileHover&&!m?{scale:1.02,y:-1}:void 0,whileTap:l.enableWhileTap&&!m?{scale:.98}:void 0,initial:l.enableInitialAnimations?{opacity:0,y:12}:!1,animate:l.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:l.enableFramerMotion?{duration:.25,delay:.05}:void 0,style:{background:`color-mix(in srgb, ${p} 8%, transparent)`,border:`1px solid color-mix(in srgb, ${p} 20%, transparent)`,backdropFilter:"blur(12px) saturate(130%)",opacity:m?.6:1,cursor:m?"not-allowed":"pointer"},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{Icon:C.Image,size:16,color:"white",glowColor:p,variant:"pure"}),e.jsx("span",{children:"Galerie"})]})})]}),o&&r&&e.jsx("input",{ref:o,type:"file",accept:"image/*",onChange:r,className:"hidden",capture:"environment"})]})},de=({photoType:a,step:i,capturedPhotos:n,userGender:t,isFaceScan:s=!1,isValidating:o,showSuccessAnimation:r,isProgressInitialized:l,onRetake:p,onCameraClick:m,onGalleryClick:h,fileInputRef:g,onFileSelect:u})=>{const f=H(),_=n.find(b=>b.type===a),v=a==="front"&&i==="front-photo"||a==="profile"&&i==="profile-photo",w=s||a==="front"?"var(--color-plasma-cyan)":"#A855F7",I=a==="front"?C.User:C.RotateCcw,d=a==="front"?"Photo de face":"Photo de profil";return e.jsx(j,{"data-photo-type":a,initial:f.enableInitialAnimations?{opacity:0,x:a==="front"?-20:20}:!1,animate:f.enableInitialAnimations?{opacity:1,x:0}:{opacity:1},transition:f.enableFramerMotion?{duration:.6,delay:a==="front"?0:.1,ease:[.25,.1,.25,1]}:void 0,className:"w-full max-w-2xl",children:e.jsxs(U,{className:`p-6 h-full relative photo-card photo-card--${a}`,style:{background:`radial-gradient(circle at 30% 20%, color-mix(in srgb, ${w} 8%, transparent) 0%, transparent 60%), var(--glass-opacity-base)`,borderColor:`color-mix(in srgb, ${w} 25%, transparent)`,borderRadius:"24px",overflow:"hidden"},children:[e.jsxs("div",{className:"flex items-start justify-between mb-6 min-h-[3rem]",children:[e.jsxs("h4",{className:"text-white text-lg font-semibold flex items-center gap-3",children:[e.jsx("div",{className:"glowing-icon-container",style:{"--icon-color":w},children:e.jsx(A,{Icon:I,size:16,style:{color:w,filter:`drop-shadow(0 0 8px ${w}80) drop-shadow(0 0 16px ${w}60)`},variant:"pure"})}),e.jsx("span",{className:"glowing-title-text",children:d})]}),e.jsx(Ye,{photo:_,photoType:a,isValidating:o})]}),_?e.jsx(Xe,{photo:_,showSuccessAnimation:r===a,onRetake:()=>p(a)}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(We,{type:a,isFaceScan:s,gender:t}),v&&e.jsx(Qe,{photoType:a,isValidating:o,isProgressInitialized:l,onCameraClick:m,onGalleryClick:h,fileInputRef:g,onFileSelect:u}),!v&&!_&&e.jsx("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(A,{Icon:C.Clock,size:24,className:"text-white/60"}),e.jsx("p",{className:"text-sm text-white/60",children:a==="profile"?"Compl√©tez d'abord la photo de face":"En attente"})]})})]})]})})};function me(a){const i=[];if(!a.type.startsWith("image/"))return i.push("File is not an image"),{isValid:!1,issues:i};const n=15*1024*1024;return a.size>n?(i.push("File is too large (max 15MB)"),{isValid:!1,issues:i}):a.size<1024?(i.push("File is too small (min 1KB)"),{isValid:!1,issues:i}):(!a.type.includes("jpeg")&&!a.type.includes("jpg")&&i.push("JPEG format is recommended for better compatibility"),{isValid:i.length===0||!i.some(t=>t.includes("not an image")||t.includes("too large")||t.includes("too small")),issues:i})}async function Ze(a){return new Promise(i=>{const n=[],t=new Image,s=document.createElement("canvas"),o=s.getContext("2d");t.onload=()=>{try{(t.width<200||t.height<200)&&n.push("Image resolution is too low (minimum 200x200)"),(t.width>4e3||t.height>4e3)&&n.push("Image resolution is very high and will be optimized");const r=t.width/t.height;(r<.3||r>3)&&n.push("Unusual aspect ratio detected"),o&&(s.width=Math.min(t.width,100),s.height=Math.min(t.height,100),o.drawImage(t,0,0,s.width,s.height),o.getImageData(0,0,s.width,s.height).data.some(m=>m>0)||n.push("Image appears to be corrupted or blank")),i({isValid:!n.some(l=>l.includes("corrupted")||l.includes("too low")),issues:n})}catch{n.push("Failed to analyze image quality"),i({isValid:!1,issues:n})}},t.onerror=()=>{n.push("Image file is corrupted or invalid"),i({isValid:!1,issues:n})},t.src=URL.createObjectURL(a)})}async function Je(a,i=2048,n=.8,t="image/jpeg"){const s=Math.round(a.size/1024);return s<=i?(c.debug("PHOTO_UTILS","No compression needed",{fileName:a.name,originalSizeKB:s,maxSizeKB:i}),{compressedFile:a,compressionApplied:!1,originalSizeKB:s,finalSizeKB:s}):new Promise((o,r)=>{const l=document.createElement("canvas"),p=l.getContext("2d"),m=new Image;m.onload=()=>{try{let{width:h,height:g}=m;const u=1920;if(h>u||g>u){const f=Math.min(u/h,u/g);h=Math.round(h*f),g=Math.round(g*f)}l.width=h,l.height=g,p?(p.drawImage(m,0,0,h,g),l.toBlob(f=>{if(f){const _=new File([f],a.name,{type:t,lastModified:Date.now()}),v=Math.round(f.size/1024);c.debug("PHOTO_UTILS","Image compressed",{fileName:a.name,originalSizeKB:s,finalSizeKB:v,compressionApplied:!0,outputMimeType:t}),o({compressedFile:_,compressionApplied:!0,originalSizeKB:s,finalSizeKB:v})}else r(new Error("Failed to create blob after compression"))},t,n)):r(new Error("Failed to get canvas context for compression"))}catch(h){r(h)}},m.onerror=()=>r(new Error("Failed to load image for compression")),m.src=URL.createObjectURL(a)})}async function ea(a){c.info("üîç [PhotoProcessing] Starting photo processing",{fileName:a.name,fileSize:Math.round(a.size/1024),fileType:a.type});try{const i=a.type.includes("jpeg")||a.type.includes("jpg")?"image/jpeg":a.type.includes("png")?"image/png":"image/jpeg";c.debug("PHOTO_UTILS","Determined output MIME type",{originalType:a.type,outputMimeType:i});const n=await Je(a,2048,.85,i),t=await pe(n.compressedFile,i),s=new File([t],a.name,{type:i,lastModified:Date.now()}),o=Math.round(s.size/1024),r=aa(n.originalSizeKB,o,n.compressionApplied);return c.info("‚úÖ [PhotoProcessing] Photo processing completed",{originalSizeKB:n.originalSizeKB,finalSizeKB:o,compressionApplied:n.compressionApplied,qualityScore:r,finalMimeType:i}),{processedFile:s,validationReport:{originalSizeKB:n.originalSizeKB,finalSizeKB:o,compressionApplied:n.compressionApplied,qualityScore:r}}}catch(i){c.error("‚ùå [PhotoProcessing] Photo processing failed",{error:i instanceof Error?i.message:String(i)});try{const n=a.type.startsWith("image/")?a.type:"image/jpeg",t=await pe(a,n),s=new File([t],a.name,{type:n,lastModified:Date.now()}),o=Math.round(a.size/1024),r=Math.round(s.size/1024);return c.warn("PHOTO_UTILS","Photo processing fallback executed",{fileName:a.name,originalSizeKB:o,finalSizeKB:r,fallbackMimeType:n}),{processedFile:s,validationReport:{originalSizeKB:o,finalSizeKB:r,compressionApplied:!1,qualityScore:.7}}}catch{throw new Error(`Photo processing failed: ${i instanceof Error?i.message:String(i)}`)}}}function aa(a,i,n){let t=1;if(n){const s=i/a;s<.3?t-=.3:s<.5?t-=.2:t-=.1}return i<100?t-=.2:i>3e3&&(t-=.1),Math.max(.1,Math.min(1,t))}async function pe(a,i="image/jpeg"){return new Promise((n,t)=>{const s=document.createElement("canvas"),o=s.getContext("2d"),r=new Image;r.onload=()=>{s.width=r.width,s.height=r.height,o?(o.drawImage(r,0,0),s.toBlob(l=>{l?(c.debug("PHOTO_UTILS","EXIF stripped",{fileName:a.name,outputMimeType:i}),n(l)):t(new Error("Failed to create blob from canvas after EXIF stripping"))},i,.95)):t(new Error("Failed to get canvas context for EXIF stripping"))},r.onerror=()=>t(new Error("Failed to load image for EXIF stripping")),r.src=URL.createObjectURL(a)})}async function ta(a,i,n,t){const s=new Date().toISOString();c.info("üì∏ [PhotoCapture] Creating capture report",{type:i,fileSize:Math.round(a.size/1024),isValid:n.isValid,confidence:Math.round(n.confidence*100)}),c.info("üé® [PhotoCapture] Skin tone extraction delegated to Vision AI",{type:i,philosophy:"vision_ai_exclusive_extraction"});const r={timestamp:s,photoType:i,fileInfo:{name:a.name,size:a.size,type:a.type,lastModified:a.lastModified},validation:n,quality:n.qualityMetrics||{blur_score:.5,brightness:.5,contrast:.5,sharpness:.5},content:n.contentMetrics||{person_detected:!1,face_detected:!1,pose_quality:.5},scale:n.scaleMetrics||{person_size_ratio:.5,distance_score:.5},skinTone:void 0,streamInfo:void 0,userId:null};return c.info("üì∏ [PhotoCapture] Capture report created",{type:i,hasValidation:!!n,hasStreamInfo:!1,philosophy:"vision_ai_exclusive_skin_tone_extraction"}),r}const sa=({isCapturing:a,onCapture:i,onClose:n,onSwitchCamera:t})=>{const s=H();return e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-8 sm:p-12 bg-gradient-to-t from-black/95 via-black/70 to-transparent",children:[e.jsxs("div",{className:"flex items-center justify-between max-w-lg mx-auto",children:[e.jsx(j,{as:"button",onClick:n,className:"w-16 h-16 sm:w-18 sm:h-18 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shadow-lg",whileHover:s.enableWhileHover?{scale:1.05}:void 0,whileTap:s.enableWhileTap?{scale:.95}:void 0,initial:s.enableInitialAnimations?{opacity:0,y:20}:!1,animate:s.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:s.enableFramerMotion?{delay:.2,duration:.5}:void 0,children:e.jsx(A,{Icon:C.X,size:26,className:"text-white"})}),e.jsxs(j,{as:"button",onClick:i,disabled:a,className:"w-24 h-24 sm:w-28 sm:h-28 rounded-full border-4 border-white/30 flex items-center justify-center relative shadow-2xl",style:{background:a?"linear-gradient(135deg, var(--brand-warning), var(--brand-warning-dark))":"linear-gradient(135deg, var(--brand-primary), var(--brand-accent))",boxShadow:a?"0 0 30px color-mix(in srgb, var(--brand-warning) 60%, transparent), 0 8px 32px rgba(0,0,0,0.4)":"0 0 30px color-mix(in srgb, var(--brand-primary) 60%, transparent), 0 8px 32px rgba(0,0,0,0.4)"},whileHover:s.enableWhileHover?{scale:1.05}:void 0,whileTap:s.enableWhileTap?{scale:.92}:void 0,initial:s.enableInitialAnimations?{opacity:0,scale:.8}:!1,animate:s.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:s.enableFramerMotion?{delay:.1,duration:.6,type:"spring",stiffness:300}:void 0,children:[a?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-white",animate:s.enableCSSAnimations?{scale:[1,.7,1]}:{scale:1},transition:s.enableFramerMotion?{duration:.6,repeat:1/0,ease:"easeInOut"}:void 0}),e.jsx(j,{className:"absolute inset-0 rounded-full border-4 border-brand-warning/60",animate:s.enableCSSAnimations?{scale:[1,1.3,1],opacity:[.8,.2,.8]}:{scale:1,opacity:.5},transition:s.enableFramerMotion?{duration:.8,repeat:1/0}:void 0})]}):e.jsx("div",{className:"w-18 h-18 sm:w-20 sm:h-20 rounded-full shadow-inner bg-white"}),!a&&s.enablePulseAnimations&&e.jsx(j,{className:"absolute inset-0 rounded-full border-2 border-brand-accent/40",animate:s.enableCSSAnimations?{scale:[1,1.1,1],opacity:[.5,.8,.5]}:{scale:1,opacity:.5},transition:s.enableFramerMotion?{duration:2,repeat:1/0,ease:"easeInOut"}:void 0})]}),e.jsx(j,{as:"button",onClick:t,className:"w-16 h-16 sm:w-18 sm:h-18 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shadow-lg",whileHover:s.enableWhileHover?{scale:1.05}:void 0,whileTap:s.enableWhileTap?{scale:.95}:void 0,initial:s.enableInitialAnimations?{opacity:0,y:20}:!1,animate:s.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:s.enableFramerMotion?{delay:.3,duration:.5}:void 0,children:e.jsx(A,{Icon:C.RotateCcw,size:26,className:"text-white"})})]}),e.jsx(j,{className:"text-center mt-8",initial:s.enableInitialAnimations?{opacity:0}:!1,animate:s.enableInitialAnimations?{opacity:1}:{opacity:1},transition:s.enableFramerMotion?{delay:.8,duration:.6}:void 0,children:e.jsx("p",{className:"text-white/80 text-lg font-medium",children:a?"Capture en cours...":"Appuyez pour capturer"})})]})},ia=({isAnyPhotoValidating:a,onProceedToProcessing:i,glassClick:n})=>{const t=H(),s=()=>{a||(n(),i())};return e.jsxs(U,{className:"glass-card refined-glass-cta p-8 text-center relative overflow-visible rounded-3xl",children:[e.jsx("div",{className:"refined-inner-glow absolute inset-0 rounded-[inherit] pointer-events-none"}),e.jsx("div",{className:"refined-glass-texture absolute inset-0 rounded-[inherit] pointer-events-none"}),e.jsxs("div",{className:"relative z-10 space-y-8",children:[e.jsxs(j,{className:"flex items-center justify-center gap-4 mb-2",initial:t.enableInitialAnimations?{opacity:0,scale:.9}:!1,animate:t.enableInitialAnimations?{opacity:1,scale:1}:{opacity:1},transition:t.enableFramerMotion?{duration:.5,delay:.15,ease:[.25,.1,.25,1]}:void 0,children:[e.jsxs("div",{className:"refined-success-icon-container relative",children:[e.jsx("div",{className:"refined-success-halo absolute inset-0"}),e.jsx("div",{className:"refined-success-icon size-12 rounded-full grid place-items-center relative z-10",children:e.jsx(A,{Icon:C.Check,size:24,className:"text-white"})}),e.jsx("div",{className:"refined-success-ring-1 absolute inset-0 rounded-full"}),e.jsx("div",{className:"refined-success-ring-2 absolute inset-0 rounded-full"})]}),e.jsx(j,{as:"span",className:"refined-success-text text-xl font-bold",initial:t.enableInitialAnimations?{opacity:0,x:-16}:!1,animate:t.enableInitialAnimations?{opacity:1,x:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.45,delay:.3}:void 0,children:"Photos captur√©es avec succ√®s¬†!"})]}),e.jsx(j,{as:"p",className:"refined-description text-lg leading-relaxed max-w-md mx-auto",initial:t.enableInitialAnimations?{opacity:0,y:10}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.45,delay:.25}:void 0,children:"Vos photos de face et de profil sont pr√™tes pour l'analyse IA avanc√©e."}),e.jsxs(j,{as:"button","data-launch-analysis":!0,onClick:s,className:"refined-cta-button w-full relative overflow-hidden rounded-full py-3 glass-focus hover-lift",disabled:a,"aria-busy":a,"aria-live":"polite",whileHover:t.enableWhileHover?{scale:1.02,y:-2}:void 0,whileTap:t.enableWhileTap?{scale:.98}:void 0,initial:t.enableInitialAnimations?{opacity:0,y:16}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.5,delay:.35,ease:[.25,.1,.25,1]}:void 0,type:"button",children:[e.jsx("span",{className:"refined-cta-glow absolute inset-0 pointer-events-none rounded-[inherit]"}),e.jsxs("span",{className:"refined-cta-content relative z-10 flex items-center justify-center gap-3",children:[e.jsx(j,{as:"span",className:"refined-cta-icon",animate:t.enableLoadingAnimations&&a?{rotate:360}:void 0,transition:t.enableFramerMotion?{duration:2,repeat:1/0,ease:"linear"}:void 0,children:e.jsx(A,{Icon:a?C.Loader2:C.Zap,size:20,className:"text-white"})}),e.jsx("span",{className:"refined-cta-text text-lg font-bold",children:a?"Analyse en cours...":"Lancer l'analyse IA"})]})]})]})]})},na=({step:a,capturedPhotos:i,onPhotoCapture:n,onRetake:t,onBack:s,onProceedToProcessing:o,isProcessingInProgress:r=!1,isFaceScan:l=!1,userGender:p,isProgressInitialized:m})=>{const[h,g]=x.useState(!1),[u,f]=x.useState(!1),[_,v]=x.useState(!1),[w,I]=x.useState(null),d=x.useRef(null),{click:b,success:E,error:B,glassClick:q}=se(),{showToast:S}=fe(),M=H(),k=M.enableFramerMotion,y={duration:M.mode==="high-performance"?.3:M.mode==="balanced"?.5:.8,ease:[.25,.1,.25,1],shouldAnimate:M.enableCSSAnimations},P=a==="front-photo"?"front":"profile",ee=i.find(T=>T.type==="front"),F=i.find(T=>T.type==="profile"),R=[{id:"tracking",icon:"TrendingUp",color:"#22C55E",title:"Suivi Pr√©cis",description:"D√©tectez les changements morphologiques subtils"},{id:"avatar-3d",icon:"Eye",color:"#8B5CF6",title:"Avatar 3D R√©aliste",description:"Visualisez votre morphologie en 3 dimensions"},{id:"recommendation",icon:"Calendar",color:"#3B82F6",title:"Scan 2x/mois",description:"Recommandation pour un suivi optimal"}],D=x.useCallback(async T=>{f(!0),v(!0),c.info("üîç [PhotoCapture] Starting photo processing",{photoType:P,fileSize:Math.round(T.size/1024),fileType:T.type,fileName:T.name,timestamp:Date.now()});try{const N=me(T);if(!N.isValid){const V=N.issues.filter(W=>W.includes("not an image")||W.includes("too large")||W.includes("too small"));if(V.length>0){S({type:"error",title:"Format de fichier invalide",message:V[0],duration:4e3}),B();return}else S({type:"warning",title:"Format non optimal",message:"Le format JPEG est recommand√© pour une meilleure compatibilit√©",duration:3e3})}const{processedFile:L,validationReport:O}=await ea(T);if(c.info("üîç [PhotoCapture] Photo processing completed",{photoType:P,validationReport:O,processingSuccess:!0}),O.compressionApplied){const V=((O.originalSizeKB-O.finalSizeKB)/O.originalSizeKB*100).toFixed(0);S({type:"info",title:"Photo optimis√©e",message:`Taille r√©duite de ${V}% pour une meilleure compatibilit√©`,duration:2e3})}let z;try{z={isValid:!0,issues:[],retakeReasons:[],confidence:.8,qualityMetrics:{blur_score:.7,brightness:.6,exposure_ok:!0,noise_score:.3},contentMetrics:{single_person:!0,pose_ok:!0,face_detected:!0,face_bbox_norm:[.3,.1,.7,.4]},scaleMetrics:{pixel_per_cm_estimate:3.5,method:"face-heuristic"}}}catch(V){c.warn("Worker validation failed, using permissive fallback:",V),z={isValid:!0,issues:["Validation simplifi√©e - Photo accept√©e"],retakeReasons:[],confidence:.8,qualityMetrics:{blur_score:.7,brightness:.6,exposure_ok:!0,noise_score:.3},contentMetrics:{single_person:!0,pose_ok:!0,face_detected:!0,face_bbox_norm:[.3,.1,.7,.4]},scaleMetrics:{pixel_per_cm_estimate:3.5,method:"face-heuristic"}}}const Q=await ta(L,P,z,void 0),ie=["multiple_people","no_person"];if(z.retakeReasons?.some(V=>ie.includes(V))){const W=z.retakeReasons.find(be=>ie.includes(be))==="multiple_people"?"Une seule personne doit √™tre visible sur la photo":"Aucune personne d√©tect√©e - Assurez-vous d‚Äô√™tre visible dans le cadre";S({type:"error",title:"Photo non utilisable",message:W,duration:4e3}),B();return}I(P);const{setCaptureProgress:ne}=J.getState();ne(P==="front"?"front_taken":"done");const ge=z.isValid?"Photo captur√©e avec succ√®s":"Photo captur√©e - Qualit√© √† am√©liorer",xe=z.isValid?"success":"warning";setTimeout(async()=>{await n(L,P,Q),I(null),P==="front"&&setTimeout(()=>{document.querySelector('[data-photo-type="profile"]')?.scrollIntoView({behavior:"smooth",block:"center"})},500),P==="profile"&&setTimeout(()=>{document.querySelector("[data-launch-analysis]")?.scrollIntoView({behavior:"smooth",block:"center"})},800)},1e3),S({type:xe,title:ge,message:z.isValid?"Excellente qualit√© d√©tect√©e":`${z.issues.length} point(s) d‚Äôam√©lioration d√©tect√©(s). Vous pouvez continuer ou reprendre la photo.`,duration:2e3}),z.isValid&&E()}catch(N){c.error(`Photo processing error: ${N instanceof Error?N.message:String(N)}`,N),S({type:"error",title:"Erreur de traitement",message:"Impossible de traiter la photo",duration:4e3}),B()}finally{f(!1),v(!1),d.current&&(d.current.value="")}},[P,n,S,E,B,i]),$=x.useCallback(async T=>{const N=T.target.files?.[0];if(!N)return;const L=me(N);if(!L.isValid){const O=L.issues.filter(z=>z.includes("not an image")||z.includes("too large"));if(O.length>0){S({type:"error",title:"Fichier invalide",message:O[0],duration:4e3});return}}N.size>8*1024*1024&&S({type:"warning",title:"Fichier volumineux",message:"La photo sera automatiquement optimis√©e pour un traitement plus rapide",duration:2e3});try{const O=await Ze(N);if(!O.isValid&&O.issues.some(Q=>Q.includes("corrupted")||Q.includes("too small"))){S({type:"error",title:"Qualit√© d‚Äôimage insuffisante",message:O.issues[0],duration:4e3});return}}catch(O){c.warn("üîç [PhotoCapture] Quality validation failed, continuing with processing",{error:O instanceof Error?O.message:"Unknown error"})}if(N.size>15*1024*1024){S({type:"error",title:"Fichier trop volumineux",message:"La photo doit faire moins de 15MB",duration:4e3});return}await D(N)},[D,S]),G=x.useCallback(async T=>{g(!1),await D(T)},[D]);return e.jsxs("div",{className:"body-scan-page twinforge visionos-26 space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(X.div,{"data-photo-type":"front",initial:k?{opacity:0,x:-20}:!1,animate:{opacity:1,x:0},transition:{duration:y.duration,ease:y.ease},children:e.jsx(de,{photoType:"front",step:a,capturedPhotos:i,userGender:p,isFaceScan:l,isValidating:u,showSuccessAnimation:w,isProgressInitialized:m,onRetake:t,onCameraClick:()=>g(!0),onGalleryClick:()=>d.current?.click(),fileInputRef:d,onFileSelect:$})}),e.jsx(X.div,{"data-photo-type":"profile",initial:k?{opacity:0,x:20}:!1,animate:{opacity:1,x:0},transition:{duration:y.duration,delay:.1,ease:y.ease},children:e.jsx(de,{photoType:"profile",step:a,capturedPhotos:i,userGender:p,isFaceScan:l,isValidating:u,showSuccessAnimation:w,isProgressInitialized:m,onRetake:t,onCameraClick:()=>g(!0),onGalleryClick:()=>d.current?.click(),fileInputRef:d,onFileSelect:$})})]}),e.jsx(ce,{children:_&&e.jsx(X.div,{initial:k?{opacity:0,y:20}:!1,animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.6,ease:[.25,.1,.25,1]},"aria-live":"polite",children:e.jsx(U,{className:"glass-card refined-glass-info p-6 text-center rounded-3xl overflow-hidden",children:e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("span",{className:"refined-spinner refined-spinner--cyan size-8","aria-hidden":"true"}),e.jsx("span",{className:"text-secondary text-base font-medium",children:"Validation en cours‚Ä¶"})]})})})}),e.jsx(ce,{children:i.length===2&&!_&&e.jsx(X.div,{className:"ready-for-processing-entrance",initial:k?{opacity:0,y:30,scale:.95}:!1,animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-20,scale:.95},transition:{duration:.8,ease:[.25,.1,.25,1]},children:e.jsx(ia,{isAnyPhotoValidating:_,onProceedToProcessing:o,glassClick:q})})}),a==="front-photo"&&e.jsx(_e,{benefits:R,themeColor:"#8B5CF6",title:"Pourquoi scanner mon corps ?"}),h&&e.jsx(sa,{photoType:P,onCapture:G,onClose:()=>g(!1)}),e.jsx("input",{ref:d,type:"file",accept:"image/*",onChange:$,className:"hidden",capture:"environment"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X.button,{onClick:()=>{b(),s()},className:"btn-glass--secondary-nav px-6 py-3 rounded-full",whileHover:k?{scale:1.02}:void 0,whileTap:k?{scale:.98}:void 0,initial:k?{opacity:0,x:-20}:!1,animate:{opacity:1,x:0},transition:{duration:.5,delay:.2},children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(A,{Icon:C.ArrowLeft,size:16}),e.jsx("span",{children:"Retour"})]})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:`text-caption text-white/60 ${y.shouldAnimate?"progress-text-pulse":""}`,children:ee&&F?"Photos captur√©es":a==="front-photo"?"√âtape 1 sur 2":"√âtape 2 sur 2"})}),e.jsx("div",{className:"w-24"})]})]})},ra=({capturedPhotos:a,currentProgress:i,currentMessage:n,currentSubMessage:t})=>{const s=H(),o=s.enableCSSAnimations,r=x.useMemo(()=>a.find(d=>d.type==="front"),[a]),l=x.useMemo(()=>a.find(d=>d.type==="profile"),[a]);if(!r||!l)return c.warn("IMMERSIVE_PHOTO_ANALYSIS","Photos manquantes pour l‚Äôanalyse immersive",{hasFrontPhoto:!!r,hasProfilePhoto:!!l,totalPhotos:a.length}),null;const p=x.useMemo(()=>{const d=[{x:50,y:12,label:"T√™te"},{x:40,y:25,label:"√âpaule G"},{x:60,y:25,label:"√âpaule D"},{x:50,y:45,label:"Taille"},{x:45,y:65,label:"Hanche G"},{x:55,y:65,label:"Hanche D"},{x:45,y:90,label:"Pied G"},{x:55,y:90,label:"Pied D"}];return s.mode==="high-performance"?[d[0],d[1],d[2],d[3],d[6]]:d},[s.mode]),m=x.useMemo(()=>{const d=[{x:50,y:15,label:"T√™te"},{x:45,y:35,label:"√âpaule"},{x:50,y:50,label:"Taille"},{x:48,y:70,label:"Hanche"},{x:50,y:90,label:"Pied"}];return s.mode==="high-performance"?[d[0],d[2],d[4]]:d},[s.mode]),[h,g]=x.useState([]);x.useEffect(()=>{if(!o||!s.enableParticleEffects){g([]);return}const d=()=>{const E=s.mode==="quality"?3:2,B=Array.from({length:E},(q,S)=>({x:Math.random()*80+10,y:Math.random()*80+10,intensity:Math.random()*.8+.2,id:`zone-${Date.now()}-${S}`}));g(B)};d();const b=setInterval(d,3e3);return()=>clearInterval(b)},[o,s.enableParticleEffects,s.mode]);const u=x.useMemo(()=>{const d=s.mode==="quality"?6:s.mode==="balanced"?4:0;return d===0?[]:Array.from({length:d},(b,E)=>{const B=12+Math.random()*76,q=70+Math.random()*25,S=(Math.random()-.5)*30,M=-120-Math.random()*120,k=3+Math.random()*3,y=8+Math.round(Math.random()*6),P=E*.3;return{id:`p-${E}`,x:B,y:q,dx:S,dy:M,speed:k,size:y,delay:P}})},[s.mode]),f=s.enableInitialAnimations?{opacity:0,scale:.94}:!1,_={opacity:1,scale:1},v=[.25,.1,.25,1],w="var(--color-body-scan-primary)",I=[{icon:"Scan",label:"D√©tection Morphologique",sublabel:"Extraction des points cl√©s corporels",color:"#8B5CF6",activeThreshold:10},{icon:"Zap",label:"Analyse IA Avanc√©e",sublabel:"Matching archetypes et affinement",color:"#A855F7",activeThreshold:40},{icon:"Box",label:"G√©n√©ration 3D",sublabel:"Construction avatar personnalis√©",color:"#C084FC",activeThreshold:70}];return e.jsxs("div",{className:"immersive-analysis-container twinforge visionos-26 space-y-8 -mt-2",style:{"--analysis-color":w},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(j,{initial:f,animate:_,transition:s.enableFramerMotion?{duration:.7,ease:v}:void 0,children:e.jsxs(U,{className:"glass-card analysis-photo-card analysis-photo-card--front p-4 relative overflow-hidden rounded-2xl border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center breathing-icon",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, var(--color-plasma-cyan) 35%, transparent), color-mix(in srgb, var(--color-plasma-cyan) 25%, transparent))
                    `,border:"3px solid color-mix(in srgb, var(--color-plasma-cyan) 70%, transparent)",boxShadow:`
                      0 0 40px color-mix(in srgb, var(--color-plasma-cyan) 60%, transparent),
                      0 0 80px color-mix(in srgb, var(--color-plasma-cyan) 40%, transparent),
                      0 0 120px color-mix(in srgb, var(--brand-primary) 30%, transparent),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -2px 0 rgba(0,0,0,0.2)
                    `,backdropFilter:"blur(20px) saturate(170%)",WebkitBackdropFilter:"blur(20px) saturate(170%)","--icon-color":"var(--color-plasma-cyan)"},children:e.jsx(A,{Icon:C.User,size:16,style:{color:"var(--color-plasma-cyan)"},variant:"pure"})}),"Photo de Face"]}),e.jsxs("div",{className:"analysis-status-badge",children:[e.jsx("div",{className:"w-2 h-2 rounded-full status-dot"}),e.jsx("span",{className:"text-xs font-medium",children:"Analyse IA"})]})]}),e.jsxs("figure",{className:"relative aspect-[3/4] rounded-xl overflow-hidden bg-black/20",role:"group","aria-label":"Analyse de la photo de face",children:[e.jsx("img",{src:r.url,alt:"Photo de face en cours d‚Äôanalyse",className:"w-full h-full object-contain analysis-photo",loading:"eager",decoding:"async",fetchpriority:"high"}),o&&s.enableScanLineOverlays&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"scan-line-vertical","aria-hidden":"true"}),e.jsx("div",{className:"analysis-grid","aria-hidden":"true",children:Array.from({length:16}).map((d,b)=>e.jsx("div",{className:"grid-cell",style:{"--cell-index":b},"aria-hidden":"true"},b))}),e.jsx("div",{className:"body-keypoints body-keypoints--front","aria-hidden":"true",children:p.map((d,b)=>e.jsx("div",{className:"keypoint",style:{left:`${d.x}%`,top:`${d.y}%`,"--keypoint-index":b}},d.label))}),h.map(d=>e.jsx("div",{className:"analysis-zone",style:{left:`${d.x}%`,top:`${d.y}%`,"--zone-intensity":d.intensity},"aria-hidden":"true"},d.id)),e.jsx("div",{className:"ai-focus-overlay ai-focus-overlay--front","aria-hidden":"true"})]}),e.jsx("figcaption",{className:"sr-only",children:"Rep√©rage des articulations et analyse de surface"})]})]})}),e.jsx(j,{initial:f,animate:_,transition:s.enableFramerMotion?{duration:.7,delay:.15,ease:v}:void 0,children:e.jsxs(U,{className:"glass-card analysis-photo-card analysis-photo-card--profile p-4 relative overflow-hidden rounded-2xl border-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-white font-semibold flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center breathing-icon",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                      linear-gradient(135deg, color-mix(in srgb, #A855F7 35%, transparent), color-mix(in srgb, #A855F7 25%, transparent))
                    `,border:"3px solid color-mix(in srgb, #A855F7 70%, transparent)",boxShadow:`
                      0 0 40px color-mix(in srgb, #A855F7 60%, transparent),
                      0 0 80px color-mix(in srgb, #A855F7 40%, transparent),
                      0 0 120px color-mix(in srgb, var(--brand-primary) 30%, transparent),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -2px 0 rgba(0,0,0,0.2)
                    `,backdropFilter:"blur(20px) saturate(170%)",WebkitBackdropFilter:"blur(20px) saturate(170%)","--icon-color":"#A855F7"},children:e.jsx(A,{Icon:C.RotateCcw,size:16,style:{color:"#A855F7"},variant:"pure"})}),"Photo de Profil"]}),e.jsxs("div",{className:"analysis-status-badge",children:[e.jsx("div",{className:"w-2 h-2 rounded-full status-dot"}),e.jsx("span",{className:"text-xs font-medium",children:"Analyse IA"})]})]}),e.jsxs("figure",{className:"relative aspect-[3/4] rounded-xl overflow-hidden bg-black/20",role:"group","aria-label":"Analyse de la photo de profil",children:[e.jsx("img",{src:l.url,alt:"Photo de profil en cours d‚Äôanalyse",className:"w-full h-full object-contain analysis-photo",loading:s.imageLoadingStrategy,decoding:"async"}),o&&s.enableScanLineOverlays&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"scan-line-horizontal","aria-hidden":"true"}),e.jsx("div",{className:"analysis-grid","aria-hidden":"true",children:Array.from({length:16}).map((d,b)=>e.jsx("div",{className:"grid-cell",style:{"--cell-index":b},"aria-hidden":"true"},b))}),e.jsx("div",{className:"body-keypoints body-keypoints--profile","aria-hidden":"true",children:m.map((d,b)=>e.jsx("div",{className:"keypoint",style:{left:`${d.x}%`,top:`${d.y}%`,"--keypoint-index":b}},d.label))}),h.map(d=>e.jsx("div",{className:"analysis-zone",style:{left:`${d.x}%`,top:`${d.y}%`,"--zone-intensity":d.intensity},"aria-hidden":"true"},d.id)),e.jsx("div",{className:"ai-focus-overlay ai-focus-overlay--profile","aria-hidden":"true"})]}),e.jsx("figcaption",{className:"sr-only",children:"Analyse lat√©rale et maillage de contr√¥le"})]})]})})]}),e.jsx(ve,{modules:I,progress:i,themeColor:"#8B5CF6",reduceMotion:!o,className:"mt-8"}),o&&s.enableDataParticles&&e.jsx("div",{className:"data-flow-container","aria-hidden":"true",children:u.map((d,b)=>e.jsx("div",{className:"data-particle",style:{left:`${d.x}%`,top:`${d.y}%`,"--particle-index":b,"--data-particle-speed":`${d.speed}s`,"--particle-dx":`${d.dx}%`,"--particle-dy":`${d.dy}px`,"--data-particle-size":`${d.size}px`,animationDelay:`${d.delay}s`}},d.id))})]})},oa=()=>{const a=ue(),{startProgress:i,progress:n,message:t,subMessage:s,isActive:o,steps:r,currentStep:l}=J(),p=H(),m=x.useRef(null),h=x.useRef(!1),{currentStep:g,capturedPhotos:u,setCapturedPhotos:f,scanResults:_,showValidationResults:v,validationSummary:w,userId:I,isProfileComplete:d,setCurrentStep:b,onProceedToProcessing:E,isProcessing:B}=qe({scanId:m.current??void 0});re.useEffect(()=>{window.scrollTo({top:0,behavior:"instant"});const F=document.getElementById("main-content");F&&F.scrollTo({top:0,behavior:"instant"})},[g]);const q=[{id:"capture",title:"Capture Photographique",subtitle:"Face et profil",icon:"Camera",color:"#8B5CF6"},{id:"processing",title:"Analyse IA Avanc√©e",subtitle:"Traitement en cours",icon:"Scan",color:"#8B5CF6"},{id:"celebration",title:"Donn√©es Trait√©es",subtitle:"Pr√©paration du rendu 3D",icon:"Check",color:"#8B5CF6"},{id:"avatar",title:"Avatar 3D",subtitle:"Votre reflet num√©rique",icon:"Eye",color:"#8B5CF6"}];x.useEffect(()=>{if(h.current)return;h.current=!0,m.current||(m.current=ye());const F=m.current,{resetProgress:R}=J.getState();R(),i(q,F,"body"),c.info("BODY_SCAN_CAPTURE","Component initialized with scanId",{clientScanId:F,flowType:"body",isDevelopment:!1,timestamp:new Date().toISOString()})},[i]);const S=re.useCallback(async(F,R,D)=>{try{const $=URL.createObjectURL(F);f(G=>{const N=[...G.filter(L=>L.type!==R),{file:F,url:$,type:R,validationResult:{isValid:D.validation?.isValid??!1,issues:D.validation?.issues??[],retakeReasons:D.validation?.retakeReasons??[],confidence:D.validation?.confidence??0},captureReport:D}];return c.info("BODY_SCAN_CAPTURE","Photo captured successfully",{clientScanId:m.current,photoType:R,totalPhotos:N.length,isValid:N.find(L=>L.type===R)?.validationResult?.isValid}),N}),R==="front"&&b("profile-photo")}catch($){c.error("BODY_SCAN_CAPTURE","Photo capture error",{error:$,clientScanId:m.current,photoType:R})}},[f,b]),M=F=>{f(R=>R.filter(D=>D.type!==F)),b(F==="front"?"front-photo":"profile-photo"),c.info("BODY_SCAN_CAPTURE","Photo retake requested",{clientScanId:m.current,photoType:F})};if(I===null)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(oe,{icon:"Shield",title:"Authentification requise",subtitle:"Connectez-vous pour acc√©der au scanner corporel",circuit:"body-scan"}),e.jsxs(U,{className:"text-center p-8",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-blue-500/20 flex items-center justify-center",children:e.jsx(A,{Icon:C.Shield,size:24,className:"text-red-400"})}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Authentification requise"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Vous devez √™tre connect√© avec un compte valide pour utiliser le scanner corporel"})]})]});if(!d)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(oe,{icon:"User",title:"Profil incomplet",subtitle:"Compl√©tez votre profil pour acc√©der au scanner corporel",circuit:"body-scan"}),e.jsxs(U,{className:"text-center p-8",children:[e.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-yellow-500/20 flex items-center justify-center",children:e.jsx(A,{Icon:C.User,size:24,className:"text-yellow-400"})}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"Profil incomplet"}),e.jsx("p",{className:"text-white/60 text-sm mb-4",children:"Veuillez renseigner votre sexe, taille et poids dans votre profil"}),e.jsx("button",{onClick:()=>a("/profile#identity"),className:"btn-glass--primary px-6 py-3 rounded-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{Icon:C.User,size:16}),e.jsx("span",{children:"Compl√©ter mon profil"})]})})]})]});const k=()=>v&&w?"validation":g==="processing"?"processing-stable":g,y=(F,R,D)=>{if(v&&w)return e.jsx(ae,{fallback:e.jsx(te,{}),children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h3",{className:"text-white font-semibold mb-4",children:"Validation en cours..."}),e.jsx("p",{className:"text-white/60",children:"Les r√©sultats de validation seront bient√¥t disponibles."})]})});switch(g){case"front-photo":case"profile-photo":return e.jsx(na,{step:g,capturedPhotos:u,onPhotoCapture:S,onRetake:$=>{M($),$==="profile"&&f(G=>G.filter(T=>T.type==="front"))},onBack:()=>{g==="profile-photo"?(b("front-photo"),f($=>$.filter(G=>G.type==="front"))):a("/")},onProceedToProcessing:E,isProcessingInProgress:B,isProgressInitialized:o});case"processing":return e.jsx(ae,{fallback:e.jsx(te,{}),children:e.jsx(ra,{capturedPhotos:u,currentProgress:F,currentMessage:R,currentSubMessage:D})});case"results":return e.jsx(ae,{fallback:e.jsx(te,{}),children:e.jsxs(U,{className:"text-center p-8",children:[e.jsx(A,{Icon:C.Check,size:48,className:"text-green-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Scan termin√© !"}),e.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Votre avatar 3D a √©t√© g√©n√©r√© avec succ√®s"}),e.jsx("button",{onClick:()=>a("/body-scan/review",{state:{scanResults:_}}),className:"btn-glass--primary px-6 py-3 rounded-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{Icon:C.Eye,size:16}),e.jsx("span",{children:"Voir mon avatar"})]})})]})});default:return e.jsxs(U,{className:"text-center p-8",children:[e.jsx(A,{Icon:C.AlertCircle,size:48,className:"text-red-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-white font-semibold mb-2",children:"√âtape inconnue"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Une erreur est survenue dans le flux de scan"})]})}},P=()=>{switch(g){case"front-photo":case"profile-photo":return"capture";case"processing":return"processing";case"results":return"celebration";default:return"capture"}},ee=o&&r.length>0&&g!=="results";return e.jsxs("div",{className:"space-y-6",children:[ee&&e.jsx(Ae,{steps:r,currentStepId:P(),progress:n,message:t,subMessage:s}),e.jsx(he,{mode:"wait",children:e.jsx(j,{initial:p.enableInitialAnimations?{opacity:0,y:20}:!1,animate:p.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},exit:p.enableExitAnimations?{opacity:0,y:-20}:void 0,transition:p.enableFramerMotion?{duration:.3}:void 0,children:y(n,t,s)},k())})]})},la=()=>e.jsx(oa,{}),Aa=()=>e.jsx("div",{className:"max-w-4xl mx-auto mt-4",children:e.jsx(la,{})});export{Aa as default};
