const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ScanExitConfirmationModal-BZoIYo53.js","assets/page-fridge-C1QVLxk9.js","assets/vendor-ZbFMzY-i.js","assets/utils-CUtLAp28.js","assets/supabase-8_3juhcZ.js","assets/stores-ZZM8MTtI.js","assets/ui-components-OHztaiDj.js","assets/motion-HGAT--uT.js","assets/page-fridge-scan-C_CisW7P.js","assets/page-fridge-scan-DAz6gEg3.css","assets/ui-components-DyoLTZgZ.css","assets/date-utils-BlBdbPk_.js","assets/signedUrlService-DzLcvpbH.js"])))=>i.map(i=>d[i]);
import{j as e,R as P,r as _,c$ as pe,u as ge,e as xe,cX as me}from"./vendor-ZbFMzY-i.js";import{a as Q,u as Z,l as d,_ as be}from"./page-fridge-C1QVLxk9.js";import{n as oe}from"./utils-CUtLAp28.js";import{a as J}from"./stores-ZZM8MTtI.js";import{G as D,S as m,I as u,t as le,u as he,o as ne,s as fe}from"./ui-components-OHztaiDj.js";import"./page-fridge-scan-C_CisW7P.js";import{S as ye,u as je,m as ve}from"./ScanExitConfirmationModal-BZoIYo53.js";import{m as f,u as q,A as se}from"./motion-HGAT--uT.js";import"./supabase-8_3juhcZ.js";import"./date-utils-BlBdbPk_.js";import"./signedUrlService-DzLcvpbH.js";const Ne="_wrap_1ie0e_12",we="_card_1ie0e_19",_e="_grid_1ie0e_33",Ce="_icon_1ie0e_43",ke="_iconHalo_1ie0e_62",Se="_iconGlyph_1ie0e_68",Ie="_center_1ie0e_74",Ee="_title_1ie0e_80",Pe="_subtitle_1ie0e_91",Ae="_rail_1ie0e_101",Me="_seg_1ie0e_106",Be="_segGreen_1ie0e_110",Fe="_segCyan_1ie0e_111",De="_isCurrent_1ie0e_113",Re="_isComplete_1ie0e_114",Oe="_fill_1ie0e_116",Le="_fillGreen_1ie0e_120",ze="_fillCyan_1ie0e_125",$e="_step_1ie0e_132",Te="_percent_1ie0e_139",B={wrap:Ne,card:we,grid:_e,icon:Ce,iconHalo:ke,iconGlyph:Se,center:Ie,title:Ee,subtitle:Pe,rail:Ae,seg:Me,segGreen:Be,segCyan:Fe,isCurrent:De,isComplete:Re,fill:Oe,fillGreen:Le,fillCyan:ze,step:$e,percent:Te},ee=[{id:"capture",title:"Capture"},{id:"processing",title:"Analyse"},{id:"results",title:"Résultats"}],Ue={capture:"Camera",processing:"Scan",results:"Check"};function Y({currentStep:a,progress:s,message:t,subMessage:i}){const{isPerformanceMode:n}=Q(),o=n?"span":f.span,l=Number.isFinite(s)?Math.min(100,Math.max(0,s)):0,g=100/ee.length,p=Math.max(0,ee.findIndex(w=>w.id===a)),b=p*g,j=Math.max(0,Math.min(1,(l-b)/g)),r=Ue[a]??"Camera";return e.jsx("div",{className:B.wrap,children:e.jsx(D,{className:B.card,children:e.jsxs("div",{className:B.grid,"data-dph":!0,children:[e.jsxs("div",{className:B.icon,children:[e.jsx("div",{className:B.iconHalo}),e.jsx(m,{Icon:u[r],size:26,className:B.iconGlyph})]}),e.jsxs("div",{className:B.center,children:[e.jsx("h2",{className:B.title,children:t||"Capture Nutritionnelle"}),i&&e.jsx("p",{className:B.subtitle,children:i}),e.jsx("div",{className:B.rail,role:"progressbar","aria-valuenow":Math.round(l),"aria-valuemin":0,"aria-valuemax":100,children:ee.map((w,I)=>{const N=I<p,A=I===p,U=N?"100%":A?`${j*100}%`:"0%",R=I===0?B.segGreen:B.segCyan,W=I===0?B.fillGreen:B.fillCyan;return e.jsx("div",{className:`${B.seg} ${R} ${N?B.isComplete:""} ${A?B.isCurrent:""}`,children:(N||A)&&e.jsx(o,{className:`${B.fill} ${W}`,...!n&&{initial:{width:0},animate:{width:U},transition:{duration:.45,ease:"easeOut"}},style:n?{width:U}:void 0})},w.id)})}),e.jsxs("div",{className:B.step,children:["Étape ",p+1," sur ",ee.length]})]}),e.jsxs("div",{className:B.percent,"aria-hidden":"true",children:[Math.round(l),"%"]})]})})})}const We=({isValidating:a,onCameraClick:s,onGalleryClick:t,onBarcodeClick:i,onBarcodeImageUpload:n})=>{const[o,l]=P.useState(!1);return P.useEffect(()=>{console.log("CaptureGuide mounted, isValidating:",a),console.log("CaptureGuide handlers:",{onCameraClick:s,onGalleryClick:t,onBarcodeClick:i});const g=p=>{console.log("🖱️ GLOBAL CLICK DETECTED:",{target:p.target,currentTarget:p.currentTarget,clientX:p.clientX,clientY:p.clientY,tagName:p.target?.tagName,className:p.target?.className})};return document.addEventListener("click",g,!0),()=>{document.removeEventListener("click",g,!0)}},[]),P.useEffect(()=>{console.log("isValidating changed:",a)},[a]),console.log("🎨 CaptureGuide RENDER",{isValidating:a}),e.jsxs(D,{interactive:!1,className:"p-6 relative glass-card--capture meal-capture-enter",style:{position:"relative",zIndex:10,background:`
          radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 60%),
          radial-gradient(circle at 70% 80%, rgba(34, 197, 94, 0.06) 0%, transparent 50%),
          var(--glass-opacity)
        `,borderColor:"rgba(16, 185, 129, 0.25)",boxShadow:`
          0 12px 40px rgba(0, 0, 0, 0.25),
          0 0 30px rgba(16, 185, 129, 0.12),
          inset 0 2px 0 rgba(255, 255, 255, 0.15)
        `},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center",background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                linear-gradient(135deg, rgba(16, 185, 129, 0.45), rgba(5, 150, 105, 0.35))
              `,border:"2px solid rgba(16, 185, 129, 0.6)",boxShadow:`
                0 0 20px rgba(16, 185, 129, 0.6),
                0 0 40px rgba(16, 185, 129, 0.3),
                inset 0 2px 0 rgba(255,255,255,0.35),
                inset 0 -2px 0 rgba(0,0,0,0.2)
              `},children:e.jsx(m,{Icon:u.Camera,size:18,style:{color:"#fff",filter:"drop-shadow(0 2px 8px rgba(16, 185, 129, 0.9)) drop-shadow(0 0 4px rgba(255,255,255,0.5))"}})}),e.jsx("h4",{className:"text-white font-bold text-base",style:{textShadow:"0 2px 8px rgba(16, 185, 129, 0.4), 0 0 4px rgba(0,0,0,0.3)"},children:"Photo de votre repas"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5",style:{background:`
              linear-gradient(135deg,
                rgba(59, 130, 246, 0.2),
                rgba(37, 99, 235, 0.15)
              )
            `,border:"2px solid rgba(59, 130, 246, 0.4)",borderRadius:"16px",backdropFilter:"blur(12px) saturate(130%)",boxShadow:`
              0 4px 16px rgba(59, 130, 246, 0.25),
              0 0 24px rgba(59, 130, 246, 0.15),
              inset 0 1px 0 rgba(255,255,255,0.2)
            `},children:[e.jsx(f.div,{className:"w-2 h-2 rounded-full",style:{backgroundColor:"#3B82F6",boxShadow:"0 0 10px #3B82F6"},animate:{scale:[1,1.3,1],opacity:[.7,1,.7]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("span",{className:"text-xs font-semibold",style:{color:"#fff",textShadow:"0 1px 4px rgba(0,0,0,0.3)"},children:"En attente"})]})]}),e.jsxs("div",{className:"space-y-6",style:{position:"relative",zIndex:1},children:[e.jsx("div",{className:"relative aspect-[4/3] rounded-xl overflow-visible meal-capture-guide",style:{background:`
              radial-gradient(circle at 40% 30%, rgba(16, 185, 129, 0.12) 0%, transparent 60%),
              radial-gradient(circle at 60% 70%, rgba(34, 197, 94, 0.08) 0%, transparent 50%),
              linear-gradient(135deg, rgba(16, 185, 129, 0.06), rgba(34, 197, 94, 0.04))
            `,border:"2px dashed rgba(16, 185, 129, 0.3)",backdropFilter:"blur(8px) saturate(120%)"},children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{pointerEvents:"none !important"},children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto rounded-full flex items-center justify-center relative",style:{background:`
                    radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15) 0%, transparent 60%),
                    linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(34, 197, 94, 0.3))
                  `,border:"2px solid rgba(16, 185, 129, 0.4)",boxShadow:"0 0 30px rgba(16, 185, 129, 0.3)"},children:[e.jsx(m,{Icon:u.Camera,size:48,className:"text-green-400 icon-pulse-css",style:{filter:"drop-shadow(0 2px 8px rgba(16, 185, 129, 0.4))"}}),[...Array(3)].map((g,p)=>e.jsx("div",{className:`absolute w-2 h-2 rounded-full bg-green-400 particle-css particle-css--${p+1}`,style:{left:`${20+p*20}%`,top:`${20+p%2*60}%`,boxShadow:"0 0 8px rgba(16, 185, 129, 0.6)","--particle-color":"#10B981"}},p))]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-white font-semibold mb-2 text-base md:text-lg",children:"Forgez Votre Nutrition"}),e.jsx("p",{className:"text-green-200 text-xs md:text-sm leading-relaxed max-w-full sm:max-w-xs mx-auto px-2 sm:px-0",children:"Capturez votre repas pour une analyse complète des nutriments et calories"})]})]})})}),e.jsx("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),console.log("CaptureGuide: Camera button onClick fired",g),console.log("isValidating:",a),console.log("Calling onCameraClick..."),s()},onMouseDown:g=>{console.log("Camera button mouseDown")},onTouchStart:g=>{console.log("Camera button touchStart")},className:"w-full btn-glass--primary touch-feedback-css",disabled:a,type:"button",style:{"--scan-primary":"#10B981",background:`
              linear-gradient(135deg, 
                rgba(16, 185, 129, 0.8), 
                rgba(34, 197, 94, 0.6)
              )
            `,backdropFilter:"blur(20px) saturate(160%)",boxShadow:`
              0 12px 40px rgba(16, 185, 129, 0.4),
              0 0 60px rgba(16, 185, 129, 0.3),
              inset 0 3px 0 rgba(255,255,255,0.3),
              inset 0 -3px 0 rgba(0,0,0,0.2)
            `,border:"2px solid rgba(16, 185, 129, 0.6)"},children:e.jsxs("div",{className:"relative flex items-center justify-center gap-3",children:[e.jsx("div",{className:a?"icon-spin-css":"",children:e.jsx(m,{Icon:a?u.Loader2:u.Camera,size:24,className:"text-white",style:{filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.3))"}})}),e.jsx("span",{className:"font-bold text-lg",children:a?"Validation...":"Appareil photo"})]})}),e.jsx("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),console.log("CaptureGuide: Gallery button onClick fired",g),console.log("isValidating:",a),console.log("Calling onGalleryClick..."),t()},onMouseDown:g=>{console.log("Gallery button mouseDown")},onTouchStart:g=>{console.log("Gallery button touchStart")},className:"w-full btn-glass btn-glass--secondary-nav touch-feedback-css",disabled:a,type:"button",style:{background:"rgba(16, 185, 129, 0.08)",borderColor:"rgba(16, 185, 129, 0.25)",backdropFilter:"blur(12px) saturate(130%)",boxShadow:`
              0 4px 16px rgba(0, 0, 0, 0.15),
              0 0 20px rgba(16, 185, 129, 0.1),
              inset 0 1px 0 rgba(255, 255, 255, 0.15)
            `},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Image,size:18}),e.jsx("span",{className:"font-medium",children:"Galerie"})]})})]})]})},Ve=({capturedPhoto:a,showSuccessAnimation:s,onRetake:t})=>{const i=q(),{glassClick:n}=Z();return e.jsxs(D,{className:"p-6 relative overflow-visible glass-card--capture",style:{background:`
          radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 60%),
          radial-gradient(circle at 70% 80%, rgba(34, 197, 94, 0.06) 0%, transparent 50%),
          var(--glass-opacity)
        `,borderColor:"rgba(16, 185, 129, 0.25)",boxShadow:`
          0 12px 40px rgba(0, 0, 0, 0.25),
          0 0 30px rgba(16, 185, 129, 0.12),
          inset 0 2px 0 rgba(255, 255, 255, 0.15)
        `},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center",background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                linear-gradient(135deg, rgba(16, 185, 129, 0.45), rgba(5, 150, 105, 0.35))
              `,border:"2px solid rgba(16, 185, 129, 0.6)",boxShadow:`
                0 0 20px rgba(16, 185, 129, 0.6),
                0 0 40px rgba(16, 185, 129, 0.3),
                inset 0 2px 0 rgba(255,255,255,0.35),
                inset 0 -2px 0 rgba(0,0,0,0.2)
              `},children:e.jsx(m,{Icon:u.Camera,size:18,style:{color:"#fff",filter:"drop-shadow(0 2px 8px rgba(16, 185, 129, 0.9)) drop-shadow(0 0 4px rgba(255,255,255,0.5))"}})}),e.jsx("h4",{className:"text-white font-bold text-base",style:{textShadow:"0 2px 8px rgba(16, 185, 129, 0.4), 0 0 4px rgba(0,0,0,0.3)"},children:"Photo de votre repas"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5",style:{background:`
              linear-gradient(135deg,
                rgba(16, 185, 129, 0.25),
                rgba(5, 150, 105, 0.2)
              )
            `,border:"2px solid rgba(16, 185, 129, 0.5)",borderRadius:"16px",backdropFilter:"blur(12px) saturate(130%)",boxShadow:`
              0 4px 16px rgba(16, 185, 129, 0.3),
              0 0 24px rgba(16, 185, 129, 0.2),
              inset 0 1px 0 rgba(255,255,255,0.25)
            `},children:[e.jsx(f.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:i?"tween":"spring",stiffness:260,damping:20,duration:i?.1:void 0},style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(m,{Icon:u.Check,size:14,style:{color:"#fff",filter:"drop-shadow(0 0 6px rgba(16, 185, 129, 0.8))"}})}),e.jsx("span",{className:"text-xs font-semibold",style:{color:"#fff",textShadow:"0 1px 4px rgba(0,0,0,0.3)"},children:"Capturée"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative aspect-[4/3] rounded-xl overflow-hidden glass-card--capture-preview",children:[e.jsx(f.img,{src:a.url,alt:"Photo du repas",className:"w-full h-full object-cover bg-black/20 border border-green-400/20",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:i?.1:.6,ease:"easeOut"}}),e.jsx(se,{children:s&&e.jsx(f.div,{className:"absolute inset-0 flex items-center justify-center backdrop-blur-md rounded-xl success-overlay",style:{background:`
                    radial-gradient(circle at center, rgba(16, 185, 129, 0.3) 0%, rgba(16, 185, 129, 0.1) 70%),
                    linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(34, 197, 94, 0.3))
                  `,border:"2px solid rgba(16, 185, 129, 0.6)",backdropFilter:"blur(16px) saturate(140%)"},initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.1},transition:{duration:i?.1:.6,ease:"easeOut"},children:e.jsx(f.div,{className:"w-24 h-24 rounded-full flex items-center justify-center backdrop-blur-sm success-icon-container",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                      linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(34, 197, 94, 0.6))
                    `,border:"3px solid rgba(16, 185, 129, 0.8)",boxShadow:`
                      0 0 60px rgba(16, 185, 129, 0.8),
                      0 0 120px rgba(16, 185, 129, 0.4),
                      inset 0 3px 0 rgba(255,255,255,0.4),
                      inset 0 -3px 0 rgba(0,0,0,0.2)
                    `},initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:i?"tween":"spring",stiffness:300,damping:20,delay:i?0:.2,duration:i?.1:void 0},children:e.jsx(m,{Icon:u.Check,size:36,className:"text-white success-icon-glow",style:{filter:"drop-shadow(0 0 8px rgba(255,255,255,0.8))"}})})})})]}),e.jsx(f.button,{onClick:()=>{n(),t()},className:"w-full btn-glass btn-glass--secondary-nav",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.RotateCcw,size:14}),e.jsx("span",{children:"Reprendre"})]})})]})]})},Ge=({onProceedToProcessing:a,isProcessingInProgress:s,hasPhoto:t,hasScannedBarcodes:i,hasScannedProducts:n,scannedBarcodesCount:o,scannedProductsCount:l})=>{const{success:g}=Z(),b=(()=>{const j=o+l;return t&&(i||n)?{title:"Photo et codes-barres détectés !",subtitle:`Votre photo${i?` et ${o} code${o>1?"s-barres":"-barre"}`:""}${n?` et ${l} produit${l>1?"s":""}`:""} sont prêts pour l'analyse complète.`}:i&&n?{title:`${j} élément${j>1?"s":""} détecté${j>1?"s":""} !`,subtitle:`${o} code${o>1?"s-barres":"-barre"} et ${l} produit${l>1?"s":""} prêts pour l'analyse.`}:i?{title:`${o} code${o>1?"s-barres":"-barre"} détecté${o>1?"s":""} !`,subtitle:"Vos codes-barres sont prêts pour l'analyse nutritionnelle avancée."}:n?{title:`${l} produit${l>1?"s":""} scanné${l>1?"s":""} !`,subtitle:"Vos produits sont prêts pour l'analyse nutritionnelle."}:{title:"Photo capturée avec succès !",subtitle:"Votre carburant nutritionnel est prêt pour l'analyse TwinForge."}})();return e.jsx("div",{className:"meal-ready-processing meal-capture-enter",children:e.jsxs(D,{className:"p-6 text-center relative glass-card--ready-processing perf-critical",style:{background:`
            radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
            radial-gradient(circle at 75% 75%, rgba(34, 197, 94, 0.12) 0%, transparent 60%),
            radial-gradient(circle at 50% 50%, rgba(52, 211, 153, 0.08) 0%, transparent 70%),
            var(--glass-opacity)
          `,borderColor:"rgba(16, 185, 129, 0.4)",boxShadow:`
            0 16px 48px rgba(0, 0, 0, 0.3),
            0 0 40px rgba(16, 185, 129, 0.25),
            0 0 80px rgba(34, 197, 94, 0.15),
            inset 0 2px 0 rgba(255, 255, 255, 0.2)
          `},children:[e.jsx("div",{className:"absolute inset-0 rounded-inherit pointer-events-none",style:{background:"radial-gradient(circle at center, rgba(16, 185, 129, 0.08) 0%, transparent 70%)",filter:"blur(20px)",transform:"scale(1.2)",zIndex:-1,animation:"forge-nutritional-glow 3s ease-in-out infinite"}}),e.jsxs("div",{className:"relative z-10 space-y-4",children:[e.jsx("div",{className:"flex flex-col sm:flex-row items-center justify-center gap-4 mb-6",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full flex items-center justify-center",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(34, 197, 94, 0.4))
                `,border:"2px solid rgba(16, 185, 129, 0.6)",boxShadow:`
                  0 0 40px rgba(16, 185, 129, 0.5),
                  inset 0 2px 0 rgba(255, 255, 255, 0.3)
                `},children:e.jsx(m,{Icon:u.Check,size:28,className:"text-white",style:{filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.3))"}})}),e.jsx("h3",{className:"text-white text-xl font-bold text-center",children:b.title}),e.jsx("p",{className:"text-green-100 text-base leading-relaxed max-w-md mx-auto text-center",children:b.subtitle})]})}),e.jsx("button",{onClick:()=>{g(),a()},className:"w-full max-w-md mx-auto py-3 btn-breathing-css btn-touch-feedback touch-feedback-css",disabled:s,style:{"--scan-primary":"#10B981",position:"relative",overflow:"hidden",background:`
                linear-gradient(135deg, 
                  rgba(16, 185, 129, 0.9), 
                  rgba(34, 197, 94, 0.7),
                  rgba(52, 211, 153, 0.8)
                )
              `,backdropFilter:"blur(20px) saturate(160%)",boxShadow:`
                0 16px 48px rgba(16, 185, 129, 0.5),
                0 0 80px rgba(16, 185, 129, 0.4),
                0 0 120px rgba(34, 197, 94, 0.3),
                inset 0 3px 0 rgba(255,255,255,0.4),
                inset 0 -3px 0 rgba(0,0,0,0.2)
              `,borderRadius:"999px",border:"2px solid rgba(16, 185, 129, 0.8)"},children:e.jsxs("div",{className:"relative z-10 flex items-center justify-center gap-3",children:[e.jsx("div",{className:s?"icon-spin-css":"",children:e.jsx(m,{Icon:s?u.Loader2:u.Zap,size:20,className:"text-white",style:{filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})}),e.jsx("span",{className:"text-lg font-bold text-white",children:s?"Analyse en cours...":"Lancer l'analyse avancée"})]})})]})]})})},qe=({capturedPhoto:a,onBack:s})=>{const{click:t}=Z();return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f.button,{onClick:()=>{t(),s()},className:"btn-glass--secondary-nav touch-target",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.ArrowLeft,size:16}),e.jsx("span",{children:"Retour"})]})}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"text-white/60 text-sm",children:a?"✓ Photo capturée":"Étape 1 sur 3"})})]})},He=async a=>{try{const s=new Image,t=URL.createObjectURL(a);await new Promise((o,l)=>{s.onload=()=>o(),s.onerror=()=>l(new Error("Failed to load image")),s.src=t});const i=document.createElement("canvas");i.width=s.width,i.height=s.height;const n=i.getContext("2d");if(!n)return URL.revokeObjectURL(t),{success:!1,error:"Failed to get canvas context"};if(n.drawImage(s,0,0),URL.revokeObjectURL(t),"BarcodeDetector"in window)try{const l=await new window.BarcodeDetector({formats:["ean_13","ean_8","upc_a","upc_e","code_128","code_39"]}).detect(i);if(l.length>0)return{success:!0,barcode:l[0].rawValue,format:l[0].format}}catch(o){console.warn("BarcodeDetector failed, falling back to error:",o)}return{success:!1,error:"Aucun code-barre détecté dans l'image. La détection de code-barres sur image n'est pas supportée par votre navigateur."}}catch(s){return console.error("Error scanning barcode from image:",s),{success:!1,error:s instanceof Error?s.message:"Erreur lors du scan de l'image"}}},Xe=({onBarcodeDetected:a,onClose:s,mode:t,uploadedImage:i})=>{const[n,o]=_.useState(t==="camera"),[l,g]=_.useState(!1),[p,b]=_.useState(null),[j,r]=_.useState(null),[w,I]=_.useState(null),[N,A]=_.useState(null),[U,R]=_.useState(null),[W,M]=_.useState("loading");_.useEffect(()=>{t==="upload"&&i&&C(i)},[t,i]),_.useEffect(()=>()=>{N&&URL.revokeObjectURL(N)},[N]);const C=v=>{r(null),M("loading");const c=URL.createObjectURL(v);A(c),R(v),d.info("BARCODE_SCANNER","Image loaded for preview, starting auto-detection",{fileName:v.name,fileSize:v.size,timestamp:new Date().toISOString()}),M("ready"),V(v)},V=async v=>{g(!0),r(null),M("detecting"),d.info("BARCODE_SCANNER","Starting barcode detection",{fileName:v.name,timestamp:new Date().toISOString()});try{const c=await He(v);if(!c.success||!c.barcode){d.warn("BARCODE_SCANNER","No barcode found in image",{error:c.error,timestamp:new Date().toISOString()}),r(c.error||"Aucun code-barre détecté"),M("ready"),g(!1);return}O(c.barcode)}catch(c){d.error("BARCODE_SCANNER","Error detecting barcode",{error:c instanceof Error?c.message:String(c),timestamp:new Date().toISOString()}),r("Erreur lors de la détection du code-barre"),M("ready")}finally{g(!1)}},O=v=>{d.info("BARCODE_SCANNER","Barcode detected successfully",{barcode:v,timestamp:new Date().toISOString()});const c={barcode:v,image_url:N||void 0,scannedAt:new Date().toISOString(),portionMultiplier:1};a(c),I(`Code-barre ${v} détecté !`),M("complete"),setTimeout(()=>{I(null),o(!0),b(null),M("loading")},1500)},x=async v=>{if(!n||l||v.length===0)return;const c=v[0]?.rawValue;!c||c===p||(b(c),o(!1),O(c))},h=v=>{d.error("BARCODE_SCANNER","Camera error",{error:v?.message||String(v),timestamp:new Date().toISOString()}),r("Erreur d'accès à la caméra")};return e.jsx(f.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"relative z-40 mt-4",children:e.jsx("div",{className:"w-full",children:e.jsxs(D,{className:"p-6 relative overflow-hidden",style:{background:`
              radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 60%),
              radial-gradient(circle at 70% 80%, rgba(79, 70, 229, 0.08) 0%, transparent 50%),
              rgba(17, 24, 39, 0.95)
            `,borderColor:"rgba(99, 102, 241, 0.3)",boxShadow:`
              0 20px 60px rgba(0, 0, 0, 0.5),
              0 0 40px rgba(99, 102, 241, 0.2),
              inset 0 2px 0 rgba(255, 255, 255, 0.15)
            `},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center",background:`
                    radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                    linear-gradient(135deg, rgba(99, 102, 241, 0.45), rgba(79, 70, 229, 0.35))
                  `,border:"2px solid rgba(99, 102, 241, 0.6)",boxShadow:`
                    0 0 20px rgba(99, 102, 241, 0.6),
                    0 0 40px rgba(99, 102, 241, 0.3)
                  `},children:e.jsx(m,{Icon:u.Scan,size:18,style:{color:"#fff",filter:"drop-shadow(0 2px 8px rgba(99, 102, 241, 0.9))"}})}),e.jsx("h4",{className:"text-white font-bold text-base",children:"Scanner Code-Barre"})]}),e.jsx("button",{onClick:s,className:"w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-gray-700/50",style:{border:"1px solid rgba(156, 163, 175, 0.3)"},"aria-label":"Fermer",children:e.jsx(m,{Icon:u.X,size:16,className:"text-gray-400"})})]}),e.jsxs("div",{className:"relative aspect-square rounded-xl overflow-hidden mb-4",children:[t==="upload"&&N?e.jsx("img",{src:N,alt:"Uploaded barcode",className:"w-full h-full object-cover"}):n&&e.jsx(pe,{onScan:x,onError:h,formats:["ean_13","ean_8","upc_a","upc_e","code_128","code_39"],components:{audio:!1,finder:!0},styles:{container:{width:"100%",height:"100%"},video:{width:"100%",height:"100%",objectFit:"cover"}}}),e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"w-64 h-48 relative",style:{border:"3px solid rgba(99, 102, 241, 0.6)",borderRadius:"12px",boxShadow:"0 0 30px rgba(99, 102, 241, 0.4)"},children:[e.jsx("div",{className:"absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-indigo-400 rounded-tl-lg"}),e.jsx("div",{className:"absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-indigo-400 rounded-tr-lg"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-indigo-400 rounded-bl-lg"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-indigo-400 rounded-br-lg"}),n&&e.jsx(f.div,{className:"absolute inset-x-0 h-1 bg-gradient-to-r from-transparent via-indigo-400 to-transparent",style:{filter:"drop-shadow(0 0 8px rgba(99, 102, 241, 0.8))"},animate:{top:["10%","90%","10%"]},transition:{duration:2,repeat:1/0,ease:"linear"}})]})}),e.jsxs(se,{children:[l&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-indigo-400 border-t-transparent rounded-full mx-auto mb-3"}),e.jsx("p",{className:"text-white font-medium",children:"Détection du code-barre..."})]})}),w&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-green-500/20 backdrop-blur-sm flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/30 flex items-center justify-center mx-auto mb-3",children:e.jsx(m,{Icon:u.Check,size:32,className:"text-green-400"})}),e.jsx("p",{className:"text-white font-bold text-lg",children:w}),e.jsx("p",{className:"text-green-200 text-sm mt-2",children:`Cliquez sur "Lancer l'analyse" pour continuer`})]})}),j&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-red-500/20 backdrop-blur-sm flex items-center justify-center",children:e.jsxs("div",{className:"text-center px-6",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-red-500/30 flex items-center justify-center mx-auto mb-3",children:e.jsx(m,{Icon:u.AlertCircle,size:32,className:"text-red-400"})}),e.jsx("p",{className:"text-white font-bold text-lg mb-2",children:"Erreur"}),e.jsx("p",{className:"text-red-200 text-sm",children:j})]})})]})]})]}),e.jsx("div",{className:"text-center",children:t==="camera"&&e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-400 text-sm mb-2",children:"Positionnez le code-barre dans le cadre"}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Formats supportés : EAN-13, EAN-8, UPC-A, UPC-E, Code 128, Code 39"})]})})]})})})},Ke=({scanType:a,onSelectScanType:s})=>e.jsxs("div",{className:"flex gap-3 mb-6",children:[e.jsxs(f.button,{onClick:()=>s("photo-analysis"),className:"flex-1 p-4 rounded-xl transition-all touch-feedback-css relative overflow-hidden",style:{background:a==="photo-analysis"?`radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.3) 0%, transparent 60%),
                 radial-gradient(circle at 70% 80%, rgba(5, 150, 105, 0.2) 0%, transparent 50%),
                 linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.15))`:"linear-gradient(135deg, rgba(107, 114, 128, 0.08), rgba(75, 85, 99, 0.06))",borderWidth:"2px",borderStyle:"solid",borderColor:a==="photo-analysis"?"rgba(16, 185, 129, 0.6)":"rgba(107, 114, 128, 0.25)",boxShadow:a==="photo-analysis"?`0 8px 32px rgba(16, 185, 129, 0.25),
                 0 0 40px rgba(16, 185, 129, 0.15),
                 inset 0 2px 0 rgba(255, 255, 255, 0.15)`:"none"},whileTap:{scale:.97},children:[e.jsxs("div",{className:"flex flex-col items-center gap-2.5",children:[e.jsx("div",{style:{width:"44px",height:"44px",borderRadius:"12px",display:"flex",alignItems:"center",justifyContent:"center",background:a==="photo-analysis"?`radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                     linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(5, 150, 105, 0.3))`:"rgba(107, 114, 128, 0.15)",border:a==="photo-analysis"?"2px solid rgba(16, 185, 129, 0.5)":"1px solid rgba(107, 114, 128, 0.3)",boxShadow:a==="photo-analysis"?"0 0 20px rgba(16, 185, 129, 0.4)":"none"},children:e.jsx(m,{Icon:u.Camera,size:24,className:a==="photo-analysis"?"text-white":"text-gray-400",style:{filter:a==="photo-analysis"?"drop-shadow(0 2px 4px rgba(0,0,0,0.3))":"none"}})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:`font-bold text-sm block ${a==="photo-analysis"?"text-white":"text-gray-400"}`,style:{textShadow:a==="photo-analysis"?"0 1px 4px rgba(0,0,0,0.3)":"none"},children:"Scan Repas IA"}),a==="photo-analysis"&&e.jsx(f.span,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},className:"text-emerald-200 text-xs font-medium block",children:"Recommandé"})]})]}),a==="photo-analysis"&&e.jsx(f.div,{layoutId:"activeIndicator",className:"absolute inset-0 rounded-xl",style:{background:"rgba(16, 185, 129, 0.05)",pointerEvents:"none"},transition:{type:"spring",bounce:.2,duration:.6}})]}),e.jsxs(f.button,{onClick:()=>s("barcode-scan"),className:"flex-1 p-4 rounded-xl transition-all touch-feedback-css relative overflow-hidden",style:{background:a==="barcode-scan"?`radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.3) 0%, transparent 60%),
                 radial-gradient(circle at 70% 80%, rgba(79, 70, 229, 0.2) 0%, transparent 50%),
                 linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(79, 70, 229, 0.15))`:"linear-gradient(135deg, rgba(107, 114, 128, 0.08), rgba(75, 85, 99, 0.06))",borderWidth:"2px",borderStyle:"solid",borderColor:a==="barcode-scan"?"rgba(99, 102, 241, 0.6)":"rgba(107, 114, 128, 0.25)",boxShadow:a==="barcode-scan"?`0 8px 32px rgba(99, 102, 241, 0.25),
                 0 0 40px rgba(99, 102, 241, 0.15),
                 inset 0 2px 0 rgba(255, 255, 255, 0.15)`:"none"},whileTap:{scale:.97},children:[e.jsxs("div",{className:"flex flex-col items-center gap-2.5",children:[e.jsx("div",{style:{width:"44px",height:"44px",borderRadius:"12px",display:"flex",alignItems:"center",justifyContent:"center",background:a==="barcode-scan"?`radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                     linear-gradient(135deg, rgba(99, 102, 241, 0.4), rgba(79, 70, 229, 0.3))`:"rgba(107, 114, 128, 0.15)",border:a==="barcode-scan"?"2px solid rgba(99, 102, 241, 0.5)":"1px solid rgba(107, 114, 128, 0.3)",boxShadow:a==="barcode-scan"?"0 0 20px rgba(99, 102, 241, 0.4)":"none"},children:e.jsx(m,{Icon:u.ScanBarcode,size:24,className:a==="barcode-scan"?"text-white":"text-gray-400",style:{filter:a==="barcode-scan"?"drop-shadow(0 2px 4px rgba(0,0,0,0.3))":"none"}})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:`font-bold text-sm block ${a==="barcode-scan"?"text-white":"text-gray-400"}`,style:{textShadow:a==="barcode-scan"?"0 1px 4px rgba(0,0,0,0.3)":"none"},children:"Code-Barre"}),a==="barcode-scan"&&e.jsx(f.span,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},className:"text-indigo-200 text-xs font-medium block",children:"Rapide"})]})]}),a==="barcode-scan"&&e.jsx(f.div,{layoutId:"activeIndicator",className:"absolute inset-0 rounded-xl",style:{background:"rgba(99, 102, 241, 0.05)",pointerEvents:"none"},transition:{type:"spring",bounce:.2,duration:.6}})]})]}),Qe=({onBarcodeClick:a,onBarcodeImageUpload:s})=>e.jsx("div",{className:"mt-6",children:e.jsxs(D,{className:"p-6 rounded-3xl",style:{background:`
            radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 70% 80%, rgba(79, 70, 229, 0.1) 0%, transparent 50%),
            rgba(17, 24, 39, 0.95)
          `,borderColor:"rgba(99, 102, 241, 0.4)",borderWidth:"2px",backdropFilter:"blur(24px) saturate(180%)",WebkitBackdropFilter:"blur(24px) saturate(180%)",boxShadow:`
            0 20px 60px rgba(0, 0, 0, 0.3),
            0 0 40px rgba(99, 102, 241, 0.2),
            inset 0 2px 0 rgba(255, 255, 255, 0.15),
            inset 0 -2px 0 rgba(0, 0, 0, 0.1)
          `},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center",background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                  linear-gradient(135deg, rgba(99, 102, 241, 0.45), rgba(79, 70, 229, 0.35))
                `,border:"2px solid rgba(99, 102, 241, 0.6)",boxShadow:`
                  0 0 20px rgba(99, 102, 241, 0.6),
                  0 0 40px rgba(99, 102, 241, 0.3),
                  inset 0 2px 0 rgba(255,255,255,0.35),
                  inset 0 -2px 0 rgba(0,0,0,0.2)
                `},children:e.jsx(m,{Icon:u.ScanBarcode,size:18,style:{color:"#fff",filter:"drop-shadow(0 2px 8px rgba(99, 102, 241, 0.9)) drop-shadow(0 0 4px rgba(255,255,255,0.5))"}})}),e.jsx("h4",{className:"text-white font-bold text-base",style:{textShadow:"0 2px 8px rgba(99, 102, 241, 0.4), 0 0 4px rgba(0,0,0,0.3)"},children:"Scan Code-Barre"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5",style:{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.15))",border:"2px solid rgba(59, 130, 246, 0.4)",borderRadius:"16px",backdropFilter:"blur(12px) saturate(130%)",boxShadow:`
                0 4px 16px rgba(59, 130, 246, 0.25),
                0 0 24px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.2)
              `},children:[e.jsx(f.div,{className:"w-2 h-2 rounded-full",style:{backgroundColor:"#3B82F6",boxShadow:"0 0 10px #3B82F6"},animate:{scale:[1,1.3,1],opacity:[.7,1,.7]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("span",{className:"text-xs font-semibold",style:{color:"#fff",textShadow:"0 1px 4px rgba(0,0,0,0.3)"},children:"En attente"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative aspect-[4/3] rounded-2xl overflow-visible",style:{background:`
                radial-gradient(circle at 40% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 60% 70%, rgba(79, 70, 229, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(79, 70, 229, 0.08))
              `,border:"2px dashed rgba(99, 102, 241, 0.4)",backdropFilter:"blur(12px) saturate(130%)",WebkitBackdropFilter:"blur(12px) saturate(130%)"},children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"w-24 h-24 mx-auto rounded-full flex items-center justify-center relative",style:{background:`
                      radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15) 0%, transparent 60%),
                      linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(79, 70, 229, 0.35))
                    `,border:"2px solid rgba(99, 102, 241, 0.5)",boxShadow:"0 0 30px rgba(99, 102, 241, 0.4)"},children:e.jsx(m,{Icon:u.ScanBarcode,size:48,className:"text-indigo-400",style:{filter:"drop-shadow(0 2px 8px rgba(99, 102, 241, 0.5))"}})}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-white font-semibold mb-2 text-base md:text-lg",children:"Scan Rapide"}),e.jsx("p",{className:"text-indigo-200 text-xs md:text-sm leading-relaxed max-w-full sm:max-w-xs mx-auto px-2 sm:px-0",children:"Scannez le code-barre pour une analyse instantanée du produit"})]})]})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:a,className:"w-full btn-glass--primary touch-feedback-css",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(79, 70, 229, 0.6))",backdropFilter:"blur(20px) saturate(160%)",boxShadow:`
                  0 12px 40px rgba(99, 102, 241, 0.4),
                  0 0 60px rgba(99, 102, 241, 0.3),
                  inset 0 3px 0 rgba(255,255,255,0.3),
                  inset 0 -3px 0 rgba(0,0,0,0.2)
                `,border:"2px solid rgba(99, 102, 241, 0.6)",padding:"1rem"},children:e.jsxs("div",{className:"relative flex flex-col items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Camera,size:28,className:"text-white",style:{filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.3))"}}),e.jsx("span",{className:"font-bold text-base",children:"Scanner avec Caméra"})]})}),e.jsx("button",{onClick:s,className:"w-full btn-glass touch-feedback-css",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.12))",backdropFilter:"blur(20px) saturate(140%)",boxShadow:`
                  0 8px 32px rgba(99, 102, 241, 0.2),
                  0 0 40px rgba(99, 102, 241, 0.12),
                  inset 0 2px 0 rgba(255,255,255,0.12)
                `,border:"2px solid rgba(99, 102, 241, 0.35)",padding:"1rem"},children:e.jsxs("div",{className:"relative flex flex-col items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Image,size:24,className:"text-indigo-300",style:{filter:"drop-shadow(0 2px 8px rgba(99, 102, 241, 0.5))"}}),e.jsx("span",{className:"font-bold text-sm text-indigo-200",children:"Choisir depuis Galerie"})]})})]})]})]})}),Ze="https://world.openfoodfacts.org/api/v2",Ye="TwinForge/1.0 (Nutrition Tracking App; contact@twinforge.app)";async function Je(a,s={},t=8e3){const i=new AbortController,n=setTimeout(()=>i.abort(),t);try{const o=await fetch(a,{...s,signal:i.signal,headers:{"User-Agent":Ye,...s.headers}});return clearTimeout(n),o}catch(o){throw clearTimeout(n),o}}const K={async getProductByBarcode(a){d.info("OFF_SERVICE","Fetching product from OpenFoodFacts",{barcode:a,timestamp:new Date().toISOString()});try{const s=`${Ze}/product/${a}?fields=code,product_name,brands,quantity,image_url,image_small_url,nutriments,serving_size,nutrition_grades,nutriscore_grade,nova_group,categories,allergens,ingredients_text`,t=await Je(s,{},8e3);if(!t.ok)return d.warn("OFF_SERVICE","OpenFoodFacts API returned non-OK status",{barcode:a,status:t.status,statusText:t.statusText,timestamp:new Date().toISOString()}),{success:!1,error:`Produit non trouvé (HTTP ${t.status})`};const i=await t.json();if(i.status!==1||!i.product)return d.info("OFF_SERVICE","Product not found in OpenFoodFacts database",{barcode:a,status:i.status,status_verbose:i.status_verbose,timestamp:new Date().toISOString()}),{success:!1,error:"Produit non trouvé dans la base de données OpenFoodFacts"};const n=i.product;if(!n.product_name||!n.nutriments)return d.warn("OFF_SERVICE","Product found but missing essential data",{barcode:a,hasName:!!n.product_name,hasNutriments:!!n.nutriments,timestamp:new Date().toISOString()}),{success:!1,error:"Données nutritionnelles incomplètes"};const o=n.nutriments,l={success:!0,product:{barcode:n.code,name:n.product_name,brand:n.brands,image_url:n.image_url||n.image_small_url,portion_size:n.serving_size||n.quantity,nutrition_per_100g:{calories:o["energy-kcal_100g"]||0,proteins:o.proteins_100g||0,carbs:o.carbohydrates_100g||0,fats:o.fat_100g||0,fiber:o.fiber_100g,sugar:o.sugars_100g,sodium:o.sodium_100g},nutriscore:n.nutriscore_grade||n.nutrition_grades,nova_group:n.nova_group,categories:n.categories,allergens:n.allergens}};return(o["energy-kcal_serving"]||o.proteins_serving||o.carbohydrates_serving||o.fat_serving)&&(l.product.nutrition_per_serving={calories:o["energy-kcal_serving"]||0,proteins:o.proteins_serving||0,carbs:o.carbohydrates_serving||0,fats:o.fat_serving||0}),d.info("OFF_SERVICE","Product fetched successfully",{barcode:a,productName:n.product_name,brand:n.brands,hasNutritionPerServing:!!l.product?.nutrition_per_serving,nutriscore:l.product?.nutriscore,timestamp:new Date().toISOString()}),l}catch(s){return s instanceof Error&&s.name==="AbortError"?(d.error("OFF_SERVICE","Request timeout",{barcode:a,error:"Request timed out after 8 seconds",timestamp:new Date().toISOString()}),{success:!1,error:"Délai d'attente dépassé. Veuillez réessayer."}):(d.error("OFF_SERVICE","Error fetching product",{barcode:a,error:s instanceof Error?s.message:String(s),errorStack:s instanceof Error?s.stack:void 0,timestamp:new Date().toISOString()}),{success:!1,error:"Erreur de connexion à OpenFoodFacts"})}},convertToMealItem(a,s=1){if(!a)return null;const t=a.nutrition_per_serving&&s===1,i=t?a.nutrition_per_serving:a.nutrition_per_100g,n=i.calories*s,o=i.proteins*s,l=i.carbs*s,g=i.fats*s,p=t?a.portion_size||"1 portion":s===1?"100g":`${s*100}g`,b={name:a.brand?`${a.brand} ${a.name}`:a.name,confidence:1,calories:Math.round(n),proteins:Math.round(o*10)/10,carbs:Math.round(l*10)/10,fats:Math.round(g*10)/10,fiber:a.nutrition_per_100g.fiber?Math.round(a.nutrition_per_100g.fiber*s*10)/10:void 0,sugar:a.nutrition_per_100g.sugar?Math.round(a.nutrition_per_100g.sugar*s*10)/10:void 0,sodium:a.nutrition_per_100g.sodium?Math.round(a.nutrition_per_100g.sodium*s*1e3)/1e3:void 0,portion_size:p,category:"packaged_product"};return d.debug("OFF_SERVICE","Converted product to MealItem",{productName:a.name,portionMultiplier:s,useServing:t,mealItem:{name:b.name,calories:b.calories,portion_size:b.portion_size},timestamp:new Date().toISOString()}),b},getCommonPortionMultipliers(){return[{label:"¼ portion",value:.25},{label:"½ portion",value:.5},{label:"1 portion",value:1},{label:"1.5 portions",value:1.5},{label:"2 portions",value:2},{label:"3 portions",value:3}]}},ea=({product:a,onPortionChange:s,onRemove:t})=>{const i=K.getCommonPortionMultipliers();return e.jsx(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,x:-100},transition:{duration:.3},children:e.jsx(D,{className:"p-4 relative",style:{background:`
            radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 60%),
            radial-gradient(circle at 70% 80%, rgba(79, 70, 229, 0.06) 0%, transparent 50%),
            var(--glass-opacity)
          `,borderColor:"rgba(99, 102, 241, 0.25)",boxShadow:`
            0 8px 32px rgba(0, 0, 0, 0.2),
            0 0 20px rgba(99, 102, 241, 0.1),
            inset 0 2px 0 rgba(255, 255, 255, 0.15)
          `},children:e.jsxs("div",{className:"flex gap-4",children:[a.image_url&&e.jsx("div",{className:"w-20 h-20 rounded-lg overflow-hidden flex-shrink-0",style:{border:"2px solid rgba(99, 102, 241, 0.3)",background:"rgba(255, 255, 255, 0.05)"},children:e.jsx("img",{src:a.image_url,alt:a.name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("div",{className:"px-2 py-0.5 rounded-md flex items-center gap-1",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.15))",border:"1px solid rgba(99, 102, 241, 0.3)"},children:[e.jsx(m,{Icon:u.Scan,size:12,className:"text-indigo-300"}),e.jsx("span",{className:"text-xs font-semibold text-indigo-200",children:"Code-barre"})]})}),e.jsx("h4",{className:"text-white font-semibold text-sm mb-0.5 truncate",children:a.name}),a.brand&&e.jsx("p",{className:"text-gray-400 text-xs truncate",children:a.brand})]}),e.jsx("button",{onClick:()=>t(a.barcode),className:"flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-red-500/20",style:{border:"1px solid rgba(239, 68, 68, 0.3)"},"aria-label":"Retirer le produit",children:e.jsx(m,{Icon:u.X,size:16,className:"text-red-400"})})]}),e.jsxs("div",{className:"flex items-center gap-4 mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400 mb-0.5",children:"Calories"}),e.jsxs("p",{className:"text-white font-bold text-lg",children:[a.mealItem.calories,e.jsx("span",{className:"text-xs text-gray-400 ml-1",children:"kcal"})]})]}),e.jsxs("div",{className:"flex gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-400 mb-0.5",children:"P"}),e.jsxs("p",{className:"text-green-400 font-semibold",children:[a.mealItem.proteins,"g"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-400 mb-0.5",children:"G"}),e.jsxs("p",{className:"text-yellow-400 font-semibold",children:[a.mealItem.carbs,"g"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-400 mb-0.5",children:"L"}),e.jsxs("p",{className:"text-orange-400 font-semibold",children:[a.mealItem.fats,"g"]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-400 mb-1 block",children:"Portion"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:i.map(n=>e.jsx("button",{onClick:()=>s(a.barcode,n.value),className:`
                      px-3 py-1.5 rounded-lg text-xs font-medium transition-all
                      ${a.portionMultiplier===n.value?"bg-indigo-500/30 text-indigo-200 border-indigo-400":"bg-gray-800/50 text-gray-400 border-gray-700 hover:bg-gray-700/50"}
                    `,style:{border:"1px solid"},children:n.label},n.value))})]})]})]})})})},aa=({scannedBarcodes:a,scannedProducts:s,capturedPhoto:t,onBarcodeRemove:i,onProductPortionChange:n,onProductRemove:o,onCameraClick:l,onGalleryClick:g})=>e.jsxs(e.Fragment,{children:[a.length>0&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h3",{className:"text-white font-semibold text-base flex items-center gap-2",children:[e.jsx(m,{Icon:u.ScanBarcode,size:20,className:"text-indigo-400"}),e.jsx("span",{children:"Codes-barres détectés"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-300 text-xs font-bold",children:a.length})]})}),e.jsx("div",{className:"space-y-3",children:a.map((p,b)=>e.jsx(D,{className:"p-4",style:{background:"rgba(99, 102, 241, 0.08)",borderColor:"rgba(99, 102, 241, 0.3)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg flex items-center justify-center",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(79, 70, 229, 0.2))",border:"1px solid rgba(99, 102, 241, 0.4)"},children:e.jsx(m,{Icon:u.ScanBarcode,size:24,className:"text-indigo-300"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white font-semibold text-sm mb-1",children:p.barcode}),e.jsx("p",{className:"text-indigo-300 text-xs",children:"En attente d'analyse"})]})]}),e.jsx("button",{onClick:()=>i(p.barcode),className:"w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-red-500/20",style:{border:"1px solid rgba(239, 68, 68, 0.3)"},children:e.jsx(m,{Icon:u.X,size:16,className:"text-red-400"})})]})},`barcode-${p.barcode}-${b}-${p.scannedAt}`))}),!t&&a.length>0&&e.jsx("div",{className:"mt-4",children:e.jsxs(D,{className:"p-4 text-center",style:{background:"rgba(99, 102, 241, 0.05)",borderColor:"rgba(99, 102, 241, 0.2)"},children:[e.jsx("p",{className:"text-gray-300 text-sm mb-3",children:"Ajouter une photo pour enrichir votre analyse nutritionnelle"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:l,className:"flex-1 btn-glass touch-feedback-css",style:{background:"rgba(16, 185, 129, 0.08)",borderColor:"rgba(16, 185, 129, 0.25)"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Camera,size:16}),e.jsx("span",{className:"text-sm font-medium",children:"Appareil photo"})]})}),e.jsx("button",{onClick:g,className:"flex-1 btn-glass touch-feedback-css",style:{background:"rgba(16, 185, 129, 0.08)",borderColor:"rgba(16, 185, 129, 0.25)"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Image,size:16}),e.jsx("span",{className:"text-sm font-medium",children:"Galerie"})]})})]})]})})]}),s.length>0&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h3",{className:"text-white font-semibold text-base flex items-center gap-2",children:[e.jsx(m,{Icon:u.Check,size:20,className:"text-green-400"}),e.jsx("span",{children:"Produits analysés"}),e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs font-bold",children:s.length})]})}),e.jsx("div",{className:"space-y-3",children:s.map(p=>e.jsx(ea,{product:p,onPortionChange:n,onRemove:o},p.barcode))})]})]});function sa({onPhotoCapture:a,onBarcodeDetected:s}){const[t,i]=_.useState(!1),[n,o]=_.useState(!1),[l,g]=_.useState(!1),[p,b]=_.useState(null),j=_.useRef(null),r=_.useRef(null),w=_.useRef(null),I=_.useCallback(()=>{if(!j.current){console.error("fileInputRef.current is null or undefined");return}j.current.click()},[]),N=_.useCallback(()=>{if(!r.current){console.error("galleryInputRef.current is null or undefined");return}r.current.value="",r.current.click()},[]),A=_.useCallback(()=>{g(!0),b("camera")},[]),U=_.useCallback(()=>{w.current?.click()},[]),R=_.useCallback(()=>{g(!1)},[]),W=_.useCallback(V=>{s(V),g(!1)},[s]),M=_.useCallback(async V=>{const O=V.target.files?.[0];if(O){i(!0);try{await new Promise(h=>setTimeout(h,1e3));const x={validation:{isValid:!0,issues:[],confidence:.9},metadata:{fileSize:O.size,dimensions:{width:1920,height:1080},timestamp:new Date().toISOString()}};a(O,x),o(!0),setTimeout(()=>o(!1),2e3)}catch(x){console.error("Photo validation failed:",x)}finally{i(!1),j.current&&(j.current.value=""),r.current&&(r.current.value="")}}},[a]),C=_.useCallback(V=>{V.target.files?.[0]&&(g(!0),b("upload"))},[]);return{isValidating:t,showSuccessAnimation:n,showBarcodeScanner:l,barcodeScanMode:p,fileInputRef:j,galleryInputRef:r,barcodeImageInputRef:w,handlers:{handleCameraClick:I,handleGalleryClick:N,handleBarcodeClick:A,handleBarcodeImageUpload:U,handleBarcodeClose:R,handleBarcodeDetected:W,handleFileSelect:M,handleBarcodeImageSelect:C}}}const ta=[{id:"nutrition-tracking",icon:"TrendingUp",color:"#22C55E",title:"Suivi Nutritionnel",description:"Analysez vos apports en macronutriments et calories"},{id:"ai-detection",icon:"Zap",color:"#10B981",title:"Détection IA",description:"Identification automatique des aliments et portions"},{id:"personalized-insights",icon:"Target",color:"#059669",title:"Conseils Personnalisés",description:"Recommandations adaptées à vos objectifs"}],ra=[{id:"instant-analysis",icon:"Zap",color:"#6366F1",title:"Analyse Instantanée",description:"Récupération immédiate des données nutritionnelles"},{id:"accurate-data",icon:"Database",color:"#818CF8",title:"Données Précises",description:"Informations officielles des fabricants via OpenFoodFacts"},{id:"easy-tracking",icon:"Package",color:"#4F46E5",title:"Suivi Simplifié",description:"Idéal pour les produits emballés et transformés"}],na=a=>{const{scanType:s,onSelectScanType:t,capturedPhoto:i,scannedBarcodes:n,scannedProducts:o,onPhotoCapture:l,onBarcodeDetected:g,onProductPortionChange:p,onProductRemove:b,onBarcodeRemove:j,onRetake:r,onBack:w,onProceedToProcessing:I,isProcessingInProgress:N,readyForProcessingRef:A,progress:U,progressMessage:R,progressSubMessage:W}=a,{isValidating:M,showSuccessAnimation:C,showBarcodeScanner:V,barcodeScanMode:O,fileInputRef:x,galleryInputRef:h,barcodeImageInputRef:v,handlers:c}=sa({onPhotoCapture:l,onBarcodeDetected:g}),F=s==="photo-analysis"&&!i,G=s==="photo-analysis"&&i,k=s==="barcode-scan"&&n.length===0&&o.length===0,$=n.length>0||o.length>0,E=i||$;return e.jsxs("div",{className:"space-y-6 pb-32",style:{minHeight:"100vh"},children:[e.jsx(Y,{currentStep:"capture",progress:U,message:R,subMessage:W}),e.jsx(Ke,{scanType:s,onSelectScanType:t}),e.jsxs("div",{className:"space-y-6",children:[F&&e.jsx("div",{className:"mt-6",children:e.jsx(We,{isValidating:M,onCameraClick:c.handleCameraClick,onGalleryClick:c.handleGalleryClick,onBarcodeClick:c.handleBarcodeClick,onBarcodeImageUpload:c.handleBarcodeImageUpload})}),G&&e.jsx(se,{mode:"wait",children:e.jsx(f.div,{className:"mt-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:e.jsx(Ve,{capturedPhoto:i,showSuccessAnimation:C,onRetake:r})},"captured")}),k&&e.jsx(Qe,{onBarcodeClick:c.handleBarcodeClick,onBarcodeImageUpload:c.handleBarcodeImageUpload}),e.jsx(aa,{scannedBarcodes:n,scannedProducts:o,capturedPhoto:i,onBarcodeRemove:j,onProductPortionChange:p,onProductRemove:b,onCameraClick:c.handleCameraClick,onGalleryClick:c.handleGalleryClick}),E&&e.jsx("div",{ref:A,className:"mt-8",children:e.jsx(Ge,{onProceedToProcessing:I,isProcessingInProgress:N,hasPhoto:!!i,hasScannedBarcodes:n.length>0,hasScannedProducts:o.length>0,scannedBarcodesCount:n.length,scannedProductsCount:o.length})}),s==="photo-analysis"&&!i&&!$&&e.jsx(le,{benefits:ta,themeColor:"#10B981",title:"Pourquoi scanner mes repas ?"}),s==="barcode-scan"&&!$&&e.jsx(le,{benefits:ra,themeColor:"#6366F1",title:"Pourquoi scanner un code-barre ?"})]}),e.jsx("input",{ref:x,type:"file",accept:"image/*",onChange:c.handleFileSelect,style:{position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",border:"0",opacity:0,pointerEvents:"none"},capture:"environment","data-testid":"camera-file-input"}),e.jsx("input",{ref:h,type:"file",accept:"image/*",onChange:c.handleFileSelect,style:{position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",border:"0",opacity:0,pointerEvents:"none"},"data-testid":"gallery-file-input"}),e.jsx("input",{ref:v,type:"file",accept:"image/*",onChange:c.handleBarcodeImageSelect,className:"hidden"}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 z-50",style:{pointerEvents:"none"},children:e.jsx("div",{style:{pointerEvents:"auto"},children:e.jsx(qe,{capturedPhoto:i,onBack:w})})}),V&&e.jsx(Xe,{onBarcodeDetected:c.handleBarcodeDetected,onClose:c.handleBarcodeClose,mode:O,uploadedImage:O==="upload"?v.current?.files?.[0]:void 0})]})},ia=({analysisZones:a,currentPhase:s,analysisColor:t})=>e.jsxs("div",{className:"absolute inset-0 analysis-overlays perf-heavy",children:[e.jsx("div",{className:"absolute top-0 w-1 h-full opacity-70 scan-line-vertical",style:{background:`linear-gradient(180deg, 
            transparent 0%, 
            ${t}CC 30%, 
            ${t}FF 50%, 
            ${t}CC 70%, 
            transparent 100%
          )`,left:"50%",transform:"translateX(-50%)",boxShadow:`0 0 8px ${t}80`}}),e.jsx("div",{className:"absolute left-0 w-full h-1 opacity-60 scan-line-horizontal",style:{background:`linear-gradient(90deg, 
            transparent 0%, 
            ${t}80 30%, 
            ${t}CC 50%, 
            ${t}80 70%, 
            transparent 100%
          )`,top:"50%",transform:"translateY(-50%)",boxShadow:`0 0 6px ${t}60`}}),e.jsx("div",{className:"absolute inset-0 opacity-25 analysis-grid",children:e.jsx("div",{className:"w-full h-full",style:{backgroundImage:`
              linear-gradient(${t}30 1px, transparent 1px),
              linear-gradient(90deg, ${t}30 1px, transparent 1px)
            `,backgroundSize:"32px 32px"}})}),e.jsx("div",{className:"absolute inset-0 nutrition-keypoints",children:[{x:25,y:30,label:"Protéines",color:"#EF4444"},{x:75,y:25,label:"Lipides",color:"#8B5CF6"}].map((i,n)=>e.jsx("div",{className:`absolute w-4 h-4 rounded-full nutrition-keypoint particle-css particle-css--${n+1}`,style:{left:`${i.x}%`,top:`${i.y}%`,background:i.color,boxShadow:`
                0 0 16px ${i.color}80,
                0 0 32px ${i.color}40
              `,border:`1px solid ${i.color}CC`,"--particle-color":i.color},children:e.jsx("div",{className:"absolute -top-8 left-1/2 transform -translate-x-1/2 px-2 py-1 rounded text-xs font-medium whitespace-nowrap pointer-events-none",style:{background:`${i.color}20`,border:`1px solid ${i.color}40`,color:i.color,backdropFilter:"blur(8px)",opacity:s==="detection"?1:.3},children:i.label})},i.label))}),a.slice(0,3).map(i=>e.jsx("div",{className:"absolute w-16 h-16 rounded-full pointer-events-none",style:{left:`${i.x}%`,top:`${i.y}%`,background:`radial-gradient(circle, 
              ${t}${Math.round(i.intensity*80)} 0%, 
              ${t}${Math.round(i.intensity*40)} 50%, 
              transparent 70%
            )`,border:`1px solid ${t}40`,backdropFilter:"blur(4px)"}},i.id)),e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none ai-focus-overlay",style:{background:`
            radial-gradient(circle at center, 
              transparent 20%, 
              ${t}10 40%, 
              ${t}20 60%, 
              ${t}15 80%, 
              transparent 100%
            )
          `,mixBlendMode:"overlay"}})]}),oa=({capturedPhoto:a,analysisZones:s,currentPhase:t,analysisColor:i})=>{const n=q(),{isPerformanceMode:o}=Q(),l=o?"div":f.div;return e.jsxs(D,{className:"p-6 relative overflow-visible glass-card--analysis",style:{background:o?"linear-gradient(145deg, color-mix(in srgb, #10B981 10%, #1e293b), color-mix(in srgb, #10B981 5%, #0f172a))":"radial-gradient(circle at 30% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 60%), radial-gradient(circle at 70% 80%, rgba(6, 182, 212, 0.08) 0%, transparent 50%), var(--glass-opacity)",borderColor:"rgba(16, 185, 129, 0.3)",boxShadow:o?"0 8px 32px rgba(0, 0, 0, 0.5)":"0 12px 40px rgba(0, 0, 0, 0.25), 0 0 30px rgba(16, 185, 129, 0.15), inset 0 2px 0 rgba(255, 255, 255, 0.15)",...o?{}:{backdropFilter:"blur(20px) saturate(150%)"}},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{style:{width:"40px",height:"40px",borderRadius:"12px",display:"flex",alignItems:"center",justifyContent:"center",background:o?"linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(5, 150, 105, 0.3))":"radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%), linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(5, 150, 105, 0.3))",border:"2px solid rgba(16, 185, 129, 0.6)",boxShadow:o?"0 4px 16px rgba(0, 0, 0, 0.5)":"0 0 24px rgba(16, 185, 129, 0.5), inset 0 2px 0 rgba(255,255,255,0.3), inset 0 -2px 0 rgba(0,0,0,0.2)"},children:e.jsx(m,{Icon:u.Scan,size:20,style:{color:"#fff",filter:"drop-shadow(0 2px 6px rgba(16, 185, 129, 0.8))"}})}),e.jsx("h4",{className:"text-white font-bold text-lg",style:{textShadow:"0 2px 8px rgba(16, 185, 129, 0.4), 0 0 4px rgba(0,0,0,0.3)"},children:"Forge Nutritionnelle"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2",style:{background:"linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(34, 197, 94, 0.2))",border:"2px solid rgba(16, 185, 129, 0.5)",borderRadius:"20px",...o?{}:{backdropFilter:"blur(16px) saturate(140%)"},boxShadow:o?"0 4px 16px rgba(0, 0, 0, 0.5)":"0 4px 20px rgba(16, 185, 129, 0.3), 0 0 30px rgba(16, 185, 129, 0.2), inset 0 1px 0 rgba(255,255,255,0.25)"},children:[e.jsx(l,{className:"w-2.5 h-2.5 rounded-full",style:{backgroundColor:i,boxShadow:`0 0 12px ${i}`},...!o&&!n&&{animate:{scale:[1,1.4,1],opacity:[.7,1,.7]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}}),e.jsx("span",{className:"font-bold text-sm",style:{color:"#fff",textShadow:"0 1px 4px rgba(0,0,0,0.3)"},children:t==="detection"?"Détection":t==="analysis"?"Analyse":"Calcul"})]})]}),e.jsxs("div",{className:"relative aspect-[4/3] rounded-xl overflow-hidden bg-black/20 analysis-viewport",children:[e.jsx("img",{src:a.url,alt:"Repas en cours d'analyse",className:"w-full h-full object-cover border border-green-400/20"}),!o&&!n&&e.jsx(ia,{analysisZones:s,currentPhase:t,analysisColor:i})]})]})},la=({currentProgress:a,currentMessage:s,currentSubMessage:t,currentPhase:i,analysisColor:n})=>{const o=q(),{isPerformanceMode:l}=Q(),g=l?"div":f.div;return e.jsx(D,{className:"p-6 text-center glass-card--progress",style:{background:l?"linear-gradient(145deg, color-mix(in srgb, #10B981 10%, #1e293b), color-mix(in srgb, #22C55E 6%, #0f172a))":`
            radial-gradient(circle at 50% 30%, rgba(16, 185, 129, 0.12) 0%, transparent 60%),
            radial-gradient(circle at 70% 80%, rgba(34, 197, 94, 0.08) 0%, transparent 50%),
            var(--glass-opacity)
          `,borderColor:"rgba(16, 185, 129, 0.3)",borderRadius:"24px",...l?{}:{backdropFilter:"blur(20px) saturate(150%)"},boxShadow:l?"0 12px 40px rgba(0, 0, 0, 0.25)":`
            0 12px 40px rgba(0, 0, 0, 0.25),
            0 0 30px rgba(16, 185, 129, 0.15),
            inset 0 2px 0 rgba(255, 255, 255, 0.15)
          `},children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4 mb-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full flex items-center justify-center relative",style:{background:`
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(34, 197, 94, 0.25))
              `,border:"2px solid rgba(16, 185, 129, 0.6)",boxShadow:`
                0 0 40px rgba(16, 185, 129, 0.5),
                inset 0 2px 0 rgba(255,255,255,0.3),
                inset 0 -2px 0 rgba(0,0,0,0.2)
              `},children:e.jsxs(f.div,{className:"relative",animate:o?{}:{rotate:360},transition:{duration:2,repeat:1/0,ease:"linear"},children:[e.jsx(m,{Icon:u.Loader2,size:28,className:"loader-essential",style:{color:"#fff",filter:"drop-shadow(0 2px 8px rgba(16, 185, 129, 0.8))"}}),!o&&!l&&e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:`conic-gradient(from 0deg,
                      transparent 0%,
                      ${n}40 25%,
                      transparent 50%,
                      ${n}60 75%,
                      transparent 100%
                    )`,animation:"spinHalo 3s linear infinite reverse"}})]})}),e.jsx("h3",{className:"text-2xl font-bold text-white",style:{textShadow:"0 2px 12px rgba(16, 185, 129, 0.4), 0 0 4px rgba(0,0,0,0.3)"},children:s})]}),e.jsx("p",{className:"text-green-100 text-sm mb-4 leading-relaxed max-w-sm mx-auto",children:t}),e.jsxs(g,{className:"inline-flex items-center justify-center gap-2 px-4 py-2 mx-auto",style:{background:`
              linear-gradient(135deg,
                rgba(16, 185, 129, 0.2),
                rgba(34, 197, 94, 0.15)
              )
            `,border:"2px solid rgba(16, 185, 129, 0.4)",borderRadius:"999px",boxShadow:l?"none":`
                0 0 20px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2)
              `,...l?{}:{backdropFilter:"blur(12px)"}},...!l&&{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.4}},children:[e.jsx("div",{className:"w-2 h-2 rounded-full",style:{background:n,boxShadow:`0 0 8px ${n}`,animation:"pulse 1.5s ease-in-out infinite"}}),e.jsx("span",{className:"text-sm font-bold",style:{color:"#fff",textShadow:"0 1px 4px rgba(0,0,0,0.3)"},children:i==="detection"?"Détection":i==="analysis"?"Analyse":"Calcul"})]},i),e.jsx("div",{className:"flex items-center justify-center gap-1 mt-3",children:["detection","analysis","calculation"].map((p,b)=>e.jsx(g,{className:"w-2 h-2 rounded-full",style:{background:p===i?n:"rgba(255, 255, 255, 0.3)",boxShadow:p===i?`0 0 8px ${n}60`:"none"},...!l&&{animate:p===i?{scale:[1,1.2,1],opacity:[.8,1,.8]}:{},transition:{duration:1.5,repeat:p===i?1/0:0,ease:"easeInOut"}}},p))}),e.jsx("div",{className:"w-full bg-white/20 rounded-full h-2 mt-4 overflow-hidden backdrop-blur-sm",children:e.jsx(f.div,{className:"h-full rounded-full relative",style:{background:`
                linear-gradient(90deg, 
                  ${n}, 
                  rgba(34, 197, 94, 0.9),
                  rgba(52, 211, 153, 0.8)
                )
              `,boxShadow:`
                0 0 16px ${n}80,
                inset 0 1px 0 rgba(255,255,255,0.3)
              `},initial:{width:0},animate:{width:`${a}%`},transition:{duration:.8,ease:"easeOut"},children:!o&&!l&&e.jsx("div",{className:"absolute inset-0 rounded-full",style:{background:`linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.4) 50%,
                    transparent 100%
                  )`,animation:"progressShimmer 2s ease-in-out infinite"}})})}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-green-300 font-medium",children:[Math.round(a),"% terminé"]}),e.jsxs("span",{className:"text-white/60",children:["Phase: ",i==="detection"?"Détection":i==="analysis"?"Analyse":"Calcul"]})]})]})})},ca=({analysisColor:a})=>e.jsxs("div",{className:"relative overflow-hidden data-flow-container h-16 perf-heavy",children:[Array.from({length:4}).map((s,t)=>e.jsx("div",{className:`absolute w-3 h-3 rounded-full particle-css particle-css--${t+1}`,style:{background:`linear-gradient(135deg, ${a}, rgba(34, 197, 94, 0.8))`,left:`${10+t*10}%`,top:`${40+t%3*20}%`,boxShadow:`
              0 0 12px ${a}80,
              0 0 24px ${a}40
            `,border:`1px solid ${a}CC`,"--particle-color":a}},t)),e.jsx("svg",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{opacity:.3},children:Array.from({length:2}).map((s,t)=>e.jsx("path",{d:`M ${20+t*30} 50 Q ${40+t*30} 20 ${60+t*30} 50`,stroke:a,strokeWidth:"2",fill:"none",strokeDasharray:"4 4",style:{animation:`data-flow-path 3s ease-in-out infinite ${t*.5}s`}},t))})]}),da=`
@keyframes data-flow-path {
  0% { stroke-dashoffset: 20; }
  100% { stroke-dashoffset: -20; }
}
`;if(typeof document<"u"){const a=document.createElement("style");a.textContent=da,document.head.appendChild(a)}const ua=({capturedPhoto:a,progress:s,progressMessage:t,progressSubMessage:i})=>{const[n,o]=_.useState([]),[l,g]=_.useState("detection"),p="#10B981";return _.useEffect(()=>{const b=()=>{const r=Array.from({length:6},(w,I)=>({x:Math.random()*80+10,y:Math.random()*80+10,intensity:Math.random()*.6+.4,id:`zone-${Date.now()}-${I}`}));o(r)};b();const j=setInterval(b,2e3);return()=>clearInterval(j)},[]),_.useEffect(()=>{const b=["detection","analysis","calculation"];let j=0;const r=setInterval(()=>{j=(j+1)%b.length,g(b[j]),d.debug("MEAL_ANALYSIS","Analysis phase changed",{phase:b[j],timestamp:new Date().toISOString()})},3e3);return()=>clearInterval(r)},[]),a?e.jsxs("div",{className:"space-y-6 w-full meal-processing-enter",children:[e.jsx(Y,{currentStep:"processing",progress:s,message:t,subMessage:i}),e.jsx("div",{children:e.jsx(oa,{capturedPhoto:a,analysisZones:n,currentPhase:l,analysisColor:p})}),e.jsx("div",{children:e.jsx(la,{currentProgress:s,currentMessage:t,currentSubMessage:i,currentPhase:l,analysisColor:p})}),e.jsx(ca,{analysisColor:p})]}):null},pa=({mealName:a,totalCalories:s,confidence:t,analysisModel:i,celebrationActive:n,analysisMetadata:o})=>{const l=q(),[g,p]=_.useState(0);return _.useEffect(()=>{if(s===0)return;const b=800,j=30,r=s/j,w=b/j;let I=0;const N=setInterval(()=>{I++;const A=Math.min(s,Math.round(r*I));p(A),(I>=j||A>=s)&&(p(s),clearInterval(N))},w);return()=>clearInterval(N)},[s]),e.jsx("div",{className:"meal-results-enter",children:e.jsx(f.div,{animate:n?{boxShadow:["0 12px 40px rgba(0, 0, 0, 0.25), 0 0 40px color-mix(in srgb, #FF4500 20%, transparent)","0 12px 40px rgba(0, 0, 0, 0.25), 0 0 60px color-mix(in srgb, #FF4500 35%, transparent)","0 12px 40px rgba(0, 0, 0, 0.25), 0 0 40px color-mix(in srgb, #FF4500 20%, transparent)"]}:l?{}:{boxShadow:["0 12px 40px rgba(0, 0, 0, 0.25), 0 0 30px color-mix(in srgb, #FF4500 15%, transparent)","0 12px 40px rgba(0, 0, 0, 0.25), 0 0 45px color-mix(in srgb, #FF4500 25%, transparent)","0 12px 40px rgba(0, 0, 0, 0.25), 0 0 30px color-mix(in srgb, #FF4500 15%, transparent)"]},transition:{duration:n?1.5:3,repeat:1/0,ease:"easeInOut"},children:e.jsxs(D,{className:"p-6 md:p-8 text-center relative w-full perf-critical",style:{background:`
              radial-gradient(circle at 50% 50%, color-mix(in srgb, #FF4500 6%, transparent) 0%, transparent 70%),
              radial-gradient(circle at 80% 20%, color-mix(in srgb, #FF8C00 4%, transparent) 0%, transparent 60%),
              var(--glass-opacity)
            `,borderColor:"color-mix(in srgb, #FF4500 30%, transparent)",boxShadow:`
              0 12px 40px rgba(0, 0, 0, 0.25),
              0 0 30px color-mix(in srgb, #FF4500 15%, transparent),
              inset 0 2px 0 rgba(255, 255, 255, 0.15)
            `,backdropFilter:"blur(20px) saturate(150%)",borderRadius:"24px",border:"2px solid color-mix(in srgb, #FF4500 40%, transparent)"},children:[e.jsx("div",{className:"absolute inset-0 rounded-inherit pointer-events-none",style:{background:"radial-gradient(circle at center, color-mix(in srgb, #FF4500 2%, transparent) 0%, transparent 70%)",filter:"blur(16px)",transform:"scale(1.1)",zIndex:-1,animation:n&&!l?"calorie-forge-glow 3s ease-in-out infinite":l?"none":"calorie-forge-glow-idle 4s ease-in-out infinite"}}),e.jsxs("div",{className:"relative z-10 space-y-6",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(f.div,{className:"w-24 h-24 rounded-full flex items-center justify-center relative",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, #FF4500 50%, transparent), color-mix(in srgb, #FF8C00 40%, transparent))
                `,border:"2px solid color-mix(in srgb, #FF4500 70%, transparent)",boxShadow:`
                  0 0 50px color-mix(in srgb, #FF4500 60%, transparent),
                  0 0 80px color-mix(in srgb, #FF4500 40%, transparent),
                  inset 0 2px 0 rgba(255, 255, 255, 0.35)
                `},animate:n?{scale:[1,1.12,1],boxShadow:["0 0 50px color-mix(in srgb, #FF4500 60%, transparent), 0 0 80px color-mix(in srgb, #FF4500 40%, transparent), inset 0 2px 0 rgba(255, 255, 255, 0.35)","0 0 70px color-mix(in srgb, #FF4500 80%, transparent), 0 0 120px color-mix(in srgb, #FF4500 60%, transparent), inset 0 3px 0 rgba(255, 255, 255, 0.45)","0 0 50px color-mix(in srgb, #FF4500 60%, transparent), 0 0 80px color-mix(in srgb, #FF4500 40%, transparent), inset 0 2px 0 rgba(255, 255, 255, 0.35)"]}:l?{}:{scale:[1,1.03,1],rotate:[0,2,-2,0]},transition:{duration:n?1.5:2.5,repeat:1/0,ease:"easeInOut"},children:e.jsx(f.div,{animate:l?{}:{scale:[1,1.1,.95,1],opacity:[1,.9,1,1]},transition:{duration:1.8,repeat:1/0,ease:"easeInOut",times:[0,.3,.6,1]},children:e.jsx(m,{Icon:u.Flame,size:48,className:"text-white",variant:"pure","aria-hidden":"true"})})})}),e.jsxs("div",{className:"text-center space-y-5",children:[e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold text-white leading-normal",children:a}),e.jsx("p",{className:"text-white/70 text-base",children:"Repas analysé par TwinForge"})]}),e.jsx("div",{className:"text-5xl md:text-6xl font-black leading-none",style:{background:`
                  linear-gradient(135deg, 
                    #FF4500, 
                    #FF8C00,
                    #FFD700
                  )
                `,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:n?"0 0 40px color-mix(in srgb, #FF4500 60%, transparent)":"0 0 20px color-mix(in srgb, #FF4500 40%, transparent)",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.3))"},children:g}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold text-white",children:"Énergie Totale"}),e.jsx("p",{className:"text-white/80 text-base md:text-lg",children:"Kilocalories analysées"})]})]})]})]})})})},ga=({analysisResults:a,celebrationActive:s})=>{const t=q();return e.jsxs("div",{className:"macronutrients-card-container",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(f.div,{className:"macronutrients-header-icon",whileHover:{scale:1.05},transition:{type:"spring",stiffness:300,damping:20},children:e.jsx(m,{Icon:u.BarChart3,size:20,style:{color:"var(--nutrition-secondary)"}})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Macronutriments Forgés"})]}),e.jsxs("div",{className:"nutrition-stats-grid",children:[e.jsxs(f.div,{className:"nutrition-stat-card proteins",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:t?.1:.5,delay:t?0:.1},children:[e.jsx("div",{className:`nutrition-stat-icon ${s?"celebrating":""}`,children:e.jsx(m,{Icon:u.Activity,size:20,style:{color:"var(--nutrition-proteins)"}})}),e.jsxs(f.div,{className:"nutrition-stat-value",style:{color:"var(--nutrition-proteins)"},initial:{scale:0},animate:{scale:1},transition:{type:t?"tween":"spring",stiffness:300,delay:t?0:.3},children:[Math.round(a.macronutrients.proteins),"g"]}),e.jsx("div",{className:"text-white font-medium text-sm",children:"Protéines"}),e.jsx("div",{className:"text-white/50 text-xs mt-1",children:"Récupération"})]}),e.jsxs(f.div,{className:"nutrition-stat-card carbs",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:t?.1:.5,delay:t?0:.2},children:[e.jsx("div",{className:`nutrition-stat-icon ${s?"celebrating":""}`,children:e.jsx(m,{Icon:u.Zap,size:20,style:{color:"var(--nutrition-carbs)"}})}),e.jsxs(f.div,{className:"nutrition-stat-value",style:{color:"var(--nutrition-carbs)"},initial:{scale:0},animate:{scale:1},transition:{type:t?"tween":"spring",stiffness:300,delay:t?0:.4},children:[Math.round(a.macronutrients.carbs),"g"]}),e.jsx("div",{className:"text-white font-medium text-sm",children:"Glucides"}),e.jsx("div",{className:"text-white/50 text-xs mt-1",children:"Énergie rapide"})]}),e.jsxs(f.div,{className:"nutrition-stat-card fats",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:t?.1:.5,delay:t?0:.3},children:[e.jsx("div",{className:`nutrition-stat-icon ${s?"celebrating":""}`,children:e.jsx(m,{Icon:u.Heart,size:20,style:{color:"var(--nutrition-fats)"}})}),e.jsxs(f.div,{className:"nutrition-stat-value",style:{color:"var(--nutrition-fats)"},initial:{scale:0},animate:{scale:1},transition:{type:t?"tween":"spring",stiffness:300,delay:t?0:.5},children:[Math.round(a.macronutrients.fats),"g"]}),e.jsx("div",{className:"text-white font-medium text-sm",children:"Lipides"}),e.jsx("div",{className:"text-white/50 text-xs mt-1",children:"Graisses saines"})]})]}),e.jsxs(f.div,{className:"nutrition-confidence-indicator",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:t?.1:.6,delay:t?0:.6},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{Icon:u.BarChart3,size:16,style:{color:"var(--nutrition-secondary)",filter:"drop-shadow(0 0 8px color-mix(in srgb, var(--nutrition-secondary) 60%, transparent))"}}),e.jsx("span",{className:"text-white/90 text-sm font-medium",children:"Répartition Macronutritionnelle"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-bold text-lg",style:{color:"var(--nutrition-secondary)"},children:[Math.round((a.macronutrients.proteins+a.macronutrients.carbs+a.macronutrients.fats)/3),"g"]}),e.jsx("div",{className:"text-white/60 text-xs",children:"Moyenne"})]})]})]})};function ae(a){const s={protein:"#EF4444",carbs:"#F59E0B",vegetables:"#22C55E",healthy_fats:"#8B5CF6",dairy:"#06B6D4",fruits:"#EC4899",grains:"#D97706",default:"#10B981"};return s[a]||s.default}const xa=({analysisResults:a})=>{const s=q();return e.jsxs("div",{className:"detected-foods-card-container",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(f.div,{className:"detected-foods-header-icon",whileHover:{scale:1.05},transition:{type:"spring",stiffness:300,damping:20},children:e.jsx(m,{Icon:u.Eye,size:20,style:{color:"var(--nutrition-accent)"}})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Aliments Détectés"})]}),e.jsx("div",{className:"space-y-3",children:a.detected_foods.map((t,i)=>e.jsx(f.div,{className:"food-item-card",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:s?.1:.4,delay:s?0:.3+i*.1},style:{background:`
                radial-gradient(circle at 30% 20%, color-mix(in srgb, ${ae(t.category)} 8%, transparent) 0%, transparent 60%),
                rgba(255, 255, 255, 0.08)
              `,border:`2px solid color-mix(in srgb, ${ae(t.category)} 25%, transparent)`,boxShadow:`
                0 4px 16px rgba(0, 0, 0, 0.15),
                0 0 12px color-mix(in srgb, ${ae(t.category)} 15%, transparent),
                inset 0 1px 0 rgba(255, 255, 255, 0.12)
              `},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"food-category-indicator",style:{color:ae(t.category)}}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-semibold text-lg",children:t.name}),t.portion_size&&e.jsx("div",{className:"text-white/60 text-sm mb-1",children:t.portion_size}),e.jsxs("div",{className:"text-white/70 text-sm",children:["P: ",Math.round(t.proteins),"g • G: ",Math.round(t.carbs),"g • L: ",Math.round(t.fats),"g"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-white font-bold text-xl",children:t.calories}),e.jsx("div",{className:"text-white/70 text-sm",children:"kcal"})]})]})},i))})]})},ma=({capturedPhoto:a})=>(q(),e.jsxs(D,{className:"p-6 glass-card--photo-analyzed",style:{background:`
          radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--brand-primary) 12%, transparent) 0%, transparent 60%),
          radial-gradient(circle at 70% 80%, color-mix(in srgb, var(--color-plasma-cyan) 8%, transparent) 0%, transparent 50%),
          var(--glass-opacity)
        `,borderColor:"color-mix(in srgb, var(--brand-primary) 35%, transparent)",boxShadow:`
          0 12px 40px rgba(0, 0, 0, 0.25),
          0 0 30px color-mix(in srgb, var(--brand-primary) 15%, transparent),
          0 0 60px color-mix(in srgb, var(--color-plasma-cyan) 10%, transparent),
          inset 0 1px 0 rgba(255, 255, 255, 0.15)
        `,backdropFilter:"blur(20px) saturate(150%)"},children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(f.div,{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:`
              radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
              linear-gradient(135deg, color-mix(in srgb, var(--brand-primary) 40%, transparent), color-mix(in srgb, var(--color-plasma-cyan) 30%, transparent))
            `,border:"2px solid color-mix(in srgb, var(--brand-primary) 60%, transparent)",boxShadow:"0 0 25px color-mix(in srgb, var(--brand-primary) 40%, transparent)"},whileHover:{scale:1.05},transition:{type:"spring",stiffness:300,damping:20},children:e.jsx(m,{Icon:u.Camera,size:18,style:{color:"var(--color-plasma-cyan)"}})}),e.jsx("h3",{className:"text-xl font-bold text-white",children:"Capture Nutritionnelle"})]}),e.jsxs("div",{className:"aspect-[4/3] rounded-2xl overflow-hidden relative",children:[e.jsx("img",{src:a.url,alt:"Repas analysé",className:"w-full h-full object-cover",style:{border:"2px solid color-mix(in srgb, var(--brand-primary) 30%, transparent)"}}),e.jsx("div",{className:"absolute inset-0 rounded-2xl pointer-events-none",style:{background:`
              radial-gradient(circle at center, color-mix(in srgb, var(--nutrition-primary) 8%, transparent) 0%, transparent 70%),
              radial-gradient(circle at 30% 30%, color-mix(in srgb, var(--color-plasma-cyan) 6%, transparent) 0%, transparent 50%)
            `,border:"1px solid color-mix(in srgb, var(--nutrition-primary) 20%, transparent)",backdropFilter:"blur(4px) saturate(120%)"}}),e.jsx("div",{className:"absolute inset-0 rounded-2xl pointer-events-none",style:{background:`
              linear-gradient(135deg, 
                color-mix(in srgb, var(--color-plasma-cyan) 4%, transparent) 0%, 
                transparent 30%, 
                color-mix(in srgb, var(--nutrition-primary) 3%, transparent) 70%, 
                transparent 100%
              )
            `,mixBlendMode:"overlay"}})]})]})),ba=({isSaving:a,onSaveMeal:s,onRetake:t,onNewScan:i,analysisResults:n})=>{const o=q(),{click:l,formSubmit:g}=Z(),p=async()=>{g();try{await s()}catch(b){console.error("ActionButtons: Save meal failed:",b)}};return e.jsxs(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:o?.1:.6,delay:o?0:.4},className:"space-y-4",children:[e.jsx("button",{onClick:p,disabled:a,className:"btn-save-meal-cta touch-feedback-css",children:e.jsxs("div",{className:"relative z-10 flex items-center justify-center gap-3",children:[e.jsx("div",{className:a?"icon-spin-css":"",children:e.jsx(m,{Icon:a?u.Loader2:u.Check,size:24})}),e.jsx("span",{className:"text-2xl font-bold text-white",children:a?"Sauvegarde...":"Sauvegarder le Repas"})]})}),e.jsxs("div",{className:"meal-secondary-actions-grid",children:[e.jsx("button",{onClick:()=>{l(),t()},className:"btn-meal-secondary retake touch-target touch-feedback-css",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(m,{Icon:u.RotateCcw,size:18}),e.jsx("span",{className:"font-medium",children:"Reprendre"})]})}),e.jsx("button",{onClick:()=>{l(),i()},className:"btn-meal-secondary new-scan touch-target touch-feedback-css",children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(m,{Icon:u.Plus,size:18}),e.jsx("span",{className:"font-medium",children:"Nouveau Scan"})]})})]})]})},ha=({analysisResults:a,capturedPhoto:s,onSaveMeal:t,isSaving:i,onRetake:n,onNewScan:o,progress:l,progressMessage:g,progressSubMessage:p})=>{const{isPerformanceMode:b}=Q(),[j,r]=P.useState(!1);return!a||!s?null:(P.useEffect(()=>{if(i)r(!0);else{const w=setTimeout(()=>r(!1),1e3);return()=>clearTimeout(w)}},[i]),e.jsxs("div",{className:`space-y-6 w-full meal-results-enter pb-6 ${j?"celebration-active celebration-glow-css":""}`,children:[e.jsx(Y,{currentStep:"results",progress:l,message:g,subMessage:p,celebrationActive:j}),e.jsx("div",{children:e.jsx(pa,{totalCalories:a.total_calories,mealName:a.meal_name,confidence:a.confidence,analysisModel:a.analysis_metadata?.analysis_model_used||"advanced",celebrationActive:j,analysisMetadata:a.analysis_metadata})}),e.jsx("div",{children:e.jsx(ga,{analysisResults:a,celebrationActive:j})}),e.jsx("div",{children:e.jsx(xa,{analysisResults:a})}),e.jsx("div",{children:e.jsx(ma,{capturedPhoto:s})}),e.jsx("div",{children:e.jsx(ba,{isSaving:i,onSaveMeal:t,onRetake:n,onNewScan:o,analysisResults:a})})]}))},X={scanType:"photo-analysis",currentStep:"capture",captureMode:"photo",capturedPhoto:null,scannedBarcodes:[],scannedProducts:[],analysisResults:null,barcodeAnalysisResults:null,isProcessing:!1,progress:0,progressMessage:"Prêt à scanner votre repas",progressSubMessage:"Prenez une photo ou sélectionnez depuis la galerie",analysisError:null,analysisMetadata:null,isScanningBarcode:!1};async function fa(a){return new Promise((s,t)=>{const i=new FileReader;i.onload=()=>{const o=i.result.split(",")[1];s(o)},i.onerror=t,i.readAsDataURL(a)})}function ya(a){return{sex:a?.sex,height_cm:a?.height_cm,weight_kg:a?.weight_kg,target_weight_kg:a?.target_weight_kg,activity_level:a?.activity_level,objective:a?.objective,birthdate:a?.birthdate,job_category:a?.job_category,nutrition:{diet:a?.nutrition?.diet,allergies:a?.nutrition?.allergies||[],intolerances:a?.nutrition?.intolerances||[],disliked:a?.nutrition?.disliked||[],budgetLevel:a?.nutrition?.budgetLevel,proteinTarget_g:a?.nutrition?.proteinTarget_g,fastingWindow:a?.nutrition?.fastingWindow},health:{bloodType:a?.health?.bloodType,conditions:a?.health?.conditions||[],medications:a?.health?.medications||[]},emotions:{chronotype:a?.emotions?.chronotype,stress:a?.emotions?.stress,sleepHours:a?.emotions?.sleepHours,moodBaseline:a?.emotionBaseline?.moodBaseline,sensitivities:a?.emotions?.sensitivities||[]},workout:{type:a?.preferences?.workout?.type,sessionsPerWeek:a?.preferences?.workout?.sessionsPerWeek,preferredDuration:a?.preferences?.workout?.preferredDuration,equipment:a?.preferences?.workout?.equipment||[],morningWorkouts:a?.preferences?.workout?.morningWorkouts,highIntensity:a?.preferences?.workout?.highIntensity,groupWorkouts:a?.preferences?.workout?.groupWorkouts,outdoorActivities:a?.preferences?.workout?.outdoorActivities},constraints:a?.constraints||{},calculated_metrics:(()=>{const s=a?.birthdate?new Date().getFullYear()-new Date(a.birthdate).getFullYear():void 0,t=a?.height_cm&&a?.weight_kg?a.weight_kg/Math.pow(a.height_cm/100,2):void 0,i=a?.height_cm&&a?.weight_kg&&s?a.sex==="male"?88.362+13.397*a.weight_kg+4.799*a.height_cm-5.677*s:447.593+9.247*a.weight_kg+3.098*a.height_cm-4.33*s:void 0,n=a?.activity_level==="sedentary"?1.2:a?.activity_level==="light"?1.375:a?.activity_level==="moderate"?1.55:a?.activity_level==="active"?1.725:a?.activity_level==="athlete"?1.9:1.55,o=i?i*n:void 0,l=a?.objective==="muscle_gain"?2.2:a?.objective==="fat_loss"?2:1.6,g=a?.weight_kg?a.weight_kg*l:void 0;return{age:s,bmi:t?Math.round(t*10)/10:void 0,bmr:i?Math.round(i):void 0,tdee:o?Math.round(o):void 0,protein_target_calculated:g?Math.round(g):void 0,daily_calorie_target:o?Math.round(o):void 0}})()}}function ja({scanFlowState:a,setScanFlowState:s,profile:t,userId:i,clientScanIdRef:n,processingGuardRef:o,readyForProcessingRef:l,showToast:g,success:p,errorSound:b,queryClient:j,onAnalysisError:r,onSuccess:w}){const I=P.useCallback(async(x,h)=>{const v={file:x,url:URL.createObjectURL(x),validationResult:{isValid:h.validation?.isValid??!0,issues:h.validation?.issues??[],confidence:h.validation?.confidence??.8},captureReport:h};s(c=>({...c,capturedPhoto:v,analysisError:null,progress:33,progressMessage:"Forge du Repas",progressSubMessage:"Photo capturée avec succès"})),d.info("MEAL_SCAN_FLOW","Photo captured",{clientScanId:n.current,isValid:v.validationResult.isValid}),setTimeout(()=>{l.current&&l.current.scrollIntoView({behavior:"smooth",block:"center"})},300)},[s,n,l]),N=P.useCallback(()=>{s(x=>({...x,capturedPhoto:null,analysisError:null,analysisMetadata:null,currentStep:"capture",progress:0,progressMessage:"Forge du Repas",progressSubMessage:"Prêt pour une nouvelle capture"})),d.info("MEAL_SCAN_FLOW","Photo retake requested",{clientScanId:n.current})},[s,n]),A=P.useCallback(async()=>{if(o.current||!a.capturedPhoto&&a.scannedBarcodes.length===0&&a.scannedProducts.length===0||!i)return;o.current=!0,s(h=>({...h,isProcessing:!0,currentStep:"processing",analysisError:null,progress:20,progressMessage:"Analyse du Carburant",progressSubMessage:"Démarrage de l'analyse..."}));const x=n.current;try{if(a.scannedBarcodes.length>0){d.info("MEAL_SCAN_FLOW","Starting barcode analysis",{clientScanId:x,barcodesCount:a.scannedBarcodes.length,barcodes:a.scannedBarcodes.map(E=>E.barcode)}),s(E=>({...E,progress:30,progressSubMessage:`Analyse de ${a.scannedBarcodes.length} code${a.scannedBarcodes.length>1?"s-barres":"-barre"}...`}));const k=[],$=[];for(let E=0;E<a.scannedBarcodes.length;E++){const L=a.scannedBarcodes[E];d.info("MEAL_SCAN_FLOW",`Analyzing barcode ${E+1}/${a.scannedBarcodes.length}`,{clientScanId:x,barcode:L.barcode,portionMultiplier:L.portionMultiplier});try{const y=await K.getProductByBarcode(L.barcode);if(y.success&&y.product){const z=K.convertToMealItem(y.product,L.portionMultiplier);z?(k.push({barcode:y.product.barcode,name:y.product.name,brand:y.product.brand,image_url:y.product.image_url,mealItem:z,portionMultiplier:L.portionMultiplier,scannedAt:L.scannedAt}),d.info("MEAL_SCAN_FLOW","Barcode analyzed successfully",{clientScanId:x,barcode:L.barcode,productName:y.product.name,calories:z.calories})):($.push({barcode:L.barcode,reason:"Failed to convert to meal item"}),d.warn("MEAL_SCAN_FLOW","Failed to convert product to meal item",{clientScanId:x,barcode:L.barcode}))}else $.push({barcode:L.barcode,reason:y.error||"Product not found"}),d.warn("MEAL_SCAN_FLOW","Product not found for barcode",{clientScanId:x,barcode:L.barcode,error:y.error})}catch(y){$.push({barcode:L.barcode,reason:y instanceof Error?y.message:"Unknown error"}),d.error("MEAL_SCAN_FLOW","Exception during barcode analysis",{clientScanId:x,barcode:L.barcode,error:y instanceof Error?y.message:String(y),stack:y instanceof Error?y.stack:void 0})}s(y=>({...y,progress:30+15*(E+1)/a.scannedBarcodes.length,progressSubMessage:`Analyse ${E+1}/${a.scannedBarcodes.length} codes-barres...`}))}if(s(E=>({...E,scannedProducts:[...E.scannedProducts,...k],scannedBarcodes:[]})),d.info("MEAL_SCAN_FLOW","Barcodes analysis completed",{clientScanId:x,totalBarcodes:a.scannedBarcodes.length,analyzedCount:k.length,failedCount:$.length,failedDetails:$,analyzedProducts:k.map(E=>({barcode:E.barcode,name:E.name,calories:E.mealItem.calories}))}),k.length===0&&$.length>0){const E=`Impossible d'analyser les codes-barres: ${$.map(L=>L.reason).join(", ")}`;d.error("MEAL_SCAN_FLOW","All barcodes failed to analyze",{clientScanId:x,failedBarcodes:$}),r(E);return}}s(k=>({...k,progress:50,progressSubMessage:"Identification des aliments..."}));const h=ya(t),v={user_id:i,meal_type:"dinner",timestamp:new Date().toISOString(),user_profile_context:h};a.capturedPhoto&&(v.image_data=await fa(a.capturedPhoto.file)),a.scannedProducts.length>0&&(v.scanned_products=a.scannedProducts.map(k=>({barcode:k.barcode,name:k.name,brand:k.brand,mealItem:k.mealItem,portionMultiplier:k.portionMultiplier})),console.log("🔵 DEBUG - scannedProducts being sent:",{count:a.scannedProducts.length,products:v.scanned_products,analysisRequestKeys:Object.keys(v),hasScannedProducts:!!v.scanned_products})),d.info("MEAL_SCAN_FLOW","Transmitting complete user context to analysis",{clientScanId:x,contextKeys:Object.keys(h),philosophy:"complete_user_context_transmission_to_analysis"}),await new Promise(k=>setTimeout(k,1500)),s(k=>({...k,progress:60,progressSubMessage:"Analyse des nutriments..."}));const{mealsRepo:c}=await be(async()=>{const{mealsRepo:k}=await import("./ScanExitConfirmationModal-BZoIYo53.js").then($=>$.a);return{mealsRepo:k}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12])),F=await c.analyzeMeal(v),G={model:F.analysis_metadata.ai_model_used,tokensUsed:F.analysis_metadata.tokens_used?.total||0,costUSD:F.analysis_metadata.tokens_used?.cost_estimate_usd||0,fallbackUsed:F.analysis_metadata.fallback_used||!1,photo_url:a.capturedPhoto?.url};s(k=>({...k,progress:70,progressSubMessage:"Calcul des macronutriments...",analysisMetadata:G})),await new Promise(k=>setTimeout(k,500)),s(k=>({...k,progress:85,progressSubMessage:"Optimisation pour vos objectifs..."})),await new Promise(k=>setTimeout(k,500)),s(k=>({...k,analysisResults:F,progress:95,progressMessage:"Énergie Raffinée",progressSubMessage:"Finalisation des données..."})),await new Promise(k=>setTimeout(k,500)),s(k=>({...k,progress:100,currentStep:"results"})),w(),d.info("MEAL_SCAN_FLOW","Analysis completed",{clientScanId:x,totalCalories:F.total_calories,confidence:F.confidence,insightsCount:F.personalized_insights?.length||0,aiModelUsed:F.analysis_metadata?.ai_model_used,tokensUsed:F.analysis_metadata?.tokens_used,analysisId:F.analysis_id,hasPhoto:!!a.capturedPhoto,scannedProductsCount:a.scannedProducts.length,philosophy:"analysis_with_complete_user_context_and_hybrid_input"})}catch(h){d.error("MEAL_SCAN_FLOW","Analysis failed",{clientScanId:x,error:h instanceof Error?h.message:"Unknown error"}),r(h instanceof Error?h.message:"Unknown error occurred")}finally{s(h=>({...h,isProcessing:!1})),o.current=!1}},[a.capturedPhoto,a.scannedBarcodes,a.scannedProducts,i,t,s,n,o,r,w]),U=P.useCallback(x=>{s(h=>({...h,scannedProducts:[...h.scannedProducts,x],analysisError:null})),d.info("MEAL_SCAN_FLOW","Product scanned and added",{clientScanId:n.current,barcode:x.barcode,productName:x.name,totalScannedProducts:a.scannedProducts.length+1})},[s,n,a.scannedProducts.length]),R=P.useCallback((x,h)=>{s(v=>({...v,scannedProducts:v.scannedProducts.map(c=>{if(c.barcode===x){const F=K.convertToMealItem({barcode:c.barcode,name:c.name,brand:c.brand,image_url:c.image_url,portion_size:c.mealItem.portion_size,nutrition_per_100g:{calories:c.mealItem.calories/c.portionMultiplier,proteins:c.mealItem.proteins/c.portionMultiplier,carbs:c.mealItem.carbs/c.portionMultiplier,fats:c.mealItem.fats/c.portionMultiplier,fiber:c.mealItem.fiber?c.mealItem.fiber/c.portionMultiplier:void 0,sugar:c.mealItem.sugar?c.mealItem.sugar/c.portionMultiplier:void 0,sodium:c.mealItem.sodium?c.mealItem.sodium/c.portionMultiplier:void 0}},h);return{...c,portionMultiplier:h,mealItem:F}}return c})})),d.info("MEAL_SCAN_FLOW","Product portion changed",{clientScanId:n.current,barcode:x,newMultiplier:h})},[s,n]),W=P.useCallback(x=>{s(h=>({...h,scannedProducts:h.scannedProducts.filter(v=>v.barcode!==x)})),d.info("MEAL_SCAN_FLOW","Product removed",{clientScanId:n.current,barcode:x,remainingProducts:a.scannedProducts.length-1})},[s,n,a.scannedProducts.length]),M=P.useRef(null),C=P.useCallback(x=>{s(h=>{const v=Date.now(),c=2e3;return M.current&&M.current.barcode===x.barcode&&v-M.current.timestamp<c?(d.warn("MEAL_SCAN_FLOW","Rapid duplicate barcode detected, applying cooldown",{clientScanId:n.current,barcode:x.barcode,timeSinceLastScan:v-M.current.timestamp,cooldownMs:c}),h):h.scannedBarcodes.some(G=>G.barcode===x.barcode)?(d.warn("MEAL_SCAN_FLOW","Barcode already in session, skipping",{clientScanId:n.current,barcode:x.barcode,existingCount:h.scannedBarcodes.length}),h):(M.current={barcode:x.barcode,timestamp:v},d.info("MEAL_SCAN_FLOW","Barcode detected and added",{clientScanId:n.current,barcode:x.barcode,totalScannedBarcodes:h.scannedBarcodes.length+1,timestamp:x.scannedAt}),{...h,scannedBarcodes:[...h.scannedBarcodes,x],analysisError:null})})},[s,n]),V=P.useCallback((x,h)=>{s(v=>({...v,scannedBarcodes:v.scannedBarcodes.map(c=>c.barcode===x?{...c,portionMultiplier:h}:c)})),d.info("MEAL_SCAN_FLOW","Barcode portion changed",{clientScanId:n.current,barcode:x,newMultiplier:h})},[s,n]),O=P.useCallback(x=>{s(h=>({...h,scannedBarcodes:h.scannedBarcodes.filter(v=>v.barcode!==x)})),d.info("MEAL_SCAN_FLOW","Barcode removed",{clientScanId:n.current,barcode:x,remainingBarcodes:a.scannedBarcodes.length-1})},[s,n,a.scannedBarcodes.length]);return{handlePhotoCapture:I,handleRetake:N,handleProceedToProcessing:A,handleProductScanned:U,handleProductPortionChange:R,handleProductRemove:W,handleBarcodeDetected:C,handleBarcodePortionChange:V,handleBarcodeRemove:O}}function va({scanFlowState:a,setScanFlowState:s,clientScanIdRef:t,processingGuardRef:i,onAnalysisError:n,onSuccess:o}){const l=P.useCallback(b=>{d.info("BARCODE_PIPELINE","Barcode detected",{clientScanId:t.current,barcode:b.barcode}),s(j=>({...j,scannedBarcodes:[b],analysisError:null,progress:33,progressMessage:"Code-Barre Détecté",progressSubMessage:"Prêt pour l'analyse"}))},[s,t]),g=P.useCallback(async()=>{if(i.current||a.scannedBarcodes.length===0)return;i.current=!0;const b=a.scannedBarcodes[0],j=t.current;try{s(N=>({...N,isProcessing:!0,currentStep:"processing",analysisError:null,progress:20,progressMessage:"Analyse du Code-Barre",progressSubMessage:"Connexion à OpenFoodFacts..."})),d.info("BARCODE_PIPELINE","Starting barcode analysis",{clientScanId:j,barcode:b.barcode}),await new Promise(N=>setTimeout(N,500)),s(N=>({...N,progress:40,progressSubMessage:"Récupération du produit..."}));const r=await K.getProductByBarcode(b.barcode);if(!r.success||!r.product)throw new Error(r.error||"Produit non trouvé dans la base OpenFoodFacts");d.info("BARCODE_PIPELINE","Product found",{clientScanId:j,barcode:b.barcode,productName:r.product.name}),s(N=>({...N,progress:60,progressSubMessage:"Analyse des données nutritionnelles..."})),await new Promise(N=>setTimeout(N,500));const w=K.convertToMealItem(r.product,b.portionMultiplier);if(!w)throw new Error("Impossible de convertir les données nutritionnelles");s(N=>({...N,progress:80,progressSubMessage:"Finalisation des données..."})),await new Promise(N=>setTimeout(N,500));const I={scannedProduct:{barcode:r.product.barcode,name:r.product.name,brand:r.product.brand,image_url:r.product.image_url,mealItem:w,portionMultiplier:b.portionMultiplier,scannedAt:b.scannedAt},totalCalories:w.calories,totalProteins:w.proteins,totalCarbs:w.carbs,totalFats:w.fats,productDetails:{name:r.product.name,brand:r.product.brand,image_url:r.product.image_url,barcode:r.product.barcode,portionSize:r.product.portion_size||"100g"}};s(N=>({...N,barcodeAnalysisResults:I,progress:100,progressMessage:"Analyse Terminée",progressSubMessage:"Produit identifié avec succès"})),await new Promise(N=>setTimeout(N,500)),s(N=>({...N,currentStep:"results"})),o(),d.info("BARCODE_PIPELINE","Analysis completed",{clientScanId:j,barcode:b.barcode,productName:r.product.name,calories:w.calories})}catch(r){d.error("BARCODE_PIPELINE","Analysis failed",{clientScanId:j,barcode:b.barcode,error:r instanceof Error?r.message:"Unknown error"}),n(r instanceof Error?r.message:"Erreur lors de l'analyse du code-barre")}finally{s(r=>({...r,isProcessing:!1})),i.current=!1}},[a.scannedBarcodes,s,t,i,n,o]),p=P.useCallback(()=>{s(b=>({...b,scannedBarcodes:[],barcodeAnalysisResults:null,analysisError:null,currentStep:"capture",progress:0,progressMessage:"Scanner un Code-Barre",progressSubMessage:"Prêt pour un nouveau scan"})),d.info("BARCODE_PIPELINE","Barcode retake requested",{clientScanId:t.current})},[s,t]);return{handleBarcodeDetected:l,handleBarcodeScan:g,handleBarcodeRetake:p}}const Na=({barcode:a,productImage:s,progress:t,progressMessage:i,progressSubMessage:n})=>e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx(Y,{currentStep:"processing",progress:t,message:i,subMessage:n}),e.jsx(f.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4},children:e.jsx(D,{className:"p-6",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(79, 70, 229, 0.05))",borderColor:"rgba(99, 102, 241, 0.3)"},children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-6",children:[e.jsxs("div",{className:"w-32 h-32 rounded-3xl flex items-center justify-center relative overflow-hidden",style:{background:s?"rgba(99, 102, 241, 0.1)":"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.15))",border:"2px solid rgba(99, 102, 241, 0.4)"},children:[s?e.jsx(f.img,{src:s,alt:"Product",className:"w-full h-full object-contain p-2",initial:{opacity:0},animate:{opacity:1},transition:{duration:.5}}):e.jsx(f.div,{animate:{scale:[1,1.1,1],rotate:[0,5,-5,0]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(m,{Icon:u.ScanBarcode,size:64,className:"text-indigo-300"})}),e.jsx(f.div,{className:"absolute inset-0 rounded-3xl",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), transparent)"},animate:{opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-white font-bold text-xl",children:"Analyse du Code-Barre"}),e.jsx("p",{className:"text-indigo-300 text-sm font-mono",children:a}),e.jsx("p",{className:"text-gray-300 text-sm max-w-md",children:"Récupération des données nutritionnelles depuis OpenFoodFacts..."})]}),e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"h-2 rounded-full overflow-hidden",style:{background:"rgba(99, 102, 241, 0.15)"},children:e.jsx(f.div,{className:"h-full rounded-full",style:{background:"linear-gradient(90deg, #6366F1, #818CF8)"},initial:{width:"0%"},animate:{width:`${t}%`},transition:{duration:.3}})}),e.jsxs("p",{className:"text-indigo-300 text-xs mt-2 text-center",children:[Math.round(t),"% complété"]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-4 w-full max-w-md",children:[{icon:u.Database,label:"OpenFoodFacts"},{icon:u.Package,label:"Produit"},{icon:u.TrendingUp,label:"Nutrition"}].map((o,l)=>e.jsxs(f.div,{className:"flex flex-col items-center gap-2 p-3 rounded-xl",style:{background:"rgba(99, 102, 241, 0.08)",border:"1px solid rgba(99, 102, 241, 0.2)"},initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:l*.1},children:[e.jsx(f.div,{animate:{scale:t>(l+1)*30?[1,1.2,1]:1},transition:{duration:.3},children:e.jsx(m,{Icon:o.icon,size:20,className:t>(l+1)*30?"text-indigo-300":"text-gray-500"})}),e.jsx("span",{className:`text-xs font-medium ${t>(l+1)*30?"text-indigo-300":"text-gray-500"}`,children:o.label})]},o.label))})]})})})]}),wa=({barcodeResults:a,onSaveMeal:s,isSaving:t,onRetake:i,onNewScan:n})=>{const[o,l]=_.useState(a.scannedProduct.portionMultiplier),g=w=>{l(w)},p=Math.round(a.totalCalories*o),b=Math.round(a.totalProteins*o),j=Math.round(a.totalCarbs*o),r=Math.round(a.totalFats*o);return e.jsxs("div",{className:"space-y-6 w-full pb-32",children:[e.jsx(Y,{currentStep:"results",progress:100,message:"Analyse Terminée",subMessage:"Produit identifié avec succès"}),e.jsx(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4},children:e.jsxs(D,{className:"p-6",style:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(79, 70, 229, 0.05))",borderColor:"rgba(99, 102, 241, 0.35)"},children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[a.productDetails.image_url&&e.jsx("div",{className:"w-24 h-24 rounded-2xl overflow-hidden flex-shrink-0",style:{background:"rgba(99, 102, 241, 0.1)",border:"2px solid rgba(99, 102, 241, 0.3)"},children:e.jsx("img",{src:a.productDetails.image_url,alt:a.productDetails.name,className:"w-full h-full object-contain p-2"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-white font-bold text-xl mb-1",children:a.productDetails.name}),a.productDetails.brand&&e.jsx("p",{className:"text-indigo-300 text-sm mb-2",children:a.productDetails.brand}),e.jsx("p",{className:"text-gray-400 text-xs font-mono",children:a.productDetails.barcode})]})]}),e.jsxs("div",{className:"p-4 rounded-xl mb-4",style:{background:"rgba(99, 102, 241, 0.08)",border:"1px solid rgba(99, 102, 241, 0.2)"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-gray-300 text-sm",children:"Portion"}),e.jsx("span",{className:"text-indigo-300 text-sm font-semibold",children:a.productDetails.portionSize})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>g(Math.max(.25,o-.25)),className:"w-10 h-10 rounded-lg flex items-center justify-center touch-feedback-css",style:{background:"rgba(99, 102, 241, 0.15)",border:"1px solid rgba(99, 102, 241, 0.3)"},children:e.jsx(m,{Icon:u.Minus,size:18,className:"text-indigo-300"})}),e.jsxs("div",{className:"flex-1 text-center",children:[e.jsxs("p",{className:"text-white font-bold text-2xl",children:[o,"x"]}),e.jsx("p",{className:"text-gray-400 text-xs",children:"Multiplicateur de portion"})]}),e.jsx("button",{onClick:()=>g(o+.25),className:"w-10 h-10 rounded-lg flex items-center justify-center touch-feedback-css",style:{background:"rgba(99, 102, 241, 0.15)",border:"1px solid rgba(99, 102, 241, 0.3)"},children:e.jsx(m,{Icon:u.Plus,size:18,className:"text-indigo-300"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{className:"p-4 rounded-xl text-center",style:{background:"linear-gradient(135deg, rgba(251, 146, 60, 0.15), rgba(249, 115, 22, 0.08))",border:"1px solid rgba(251, 146, 60, 0.3)"},children:[e.jsx(m,{Icon:u.Flame,size:24,className:"text-orange-400 mx-auto mb-2"}),e.jsx("p",{className:"text-white font-bold text-2xl mb-1",children:p}),e.jsx("p",{className:"text-orange-300 text-xs font-semibold",children:"Calories"})]}),e.jsxs("div",{className:"p-4 rounded-xl text-center",style:{background:"linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.08))",border:"1px solid rgba(239, 68, 68, 0.3)"},children:[e.jsx(m,{Icon:u.Drumstick,size:24,className:"text-red-400 mx-auto mb-2"}),e.jsxs("p",{className:"text-white font-bold text-2xl mb-1",children:[b,"g"]}),e.jsx("p",{className:"text-red-300 text-xs font-semibold",children:"Protéines"})]}),e.jsxs("div",{className:"p-4 rounded-xl text-center",style:{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.08))",border:"1px solid rgba(59, 130, 246, 0.3)"},children:[e.jsx(m,{Icon:u.Wheat,size:24,className:"text-blue-400 mx-auto mb-2"}),e.jsxs("p",{className:"text-white font-bold text-2xl mb-1",children:[j,"g"]}),e.jsx("p",{className:"text-blue-300 text-xs font-semibold",children:"Glucides"})]}),e.jsxs("div",{className:"p-4 rounded-xl text-center",style:{background:"linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(202, 138, 4, 0.08))",border:"1px solid rgba(234, 179, 8, 0.3)"},children:[e.jsx(m,{Icon:u.Droplet,size:24,className:"text-yellow-400 mx-auto mb-2"}),e.jsxs("p",{className:"text-white font-bold text-2xl mb-1",children:[r,"g"]}),e.jsx("p",{className:"text-yellow-300 text-xs font-semibold",children:"Lipides"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 p-4 z-50",style:{background:"linear-gradient(to top, rgba(17, 24, 39, 0.98), rgba(17, 24, 39, 0.95), transparent)",pointerEvents:"none"},children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-3",style:{pointerEvents:"auto"},children:[e.jsx("button",{onClick:s,disabled:t,className:"w-full btn-glass touch-feedback-css disabled:opacity-50 disabled:cursor-not-allowed",style:{background:"linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.15))",borderColor:"rgba(16, 185, 129, 0.4)"},children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-white font-semibold",children:"Sauvegarde en cours..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(m,{Icon:u.Check,size:20,className:"text-emerald-400"}),e.jsx("span",{className:"text-white font-semibold",children:"Sauvegarder dans mon historique"})]})})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:i,disabled:t,className:"flex-1 btn-glass touch-feedback-css disabled:opacity-50",style:{background:"rgba(107, 114, 128, 0.1)",borderColor:"rgba(107, 114, 128, 0.3)"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.RotateCcw,size:18,className:"text-gray-400"}),e.jsx("span",{className:"text-gray-300 font-medium text-sm",children:"Rescanner"})]})}),e.jsx("button",{onClick:n,disabled:t,className:"flex-1 btn-glass touch-feedback-css disabled:opacity-50",style:{background:"rgba(99, 102, 241, 0.1)",borderColor:"rgba(99, 102, 241, 0.3)"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Plus,size:18,className:"text-indigo-400"}),e.jsx("span",{className:"text-indigo-300 font-medium text-sm",children:"Nouveau scan"})]})})]})]})})]})},Da=()=>{const a=ge(),s=xe(),{isPerformanceMode:t}=Q(),i=t?"div":f.div,{profile:n,authReady:o,session:l,user:g}=J(),{showToast:p}=he(),{success:b,error:j}=Z(),[r,w]=_.useState(X),[I,N]=_.useState(!1),[A,U]=_.useState(null),R=_.useRef(null),W=_.useRef(!1),M=_.useRef(null),C=l?.user?.id||g?.id||n?.userId,V=!!(r.capturedPhoto||r.isProcessing||r.analysisResults),O=me(({currentLocation:y,nextLocation:z})=>y.pathname===z.pathname?!1:V);P.useEffect(()=>{O.state==="blocked"&&(d.info("MEAL_SCAN_EXIT","Navigation blocked - showing confirmation",{currentStep:r.currentStep,hasCapturedPhoto:!!r.capturedPhoto,isProcessing:r.isProcessing,hasResults:!!r.analysisResults,timestamp:new Date().toISOString()}),U(()=>()=>{O.proceed()}),N(!0))},[O.state,r]),P.useEffect(()=>{const z=setTimeout(()=>{const T=document.getElementById("main-content");T&&T.scrollTo({top:0,behavior:"smooth"}),window.scrollTo({top:0,behavior:"smooth"})},100);return d.debug("MEAL_SCAN_SCROLL","Auto scroll triggered on step change",{currentStep:r.currentStep,progress:r.progress,timestamp:new Date().toISOString()}),()=>clearTimeout(z)},[r.currentStep]),P.useEffect(()=>{d.info("MEAL_SCAN_FLOW_AUTH_DEBUG","Complete auth state in MealScanFlowPage",{hasSession:!!l,sessionUserId:l?.user?.id,sessionUserEmail:l?.user?.email,sessionAccessToken:l?.access_token?"present":"missing",sessionExpiresAt:l?.expires_at,hasUser:!!g,userIdDirect:g?.id,userEmail:g?.email,hasProfile:!!n,profileUserId:n?.userId,profileDisplayName:n?.displayName,profileKeys:n?Object.keys(n):[],authReady:o,userId:C})},[l,g,n,o,C]);const x=ja({scanFlowState:r,setScanFlowState:w,profile:n,userId:C,clientScanIdRef:R,processingGuardRef:W,readyForProcessingRef:M,showToast:p,success:b,errorSound:j,queryClient:s,onAnalysisError:y=>{w(z=>({...z,analysisError:y})),p(`Erreur d'analyse: ${y}`,"error"),j()},onSuccess:()=>{b()}}),h=va({scanFlowState:r,setScanFlowState:w,clientScanIdRef:R,processingGuardRef:W,onAnalysisError:y=>{w(z=>({...z,analysisError:y})),p(`Erreur d'analyse: ${y}`,"error"),j()},onSuccess:()=>{b()}}),v=P.useCallback(y=>{w(z=>({...z,scanType:y,progressMessage:y==="photo-analysis"?"Forge du Repas":"Scanner un Code-Barre",progressSubMessage:y==="photo-analysis"?"Capturez votre carburant nutritionnel":"Scannez le code-barre d'un produit"})),d.info("MEAL_SCAN_FLOW","Scan type selected",{scanType:y,timestamp:new Date().toISOString()})},[w]),[c,F]=_.useState(!1),G=async()=>{if(!C||c)return;const y=!!r.analysisResults,z=!!r.barcodeAnalysisResults;if(!(!y&&!z)){F(!0);try{d.info("MEAL_SCAN_SAVE","Starting meal save and reset process",{userId:C,scanType:r.scanType,hasAnalysisResults:y,hasBarcodeResults:z,totalCalories:y?r.analysisResults.total_calories:r.barcodeAnalysisResults?.totalCalories,hasCapturedPhoto:!!r.capturedPhoto,timestamp:new Date().toISOString()});let T;if(r.capturedPhoto?.file){d.info("MEAL_SCAN_SAVE","Uploading meal photo to storage",{userId:C,fileSize:r.capturedPhoto.file.size,fileType:r.capturedPhoto.file.type,timestamp:new Date().toISOString()});try{const S=await je(r.capturedPhoto.file,C);S.success&&S.signedUrl?(T=S.signedUrl,d.info("MEAL_SCAN_SAVE","Photo uploaded successfully with signed URL",{hasSignedUrl:!0,uploadPath:S.uploadPath,userId:C,timestamp:new Date().toISOString()})):(d.warn("MEAL_SCAN_SAVE","Photo upload failed, continuing without photo",{error:S.error,userId:C,timestamp:new Date().toISOString()}),p({type:"warning",title:"Photo non sauvegardée",message:S.error||"La photo n'a pas pu être sauvegardée, mais votre repas sera enregistré.",duration:4e3}))}catch(S){d.error("MEAL_SCAN_SAVE","Photo upload exception",{error:S instanceof Error?S.message:String(S),userId:C,timestamp:new Date().toISOString()})}}let te;if(r.scanType==="barcode-scan"&&z){const S=r.barcodeAnalysisResults.scannedProduct;te={user_id:C,timestamp:new Date().toISOString(),items:[S.mealItem],total_kcal:r.barcodeAnalysisResults.totalCalories,meal_type:"snack",meal_name:S.name,photo_url:T}}else if(y){const S=[...r.analysisResults.detected_foods||[],...r.scannedProducts.map(re=>re.mealItem)||[]],de=S.reduce((re,ue)=>re+ue.calories,0);te={user_id:C,timestamp:new Date().toISOString(),items:S,total_kcal:de||r.analysisResults.total_calories||0,meal_type:r.analysisResults.meal_type||"dinner",meal_name:r.analysisResults.meal_name,photo_url:T}}else throw new Error("Aucune donnée de repas à sauvegarder");const H=await ve.saveMeal(te);d.info("MEAL_SCAN_SAVE","Meal saved to database, starting cache update",{mealId:H.id,userId:C,timestamp:new Date().toISOString()});const ie=s.getQueryData(["meals-today",C])||[];s.setQueryData(["meals-today",C],[H,...ie]),d.info("MEAL_SCAN_SAVE","Optimistic cache update applied",{mealId:H.id,newMealsCount:ie.length+1,timestamp:new Date().toISOString()}),await Promise.all([s.refetchQueries({queryKey:["meals-today",C],type:"active"}).catch(S=>{if(S?.name!=="CancelledError")throw S;d.debug("MEAL_SCAN_SAVE","meals-today refetch cancelled, ignoring",{userId:C})}),s.refetchQueries({queryKey:["meals-week",C],type:"active"}).catch(S=>{if(S?.name!=="CancelledError")throw S;d.debug("MEAL_SCAN_SAVE","meals-week refetch cancelled, ignoring",{userId:C})}),s.refetchQueries({queryKey:["meals-recent",C],type:"active"}).catch(S=>{if(S?.name!=="CancelledError")throw S;d.debug("MEAL_SCAN_SAVE","meals-recent refetch cancelled, ignoring",{userId:C})}),s.refetchQueries({queryKey:["meals-history",C],type:"active"}).catch(S=>{if(S?.name!=="CancelledError")throw S;d.debug("MEAL_SCAN_SAVE","meals-history refetch cancelled, ignoring",{userId:C})}),s.invalidateQueries({queryKey:["meals-month",C]}),s.invalidateQueries({queryKey:["daily-ai-summary",C]})]),d.info("MEAL_SCAN_SAVE","All meal queries refetched",{mealId:H.id,queries:["meals-today","meals-week","meals-recent","meals-history","meals-month","daily-ai-summary"],timestamp:new Date().toISOString()}),b();const ce=y?r.analysisResults.total_calories:r.barcodeAnalysisResults.totalCalories;p({type:"success",title:"Repas sauvegardé !",message:`${ce} kcal ajoutées à votre forge nutritionnelle${T?" avec photo":""}`,duration:3e3}),d.info("MEAL_SCAN_SAVE","Meal saved successfully, resetting scan state",{mealId:H.id,userId:C,photoSaved:!!T,timestamp:new Date().toISOString()}),I||(w(X),R.current=null,W.current=!1,await new Promise(S=>setTimeout(S,150)),d.info("MEAL_SCAN_SAVE","Navigating to meals page with fresh cache",{mealId:H.id,timestamp:new Date().toISOString()}),a("/meals",{state:{freshMealSaved:!0,mealId:H.id}}))}catch(T){j(),d.error("MEAL_SCAN_SAVE","Failed to save meal",{error:T instanceof Error?T.message:String(T),errorStack:T instanceof Error?T.stack:void 0,userId:C,mealData:{totalCalories:r.analysisResults?.total_calories,itemsCount:r.analysisResults?.detected_foods?.length,mealType:r.analysisResults?.meal_type,hasPhoto:!!photoUrl},timestamp:new Date().toISOString()}),p({type:"error",title:"Erreur de sauvegarde",message:`Impossible de sauvegarder le repas: ${T instanceof Error?T.message:"Erreur inconnue"}. Veuillez réessayer.`,duration:4e3})}finally{F(!1)}}},k=async()=>{try{r.analysisResults?(d.info("MEAL_SCAN_EXIT","Saving meal before exit",{hasResults:!!r.analysisResults,timestamp:new Date().toISOString()}),N(!1),w(X),R.current=null,W.current=!1,A&&(A(),U(null)),G().catch(y=>{d.error("MEAL_SCAN_EXIT","Background save failed",{error:y instanceof Error?y.message:String(y),timestamp:new Date().toISOString()})}),d.info("MEAL_SCAN_EXIT","Navigation allowed, saving in background",{timestamp:new Date().toISOString()})):(N(!1),w(X),R.current=null,A&&(A(),U(null)))}catch(y){d.error("MEAL_SCAN_EXIT","Failed to exit",{error:y instanceof Error?y.message:String(y),timestamp:new Date().toISOString()}),p("Erreur lors de la sortie","error"),N(!1)}},$=()=>{d.info("MEAL_SCAN_EXIT","User chose to discard scan and exit",{currentStep:r.currentStep,hasCapturedPhoto:!!r.capturedPhoto,hasResults:!!r.analysisResults,timestamp:new Date().toISOString()}),w(X),R.current=null,W.current=!1,N(!1),A&&(A(),U(null))},E=()=>{d.info("MEAL_SCAN_EXIT","User cancelled exit, continuing scan",{currentStep:r.currentStep,timestamp:new Date().toISOString()}),N(!1),U(null),O.state==="blocked"&&O.reset()};if(!o)return e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx(ne,{icon:"Loader",title:"Chargement...",subtitle:"Initialisation de votre session",circuit:"meal-scan"}),e.jsxs(D,{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-blue-400 border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-gray-300",children:"Chargement de votre session..."})]})]});if(!C)return e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx(ne,{icon:"LogIn",title:"Connexion Requise",subtitle:"Connectez-vous pour analyser vos repas",circuit:"meal-scan"}),e.jsxs(D,{className:"p-8 text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Connexion Requise"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Vous devez être connecté pour utiliser l'analyse de repas."}),e.jsx("button",{onClick:()=>a("/auth/login"),className:"btn-glass--primary w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.LogIn,size:16}),e.jsx("span",{children:"Se Connecter"})]})})]})]});if(!n)return d.warn("MEAL_SCAN_FLOW_NO_PROFILE","CRITICAL: No profile detected, showing incomplete profile",{hasProfile:!!n,hasSessionInfo:!!sessionInfo,authReady:o,userId:C,profileType:typeof n,profileStringified:n?JSON.stringify(n,null,2).substring(0,500)+"...":"null",userStoreProfileState:{profile:!!J.getState().profile,profileUserId:J.getState().profile?.userId,profileDisplayName:J.getState().profile?.displayName},timestamp:new Date().toISOString()}),e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx(ne,{icon:"User",title:"Profil Incomplet",subtitle:"Complétez votre profil pour des analyses nutritionnelles personnalisées",circuit:"meal-scan"}),e.jsxs(D,{className:"p-8 text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Profil Incomplet"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Complétez votre profil pour bénéficier d'analyses nutritionnelles personnalisées."}),e.jsx("button",{onClick:()=>a("/profile"),className:"btn-glass--primary w-full mb-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.User,size:16}),e.jsx("span",{children:"Compléter le Profil"})]})}),e.jsx("button",{onClick:()=>a("/"),className:"btn-glass--secondary-nav w-full",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.Home,size:16}),e.jsx("span",{children:"Retour à l'accueil"})]})})]})]});const L=()=>{if(r.analysisError&&r.currentStep==="processing")return e.jsxs(D,{className:"p-8 text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(m,{Icon:u.AlertCircle,size:48,className:"text-red-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"Erreur d'analyse"}),e.jsx("p",{className:"text-gray-300",children:r.analysisError})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>a("/meals"),className:"flex-1 btn-glass--secondary-nav",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.ArrowLeft,size:16}),e.jsx("span",{children:"Retour"})]})}),e.jsx("button",{onClick:x.handleRetake,className:"flex-1 btn-glass--primary",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(m,{Icon:u.RotateCcw,size:16}),e.jsx("span",{children:"Réessayer"})]})})]})]});switch(r.currentStep){case"capture":return e.jsx(na,{scanType:r.scanType,onSelectScanType:v,capturedPhoto:r.capturedPhoto,scannedBarcodes:r.scannedBarcodes,scannedProducts:r.scannedProducts,onPhotoCapture:x.handlePhotoCapture,onBarcodeDetected:r.scanType==="barcode-scan"?h.handleBarcodeDetected:x.handleBarcodeDetected,onProductScanned:x.handleProductScanned,onProductPortionChange:x.handleProductPortionChange,onProductRemove:x.handleProductRemove,onBarcodePortionChange:x.handleBarcodePortionChange,onBarcodeRemove:x.handleBarcodeRemove,onRetake:r.scanType==="barcode-scan"?h.handleBarcodeRetake:x.handleRetake,onBack:()=>a("/meals"),onProceedToProcessing:r.scanType==="barcode-scan"?h.handleBarcodeScan:x.handleProceedToProcessing,isProcessingInProgress:r.isProcessing,readyForProcessingRef:M,progress:r.progress,progressMessage:r.progressMessage,progressSubMessage:r.progressSubMessage});case"processing":return r.scanType==="barcode-scan"?e.jsx(Na,{barcode:r.scannedBarcodes[0]?.barcode||"",productImage:r.scannedBarcodes[0]?.image_url,progress:r.progress,progressMessage:r.progressMessage,progressSubMessage:r.progressSubMessage}):e.jsx(ua,{capturedPhoto:r.capturedPhoto,progress:r.progress,progressMessage:r.progressMessage,progressSubMessage:r.progressSubMessage});case"results":return r.scanType==="barcode-scan"&&r.barcodeAnalysisResults?e.jsx(wa,{barcodeResults:r.barcodeAnalysisResults,onSaveMeal:G,isSaving:c,onRetake:h.handleBarcodeRetake,onNewScan:()=>{w(X),R.current=oe()}}):e.jsx(ha,{analysisResults:r.analysisResults,capturedPhoto:r.capturedPhoto,progress:r.progress,progressMessage:r.progressMessage,progressSubMessage:r.progressSubMessage,onSaveMeal:G,isSaving:c,onRetake:x.handleRetake,onNewScan:()=>{w(X),R.current=oe()}});default:return null}};return e.jsxs("div",{className:"w-full min-w-0 pb-8",style:{overflow:"visible !important"},children:[e.jsx(se,{mode:"wait",children:e.jsx(i,{className:"meal-scan-step pb-6","data-step":r.currentStep,...!t&&{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3}},style:{minHeight:"auto",overflow:"visible"},children:L()},r.currentStep)}),e.jsx(fe,{children:e.jsx(ye,{isOpen:I,onSaveAndExit:k,onDiscardAndExit:$,onCancel:E,hasResults:!!r.analysisResults,isProcessing:r.isProcessing,capturedPhoto:r.capturedPhoto})})]})};export{Da as default};
