const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/page-fridge-C1QVLxk9.js","assets/vendor-ZbFMzY-i.js","assets/utils-CUtLAp28.js","assets/supabase-8_3juhcZ.js","assets/stores-ZZM8MTtI.js","assets/ui-components-OHztaiDj.js","assets/motion-HGAT--uT.js","assets/page-fridge-scan-C_CisW7P.js","assets/page-fridge-scan-DAz6gEg3.css","assets/ui-components-DyoLTZgZ.css","assets/date-utils-BlBdbPk_.js","assets/normalizeSkinTone---q_oCYc.js"])))=>i.map(i=>d[i]);
import{h as Oe,u as ye,r as A,R as de,j as o}from"./vendor-ZbFMzY-i.js";import{a as ve,t as Z}from"./stores-ZZM8MTtI.js";import{B as we}from"./BodyScanProgressHeader-DadWtsli.js";import{u as me}from"./useBodyScanPerformance-CZTD3PbH.js";import{t as ee,n as G,u as Ee,A as Me}from"./Avatar3DViewer-Br1Jt5km.js";import{u as je,N as z,G as Q,S as T,I as D}from"./ui-components-OHztaiDj.js";import{l as c,_ as J,u as se,s as Pe}from"./page-fridge-C1QVLxk9.js";import{resolveSkinTone as Ce,isSkinToneV2 as ne}from"./normalizeSkinTone---q_oCYc.js";import"./utils-CUtLAp28.js";import"./supabase-8_3juhcZ.js";import"./mobileDetection-qVCXVKdX.js";import"./signedUrlService-DzLcvpbH.js";import"./debugFlags-CvPyqWqQ.js";import"./motion-HGAT--uT.js";import"./page-fridge-scan-C_CisW7P.js";import"./date-utils-BlBdbPk_.js";function Ne(e){if(!e||typeof e!="string")return c.warn("Invalid dbKey provided to toBlenderKey",{dbKey:e,type:typeof e}),null;const n=ee(e),r={pregnant:"BS_LOD0.BodyPregnant",pearFigure:"BS_LOD0.BodyPearFigure",bigHips:"BS_LOD0.BodyBigHips",assLarge:"BS_LOD0.BodyAssLarge",narrowWaist:"BS_LOD0.BodyNarrowWaist",bodybuilderSize:"BS_LOD0.BodyBodybuilderSize",bodybuilderDetails:"BS_LOD0.BodyBodybuilderDetails",emaciated:"BS_LOD0.BodyEmaciated",superBreast:"BS_LOD0.BodySuperBreast",breastsSmall:"BS_LOD0.BodyBreastsSmall",breastsSag:"BS_LOD0.BodyBreastsSag",animeWaist:"BS_LOD0.BodyAnimeWaist",dollBody:"BS_LOD0.BodyDollBody",nipples:"BS_LOD0.BodyNipples",animeNeck:"BS_LOD0.BodyAnimeNeck",animeProportion:"BS_LOD0.BodyAnimeProportion",eyesClosedL:"BS_LOD0.AnimEyesClosedL",eyesClosedR:"BS_LOD0.AnimEyesClosedR",FaceLowerEyelashLength:"BS_LOD0.FaceLowerEyelashLength",eyelashLength:"BS_LOD0.FaceEyelashLength",eyelashesSpecial:"BS_LOD0.FaceEyelashesSpecial",eyesShape:"BS_LOD0.FaceEyesShape",eyesSpacing:"BS_LOD0.FaceEyesSpacing",eyesDown:"BS_LOD0.FaceEyesDown",eyesUp:"BS_LOD0.FaceEyesUp",eyesSpacingWide:"BS_LOD0.FaceEyesSpacingWide",FaceJawWidth:"BS_LOD0.FaceJawWidth",FaceCheekFullness:"BS_LOD0.FaceCheekFullness",FaceCheeksSize:"BS_LOD0.FaceCheeksSize",FaceNoseSize:"BS_LOD0.FaceNoseSize",FaceEyeSize:"BS_LOD0.FaceEyeSize",FaceLipThickness:"BS_LOD0.FaceLipThickness",FaceChinLength:"BS_LOD0.FaceChinLength",FaceChinSize:"BS_LOD0.FaceChinSize",FaceForeheadHeight:"BS_LOD0.FaceForeheadHeight",FaceBrowHeight:"BS_LOD0.FaceBrowHeight",FaceEarSize:"BS_LOD0.FaceEarSize",FaceHeadSize:"BS_LOD0.FaceHeadSize",FaceNarrow:"BS_LOD0.FaceNarrow",FaceNoseAngle:"BS_LOD0.FaceNoseAngle",FaceNoseHump:"BS_LOD0.FaceNoseHump",FaceNoseNarrow:"BS_LOD0.FaceNoseNarrow",FaceNoseSmall:"BS_LOD0.FaceNoseSmall",FaceNoseWide:"BS_LOD0.FaceNoseWide",FaceRoundFace:"BS_LOD0.FaceRoundFace",FaceSymmetry:"BS_LOD0.FaceSymmetry",FaceLongFace:"BS_LOD0.FaceLongFace",FaceCheekbones:"BS_LOD0.FaceCheekbones",FaceMouthWidth:"BS_LOD0.FaceMouthWidth",FaceMouthSize:"BS_LOD0.FaceMouthSize",FaceLipsToMegalips:"BS_LOD0.FaceLipsToMegalips",FaceNostrilsFlare:"BS_LOD0.FaceNostrilsFlare"};if(r[n])return r[n];if(n.startsWith("Face")){const a=`BS_LOD0.${n}`;return c.warn("Attempted to construct Blender key for face morph (should be in direct mapping)",{dbKey:n,blenderKey:a}),a}const t=`BS_LOD0.Body${n.charAt(0).toUpperCase()+n.slice(1)}`;return c.trace("Blender key generated",{dbKey:n,blenderKey:t,method:r[n]?"direct_mapping":"constructed"}),t}function _e(e,n){const r=n==="male"?e.mapping_masculine:e.mapping_feminine;if(!r||!r.morph_values)throw c.error("MORPH_POLICY","Invalid gender mapping - missing morph_values",{gender:n,hasGenderMapping:!!r,genderMappingKeys:r?Object.keys(r):[],philosophy:"db_validation_failed"}),new Error(`Invalid gender mapping for ${n} - missing morph_values`);c.info("MORPH_POLICY","Building morph policy from gender-specific mapping",{gender:n,mappingMorphValuesCount:Object.keys(r.morph_values).length,mappingLimbMassesCount:Object.keys(r.limb_masses).length,philosophy:"ai_driven_db_bounds_only_no_caps_mutex"});const t=[],a=[],i={};return Object.entries(r.morph_values).forEach(([l,m])=>{if(!m||typeof m.min!="number"||typeof m.max!="number"){c.warn("MORPH_POLICY","Invalid range for morph key",{key:l,range:m,gender:n,philosophy:"db_validation_warning"});return}const y=ee(l);i[y]=m,m.min===0&&m.max===0?(a.push(y),c.debug("MORPH_POLICY","Morph banned by DB range [0,0]",{key:y,gender:n,philosophy:"db_banned_morph"})):t.push(y)}),["FaceLowerEyelashLength","eyelashLength","eyelashesSpecial","eyesShape","eyesSpacing","eyesDown","eyesUp","eyesSpacingWide","eyesClosedL","eyesClosedR"].forEach(l=>{const m=ee(l);!a.includes(m)&&!t.includes(m)&&(a.push(m),i[m]||(i[m]={min:-2,max:2}))}),c.info("MORPH_POLICY","DB-only morph policy built",{gender:n,mappingSource:n==="male"?"mapping_masculine":"mapping_feminine",requiredKeys:t.length,optionalKeys:a.length,totalRanges:Object.keys(i).length,philosophy:"ai_driven_db_bounds_only"}),{requiredKeys:t,optionalKeys:a,ranges:i}}const De=Object.freeze(Object.defineProperty({__proto__:null,buildMorphPolicy:_e},Symbol.toStringTag,{value:"Module"}));function Le(){return{DISABLE_LIMB_TO_MORPH:!1,FALLBACK_MODE:"PERMISSIVE",ENFORCE_CAPS_MUTEX:!1,STRICT_ARCHETYPE_MATCH:!1,AI_REFINE_MODE:"PERMISSIVE"}}function Re(e,n,r){const t=r==="male"?n.mapping_masculine:n.mapping_feminine;if(c.info("MORPH_BLEND","Starting client-side archetype blending",{archetypesCount:e.length,gender:r,mappingMorphValuesCount:Object.keys(t.morph_values).length,mappingLimbMassesCount:Object.keys(t.limb_masses).length,primaryArchetype:e[0]?.id}),e.length===0)throw new Error("No archetypes provided for blending");const a=Fe(e),i=new Set,s=new Set;e.forEach(u=>{Object.keys(u.morph_values||{}).forEach(p=>{i.add(ee(p))}),Object.keys(u.limb_masses||{}).forEach(p=>{s.add(p)})});const l={};for(const u of i){let p=0,k=0;e.forEach((F,d)=>{const C=a[d][1];let L=0;const j=[u,u.toLowerCase(),`Body${u}`];for(const B of j)if(F.morph_values&&B in F.morph_values){L=F.morph_values[B];break}p+=L*C,k+=C}),l[u]=k>0?p/k:0}const m={};for(const u of s){let p=0,k=0;e.forEach((F,d)=>{const C=a[d][1],L=F.limb_masses?.[u]||1;p+=L*C,k+=C}),m[u]=k>0?p/k:1}const y=Be(e,a),E=Ve(e,a,l);return c.info("MORPH_BLEND","Archetype blending completed",{blendedShapeKeys:Object.keys(l).length,blendedLimbKeys:Object.keys(m).length,confidence:y.toFixed(3),qualityScore:E.toFixed(3),weights:a.map(([u,p])=>({id:u,weight:p.toFixed(3)}))}),{shape_params:l,limb_masses:m,blend_weights:a,confidence:y,quality_score:E}}function Fe(e){if(e.length===1)return[[e[0].id,1]];const n=e.map(u=>{const k=1/(.1+(u.distance||1));return[u.id,k]}),r=n.reduce((u,[p,k])=>u+k,0),t=n.map(([u,p])=>[u,p/r]),a=2,i=t.map(([u,p])=>[u,Math.exp(p/a)]),s=i.reduce((u,[p,k])=>u+k,0),m=i.map(([u,p])=>[u,p/s]).filter(([u,p])=>p>=.01),y=m.reduce((u,[p,k])=>u+k,0),E=m.map(([u,p])=>[u,p/y]);return c.debug("MORPH_BLEND","Blend weights calculated",{originalCount:e.length,significantCount:E.length,weights:E.map(([u,p])=>({id:u,weight:p.toFixed(3)}))}),E}function Be(e,n){if(e.length===0)return 0;const r=e.reduce((m,y)=>m+(y.distance||1),0)/e.length,t=Math.max(.1,1/(1+r)),a=Math.min(.2,e.length*.05),i=-n.reduce((m,[y,E])=>m+(E>0?E*Math.log(E):0),0),s=Math.log(n.length),l=s>0?i/s*.1:0;return Math.min(.95,t+a+l)}function Ve(e,n,r){let t=1;Object.entries(r).forEach(([s,l])=>{Math.abs(l)>3&&(t*=.9)});const a=n.filter(([s,l])=>l>.1).length,i=Math.min(.2,a*.05);return Math.max(.1,Math.min(1,t+i))}function Te(e,n){const r={...e};return n.requiredKeys.forEach(t=>{if(!(t in r)){const a=n.ranges[t],i=a&&a.min<=0&&a.max>=0?0:a?(a.min+a.max)/2:0;r[t]=i,c.debug("MORPH_BLEND","Added missing required key",{key:t,defaultValue:i.toFixed(3),range:a?`[${a.min}, ${a.max}]`:"no_range"})}}),c.debug("MORPH_BLEND","Shape params completed",{originalKeys:Object.keys(e).length,completeKeys:Object.keys(r).length,addedKeys:Object.keys(r).length-Object.keys(e).length}),r}function Se(e,n){const r={};return e.requiredKeys.forEach(t=>{const a=e.ranges[t];if(a&&a.min===0&&a.max===0){r[t]=0;return}a?a.min<=0&&a.max>=0?r[t]=0:r[t]=Math.abs(a.min)<Math.abs(a.max)?a.min:a.max:r[t]=0}),n==="male"&&("pregnant"in r&&(r.pregnant=0),"nipples"in r&&(r.nipples=0),"superBreast"in r&&(r.superBreast=0),"animeProportion"in r&&(r.animeProportion=0)),c.info("MORPH_PAYLOAD","PHASE A.4: Generated strict DB-only fallback",{gender:n,keysCount:Object.keys(r).length,sampleKeys:Object.keys(r).slice(0,5),bannedKeysForced:Object.entries(r).filter(([t,a])=>a===0).length,philosophy:"phase_a_strict_db_only_no_contradictory_morphs"}),r}function He(){return{gate:1,armMass:1,calfMass:1,neckMass:1,thighMass:1,torsoMass:1,forearmMass:1}}function Ke(e,n,r){const t=r==="male"?n.mapping_masculine:n.mapping_feminine,a={...e};return Object.keys(t.limb_masses).forEach(i=>{if(!(i in a)){const s=t.limb_masses[i];a[i]=s&&s.min<=1&&s.max>=1?1:s?(s.min+s.max)/2:1,c.debug("MORPH_PAYLOAD","Added missing limb mass with default value",{key:i,defaultValue:a[i],range:s?`[${s.min}, ${s.max}]`:"no_range",gender:r,philosophy:"ai_driven_completion"})}}),c.debug("MORPH_PAYLOAD","Limb masses completed for AI-driven processing",{originalKeys:Object.keys(e).length,completeKeys:Object.keys(a).length,addedKeys:Object.keys(a).length-Object.keys(e).length,gender:r,philosophy:"ai_driven_completion"}),a}function Ue(e){const n=[];return e.commit?.photos_metadata&&Array.isArray(e.commit.photos_metadata)&&e.commit.photos_metadata.forEach(r=>{r.type&&r.url&&n.push({view:r.type,url:r.url,report:r.captureReport||r.report})}),n.length===0&&e.estimate?.photos_metadata&&Array.isArray(e.estimate.photos_metadata)&&e.estimate.photos_metadata.forEach(r=>{r.view&&r.url&&n.push({view:r.view,url:r.url,report:r.report})}),c.debug("MORPH_PAYLOAD","Extracted photos for AI refinement",{photosCount:n.length,photoViews:n.map(r=>r.view),hasReports:n.filter(r=>!!r.report).length}),n}function Ye(e,n,r,t,a){let i="comprehensive_fallback";if(t.FALLBACK_MODE==="DB_ONLY"){if(c.info("MORPH_PAYLOAD","Using DB-ONLY fallback mode",{finalGender:r,philosophy:"phase_a_strict_db_only_no_generic_morphs"}),e.match?.ai_refinement?.ai_refine&&e.match?.ai_refinement?.final_shape_params)return c.info("MORPH_PAYLOAD","Using AI-refined results from scan results"),i="ai_refined_from_scan_results",{shape_params:G(e.match.ai_refinement.final_shape_params??{},r,a),limb_masses:e.match.ai_refinement.final_limb_masses??{},strategy:i};if(e.match?.selected_archetypes&&e.match.selected_archetypes.length>0){const s=e.match.selected_archetypes[0];return c.info("MORPH_PAYLOAD","Using primary archetype (DB-only mode)",{archetypeId:s.id,archetypeName:s.name,philosophy:"phase_a_strict_db_archetype_only"}),i="primary_archetype_db_only",{shape_params:G(s.morph_values??{},r,a),limb_masses:s.limb_masses??{},strategy:i}}return c.warn("MORPH_PAYLOAD","No archetype data available, using strict DB-only fallback"),i="strict_db_only_fallback",{shape_params:Se(n,r),limb_masses:generateStrictDBOnlyLimbMasses(n,r),strategy:i}}if(e.match?.blended_shape_params&&Object.keys(e.match.blended_shape_params).length>0)return c.debug("MORPH_PAYLOAD","Using blended data from match result"),i=e.match?.strategy_used??e.match?.strategy??"match_blended_data",{shape_params:G(e.match.blended_shape_params,r,a),limb_masses:e.match.blended_limb_masses??{},strategy:i};if(e.match?.selected_archetypes&&e.match.selected_archetypes.length>0){const s=e.match.selected_archetypes[0];return c.debug("MORPH_PAYLOAD","Using primary archetype data",{archetypeId:s.id,archetypeName:s.name}),i=e.match?.strategy_used??e.match?.strategy??"primary_archetype",{shape_params:G(s.morph_values??{},r,a),limb_masses:s.limb_masses??{},strategy:i}}return e.semantic?.semantic_profile?.validated_morph_values?(c.debug("MORPH_PAYLOAD","Using validated morph values from semantic"),i=e.match?.strategy_used??e.match?.strategy??"semantic_validated",{shape_params:G(e.semantic.semantic_profile.validated_morph_values,r,a),limb_masses:{},strategy:i}):e.estimate?.extracted_data?.shape_params?(c.debug("MORPH_PAYLOAD","Using shape params from estimate"),i=e.match?.strategy_used??e.match?.strategy??"estimate_data",{shape_params:G(e.estimate.extracted_data.shape_params,r,a),limb_masses:e.estimate.extracted_data.limb_masses??{},strategy:i}):(c.warn("MORPH_PAYLOAD","PHASE A.4: No morph data found, using comprehensive fallback"),i=e.match?.strategy_used??e.match?.strategy??"comprehensive_fallback",{shape_params:We(n,r),limb_masses:He(),strategy:i})}function We(e,n){return Se(e,n)}function he(e,n,r,t){const a=new Set(Object.keys(n.mapping_masculine.morph_values)),i=new Set(Object.keys(n.mapping_feminine.morph_values)),s=new Set([...a,...i]);r==="male"?n.mapping_masculine:n.mapping_feminine;const l={};let m=0;return Object.entries(e).forEach(([y,E])=>{const u=ee(y);s.has(u)?l[u]=E:(m++,c.warn("MORPH_PAYLOAD","PHASE A.4: Rejected non-DB key",{originalKey:y,canonicalKey:u,value:typeof E=="number"?E.toFixed(3):E,gender:r,source:t,reason:"key_not_in_stable_allowlist",philosophy:"strict_allowlisting"}))}),c.info("MORPH_PAYLOAD","PHASE A.4: Stable allowlisting applied to shape params",{originalKeys:Object.keys(e).length,allowlistedKeys:Object.keys(l).length,rejectedKeys:m,stableAllowlistSize:s.size,gender:r,source:t,philosophy:"stable_union_allowlisting"}),l}function ge(e,n,r,t){const a=new Set(Object.keys(n.mapping_masculine.limb_masses)),i=new Set(Object.keys(n.mapping_feminine.limb_masses)),s=new Set([...a,...i]);r==="male"?n.mapping_masculine:n.mapping_feminine;const l={};let m=0;return Object.entries(e).forEach(([y,E])=>{s.has(y)?l[y]=E:(m++,c.warn("MORPH_PAYLOAD","PHASE A.4: Rejected non-DB limb mass key",{key:y,value:typeof E=="number"?E.toFixed(3):E,gender:r,source:t,reason:"key_not_in_stable_allowlist",philosophy:"strict_allowlisting"}))}),c.info("MORPH_PAYLOAD","PHASE A.4: Stable allowlisting applied to limb masses",{originalKeys:Object.keys(e).length,allowlistedKeys:Object.keys(l).length,rejectedKeys:m,stableAllowlistSize:s.size,gender:r,source:t,philosophy:"stable_union_allowlisting"}),l}function te(e,n,r){const t=r==="male"?n.mapping_masculine:n.mapping_feminine,a={...e};return Object.entries(a).forEach(([i,s])=>{const l=t.morph_values[i];if(l&&typeof s=="number"){const m=Math.max(l.min,Math.min(l.max,s));Math.abs(s-m)>.001&&(c.debug("MORPH_CONSTRAINTS","Clamped value to DB range",{key:i,original:s.toFixed(3),clamped:m.toFixed(3),range:`[${l.min}, ${l.max}]`}),a[i]=m)}}),a}function re(e,n,r){const t=r==="male"?n.mapping_masculine:n.mapping_feminine,a={...e};return Object.entries(a).forEach(([i,s])=>{const l=t.limb_masses[i];if(l&&typeof s=="number"){const m=Math.max(l.min,Math.min(l.max,s));Math.abs(s-m)>.001&&(c.debug("MORPH_CONSTRAINTS","Clamped limb mass to DB range",{key:i,original:s.toFixed(3),clamped:m.toFixed(3),range:`[${l.min}, ${l.max}]`,philosophy:"ai_driven_db_only"}),a[i]=m)}}),a}function ie(e){const n={};return Object.entries(e).forEach(([r,t])=>{const a=Ne(r);a?n[a]=t:c.warn("MORPH_PAYLOAD","No Blender key mapping found",{dbKey:r})}),c.debug("MORPH_PAYLOAD","Converted to Blender keys",{dbKeysCount:Object.keys(e).length,blenderKeysCount:Object.keys(n).length}),n}function ze(e,n,r){return{missing_required:[],missing_optional:[]}}async function $e(e){const{validateRefineResponse:n}=await J(async()=>{const{validateRefineResponse:m}=await import("./types-CMUW8gDJ.js");return{validateRefineResponse:m}},[]),{RefineResponse:r}=await J(async()=>{const{RefineResponse:m}=await import("./types-CMUW8gDJ.js");return{RefineResponse:m}},[]),{supabase:t}=await J(async()=>{const{supabase:m}=await import("./page-fridge-C1QVLxk9.js").then(y=>y.q);return{supabase:m}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),a={};Object.entries(e.blend_limb_masses).forEach(([m,y])=>{typeof y=="number"&&isFinite(y)&&(a[m]=y)}),c.info("MORPH_PAYLOAD","Calling scan-refine-morphs Edge Function",{scanId:e.scan_id,userId:e.user_id,resolvedGender:e.resolvedGender,photosCount:e.photos.length,blendShapeParamsCount:Object.keys(e.blend_shape_params).length,blendLimbMassesCount:Object.keys(a).length,originalLimbMassesCount:Object.keys(e.blend_limb_masses).length,filteredOutKeys:Object.keys(e.blend_limb_masses).filter(m=>typeof e.blend_limb_masses[m]!="number"||!isFinite(e.blend_limb_masses[m])),mappingVersion:e.mapping_version,hasUserMeasurements:!!e.user_measurements,philosophy:"ai_driven_edge_function_call"});const{data:i,error:s}=await t.functions.invoke("scan-refine-morphs",{body:{...e,blend_limb_masses:a,user_measurements:e.user_measurements}});if(s)throw c.error("MORPH_PAYLOAD","scan-refine-morphs Edge Function failed",{scanId:e.scan_id,error:s.message||s,philosophy:"ai_refinement_failed"}),new Error(`AI refinement failed: ${s.message}`);if(!i)throw c.error("MORPH_PAYLOAD","PHASE 1: scan-refine-morphs returned null/undefined data",{scanId:e.scan_id,philosophy:"phase_1_null_response_validation"}),new Error("AI refinement service returned null or undefined data");const l=n(i);if(!l.isValid)throw c.error("MORPH_PAYLOAD","PHASE 1: scan-refine-morphs response validation failed",{scanId:e.scan_id,errors:l.errors,warnings:l.warnings,responseData:i,philosophy:"phase_1_edge_function_response_validation_failed"}),new Error(`AI refinement response validation failed: ${l.errors.join(", ")}`);return l.warnings.length>0&&c.warn("MORPH_PAYLOAD","PHASE 1: scan-refine-morphs response has warnings",{scanId:e.scan_id,warnings:l.warnings,philosophy:"phase_1_edge_function_response_quality_warnings"}),c.info("MORPH_PAYLOAD","scan-refine-morphs Edge Function completed successfully",{scanId:e.scan_id,aiRefine:i.ai_refine,finalShapeParamsCount:Object.keys(i.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(i.final_limb_masses||{}).length,clampedKeysCount:i.clamped_keys?.length||0,outOfRangeCount:i.out_of_range_count||0,activeKeysCount:i.active_keys_count||0,aiConfidence:i.ai_confidence,validationPassed:!0,philosophy:"ai_refinement_success"}),i}async function qe(e,n,r,t){const a=Le(),i=t||r;if(c.info("MORPH_PAYLOAD","Starting AI-driven morphological payload preparation",{gender:i,explicitResolvedGender:t,originalGender:r,hasScanResults:!!e,hasMapping:!!n,featureFlags:a,philosophy:"phase_a_strict_allowlisting_robust_fallback"}),!n||!n.mapping_masculine||!n.mapping_feminine){const h="Invalid morphology mapping - missing gender mappings";return c.error("MORPH_PAYLOAD","PHASE 2: Critical input validation failed",{error:h,hasMapping:!!n,hasMasculineMapping:!!n?.mapping_masculine,hasFeminineMapping:!!n?.mapping_feminine,philosophy:"phase_2_critical_input_validation"}),{status:"error",shape_params:{},limb_masses:{},blender_shape_keys:{},metadata:{strategy:"critical_input_validation_failed",finalGender:i,confidence:0,quality_score:0,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!1,mapping_version:"unknown",allowlisted_keys_count:0,rejected_keys_count:0,envelope_constrained:!1,morph_generation_fallback:!0},error:h}}let s;try{s=_e(n,i)}catch(h){const g=`Failed to build morph policy: ${h instanceof Error?h.message:"Unknown error"}`;return c.error("MORPH_PAYLOAD","PHASE 2: Morph policy building failed",{error:g,finalGender:i,philosophy:"phase_2_policy_building_failure"}),{status:"error",shape_params:{},limb_masses:{},blender_shape_keys:{},metadata:{strategy:"morph_policy_building_failed",finalGender:i,confidence:0,quality_score:0,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!1,mapping_version:"unknown",allowlisted_keys_count:0,rejected_keys_count:0,envelope_constrained:!1,morph_generation_fallback:!0},error:g}}const l=i==="male"?n.mapping_masculine:n.mapping_feminine;if(c.info("MORPH_PAYLOAD","Using gender-specific mapping for AI-driven processing",{finalGender:i,mappingMorphValuesCount:Object.keys(l.morph_values).length,mappingLimbMassesCount:Object.keys(l.limb_masses).length,policyRequiredKeys:s.requiredKeys.length,policyOptionalKeys:s.optionalKeys.length,philosophy:"ai_driven_db_mapping"}),e.match?.ai_refinement?.ai_refine===!0&&e.match?.ai_refinement?.final_shape_params){const{validateRefineResponse:h}=await J(async()=>{const{validateRefineResponse:X}=await import("./types-CMUW8gDJ.js");return{validateRefineResponse:X}},[]),g=h(e.match.ai_refinement);if(!g.isValid)throw c.error("MORPH_PAYLOAD","PHASE 1: AI refinement response validation failed",{finalGender:i,errors:g.errors,warnings:g.warnings,philosophy:"phase_1_strict_schema_validation"}),new Error(`AI refinement data validation failed: ${g.errors.join(", ")}`);g.warnings.length>0&&c.warn("MORPH_PAYLOAD","PHASE 1: AI refinement response has warnings",{finalGender:i,warnings:g.warnings,philosophy:"phase_1_data_quality_warnings"});const x=e.match.ai_refinement;if(!x.final_shape_params||Object.keys(x.final_shape_params).length===0)throw c.error("MORPH_PAYLOAD","PHASE 1: AI refinement missing final_shape_params",{finalGender:i,aiRefine:x.ai_refine,hasFinalShapeParams:!!x.final_shape_params,finalShapeParamsKeys:x.final_shape_params?Object.keys(x.final_shape_params):[],philosophy:"phase_1_critical_data_validation"}),new Error("AI refinement succeeded but final_shape_params is missing or empty");if(!x.final_limb_masses||Object.keys(x.final_limb_masses).length===0)throw c.error("MORPH_PAYLOAD","PHASE 1: AI refinement missing final_limb_masses",{finalGender:i,aiRefine:x.ai_refine,hasFinalLimbMasses:!!x.final_limb_masses,finalLimbMassesKeys:x.final_limb_masses?Object.keys(x.final_limb_masses):[],philosophy:"phase_1_critical_data_validation"}),new Error("AI refinement succeeded but final_limb_masses is missing or empty");c.info("MORPH_PAYLOAD","Using AI-refined results directly",{finalGender:i,aiRefined:!0,mappingVersion:e.match.ai_refinement.mapping_version,validationPassed:!0,philosophy:"phase_a_ai_refined_direct_use"});const P=he(x.final_shape_params,n,i,"ai_refined"),$=te(P,n,i),W=ge(x.final_limb_masses,n,i,"ai_refined"),U=re(W,n,i);return{shape_params:$,limb_masses:U,blender_shape_keys:ie($),metadata:{strategy:"ai_refined_k5_constrained_validated",finalGender:i,confidence:.95,quality_score:.95,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!0,mapping_version:x.mapping_version,allowlisted_keys_count:Object.keys($).length,rejected_keys_count:Object.keys(x.final_shape_params).length-Object.keys(P).length,envelope_constrained:!1,morph_generation_fallback:!1,phase_b_ai_refinement_metrics:{clamped_keys:x.clamped_keys||[],envelope_violations:x.envelope_violations||[],db_violations:x.db_violations||[],out_of_range_count:x.out_of_range_count||0,missing_keys_added:x.missing_keys_added||[],extra_keys_removed:x.extra_keys_removed||[],active_keys_count:x.active_keys_count||0,top_shape_deltas:x.refinement_deltas?.top_10_shape_deltas||[],top_limb_deltas:x.refinement_deltas?.top_10_limb_deltas||[],k5_envelope_used:!!e.match?.k5_envelope,vision_classification_used:!!e.semantic?.semantic_profile}}}}const m=Ye(e,s,i,a,n),{shape_params:y,limb_masses:E,strategy:u="comprehensive_fallback"}=m,p=u||"comprehensive_fallback_no_strategy_detected";c.info("MORPH_PAYLOAD","PHASE 1: Strategy validation and assignment completed",{originalStrategy:u,finalStrategy:p,strategyWasUndefined:!u,philosophy:"phase_1_explicit_strategy_assignment"});let k={shape_params:y,limb_masses:E},F=.8,d=.8;if(e.match?.selected_archetypes&&e.match.selected_archetypes.length>1){c.info("MORPH_PAYLOAD","Applying client-side blending (pre-AI refinement)",{archetypesCount:e.match.selected_archetypes.length,philosophy:"pre_ai_blending"});const h=Re(e.match.selected_archetypes,n,i);k={shape_params:h.shape_params,limb_masses:h.limb_masses},F=h.confidence,d=h.quality_score}try{const h=e.estimate?.extracted_data?{height_cm:e.estimate.extracted_data.raw_measurements?.height_cm||175,weight_kg:e.estimate.extracted_data.raw_measurements?.weight_kg||70,estimated_bmi:e.estimate.extracted_data.estimated_bmi||22,raw_measurements:{waist_cm:e.estimate.extracted_data.raw_measurements?.waist_cm||80,chest_cm:e.estimate.extracted_data.raw_measurements?.chest_cm||95,hips_cm:e.estimate.extracted_data.raw_measurements?.hips_cm||100}}:void 0,g=e.match?.k5_envelope,x=e.semantic?.semantic_profile?{muscularity:e.semantic.semantic_profile.muscularity,obesity:e.semantic.semantic_profile.obesity,morphotype:e.semantic.semantic_profile.morphotype,level:e.semantic.semantic_profile.level}:null;c.info("MORPH_PAYLOAD","Calling scan-refine-morphs for AI refinement",{finalGender:i,blendedShapeParamsCount:Object.keys(k.shape_params).length,blendedLimbMassesCount:Object.keys(k.limb_masses).length,hasK5Envelope:!!g,hasVisionClassification:!!x,hasUserMeasurements:!!h,philosophy:"phase_b_ai_driven_k5_constrained_refinement"});const P=await $e({scan_id:e.serverScanId||e.commit?.scan_id||"unknown",user_id:e.userId||"unknown",resolvedGender:i==="male"?"masculine":"feminine",photos:Ue(e),blend_shape_params:k.shape_params,blend_limb_masses:k.limb_masses,mapping_version:"v1.0",k5_envelope:g,vision_classification:x,user_measurements:h});if(!P)throw new Error("AI refinement service returned null or undefined response");const{validateRefineResponse:$}=await J(async()=>{const{validateRefineResponse:U}=await import("./types-CMUW8gDJ.js");return{validateRefineResponse:U}},[]),W=$(P);if(!W.isValid)throw c.error("MORPH_PAYLOAD","PHASE 1: AI refinement result validation failed",{finalGender:i,errors:W.errors,warnings:W.warnings,aiRefinementResult:P,philosophy:"phase_1_ai_result_validation_failed"}),new Error(`AI refinement result validation failed: ${W.errors.join(", ")}`);if(W.warnings.length>0&&c.warn("MORPH_PAYLOAD","PHASE 1: AI refinement result has warnings",{finalGender:i,warnings:W.warnings,philosophy:"phase_1_ai_result_quality_warnings"}),P.ai_refine){if(Object.keys(P.final_shape_params).length===0)throw new Error("AI refinement succeeded but final_shape_params is empty");if(Object.keys(P.final_limb_masses).length===0)throw new Error("AI refinement succeeded but final_limb_masses is empty");const U=te(P.final_shape_params,n,i),X=re(P.final_limb_masses,n,i);return{shape_params:U,limb_masses:X,blender_shape_keys:ie(U),metadata:{strategy:"phase_b_ai_refined_k5_constrained_validated",finalGender:i,confidence:P.ai_confidence||.95,quality_score:.95,constraints_applied:0,missing_required:[],missing_optional:[],ai_refined:!0,mapping_version:P.mapping_version,allowlisted_keys_count:Object.keys(U).length,rejected_keys_count:0,envelope_constrained:!0,morph_generation_fallback:!1,phase_b_ai_refinement_metrics:{clamped_keys:P.clamped_keys||[],envelope_violations:P.envelope_violations||[],db_violations:P.db_violations||[],out_of_range_count:P.out_of_range_count||0,missing_keys_added:P.missing_keys_added||[],extra_keys_removed:P.extra_keys_removed||[],active_keys_count:P.active_keys_count||0,top_shape_deltas:P.refinement_deltas?.top_10_shape_deltas||[],top_limb_deltas:P.refinement_deltas?.top_10_limb_deltas||[],k5_envelope_used:!!g,vision_classification_used:!!x}}}}}catch(h){if(c.error("MORPH_PAYLOAD","PHASE 1: AI refinement failed with validation error",{finalGender:i,error:h instanceof Error?h.message:"Unknown error",stack:h instanceof Error?h.stack:void 0,philosophy:"phase_1_ai_refinement_critical_failure"}),h instanceof Error&&(h.message.includes("validation failed")||h.message.includes("missing or empty")||h.message.includes("null or undefined")))throw h;c.warn("MORPH_PAYLOAD","PHASE 1: AI refinement service error, falling back to blended data",{finalGender:i,error:h instanceof Error?h.message:"Unknown error",philosophy:"phase_1_service_error_fallback"})}const{constrainedParams:C,constraintsApplied:L}=await J(async()=>{const{constrainedParams:h,constraintsApplied:g}=await Promise.resolve().then(()=>De);return{constrainedParams:h,constraintsApplied:g}},void 0).then(h=>h.applyMorphologicalConstraints(k.shape_params,s,i)),j=he(C,n,i,u),B=ge(k.limb_masses,n,i,u),R=p||"fallback_blend_with_constraints",K=te(j,n,i),b=re(B,n,i),w=Te(K,s),N=Ke(b,n,i),_=Je(w,i,"realistic"),v=ie(_),{missing_required:O,missing_optional:I}=ze(),M={shape_params:_,limb_masses:N,blender_shape_keys:v,metadata:{strategy:R||"fallback_blend_with_constraints_validated",finalGender:i,confidence:F,quality_score:d,constraints_applied:L.length,missing_required:O,missing_optional:I,ai_refined:!1,mapping_version:"v1.0",allowlisted_keys_count:Object.keys(_).length,rejected_keys_count:Object.keys(C).length-Object.keys(j).length,envelope_constrained:!1,morph_generation_fallback:!1}};if(!M.metadata.strategy||M.metadata.strategy.length===0)throw c.error("MORPH_PAYLOAD","PHASE 1: Critical error - strategy is still undefined after all fallbacks",{finalGender:i,robustFinalStrategy:R,originalStrategy:u,philosophy:"phase_1_critical_strategy_validation"}),new Error("Critical error: strategy field is undefined after all fallback attempts");if(Object.keys(M.shape_params).length===0)throw c.error("MORPH_PAYLOAD","PHASE 1: Critical error - no shape parameters in final payload",{finalGender:i,strategy:M.metadata.strategy,philosophy:"phase_1_critical_data_validation"}),new Error("Critical error: final payload contains no shape parameters");return c.info("MORPH_PAYLOAD","PHASE A.4: Fallback morphological payload prepared",{strategy:M.metadata.strategy,finalGender:i,shapeParamsCount:Object.keys(w).length,limbMassesCount:Object.keys(N).length,blenderKeysCount:Object.keys(v).length,confidence:F.toFixed(3),qualityScore:d.toFixed(3),constraintsApplied:L.length,allowlistedKeysCount:M.metadata.allowlisted_keys_count,rejectedKeysCount:M.metadata.rejected_keys_count,validationPassed:!0,philosophy:"phase_a_fallback_with_strict_allowlisting"}),M}function Je(e,n,r="realistic"){if(r!=="realistic"||n!=="male")return e;const t={...e},a=["superBreast","breastsSmall","breastsSag","pregnant","animeWaist","dollBody","animeProportion","animeNeck","nipples"];let i=0;return a.forEach(s=>{if(s in t&&Math.abs(t[s])>.01){const l=t[s],m=Math.min(l,.05);Math.abs(l-m)>.001&&(t[s]=m,i++,c.debug("STYLE_CONSTRAINTS","Applied realistic soft-clamp for male avatar",{morphKey:s,originalValue:l.toFixed(3),softClampedValue:m.toFixed(3),style:r,gender:n,philosophy:"realistic_male_avatar_soft_clamping"}))}}),i>0&&c.info("STYLE_CONSTRAINTS","Applied realistic style constraints",{gender:n,style:r,adjustedMorphsCount:i,philosophy:"realistic_avatar_style_optimization"}),t}const oe=["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass"];function fe(e){const n=typeof e=="string"?parseFloat(e):typeof e=="number"?e:NaN;return Number.isFinite(n)?n:null}function Ge(e){const n=e?.limb_masses??e?.limbMasses??e?.match?.blended_limb_masses??e?.match?.primary_archetype?.limb_masses??e?.match?.selected_archetypes?.[0]?.limb_masses??e?.estimate?.extracted_data?.limb_masses??null,r=typeof n=="string"?Xe(n):n;if(!r||typeof r!="object")throw new Error("Missing limb_masses in scan");const t={};for(const l of oe){const m=fe(r[l]);m!==null&&(t[l]=m)}const a=fe(r.gate);t.gate=a===null?1:a,t.isActive=r.isActive??!0;const i=Object.keys(t).filter(l=>oe.includes(l)),s=oe.filter(l=>!i.includes(l));return c.info("LIMB_MASSES_EXTRACTED","Limb masses extracted",{count:i.length,missing:s.length>0?s.join(", "):"none",values:i.reduce((l,m)=>(l[m]=t[m],l),{})}),{masses:t,count:i.length,missing:s}}function Xe(e){try{return JSON.parse(e)}catch{return null}}function Ze(){const e=Oe(),n=ye(),{profile:r}=ve(),{successMajor:t}=se(),{data:a}=Ee(),{showToast:i}=je(),[s,l]=A.useState(e.state?.scanResults||null),[m,y]=A.useState({}),[E,u]=A.useState("front"),[p,k]=A.useState(!0),[F,d]=A.useState(!1),[C,L]=A.useState(!1),[j,B]=A.useState(null),[R,K]=A.useState(0),b=A.useRef(null),w=A.useRef(!1),N=A.useRef(!1),_=A.useRef(null),v=A.useRef(null),O=A.useRef({}),I=A.useMemo(()=>s?.userProfile?{sex:s.userProfile.sex,height_cm:s.userProfile.height_cm,weight_kg:s.userProfile.weight_kg}:{sex:"male",height_cm:175,weight_kg:70},[s?.userProfile?.sex,s?.userProfile?.height_cm,s?.userProfile?.weight_kg]),M=A.useMemo(()=>s?.match?.k5_envelope||s?.match?.morph_bounds||s?.morph_bounds||s?.k5_envelope||{},[s?.match?.k5_envelope,s?.match?.morph_bounds,s?.morph_bounds,s?.k5_envelope]),h=A.useMemo(()=>s?.match?.selected_archetypes||[],[s?.match?.selected_archetypes]),g=A.useMemo(()=>{if(!s||!s.userProfile&&!s.match?.selected_archetypes?.length)return"male";if(s?.resolvedGender)return c.info("RESOLVED_GENDER_REVIEW","Using explicit resolved gender from scan results",{resolvedGender:s.resolvedGender,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),s.resolvedGender;if(I?.sex)return c.info("RESOLVED_GENDER_REVIEW","Using user profile gender",{profileGender:I.sex,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),I.sex;if(h?.length>0){const f=h[0],Y=f.gender==="feminine"?"female":"male";return c.warn("RESOLVED_GENDER_REVIEW","Using archetype gender as fallback",{archetypeGender:Y,archetypeId:f.id,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,reason:"no_explicit_gender_in_scan_results_or_profile"}),Y}const S="male";return c.warn("RESOLVED_GENDER_REVIEW","Using ultimate fallback gender",{fallbackGender:S,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,reason:"no_gender_information_available_anywhere"}),S},[s,I?.sex,h]),x=A.useMemo(()=>{if(!s)return{};c.info("LIMB_MASSES_EXTRACTION_REVIEW","Starting limb masses extraction from scan results",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,scanResultsKeys:s?Object.keys(s):[]});try{const{masses:S,count:f,missing:Y}=Ge(s);return c.info("LIMB_MASSES_NORMALIZED",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,count:f,missing:Y,masses:Object.entries(S).map(([q,H])=>({key:q,value:H}))}),f===0?(c.warn("LIMB_MASSES_EXTRACTION_REVIEW","No limb masses available, using empty object",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),{}):S}catch(S){return c.error("LIMB_MASSES_EXTRACTION_REVIEW","Failed to normalize limb masses",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,error:S instanceof Error?S.message:"Unknown error"}),{}}},[s]),P=A.useMemo(()=>{if(!s)return null;const S=Ce(s),f=S?.tone;return f?c.info("SKIN_TONE_EXTRACTION_REVIEW","Skin tone resolved successfully",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,skinTone:`rgb(${f.rgb.r}, ${f.rgb.g}, ${f.rgb.b})`,skinToneHex:f.hex,source:S.source,confidence:f.confidence?f.confidence.toFixed(3):"N/A",schema:f.schema}):c.debug("SKIN_TONE_EXTRACTION_REVIEW","Skin tone not yet available - pending state",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,reason:"skin_tone_pending_not_error"}),f},[s]),$=A.useMemo(()=>{if(!a||!I||!g)return null;try{const S=_e(a,g);return c.info("MORPH_CONSTRAINTS Policy built from DB",{gender:g,requiredKeys:S.requiredKeys.length,optionalKeys:S.optionalKeys.length,totalRanges:Object.keys(S.ranges).length}),S}catch(S){return c.error("Failed to build morph policy",{error:S instanceof Error?S.message:"Unknown error",gender:g,clientScanId:s?.clientScanId,serverScanId:s?.serverScanId}),null}},[a,I,g,s?.clientScanId,s?.serverScanId]),W=A.useMemo(()=>{const S=I?.sex||"male";if(!v.current||v.current._generatedForSex!==S){const f=ce(S);f._generatedForSex=S,v.current=f,c.debug("MORPH_FALLBACK","Generated new stable fallback morph data",{sex:S,morphCount:Object.keys(f).length})}return v.current},[I?.sex]),U=A.useMemo(()=>{if(m&&Object.keys(m).length>0&&R===0)return c.debug("BODY_SCAN_REVIEW","Using currentMorphData as primary source",{clientScanId:s?.clientScanId,morphDataKeys:Object.keys(m),resetTrigger:R,philosophy:"current_morph_data_priority"}),m;let S={},f="unknown";s?.match?.ai_refinement?.ai_refine&&s.match.final_shape_params?(c.info("AI_REFINEMENT","Using AI-refined morphological data",{scanId:s?.serverScanId,resolvedGender:g,finalShapeParamsCount:Object.keys(s.match.final_shape_params).length,aiConfidence:s.match.ai_refinement.ai_confidence,philosophy:"ai_refined_direct_use"}),S=s.match.final_shape_params,f="ai_refined"):s?.match?.blended_shape_params&&Object.keys(s.match.blended_shape_params).length>0?(c.info("BODY_SCAN_REVIEW","Using blended shape params from match result",{clientScanId:s?.clientScanId,morphDataKeys:Object.keys(s.match.blended_shape_params),philosophy:"blend_fallback"}),S=s.match.blended_shape_params,f="blended"):(c.info("BODY_SCAN_REVIEW","Using stable fallback morph data",{clientScanId:s?.clientScanId,philosophy:"stable_fallback"}),S=W,f="fallback");const Y=JSON.stringify(Object.keys(S).sort().map(H=>[H,S[H]])),q=JSON.stringify(Object.keys(O.current).sort().map(H=>[H,O.current[H]]));return Y!==q?(O.current=S,c.debug("BODY_SCAN_REVIEW","Morph data content changed, updating stable reference",{clientScanId:s?.clientScanId,dataSource:f,morphDataKeys:Object.keys(S),reason:"content_changed"})):c.debug("BODY_SCAN_REVIEW","Morph data content unchanged, using stable reference",{clientScanId:s?.clientScanId,dataSource:f,reason:"content_identical"}),(!b.current||Object.keys(b.current).length===0)&&(b.current=JSON.parse(JSON.stringify(O.current)),c.info("REVIEW_STATE","Initial morph data stored for reset functionality",{morphKeysCount:Object.keys(b.current).length,philosophy:"initial_morph_data_storage_from_completeMorphData"})),O.current},[m,R,s,a,I,g,W,g,s?.clientScanId,s?.serverScanId]);de.useEffect(()=>{U&&Object.keys(U).length>0&&!b.current&&(b.current={...U},c.debug("REVIEW_STATE","Initial morph data stored for reset functionality",{morphKeysCount:Object.keys(U).length,sampleMorphs:Object.entries(U).slice(0,3).map(([S,f])=>({key:S,value:f.toFixed(3)})),philosophy:"initial_morph_data_storage"}))},[U]);const X=A.useMemo(()=>{const S=Object.keys(U||{}).length,f=Object.keys(x||{}).filter(q=>["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass","hipMass"].includes(q)).length,Y=S+f;return{shapeParamCount:S,limbMassCount:f,totalMorphKeys:Y}},[U,x]),ke=A.useCallback(()=>{if(!C){L(!0);const S=Z.getState().progress;S<100&&Z.getState().setRenderReady(),c.info("BODY_SCAN_REVIEW Avatar 3D viewer ready",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,currentProgress:S})}},[C,s?.clientScanId,s?.serverScanId]);A.useEffect(()=>{(async()=>{if(N.current)return;const f=e.state?.scanResults;if(c.logOnce("navigation-state-received","info","BODY_SCAN_REVIEW Navigation state received",{hasLocationState:!!e.state,hasScanData:!!f,scanDataKeys:f?Object.keys(f):[],clientScanId:f?.clientScanId,serverScanId:f?.serverScanId,timestamp:new Date().toISOString()}),N.current=!0,!f){c.warn("BODY_SCAN_REVIEW No scan data available, redirecting to body-scan"),n("/body-scan",{replace:!0});return}const Y=JSON.stringify(f),q=s?JSON.stringify(s):null;if(Y!==q?(l(f),c.debug("BODY_SCAN_REVIEW","Scan results updated due to content change",{clientScanId:f.clientScanId,contentChanged:!0,reason:"deep_comparison_detected_change"})):c.debug("BODY_SCAN_REVIEW","Scan results content unchanged, skipping update",{clientScanId:f.clientScanId,contentChanged:!1,reason:"deep_comparison_no_change"}),m&&Object.keys(m).length>0){c.debug("BODY_SCAN_REVIEW","Morph data already set, skipping re-extraction",{clientScanId:f.clientScanId,existingMorphDataKeys:Object.keys(m)});return}let H={},ae="unknown";if(a&&I)try{const V=await qe(f,a,I.sex,g);H=V.shape_params,ae=`prepared_payload_${V.metadata.strategy}`,c.info("BODY_SCAN_REVIEW Used prepared morphological payload",{clientScanId:f.clientScanId,morphDataKeys:Object.keys(H),strategy:V.metadata.strategy,confidence:V.metadata.confidence.toFixed(3),qualityScore:V.metadata.quality_score.toFixed(3),morphGenerationFallback:V.metadata.morph_generation_fallback,validationPassed:!0})}catch(V){if(c.error("BODY_SCAN_REVIEW","PHASE 1: Critical error during payload preparation",{clientScanId:f.clientScanId,error:V instanceof Error?V.message:"Unknown error",stack:V instanceof Error?V.stack:void 0,scanDataKeys:Object.keys(f),hasMorphologyMapping:!!a,hasStableUserProfile:!!I,philosophy:"phase_1_critical_payload_preparation_error"}),V instanceof Error&&(V.message.includes("validation failed")||V.message.includes("missing or empty")||V.message.includes("null or undefined")||V.message.includes("Critical error"))){const ue=`Erreur de préparation des données: ${V instanceof Error?V.message:"Erreur inconnue"}`;B(ue),c.error("BODY_SCAN_REVIEW","PHASE 1: Critical error state set due to payload preparation failure",{clientScanId:f.clientScanId,errorMessage:ue,criticalErrorSet:!0,philosophy:"phase_1_critical_error_state_management"});return}else c.warn("BODY_SCAN_REVIEW","PHASE 1: Non-critical payload preparation error, using fallback",{clientScanId:f.clientScanId,error:V instanceof Error?V.message:"Unknown error",philosophy:"phase_1_non_critical_error_fallback"}),H=ce(I?.sex||"male"),ae="payload_preparation_failed_fallback_validated"}else H=ce(I?.sex||"male"),ae="comprehensive_fallback_no_mapping_or_profile";if(j){c.debug("BODY_SCAN_REVIEW","PHASE 1: Skipping morph data setting due to critical error",{clientScanId:f.clientScanId,criticalError:j});return}c.info("BODY_SCAN_REVIEW Final morph data extracted for 3D viewer",{clientScanId:f.clientScanId,serverScanId:f.serverScanId,morphDataKeys:Object.keys(H),morphDataCount:Object.keys(H).length,strategy:ae,timestamp:new Date().toISOString()}),(!b.current||JSON.stringify(b.current)!==JSON.stringify(H))&&(b.current={...H},c.info("REVIEW_STATE","Initial morph data set/updated for reset",{morphKeysCount:Object.keys(H).length,sampleMorphs:Object.entries(H).slice(0,3).map(([V,pe])=>({key:V,value:pe.toFixed(3)})),philosophy:"initial_morph_data_storage_fix"})),y(H)})()},[e.state?.scanResults,n,m,a,I]);const Ie=A.useCallback(()=>{if(c.info("REVIEW_STATE","Reset morphs requested - BEFORE reset",{hasInitialData:!!b.current,initialDataKeys:b.current?Object.keys(b.current):[],initialDataCount:b.current?Object.keys(b.current).length:0,currentMorphDataKeys:Object.keys(m),currentMorphDataCount:Object.keys(m).length,resetTrigger:R,philosophy:"reset_morphs_before_audit"}),!b.current||Object.keys(b.current).length===0){c.error("REVIEW_STATE","Cannot reset morphs - no initial data available",{hasInitialDataRef:!!b.current,initialDataKeys:b.current?Object.keys(b.current):[],philosophy:"reset_morphs_no_initial_data_error"});return}const S=JSON.parse(JSON.stringify(b.current));y(S),_.current?.forceMorphsUpdate&&(_.current.forceMorphsUpdate(S),c.info("REVIEW_STATE","Forced morph cache reset with immediate reapplication",{resetDataKeys:Object.keys(S),philosophy:"force_3d_viewer_cache_reset_with_data"})),K(f=>f+1),c.info("REVIEW_STATE","Reset morphs completed - AFTER reset",{resetDataKeys:Object.keys(S),resetDataCount:Object.keys(S).length,sampleResetMorphs:Object.entries(S).slice(0,3).map(([f,Y])=>({key:f,value:Y.toFixed(3)})),newResetTrigger:R+1,philosophy:"reset_morphs_after_audit"})},[y,m,R,_]);return A.useEffect(()=>{const S=Z.getState().progress;if(S<100){const{setRenderReady:f}=Z.getState();f()}t(),c.info("BODY_SCAN_REVIEW — page mounted, avatar ready for initialization",{clientScanId:s?.clientScanId,serverScanId:s?.serverScanId,currentProgress:S,timestamp:new Date().toISOString()}),w.current=!0},[t,U,s?.clientScanId,s?.serverScanId]),{scanResults:s,setScanResults:l,currentMorphData:m,completeMorphData:U,morphCounters:X,setCurrentMorphData:y,activeView:E,setActiveView:u,autoRotate:p,setAutoRotate:k,showMorphControls:F,setShowMorphControls:d,avatar3DRef:_,resetMorphsToInitial:Ie,stableUserProfile:I,stableMorphBounds:M,stableSelectedArchetypes:h,stableLimbMasses:x,stableSkinTone:P,profile:r,isViewerReady:C,handleViewerReady:ke,morphologyMapping:a,morphPolicy:$,showToast:i,resolvedGender:g,criticalError:j,setCriticalError:B,initialMorphDataRef:b}}function ce(e){const n={pearFigure:.1,bodybuilderSize:.1,emaciated:0,narrowWaist:.1,bigHips:e==="female"?.2:.1,assLarge:e==="female"?.2:.1,superBreast:e==="female"?.1:0,breastsSmall:e==="female"?.1:0,breastsSag:0,pregnant:0,bodybuilderDetails:0,animeWaist:0,dollBody:0,animeProportion:0,animeNeck:0,nipples:0,FaceLowerEyelashLength:0,eyesClosedL:0,eyesClosedR:0,eyelashLength:0,eyelashesSpecial:0,eyesShape:0,eyesSpacing:0,eyesDown:0,eyesUp:0,eyesSpacingWide:0};return c.debug("MORPH_FALLBACK","Generated comprehensive morph fallback",{sex:e,morphCount:Object.keys(n).length,sampleMorphs:Object.entries(n).slice(0,5).map(([r,t])=>({key:r,value:t}))}),n}const Qe={waist_cm:"Tour de taille",chest_cm:"Tour de poitrine",hips_cm:"Tour de hanches",shoulder_width_cm:"Largeur d'épaules",neck_cm:"Tour de cou",arm_length_cm:"Longueur de bras",bicep_cm:"Tour de biceps",thigh_cm:"Tour de cuisse",calf_cm:"Tour de mollet",forearm_cm:"Tour d'avant-bras",wrist_cm:"Tour de poignet",ankle_cm:"Tour de cheville",height_cm:"Taille",weight_kg:"Poids",inseam_cm:"Entrejambe",torso_length_cm:"Longueur du torse",estimated_body_fat_perc:"Masse Grasse Estimée",estimated_muscle_mass_kg:"Masse Musculaire Estimée",waist_to_hip_ratio:"Ratio Taille/Hanches"};function ea(e,n,r){const a=r==="male"?15:25,i=Math.abs(e-22)/22,s=Math.abs(n-a)/a,m=30+(i+s)*15;return Math.max(18,Math.min(65,m))}function aa(e){const r=e/100;return 22*r*r}function sa(e){return e<18.5?{category:"Insuffisant",color:"#06B6D4",description:"Poids en dessous de la normale"}:e<25?{category:"Normal",color:"#10B981",description:"Poids dans la plage normale"}:e<30?{category:"Surpoids",color:"#F59E0B",description:"Poids au-dessus de la normale"}:{category:"Obésité",color:"#EF4444",description:"Poids significativement élevé"}}const na=e=>{switch(e){case"weight_kg":return"measurement-detail-item--weight";case"height_cm":return"measurement-detail-item--height";case"waist_cm":return"measurement-detail-item--waist";case"chest_cm":return"measurement-detail-item--chest";default:return""}},ta=e=>{switch(e){case"weight_kg":return"Scale";case"height_cm":return"Ruler";case"waist_cm":return"Circle";case"chest_cm":return"Heart";case"hips_cm":return"Circle";case"shoulder_width_cm":return"Users";case"neck_cm":return"Circle";case"arm_length_cm":return"Minus";case"bicep_cm":return"Dumbbell";case"thigh_cm":return"Triangle";case"calf_cm":return"Triangle";case"forearm_cm":return"Minus";case"wrist_cm":return"Circle";case"ankle_cm":return"Circle";case"inseam_cm":return"Minus";case"torso_length_cm":return"Minus";case"estimated_body_fat_perc":return"Zap";case"estimated_muscle_mass_kg":return"Dumbbell";case"waist_to_hip_ratio":return"GitCompare";default:return"Info"}},ra=({scanResults:e,userProfile:n,skinTone:r})=>{const t=me(),{click:a}=se(),i=e?.estimate?.extracted_data||{};let s=null;r&&ne(r)?s=r:i?.skin_tone&&ne(i.skin_tone)?s=i.skin_tone:e?.commit?.data?.skin_tone&&ne(e.commit.data.skin_tone)?s=e.commit.data.skin_tone:r&&c.warn("MEASUREMENTS_CARD","Received skin tone is not in V2 format",{skinTone:r,hasSkinToneProp:!!r,skinToneKeys:r?Object.keys(r):[]});const l=i?.raw_measurements||{},m=Number(l.waist_cm)||0,y=Number(l.hips_cm)||0,E=Number(l.chest_cm)||0,u=Number(l.height_cm)||n.height_cm||0,p=Number(l.weight_kg)||n.weight_kg||0,k=Number(i.estimated_body_fat_perc)||0,F=Number(i.estimated_muscle_mass_kg)||0,d=i?.estimated_bmi??n.weight_kg/Math.pow(n.height_cm/100,2),C=i?.estimated_body_fat_perc??(n.sex==="male"?15:25),L=i?.processing_confidence,j=m>0&&y>0&&E>0&&u>0&&p>0&&k>0&&F>0;if(!i||Object.keys(l).length===0)return null;const B=d||n.weight_kg/Math.pow(n.height_cm/100,2),R=sa(B),K=B&&C?ea(B,C,n.sex):null,b=aa(n.height_cm),N=[...Object.entries(l),["estimated_body_fat_perc",i.estimated_body_fat_perc],["estimated_muscle_mass_kg",i.estimated_muscle_mass_kg]].filter(([_,v])=>v!=null).map(([_,v])=>{const O=Qe[_]||_.replace(/_/g," "),I=_.includes("_cm")?"cm":_.includes("_kg")?"kg":_.includes("_perc")?"%":"",M=typeof v=="number"?v.toFixed(1):v;let h=ta(_),g="#9CA3AF";switch(_){case"weight_kg":case"estimated_muscle_mass_kg":g="#60A5FA";break;case"height_cm":g="#8B5CF6";break;case"waist_cm":case"hips_cm":case"chest_cm":g="#10B981";break;case"estimated_body_fat_perc":case"waist_to_hip_ratio":g="#F59E0B";break;default:g="var(--color-body-scan-primary)";break}return{key:_,value:M,label:O,unit:I,icon:h,color:g}});return o.jsx(z,{className:"measurements-card",initial:t.enableInitialAnimations?{opacity:0,y:20}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.6,ease:"easeOut"}:void 0,children:o.jsxs(Q,{className:"p-6 relative overflow-visible",style:{background:`
            radial-gradient(circle at 30% 20%, color-mix(in srgb, var(--color-body-scan-primary) 6%, transparent) 0%, transparent 60%),
            radial-gradient(circle at 70% 80%, color-mix(in srgb, var(--color-plasma-cyan) 4%, transparent) 0%, transparent 50%),
            rgba(18, 24, 38, 0.7)
          `,borderColor:"color-mix(in srgb, var(--color-body-scan-primary) 20%, transparent)",boxShadow:`
            0 8px 32px rgba(0, 0, 0, 0.25),
            0 0 20px color-mix(in srgb, var(--color-body-scan-primary) 10%, transparent),
            inset 0 1px 0 rgba(255, 255, 255, 0.1)
          `,backdropFilter:"blur(var(--glass-blur-base)) saturate(var(--glass-saturate-base))"},children:[o.jsxs("div",{className:"flex items-center justify-between mb-6",children:[o.jsxs("div",{className:"flex items-center bodyscan-gap-md",children:[o.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, var(--color-body-scan-success) 35%, transparent), color-mix(in srgb, var(--color-body-scan-success) 25%, transparent))
                `,border:"2px solid color-mix(in srgb, var(--color-body-scan-success) 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, var(--color-body-scan-success) 30%, transparent)"},children:o.jsx(T,{Icon:j?D.Activity:D.Info,size:20,style:{color:j?"var(--color-body-scan-success)":"var(--color-body-scan-warning)"},variant:"pure"})}),o.jsx("h3",{className:"text-lg font-semibold text-white",children:"Mesures extraites"})]}),L&&o.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full ${j?"bg-emerald-500/20 border border-emerald-500/30":"bg-yellow-500/20 border border-yellow-400/30"}`,children:[o.jsx("div",{className:`w-2 h-2 rounded-full ${j?"bg-emerald-400":"bg-yellow-400"} ${j?"":"animate-pulse"}`}),o.jsx("span",{className:`${j?"text-emerald-400":"text-yellow-300"} text-xs font-medium`,children:j?`${Math.round(L*100)}% confiance`:"Données incomplètes"})]})]}),o.jsxs("div",{className:"measurements-grid mb-8",children:[B&&R&&o.jsxs(z,{className:"measurement-summary-card",style:{"--measurement-color":R.color},initial:t.enableInitialAnimations?{opacity:0,y:15}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.4,delay:.1}:void 0,whileHover:t.enableWhileHover?{scale:1.02,y:-2}:void 0,onClick:()=>a(),children:[o.jsx("div",{className:"measurement-value measurement-value--large",children:B.toFixed(1)}),o.jsxs("div",{className:"measurement-label measurement-label--primary",children:["IMC • ",R.category]}),o.jsx("div",{className:"measurement-description",children:R.description})]}),K&&o.jsxs(z,{className:"measurement-detail-item",initial:t.enableInitialAnimations?{opacity:0,y:15}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.4,delay:.2}:void 0,whileHover:t.enableWhileHover?{scale:1.02,y:-2}:void 0,onClick:()=>a(),children:[o.jsxs("div",{className:"measurement-value",children:[Math.round(K)," ans"]}),o.jsx("div",{className:"measurement-label",children:"Âge Corporel"})]}),o.jsxs(z,{className:"measurement-detail-item",initial:t.enableInitialAnimations?{opacity:0,y:15}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.4,delay:.3}:void 0,whileHover:t.enableWhileHover?{scale:1.02,y:-2}:void 0,onClick:()=>a(),children:[o.jsxs("div",{className:"measurement-value",children:[b.toFixed(1)," kg"]}),o.jsx("div",{className:"measurement-label",children:"Poids Idéal"})]})]}),s&&s.hex&&o.jsx(z,{className:"measurement-detail-item",style:{"--icon-bg-color":`${s.hex}20`,"--icon-border-color":`${s.hex}50`,"--icon-text-color":s.hex},initial:t.enableInitialAnimations?{opacity:0,y:15}:!1,animate:t.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.4,delay:.4}:void 0,whileHover:t.enableWhileHover?{scale:1.02,y:-2}:void 0,onClick:()=>a(),children:o.jsxs("div",{className:"flex items-center gap-3",children:[o.jsx("div",{className:"w-12 h-12 rounded-full border-2 shadow-lg",style:{backgroundColor:s.hex,borderColor:`${s.hex}80`,boxShadow:`0 4px 12px ${s.hex}40`}}),o.jsxs("div",{children:[o.jsx("div",{className:"measurement-value text-sm",children:s.hex.toUpperCase()}),o.jsxs("div",{className:"measurement-label text-xs",children:["Couleur de Peau Extraite",s.confidence&&o.jsxs("span",{className:"ml-2 text-xs opacity-70",children:[Math.round(s.confidence*100),"% confiance"]})]})]})]})}),o.jsx("div",{className:"measurements-grid",children:N.map((_,v)=>o.jsxs(z,{className:`measurement-detail-item ${na(_.key)}`,style:{"--icon-bg-color":`color-mix(in srgb, ${_.color} 20%, transparent)`,"--icon-border-color":`color-mix(in srgb, ${_.color} 30%, transparent)`,"--icon-text-color":_.color},initial:t.enableStaggerAnimations?{opacity:0,y:20}:!1,animate:t.enableStaggerAnimations?{opacity:1,y:0}:{opacity:1},transition:t.enableFramerMotion?{duration:.4,delay:v*.1,ease:"easeOut"}:void 0,whileHover:t.enableWhileHover?{scale:1.02,y:-2}:void 0,onClick:()=>a(),children:[o.jsx("div",{className:"measurement-detail-icon-container",children:o.jsx(T,{Icon:D[_.icon],size:12,style:{color:_.color},variant:"pure"})}),o.jsxs("div",{className:"measurement-value",children:[_.value,_.unit]}),o.jsx("div",{className:"measurement-label",children:_.label})]},_.key))})]})})};function ia(e,n){const[r,t]=A.useState(e);return A.useEffect(()=>{const a=setTimeout(()=>{t(e)},n);return()=>{clearTimeout(a)}},[e,n]),r}const be=.05,le={bodyShape:[{key:"bodybuilderSize",label:"Développement musculaire",icon:"Zap",color:"#8B5CF6"},{key:"pearFigure",label:"Masse grasse",icon:"Triangle",color:"#F59E0B"},{key:"narrowWaist",label:"Tour de taille",icon:"Minimize2",color:"#10B981"},{key:"emaciated",label:"Gabarit",icon:"Minus",color:"#06B6D4"}],curves:[{key:"bigHips",label:"Hanches",icon:"Circle",color:"#EC4899"},{key:"assLarge",label:"Fessiers",icon:"Circle",color:"#F97316"}],chest:[]};function oa(e,n){const r=[];return le.bodyShape.forEach(t=>{const a=n.ranges[t.key];a&&!(a.min===0&&a.max===0)&&r.push({...t,category:"Corps"})}),le.curves.forEach(t=>{const a=n.ranges[t.key];a&&!(a.min===0&&a.max===0)&&r.push({...t,category:"Courbes"})}),le.chest.forEach(t=>{const a=n.ranges[t.key];a&&!(a.min===0&&a.max===0)&&r.push({...t,category:"Poitrine"})}),r}const Ae=de.memo(({currentMorphData:e,setCurrentMorphData:n,resetMorphsToInitial:r,morphPolicy:t,morphologyMapping:a,resolvedGender:i,isViewerReady:s,avatar3DRef:l})=>{const m=me(),[y,E]=A.useState(!1),[u,p]=A.useState(new Set),{click:k,formInput:F}=se(),d=ia(e,50),C=A.useMemo(()=>oa(i,t),[i,t]);de.useEffect(()=>{s&&l.current?.updateMorphData&&(c.debug("MORPH_ADJUSTMENT","Applying debounced morph data to 3D viewer",{morphDataKeys:Object.keys(d),resolvedGender:i}),l.current.updateMorphData(d))},[d,s,l,i]);const L=A.useCallback((_,v)=>{const O=t.ranges[_];if(!O)return;const I=Math.max(O.min,Math.min(O.max,v)),M={...e,[_]:I};n(M),p(h=>new Set([...h,_]));try{F()}catch(h){console.warn("MORPH_ADJUSTMENT","Audio feedback failed for button click",{audioError:h})}c.debug("MORPH_ADJUSTMENT","Morph value updated with direct 3D update",{morphKey:_,value:I.toFixed(3),resolvedGender:i,philosophy:"direct_3d_morph_update"})},[e,n,p,F,t.ranges,i]),j=A.useCallback(_=>{const O=(e[_]!==void 0&&e[_]!==null?e[_]:0)+be;L(_,O)},[e,L]),B=A.useCallback(_=>{const O=(e[_]!==void 0&&e[_]!==null?e[_]:0)-be;L(_,O)},[e,L]),R=A.useCallback(()=>{k(),p(new Set),r()},[r,k,p]),K=A.useMemo(()=>{const _={};return C.forEach(v=>{_[v.category]||(_[v.category]=[]),_[v.category].push(v)}),_},[C]),b=A.useMemo(()=>{const _=K.Corps||[],v=Object.entries(K).filter(([M])=>M!=="Corps"),O=Math.max(0,_.length-2),I=v.reduce((M,[,h])=>M+h.length,0);return O+I},[K]);if(!s||C.length===0)return null;const w=K.Corps||[],N=Object.entries(K).filter(([_])=>_!=="Corps");return o.jsx(z,{className:"slide-enter",initial:m.enableInitialAnimations?{opacity:0,y:20}:!1,animate:m.enableInitialAnimations?{opacity:1,y:0}:{opacity:1},transition:m.enableFramerMotion?{duration:.6,delay:.4}:void 0,children:o.jsxs(Q,{className:"morph-adjustment-card",children:[o.jsxs("div",{className:"bodyscan-flex-between mb-6",children:[o.jsxs("h4",{className:"text-white font-semibold bodyscan-flex-center bodyscan-gap-sm",children:[o.jsx("div",{className:"bodyscan-header-icon-container",style:{background:`
                  radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%),
                  linear-gradient(135deg, color-mix(in srgb, var(--color-body-scan-accent) 35%, transparent), color-mix(in srgb, var(--color-body-scan-accent) 25%, transparent))
                `,border:"2px solid color-mix(in srgb, var(--color-body-scan-accent) 50%, transparent)",boxShadow:"0 0 20px color-mix(in srgb, var(--color-body-scan-accent) 30%, transparent)"},children:o.jsx(T,{Icon:D.Settings,size:20,style:{color:"var(--color-body-scan-accent)"},variant:"pure"})}),"Ajustements morphologiques",u.size>0&&o.jsxs("span",{className:"morph-adjustment-badge",children:[u.size," modifié",u.size>1?"s":""]})]}),o.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[u.size>0&&o.jsxs("button",{onClick:R,className:"btn-glass px-4 py-2 text-sm bodyscan-flex-center bodyscan-gap-sm",title:"Réinitialiser tous les ajustements",children:[o.jsx(T,{Icon:D.RotateCcw,size:14}),o.jsx("span",{children:"Réinitialiser"})]}),o.jsx("button",{onClick:()=>{k(),E(!y)},className:"btn-glass--secondary-nav",children:o.jsx(T,{Icon:y?D.ChevronUp:D.ChevronDown,size:18,className:"bodyscan-text-warning"})})]})]}),o.jsx("p",{className:"text-white/70 text-sm mb-6",children:"Ajustez subtilement votre avatar en temps réel. Les modifications sont appliquées instantanément au modèle 3D."}),w.length>0&&o.jsxs("div",{className:"mb-6",children:[o.jsxs("h5",{className:"glowing-title-text bodyscan-flex-center bodyscan-gap-sm mb-4",children:[o.jsx("div",{className:"bodyscan-header-icon-container",children:o.jsx(T,{Icon:D.Circle,size:16,className:"bodyscan-text-accent"})}),"Corps"]}),o.jsx("div",{className:"space-y-3",children:w.slice(0,y?w.length:2).map((_,v)=>{const O=t.ranges[_.key];if(!O)return null;const I=e[_.key]!==void 0&&e[_.key]!==null?e[_.key]:0,M=I>O.min,h=I<O.max,g=u.has(_.key);return o.jsx(z,{className:`glass-nested-card glass-field-container p-4 ${g?"ring-2 ring-blue-400/30":""}`,initial:m.enableStaggerAnimations?{opacity:0,x:-20}:!1,animate:m.enableStaggerAnimations?{opacity:1,x:0}:{opacity:1},transition:m.enableFramerMotion?{delay:.1*v,duration:.4}:void 0,children:o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsxs("div",{className:"flex items-center space-x-3",children:[o.jsx(T,{Icon:D[_.icon]||D.Circle,size:16,style:{color:_.color},variant:"pure"}),o.jsx("span",{className:"text-white font-medium",children:_.label}),g&&o.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full"})]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx("button",{onClick:()=>B(_.key),disabled:!M,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${M?"":"opacity-30 cursor-not-allowed"}`,title:"Diminuer",children:o.jsx(T,{Icon:D.Minus,size:14})}),o.jsx("div",{className:`glass-field-container px-3 py-1 min-w-[60px] text-center text-sm font-mono ${g?"text-blue-300":"text-white/80"}`,title:I.toFixed(2),children:I.toFixed(2)}),o.jsx("button",{onClick:()=>j(_.key),disabled:!h,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${h?"":"opacity-30 cursor-not-allowed"}`,title:"Augmenter",children:o.jsx(T,{Icon:D.Plus,size:14})})]})]})},_.key)})})]}),b>0&&o.jsxs("button",{onClick:()=>{k(),E(!y)},className:"btn-glass w-full py-2 text-sm bodyscan-flex-center bodyscan-gap-sm mb-6",children:[o.jsx(T,{Icon:y?D.ChevronUp:D.ChevronDown,size:14}),o.jsx("span",{children:y?"Réduire":`Voir ${b} ajusteur${b>1?"s":""} de plus`})]}),y&&N.map(([_,v])=>o.jsxs("div",{className:"mb-6",children:[o.jsxs("h5",{className:"glowing-title-text bodyscan-flex-center bodyscan-gap-sm mb-4",children:[o.jsx("div",{className:"bodyscan-header-icon-container",children:o.jsx(T,{Icon:D.Circle,size:16,className:"bodyscan-text-accent"})}),_]}),o.jsx("div",{className:"space-y-3",children:v.map((O,I)=>{const M=t.ranges[O.key];if(!M)return null;const h=e[O.key]!==void 0&&e[O.key]!==null?e[O.key]:0,g=h>M.min,x=h<M.max,P=u.has(O.key);return o.jsx(z,{className:`glass-nested-card glass-field-container p-4 ${P?"ring-2 ring-blue-400/30":""}`,initial:m.enableStaggerAnimations?{opacity:0,x:-20}:!1,animate:m.enableStaggerAnimations?{opacity:1,x:0}:{opacity:1},transition:m.enableFramerMotion?{delay:.1*I,duration:.4}:void 0,children:o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsxs("div",{className:"flex items-center space-x-3",children:[o.jsx(T,{Icon:D[O.icon]||D.Circle,size:16,style:{color:O.color},variant:"pure"}),o.jsx("span",{className:"text-white font-medium",children:O.label}),P&&o.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full"})]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx("button",{onClick:()=>B(O.key),disabled:!g,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${g?"":"opacity-30 cursor-not-allowed"}`,title:"Diminuer",children:o.jsx(T,{Icon:D.Minus,size:14})}),o.jsx("div",{className:`glass-field-container px-3 py-1 min-w-[60px] text-center text-sm font-mono ${P?"text-blue-300":"text-white/80"}`,title:h.toFixed(2),children:h.toFixed(2)}),o.jsx("button",{onClick:()=>j(O.key),disabled:!x,className:`btn-glass--secondary-nav w-8 h-8 flex items-center justify-center ${x?"":"opacity-30 cursor-not-allowed"}`,title:"Augmenter",children:o.jsx(T,{Icon:D.Plus,size:14})})]})]})},O.key)})})]},_)),!y&&u.size>0&&o.jsx("div",{className:"mt-4 p-3 glass-nested-card",children:o.jsxs("p",{className:"text-white/60 text-sm text-center",children:[u.size," ajustement",u.size>1?"s":""," appliqué",u.size>1?"s":""]})})]})})});Ae.displayName="MorphAdjustmentControls";const ca=({isViewerReady:e,onSaveAvatar:n,onNewScan:r})=>o.jsxs("div",{className:"review-action-buttons",children:[o.jsx("button",{onClick:n,disabled:!e,className:`review-action-button ${e?"review-action-button--primary":"review-action-button--primary review-action-button--disabled"}`,children:o.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[o.jsx(T,{Icon:D.Save,size:20}),o.jsx("span",{children:"Sauvegarder cet avatar"})]})}),o.jsx("button",{onClick:r,className:"review-action-button review-action-button--secondary",children:o.jsxs("div",{className:"bodyscan-flex-center bodyscan-gap-sm",children:[o.jsx(T,{Icon:D.Scan,size:20}),o.jsx("span",{children:"Nouveau scan"})]})})]}),xe=e=>Math.round(e*1e3)/1e3;function la(e){const n={};return Object.entries(e).forEach(([r,t])=>{typeof t=="number"&&Number.isFinite(t)&&(n[r]=xe(t))}),n}function da(e){const n={},r=["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass","hipMass"];return Object.entries(e).forEach(([t,a])=>{r.includes(t)&&typeof a=="number"&&Number.isFinite(a)&&(n[t]=xe(a))}),n}function ma(e){return`${e}_v4.13`}async function _a(e){c.info("AVATAR_SAVE_SKIN_TONE_PREP","AUDIT: Starting skin tone preparation for persistence",{inputSkinTone:e,inputSkinToneType:typeof e,inputSkinToneKeys:e?Object.keys(e):[],inputSkinToneStringified:e?JSON.stringify(e):null,hasRgbProperty:!!e?.rgb,rgbValue:e?.rgb,hasLinearF32Property:!!e?.linear_f32,linearF32Value:e?.linear_f32});const n=await J(()=>import("./normalizeSkinTone---q_oCYc.js"),__vite__mapDeps([11,0,1,2,3,4,5,6,7,8,9,10])),r=n.resolveSkinTone,t=n.isSkinToneV2,a=r({skin_tone:e});if(!t(a.tone))throw c.error("AVATAR_SAVE_SKIN_TONE_PREP","CRITICAL: Resolved skin tone is NOT V2 format",{resolvedTone:a.tone,resolvedSource:a.source,hasSchema:!!a.tone?.schema,schema:a.tone?.schema,hasRgb:!!a.tone?.rgb,hasHex:!!a.tone?.hex,hasSrgbF32:!!a.tone?.srgb_f32,hasLinearF32:!!a.tone?.linear_f32,philosophy:"skin_tone_v2_validation_failed_after_resolve"}),new Error("Resolved skin tone is not in V2 format");const i={hasSchema:a.tone.schema==="v2",hasSpace:a.tone.space==="sRGB",hasFormat:a.tone.format==="rgb255",hasRgb:!!a.tone.rgb&&typeof a.tone.rgb.r=="number"&&typeof a.tone.rgb.g=="number"&&typeof a.tone.rgb.b=="number",rgbInRange:a.tone.rgb&&a.tone.rgb.r>=0&&a.tone.rgb.r<=255&&a.tone.rgb.g>=0&&a.tone.rgb.g<=255&&a.tone.rgb.b>=0&&a.tone.rgb.b<=255,hasHex:!!a.tone.hex&&/^#[0-9A-Fa-f]{6}$/.test(a.tone.hex),hasSrgbF32:!!a.tone.srgb_f32&&typeof a.tone.srgb_f32.r=="number"&&typeof a.tone.srgb_f32.g=="number"&&typeof a.tone.srgb_f32.b=="number",srgbF32InRange:a.tone.srgb_f32&&a.tone.srgb_f32.r>=0&&a.tone.srgb_f32.r<=1&&a.tone.srgb_f32.g>=0&&a.tone.srgb_f32.g<=1&&a.tone.srgb_f32.b>=0&&a.tone.srgb_f32.b<=1,hasLinearF32:!!a.tone.linear_f32&&typeof a.tone.linear_f32.r=="number"&&typeof a.tone.linear_f32.g=="number"&&typeof a.tone.linear_f32.b=="number",linearF32InRange:a.tone.linear_f32&&a.tone.linear_f32.r>=0&&a.tone.linear_f32.r<=1&&a.tone.linear_f32.g>=0&&a.tone.linear_f32.g<=1&&a.tone.linear_f32.b>=0&&a.tone.linear_f32.b<=1},s=Object.values(i).every(l=>l===!0);if(!s)throw c.error("AVATAR_SAVE_SKIN_TONE_PREP","CRITICAL: V2 skin tone validation failed",{validationResults:i,resolvedTone:a.tone,philosophy:"skin_tone_v2_properties_validation_failed"}),new Error("V2 skin tone properties validation failed");return c.info("AVATAR_SAVE_V2","Skin tone re-canonicalized and validated before persistence",{originalInput:e,resolvedTone:a.tone,resolvedSource:a.source,resolvedToneRGB:`rgb(${a.tone.rgb.r}, ${a.tone.rgb.g}, ${a.tone.rgb.b})`,resolvedToneHex:a.tone.hex,resolvedToneSchema:a.tone.schema,resolvedToneLinearF32:a.tone.linear_f32,validationResults:i,allPropertiesValid:s,philosophy:"re_canonicalize_and_validate_before_persistence"}),a.tone}async function pa(e,n,r,t,a,i,s,l,m,y,E,u){if(c.info("AVATAR_SAVE_AUDIT","Starting avatar save with complete input audit",{userId:e?.userId,hasSkinTone:!!l,skinToneRGB:l?`rgb(${l.rgb.r}, ${l.rgb.g}, ${l.rgb.b})`:"none",skinToneHex:l?.hex,skinToneSource:l?.source,skinToneConfidence:l?.confidence,skinToneSchema:l?.schema,resolvedGender:m,completeMorphDataCount:Object.keys(r).length,stableLimbMassesCount:Object.keys(s).length,scanResultsKeys:t?Object.keys(t):[],philosophy:"skin_tone_save_audit_entry_point"}),!e?.userId){y({type:"error",title:"Erreur d'authentification",message:"Impossible de sauvegarder sans utilisateur connecté",duration:4e3});return}if(!r||Object.keys(r).length===0){y({type:"error",title:"Aucune donnée à sauvegarder",message:"Aucune donnée morphologique disponible",duration:4e3});return}try{const p=la(r),k=da(s);let F=null;const d=await _a(l);c.info("AVATAR_SAVE_CRITICAL_AUDIT","AUDIT: skinTonePayload after preparation - COMPLETE STRUCTURE",{skinTonePayload:d,skinTonePayloadType:typeof d,skinTonePayloadKeys:d?Object.keys(d):[],skinTonePayloadStringified:d?JSON.stringify(d):null,hasAllV2Properties:!!(d?.rgb&&d?.hex&&d?.srgb_f32&&d?.linear_f32&&d?.schema),v2PropertiesIntegrity:d?{rgb:d.rgb,hex:d.hex,srgb_f32:d.srgb_f32,linear_f32:d.linear_f32,schema:d.schema,source:d.source,confidence:d.confidence}:null,philosophy:"critical_skin_tone_payload_audit_after_preparation"}),c.info("AVATAR_SAVE_V2","V2 skin tone payload preparation - canonical format validation",{userId:e.userId,inputSkinToneAudit:l?{hasRgbProperty:!!l.rgb,rgbValue:l.rgb,hasHexProperty:!!l.hex,hexValue:l.hex,hasSchemaProperty:!!l.schema,schemaValue:l.schema,hasLinearF32Property:!!l.linear_f32,linearF32Value:l.linear_f32,hasSrgbF32Property:!!l.srgb_f32,srgbF32Value:l.srgb_f32,hasSourceProperty:!!l.source,sourceValue:l.source,hasConfidenceProperty:!!l.confidence,confidenceValue:l.confidence,completeObjectStructure:l}:null,originalSkinTone:l?{rgb:l.rgb,hex:l.hex,schema:l.schema,source:l.source,confidence:l.confidence}:null,preparedSkinTone:d?{rgb:d.rgb,hex:d.hex,schema:d.schema,srgb_f32:d.srgb_f32,linear_f32:d.linear_f32,source:d.source,confidence:d.confidence}:null,preparedSkinToneCompleteAudit:d?{hasAllRequiredProperties:!!(d.rgb&&d.hex&&d.srgb_f32&&d.linear_f32),rgbIntegrity:d.rgb?{r:d.rgb.r,g:d.rgb.g,b:d.rgb.b,allFinite:Number.isFinite(d.rgb.r)&&Number.isFinite(d.rgb.g)&&Number.isFinite(d.rgb.b)}:null,hexIntegrity:{value:d.hex,isValidHex:/^#[0-9A-Fa-f]{6}$/.test(d.hex||"")},srgbF32Integrity:d.srgb_f32?{r:d.srgb_f32.r,g:d.srgb_f32.g,b:d.srgb_f32.b,allFinite:Number.isFinite(d.srgb_f32.r)&&Number.isFinite(d.srgb_f32.g)&&Number.isFinite(d.srgb_f32.b),inRange:d.srgb_f32.r>=0&&d.srgb_f32.r<=1&&d.srgb_f32.g>=0&&d.srgb_f32.g<=1&&d.srgb_f32.b>=0&&d.srgb_f32.b<=1}:null,linearF32Integrity:d.linear_f32?{r:d.linear_f32.r,g:d.linear_f32.g,b:d.linear_f32.b,allFinite:Number.isFinite(d.linear_f32.r)&&Number.isFinite(d.linear_f32.g)&&Number.isFinite(d.linear_f32.b),inRange:d.linear_f32.r>=0&&d.linear_f32.r<=1&&d.linear_f32.g>=0&&d.linear_f32.g<=1&&d.linear_f32.b>=0&&d.linear_f32.b<=1}:null,completePayloadStructure:d}:null,skinTonePreparationSuccess:!!d,v2FormatIntegrity:!!(l?.rgb&&d?.rgb&&l.rgb.r===d.rgb.r&&l.rgb.g===d.rgb.g&&l.rgb.b===d.rgb.b),philosophy:"v2_canonical_format_validation"});const C=ma(m),L="pbr-v2",j="v1.0",B=Object.keys(k),K=["armMass","forearmMass","thighMass","calfMass","torsoMass","neckMass"].filter(v=>!B.includes(v));K.length>0&&c.warn("AVATAR_SAVE","Missing limb masses detected",{missing:K.join(", "),present:B.join(", ")}),c.info("AVATAR_SAVE_LIMB_MASSES","Limb masses before persistence",{count:B.length,values:k});const b={final_shape_params:p,final_limb_masses:k,skin_tone:d,resolved_gender:m,mapping_version:j,gltf_model_id:C,material_config_version:L,savedMorphData:p,morphBounds:a,selectedArchetypes:i,lastMorphSave:new Date().toISOString(),scanId:t?.serverScanId||t?.commit?.scan_id,avatar_version:"v2.0"},w={...b};delete w.skinTone,delete w.skinToneLegacy,delete w.skin_tone_legacy,delete w.legacy_skin_tone,c.info("AVATAR_SAVE_V2","Legacy skin tone fields purged from payload",{purgedFields:["skinTone","skinToneLegacy","skin_tone_legacy","legacy_skin_tone"],canonicalField:"skin_tone",philosophy:"legacy_purge_prevent_fallback_confusion"}),c.info("AVATAR_SAVE_V2","Complete V2 payload prepared - canonical skin tone persistence",{userId:e.userId,payloadKeys:Object.keys(b),canonicalSkinTone:b.skin_tone?{rgb:b.skin_tone.rgb,hex:b.skin_tone.hex,schema:b.skin_tone.schema,source:b.skin_tone.source,confidence:b.skin_tone.confidence}:null,avatarVersion:b.avatar_version,resolvedGender:b.resolved_gender,gltfModelId:b.gltf_model_id,materialConfigVersion:b.material_config_version,v2SkinTonePersistenceReady:!!b.skin_tone,legacyFieldsPurged:!0,philosophy:"v2_canonical_payload_persistence"});const N={...e.preferences,...w};delete N.skinTone,delete N.skinToneLegacy,delete N.skin_tone_legacy,delete N.legacy_skin_tone,c.info("AVATAR_SAVE_V2","Purging legacy skin tone fields from preferences",{userId:e.userId,purgedFromPreferences:["skinTone","skinToneLegacy","skin_tone_legacy","legacy_skin_tone"],canonicalFieldPresent:!!N.skin_tone,philosophy:"preferences_legacy_purge"}),c.info("AVATAR_SAVE_V2","Saving avatar with V2 canonical skin tone data",{userId:e.userId,scanId:w.scanId,resolvedGender:m,hasV2SkinTone:!!d,v2SkinToneRGB:d?.rgb?`rgb(${d.rgb.r}, ${d.rgb.g}, ${d.rgb.b})`:"none",v2SkinToneHex:d?.hex||"none",v2SkinToneSchema:d?.schema||"none",skinToneSource:d?.source,completePayloadAuditBeforeSave:{finalShapeParamsCount:Object.keys(w.final_shape_params||{}).length,finalLimbMassesCount:Object.keys(w.final_limb_masses||{}).length,skinToneCompleteStructure:w.skin_tone,skinToneLinearF32Present:!!w.skin_tone?.linear_f32,skinToneSrgbF32Present:!!w.skin_tone?.srgb_f32,skinToneRgbPresent:!!w.skin_tone?.rgb,skinToneHexPresent:!!w.skin_tone?.hex,avatarVersion:w.avatar_version,gltfModelId:w.gltf_model_id,materialConfigVersion:w.material_config_version,mappingVersion:w.mapping_version},legacyFieldsPurged:!0,philosophy:"v2_canonical_avatar_persistence"}),c.info("AVATAR_SAVE_AUDIT","About to call updateProfile with payload",{userId:e.userId,payloadSkinToneIncluded:!!b.skin_tone,finalPayloadAuditBeforeUpdateProfile:{preferencesKeys:Object.keys(N),skinToneInPreferences:!!N.skin_tone,skinToneStructureInPreferences:N.skin_tone,skinToneLinearF32InPreferences:N.skin_tone?.linear_f32,skinToneSrgbF32InPreferences:N.skin_tone?.srgb_f32,skinToneRgbInPreferences:N.skin_tone?.rgb,skinToneHexInPreferences:N.skin_tone?.hex,avatarVersionInPreferences:N.avatar_version,resolvedGenderInPreferences:N.resolved_gender},philosophy:"pre_update_profile_call_audit"});try{await n({preferences:{...e.preferences,...b}}),c.info("AVATAR_SAVE_AUDIT","updateProfile call completed successfully",{userId:e.userId,updateProfileCallSuccess:!0,payloadKeys:Object.keys(b),skinToneIncluded:!!b.skin_tone,avatarVersion:b.avatar_version,philosophy:"update_profile_success"})}catch(v){throw c.error("AVATAR_SAVE_AUDIT","updateProfile call failed - database error",{error:v instanceof Error?v.message:"Unknown error",stack:v instanceof Error?v.stack:void 0,userId:e.userId,payloadKeys:Object.keys(b),philosophy:"update_profile_database_failure"}),v}const _=t?.serverScanId||t?.commit?.scan_id;if(_){c.info("AVATAR_SAVE_AUDIT","About to update body_scans table with complete avatar payload",{serverScanId:_,userId:e.userId,skinToneIncluded:!!d,skinToneRGB:d?.srgb_u8?`rgb(${d.srgb_u8.r}, ${d.srgb_u8.g}, ${d.srgb_u8.b})`:"none",skinToneHex:d?.hex||"none",philosophy:"body_scans_update_pre_call_audit"});const{data:v,error:O}=await Pe.from("body_scans").update({metrics:{...t.estimate?.extracted_data,final_shape_params:p,final_limb_masses:k,skin_tone:d,resolved_gender:m,mapping_version:j,gltf_model_id:C,material_config_version:L,avatar_version:"v2.0",user_adjusted_morph:p,morph_saved_at:new Date().toISOString()}}).eq("id",_).select("metrics").single();if(F=O,!O&&v?.metrics){const I=v.metrics.skin_tone,M=I&&I.schema==="v2"&&I.rgb&&I.hex&&I.srgb_f32&&I.linear_f32;c.info("AVATAR_SAVE_AUDIT","Body scans skin tone persistence verification",{serverScanId:_,userId:e.userId,bodyScanSkinTonePersistenceValid:M,persistedBodyScanSkinTone:I,expectedSkinTone:d,philosophy:"body_scans_skin_tone_persistence_verification"}),M||c.error("AVATAR_SAVE_AUDIT","CRITICAL: Body scans skin tone persistence validation failed",{serverScanId:_,userId:e.userId,persistedBodyScanSkinTone:I,expectedSkinTone:d,philosophy:"body_scans_skin_tone_persistence_validation_failed"})}O?c.error("AVATAR_SAVE_AUDIT","Failed to update body_scans table",{error:O.message,serverScanId:_,userId:e.userId,philosophy:"body_scans_update_failure_audit"}):c.info("AVATAR_SAVE_AUDIT","Successfully updated body_scans table",{serverScanId:_,userId:e.userId,philosophy:"body_scans_update_success_audit"})}c.info("AVATAR_SAVE_V2","All V2 canonical persistence operations completed successfully",{userId:e.userId,scanId:w.scanId,serverScanId:_,feedbackWorked:!0,philosophy:"complete_success_with_feedback"});try{y({type:"success",title:"Avatar sauvegardé",message:"Votre avatar a été sauvegardé avec succès",duration:3e3}),E(),c.info("AVATAR_SAVE_V2","Success feedback delivered successfully",{userId:e.userId,legacyFieldsPurged:!0,philosophy:"v2_canonical_persistence_success_confirmed_before_feedback"}),u&&setTimeout(()=>{u("/avatar#avatar"),c.info("AVATAR_SAVE_V2","Auto-redirected to avatar page after save",{userId:e.userId,redirectPath:"/avatar#avatar",philosophy:"post_save_auto_redirect"})},1500)}catch(v){c.error("AVATAR_SAVE_V2","Success feedback failed but save succeeded",{feedbackError:v instanceof Error?v.message:"Unknown error",userId:e.userId,saveSucceeded:!0,philosophy:"feedback_failure_but_save_success"})}}catch(p){c.error("AVATAR_SAVE","Avatar save failed - operation error",{error:p instanceof Error?p.message:"Unknown error",errorType:p instanceof Error?p.constructor.name:typeof p,stack:p instanceof Error?p.stack:void 0,userId:e.userId,scanId:t?.serverScanId||t?.commit?.scan_id,serverScanId:t?.serverScanId,hasSkinTone:!!l,philosophy:"save_operation_failure"}),c.error("AVATAR_SAVE_AUDIT","Avatar save failed - detailed error audit",{error:p instanceof Error?p.message:"Unknown error",errorName:p instanceof Error?p.name:"UnknownError",userId:e.userId,serverScanId:t?.serverScanId,stableSkinToneAtFailure:l?{hasRgb:!!l.rgb,rgbValue:l.rgb,source:l.source,schema:l.schema}:null,payloadPreparationCompleted:!!skinTonePayload,philosophy:"save_failure_detailed_audit"});try{y({type:"error",title:"Erreur de sauvegarde",message:"Erreur de base de données lors de la sauvegarde",duration:4e3})}catch(k){c.error("AVATAR_SAVE_AUDIT","Error toast also failed",{originalError:p instanceof Error?p.message:"Unknown error",toastError:k instanceof Error?k.message:"Unknown error",userId:e.userId,philosophy:"error_toast_failure"})}throw p}}const ua=()=>{me();const e=ye(),{updateProfile:n}=ve(),{success:r}=se(),{scanResults:t,currentMorphData:a,completeMorphData:i,setCurrentMorphData:s,setActiveView:l,autoRotate:m,setAutoRotate:y,avatar3DRef:E,resetMorphsToInitial:u,stableUserProfile:p,stableMorphBounds:k,stableSelectedArchetypes:F,stableLimbMasses:d,stableSkinTone:C,profile:L,isViewerReady:j,handleViewerReady:B,morphologyMapping:R,morphPolicy:K,showToast:b,resolvedGender:w,criticalError:N,setCriticalError:_}=Ze(),v=A.useMemo(()=>{const g=i||{};return c.debug("BODY_SCAN_REVIEW","Using AI-refined morphs directly (no filtering)",{originalKeys:Object.keys(g).length,finalKeys:Object.keys(g).length,gender:w,philosophy:"ai_driven_no_filtering"}),g},[i,w]);if(A.useMemo(()=>{const g=!!(t&&p&&R&&v&&Object.keys(v).length>0&&w);return g&&!j&&queueMicrotask(()=>{c.info("Gate resolved - viewer ready for initialization",{hasScanResults:!!t,hasUserProfile:!!p,hasMorphologyMapping:!!R,finalShapeParamsCount:Object.keys(v).length,resolvedGender:w,readyForViewer:g})}),g},[t,p,R,v,w,j]),N)return o.jsx("div",{className:"space-y-8",children:o.jsxs(Q,{className:"text-center p-8",children:[o.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center",children:o.jsx(T,{Icon:D.AlertCircle,size:32,className:"text-red-400"})}),o.jsx("h3",{className:"text-xl font-bold text-white mb-3",children:"Erreur de données critiques"}),o.jsx("p",{className:"text-red-300 text-sm mb-6 leading-relaxed max-w-md mx-auto",children:N}),o.jsxs("div",{className:"space-y-4",children:[o.jsx("button",{onClick:()=>e("/body-scan"),className:"btn-glass--primary px-6 py-3",children:o.jsxs("div",{className:"flex items-center justify-center gap-2",children:[o.jsx(T,{Icon:D.Scan,size:16}),o.jsx("span",{children:"Nouveau scan"})]})}),o.jsx("button",{onClick:()=>{_(null),window.location.reload()},className:"btn-glass px-6 py-3",children:o.jsxs("div",{className:"flex items-center justify-center gap-2",children:[o.jsx(T,{Icon:D.RotateCcw,size:16}),o.jsx("span",{children:"Recharger"})]})})]})]})});const O=A.useCallback(g=>{s(g)},[s]);A.useCallback(g=>{l(g);const x=E.current?.getCameraControls?.();x?.setCameraView&&x.setCameraView(g)},[l,E]),A.useCallback(()=>{y(!m);const x=E.current?.getCameraControls?.();x?.toggleAutoRotate&&x.toggleAutoRotate()},[m,y,E]);const I=A.useCallback(async()=>{await pa(L,n,i,t,k,F,d,C,w,b,r,e)},[L,n,i,t,k,F,d,C,w,b,r,e]),M=A.useCallback(()=>{e("/body-scan")},[e]),h=t?.estimate?.extracted_data?.processing_confidence||t?.match?.semantic_coherence_score||t?.insights?.confidence||null;return A.useMemo(()=>{if(!h)return null;const g=t?.metadata?.morph_generation_fallback||t?.match?.metadata?.morph_generation_fallback||!1,x=g?h*.7:h;return c.debug("CONFIDENCE_CALCULATION","Adjusted confidence based on morph generation fallback",{baseConfidence:h.toFixed(3),morphGenerationFallback:g,adjustedConfidence:x.toFixed(3),philosophy:"telemetry_coherent_confidence_calculation"}),x},[h,t?.metadata?.morph_generation_fallback,t?.match?.metadata?.morph_generation_fallback]),t?o.jsxs("div",{className:"space-y-8 visionos-grid",children:[o.jsxs(Q,{className:"bodyscan-card p-8 -mt-4",children:[o.jsxs("div",{className:"flex items-center justify-between mb-4",children:[o.jsxs("h3",{className:"text-white font-semibold flex items-center gap-2",children:[o.jsx("div",{className:"glowing-icon-container",children:o.jsx(T,{Icon:D.Eye,size:16,className:"text-purple-400"})}),o.jsx("span",{className:"glowing-title-text",children:"Votre Avatar 3D"})]}),!j&&o.jsxs("div",{className:"viewer-status-badge viewer-status-badge--preparing flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/20 border border-blue-400/30",children:[o.jsx("div",{className:"viewer-status-icon w-2 h-2 rounded-full bg-blue-400 animate-pulse"}),o.jsx("span",{className:"viewer-status-text text-blue-300 text-xs font-medium",children:"Préparation..."})]}),j&&o.jsxs("div",{className:"viewer-status-badge viewer-status-badge--ready flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/20 border border-green-400/30",children:[o.jsx(T,{Icon:D.Check,size:12,className:"viewer-status-icon text-green-400"}),o.jsx("span",{className:"viewer-status-text text-green-300 text-xs font-medium",children:"Prêt"})]})]}),o.jsx("div",{className:"avatar-3d-viewer-container h-[400px] sm:h-[500px] md:h-[550px] lg:h-[600px] xl:h-[650px] rounded-2xl bg-gradient-to-br from-purple-500/10 via-blue-500/10 to-cyan-500/10 border border-purple-400/20 relative overflow-hidden",children:o.jsx(Me,{ref:E,scanResult:t,userProfile:p||{sex:w,height_cm:175,weight_kg:70},morphData:v,limbMasses:d,skinTone:C,minMaxBounds:k,selectedArchetypes:F,serverScanId:t?.serverScanId||t?.commit?.scan_id,resolvedGender:w,className:"w-full h-full",autoRotate:m,onMorphDataChange:O,onViewerReady:B,showControls:!0})})]}),R&&K&&o.jsx("div",{className:"mt-8",children:o.jsx(Ae,{currentMorphData:a,setCurrentMorphData:s,resetMorphsToInitial:u,morphPolicy:K,morphologyMapping:R,resolvedGender:w,isViewerReady:j,avatar3DRef:E})}),o.jsx("div",{className:"mt-8",children:o.jsx(ra,{scanResults:t,userProfile:p,skinTone:C})}),o.jsx("div",{className:"mt-12",children:o.jsx(ca,{isViewerReady:j,onSaveAvatar:I,onNewScan:M})})]}):o.jsxs(Q,{className:"text-center p-8",children:[o.jsx("div",{className:"w-12 h-12 mx-auto mb-4 rounded-full bg-purple-500/20 flex items-center justify-center",children:o.jsx(T,{Icon:D.Loader2,size:24,className:"text-purple-400 animate-spin"})}),o.jsx("h3",{className:"text-white font-semibold mb-2",children:"Chargement de votre avatar"}),o.jsx("p",{className:"text-white/60 text-sm",children:"Préparation de l'expérience 3D..."})]})},Pa=()=>{const{isActive:e,steps:n,currentStep:r,progress:t,message:a,subMessage:i}=Z();return o.jsxs("div",{className:"max-w-7xl mx-auto mt-4 space-y-6 pb-4",children:[e&&n.length>0&&o.jsx(we,{steps:n,currentStepId:"avatar",progress:100,message:"Avatar 3D Prêt",subMessage:"Ajustez et sauvegardez votre reflet numérique"}),o.jsx(ua,{})]})};export{Pa as default};
