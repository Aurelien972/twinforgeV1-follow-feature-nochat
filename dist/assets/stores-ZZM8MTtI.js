const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/page-fridge-C1QVLxk9.js","assets/vendor-ZbFMzY-i.js","assets/utils-CUtLAp28.js","assets/supabase-8_3juhcZ.js","assets/ui-components-OHztaiDj.js","assets/motion-HGAT--uT.js","assets/page-fridge-scan-C_CisW7P.js","assets/page-fridge-scan-DAz6gEg3.css","assets/ui-components-DyoLTZgZ.css","assets/date-utils-BlBdbPk_.js","assets/index-B1aqsbWO.js","assets/page-profile-C7_QN5um.js","assets/forms-CBZzt5O6.js","assets/index-CS1ADwVz.css"])))=>i.map(i=>d[i]);
var Re=Object.defineProperty;var Ce=(t,n,e)=>n in t?Re(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var H=(t,n,e)=>Ce(t,typeof n!="symbol"?n+"":n,e);import{l as a,s as m,_ as E,p as fe}from"./page-fridge-C1QVLxk9.js";import{p as Y,c as ae,n as re}from"./utils-CUtLAp28.js";import{d as y}from"./vendor-ZbFMzY-i.js";const q=[{title:"Initialisation de la Forge Nutritionnelle",subtitle:"Préparation de votre plan personnalisé",message:"Analyse de votre profil nutritionnel...",duration:3e3,progressStart:0,progressEnd:15},{title:"Analyse des Préférences",subtitle:"Optimisation selon vos goûts",message:"Traitement de vos préférences alimentaires...",duration:2500,progressStart:15,progressEnd:30},{title:"Génération Intelligente",subtitle:"Création de recettes personnalisées",message:"Génération des repas avec IA...",duration:4e3,progressStart:30,progressEnd:60},{title:"Optimisation Nutritionnelle",subtitle:"Équilibrage des macronutriments",message:"Calcul des valeurs nutritionnelles...",duration:2e3,progressStart:60,progressEnd:80},{title:"Finalisation",subtitle:"Derniers ajustements",message:"Finalisation de votre plan hebdomadaire...",duration:1500,progressStart:80,progressEnd:95}],Ne="twinforge:meal-plan-store";function we(t,n){let e;n?e=new Date(n):(e=new Date,e.setHours(0,0,0,0));const r=new Date(e);return r.setDate(e.getDate()+(t-1)*7),r.setHours(0,0,0,0),r}const Le=(t,n)=>({formatted:`${t.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})} - ${n.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}`,startDate:t.toISOString(),endDate:n.toISOString()});function M(t,n=0){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"){const e=t.match(/-?\d+(?:[.,]\d+)?/);return e?Number(e[0].replace(",",".")):n}return n}function Q(t){console.log("🔍 [transformEdgeMealToFrontendMealDetail] Raw edgeMeal:",t);const n=(t?.mealName??t?.title??t?.meal??"Repas sans nom").toString(),e=(t?.descriptionSummary??t?.description??"").toString();!t?.mealName&&!t?.title&&!t?.meal&&console.warn("⚠️ [transformEdgeMealToFrontendMealDetail] Meal missing name fields:",t);const r=M(t?.prep_time_min??t?.prepTimeMin,0),s=M(t?.cook_time_min??t?.cookTimeMin,0),i=M(t?.calories_est??t?.estimatedCalories??t?.calories,0);console.log("🔍 [transformEdgeMealToFrontendMealDetail] Processed values:",{estimatedPrepTime:r,estimatedCookTime:s,estimatedCalories:i});const o=Array.isArray(t?.ingredients)?t.ingredients:Array.isArray(t?.mainIngredients)?t.mainIngredients:[],l=Array.isArray(t?.dietaryTags)?t.dietaryTags:[],c=Array.isArray(t?.mealComponents)?t.mealComponents:[];return{mealName:n,descriptionSummary:e,mainIngredients:o,estimatedPrepTime:r,estimatedCookTime:s,estimatedCalories:i,nutritionalOverview:{kcal:i,protein:M(t?.protein,0),carbs:M(t?.carbs,0),fat:M(t?.fat,0)},mealComponents:c,dietaryTags:l,recipeId:t?.recipeId,isDetailedRecipeGenerated:!1,detailedRecipe:void 0,status:"ready"}}function Me(t){console.log("🔍 [transformEdgeDayToFrontendDay] Raw dayData:",t);const e=new Date(t.date).toLocaleDateString("fr-FR",{weekday:"long"}),r={};t.breakfast&&(r.breakfast=Q(t.breakfast)),t.lunch&&(r.lunch=Q(t.lunch)),t.dinner&&(r.dinner=Q(t.dinner)),t.snack&&(r.snack=Q(t.snack));const s=[r.breakfast,r.lunch,r.dinner,r.snack].filter(Boolean),i=s.reduce((c,d)=>c+M(d.estimatedPrepTime,0),0),o=s.reduce((c,d)=>c+M(d.estimatedCookTime,0),0),l=M(t.total_calories,s.reduce((c,d)=>c+M(d.estimatedCalories,0),0));return console.log("🔍 [transformEdgeDayToFrontendDay] Calculated totals:",{prepTime:i,cookTime:o,totalCalories:l}),{date:t.date,dayName:e.charAt(0).toUpperCase()+e.slice(1),meals:r,prepTime:i,cookTime:o,totalCalories:l,daily_summary:t.daily_summary,isBatchCookingDay:t.isBatchCookingDay||!1,status:"ready"}}const Fe=(t,n)=>({startProgressSimulation:()=>{const e=n();e.progressIntervalId&&clearInterval(e.progressIntervalId),e.progressTimeoutId&&clearTimeout(e.progressTimeoutId);const r=Date.now();let s=0;const i=()=>{const c=Date.now(),d=n();if(c-d.lastBackendProgressUpdate<2e3&&d.lastBackendProgressUpdate>0)return;if(s>=q.length){t({generationProgress:95,currentLoadingTitle:"Finalisation",currentLoadingSubtitle:"Derniers ajustements",loadingMessage:"Finalisation de votre plan hebdomadaire..."});return}const u=q[s],g=r+q.slice(0,s).reduce((S,N)=>S+N.duration,0),p=c-g;if(p>=u.duration){if(s++,s<q.length){const S=q[s];t({simulatedStepIndex:s,generationProgress:S.progressStart,currentLoadingTitle:S.title,currentLoadingSubtitle:S.subtitle,loadingMessage:S.message})}}else{const S=p/u.duration,N=u.progressStart+(u.progressEnd-u.progressStart)*S;t({generationProgress:Math.min(N,u.progressEnd),currentLoadingTitle:u.title,currentLoadingSubtitle:u.subtitle,loadingMessage:u.message})}},o=q[0];t({simulatedStepIndex:0,simulatedProgressStartTime:r,lastBackendProgressUpdate:0,generationProgress:o.progressStart,currentLoadingTitle:o.title,currentLoadingSubtitle:o.subtitle,loadingMessage:o.message});const l=setInterval(i,100);t({progressIntervalId:l}),a.info("MEAL_PLAN_STORE","Progress simulation started",{stepsCount:q.length,timestamp:new Date().toISOString()})},stopProgressSimulation:()=>{const e=n();e.progressIntervalId&&clearInterval(e.progressIntervalId),e.progressTimeoutId&&clearTimeout(e.progressTimeoutId),t({progressIntervalId:null,progressTimeoutId:null,simulatedStepIndex:0,lastBackendProgressUpdate:0,simulatedProgressStartTime:0,simulatedProgressCurrentStepDuration:0,simulatedProgressCurrentStepStartValue:0,simulatedProgressCurrentStepEndValue:0}),a.info("MEAL_PLAN_STORE","Progress simulation stopped",{timestamp:new Date().toISOString()})}}),ke=(t,n)=>({loadAvailableInventories:async()=>{try{const{data:{user:e}}=await m.auth.getUser();if(!e)return;a.info("MEAL_PLAN_STORE","Loading available inventories",{userId:e.id,timestamp:new Date().toISOString()});const{data:r,error:s}=await m.from("recipe_sessions").select("id, created_at, inventory_final, status").eq("user_id",e.id).not("inventory_final","is",null).order("created_at",{ascending:!1});if(a.debug("MEAL_PLAN_STORE","Raw Supabase response for recipe_sessions",{userId:e.id,data:r?r.map(c=>({id:c.id,created_at:c.created_at,inventory_final_length:c.inventory_final?.length,status:c.status})):null,error:s?.message,timestamp:new Date().toISOString()}),a.debug("MEAL_PLAN_STORE","Raw data from Supabase before filtering",{userId:e.id,totalSessions:r?.length||0,sessions:r?r.map(c=>({id:c.id,created_at:c.created_at,inventory_final_type:Array.isArray(c.inventory_final)?"array":typeof c.inventory_final,inventory_final_length:c.inventory_final?.length||0,status:c.status})):[],timestamp:new Date().toISOString()}),s)throw new Error(`Failed to load inventories: ${s.message}`);const i=(r||[]).filter(c=>c.inventory_final&&Array.isArray(c.inventory_final)&&c.inventory_final.length>0);a.debug("MEAL_PLAN_STORE","Filtered valid inventories",{userId:e.id,validInventoriesCount:i.length,validInventoriesIds:i.map(c=>c.id),timestamp:new Date().toISOString()}),a.debug("MEAL_PLAN_STORE","Valid inventories after filtering",{userId:e.id,validInventoriesCount:i.length,validInventories:i.map(c=>({id:c.id,created_at:c.created_at,inventory_final_length:c.inventory_final?.length||0,status:c.status})),timestamp:new Date().toISOString()}),t({availableInventories:i});const o=n().selectedInventoryId;i.length>0?o&&i.some(d=>d.id===o)?a.debug("MEAL_PLAN_STORE","Current selected inventory is valid",{userId:e.id,currentSelectedId:o,timestamp:new Date().toISOString()}):(a.info("MEAL_PLAN_STORE","No valid selected inventory found, defaulting to first available",{userId:e.id,currentSelectedId:o,defaultingTo:i[0].id,timestamp:new Date().toISOString()}),t({selectedInventoryId:i[0].id})):o!==null?(a.info("MEAL_PLAN_STORE","No inventories available, clearing selected inventory",{userId:e.id,currentSelectedId:o,timestamp:new Date().toISOString()}),t({selectedInventoryId:null})):a.debug("MEAL_PLAN_STORE","No inventories available and selected inventory already null",{userId:e.id,timestamp:new Date().toISOString()});const l=n().selectedInventoryId;i.length>0&&!l&&(a.info("MEAL_PLAN_STORE","Force selecting first available inventory",{userId:e.id,forcedSelectionId:i[0].id,timestamp:new Date().toISOString()}),t({selectedInventoryId:i[0].id})),a.info("MEAL_PLAN_STORE","Available inventories loaded",{inventoriesCount:i.length,selectedInventoryId:n().selectedInventoryId,timestamp:new Date().toISOString()})}catch(e){a.error("MEAL_PLAN_STORE","Failed to load available inventories",{error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()})}},selectInventory:e=>{t({selectedInventoryId:e}),a.info("MEAL_PLAN_STORE","Inventory selected",{inventoryId:e,timestamp:new Date().toISOString()})}}),Ue=(t,n)=>({date:t,dayName:n,meals:{breakfast:{title:"",description:"",ingredients:[],prep_time_min:0,calories_est:0,status:"idle",isDetailedRecipeGenerated:!1},lunch:{title:"",description:"",ingredients:[],prep_time_min:0,calories_est:0,status:"idle",isDetailedRecipeGenerated:!1},dinner:{title:"",description:"",ingredients:[],prep_time_min:0,calories_est:0,status:"idle",isDetailedRecipeGenerated:!1},snack:{title:"",description:"",ingredients:[],prep_time_min:0,calories_est:0,status:"idle",isDetailedRecipeGenerated:!1}},daily_summary:"",prepTime:0,cookTime:0,totalCalories:0,status:"loading"}),xe=async(t,n)=>{const e=JSON.stringify({title:t,ingredients:n.sort().join(",")}),s=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join("")},Ge=t=>({title:t.detailedRecipe?.title||t.mealName||t.title||"Generated Meal Image",description:t.detailedRecipe?.description||t.descriptionSummary||"",ingredients:t.detailedRecipe?.ingredients||(t.mainIngredients||[]).map(n=>typeof n=="string"?{name:n}:n)}),oe=(t,n,e,r,s)=>{const{currentPlan:i,setCurrentPlan:o}=C.getState();if(!i||!i.days[t]){console.error("MEAL_PLAN_STORE No plan or day found for image URL update");return}const l={...i,days:i.days.map((c,d)=>d===t?{...c,meals:{...c.meals,[n]:{...c.meals[n],imageUrl:s?void 0:e,imageGenerationError:s||!1,updatedAt:r}}}:c)};o(l)},qe=async(t,n,e)=>{try{console.log("MEAL_PLAN_STORE Starting image generation for meal",{dayIndex:t,mealType:n,mealTitle:e.mealName||e.title,hasDetailedRecipe:!!e.detailedRecipe});const r=Ge(e),s=r.ingredients.map(u=>u.name),i=await xe(r.title,s),o=e.detailedRecipe?.id||e.recipeId||crypto.randomUUID(),{data:{session:l}}=await m.auth.getSession();if(!l)throw new Error("No session found");const c=await fetch("https://kwipydbtjagypocpvbwn.supabase.co/functions/v1/image-generator",{method:"POST",headers:{Authorization:`Bearer ${l.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({recipe_id:o,type:"recipe",recipe_details:r,image_signature:i,user_id:(await m.auth.getUser()).data.user?.id})});if(!c.ok){console.error("MEAL_PLAN_STORE Image generation failed:",c.status),oe(t,n,"",new Date().toISOString(),!0);return}const d=await c.json();console.log("MEAL_PLAN_STORE Image generated successfully",{dayIndex:t,mealType:n,imageUrl:d.image_url}),oe(t,n,d.image_url,new Date().toISOString(),!1)}catch(r){console.error("MEAL_PLAN_STORE Error generating image for meal:",r),oe(t,n,"",new Date().toISOString(),!0)}};function T(t){return typeof t=="string"&&t.trim()===""?null:t}function je(t){return t?{...t,displayName:T(t.displayName),phoneNumber:T(t.phoneNumber),sex:T(t.sex),activity_level:T(t.activity_level),job_category:T(t.job_category),objective:T(t.objective),birthdate:T(t.birthdate),portraitUrl:T(t.portraitUrl),avatarUrl:T(t.avatarUrl),portraitSource:T(t.portraitSource),avatarStatus:T(t.avatarStatus)}:null}function ne(t){return new Blob([t]).size}function se(){const t=[];let n=0;try{for(let i=0;i<localStorage.length;i++){const o=localStorage.key(i);if(o){const l=localStorage.getItem(o)||"",c=ne(o+l);t.push({key:o,size:c}),n+=c}}}catch(i){a.error("STORAGE_MANAGER","Failed to calculate storage stats",{error:i instanceof Error?i.message:String(i)})}t.sort((i,o)=>o.size-i.size);const e=10*1024*1024,r=e-n,s=n/e*100;return{used:n,available:Math.max(0,r),percentage:s,items:t}}function Se(t="STORAGE_USAGE"){const n=se();a.info(t,"Storage usage",{usedMB:(n.used/(1024*1024)).toFixed(2),availableMB:(n.available/(1024*1024)).toFixed(2),percentage:n.percentage.toFixed(1),itemCount:n.items.length,largestItems:n.items.slice(0,5).map(e=>({key:e.key,sizeMB:(e.size/(1024*1024)).toFixed(2)}))})}function Be(){let t=0;try{const n=[];for(let e=0;e<localStorage.length;e++){const r=localStorage.key(e);if(r&&r.startsWith("REACT_QUERY_")){const s=localStorage.getItem(r)||"";t+=ne(r+s),n.push(r)}}n.forEach(e=>localStorage.removeItem(e)),a.info("STORAGE_CLEANUP","React Query cache cleaned",{keysRemoved:n.length,spaceFreesMB:(t/(1024*1024)).toFixed(2)})}catch(n){a.error("STORAGE_CLEANUP","Failed to clean React Query cache",{error:n instanceof Error?n.message:String(n)})}return t}function X(t,n=7){let e=0;try{const r=Date.now(),s=n*24*60*60*1e3,i=[];for(let o=0;o<localStorage.length;o++){const l=localStorage.key(o);if(l&&l.startsWith(t))try{const c=localStorage.getItem(l);if(c){const u=JSON.parse(c).state;u?.timestamp&&r-new Date(u.timestamp).getTime()>s&&(e+=ne(l+c),i.push(l))}}catch{a.warn("STORAGE_CLEANUP","Invalid JSON in localStorage, removing",{key:l});const d=localStorage.getItem(l)||"";e+=ne(l+d),i.push(l)}}i.forEach(o=>localStorage.removeItem(o)),i.length>0&&a.info("STORAGE_CLEANUP","Old store data cleaned",{storePrefix:t,keysRemoved:i.length,spaceFreesMB:(e/(1024*1024)).toFixed(2)})}catch(r){a.error("STORAGE_CLEANUP","Failed to clean old store data",{storePrefix:t,error:r instanceof Error?r.message:String(r)})}return e}function Ve(){a.info("STORAGE_CLEANUP","Starting aggressive cleanup");const t=se();let n=0;n+=Be(),n+=X("fastlift:chat:",7),n+=X("fastlift:coach-chat:",7),n+=X("fastlift:meal-plan:",7),n+=X("fastlift:fridge-scan:",7);const e=se();return a.info("STORAGE_CLEANUP","Aggressive cleanup completed",{freedMB:(n/(1024*1024)).toFixed(2),usageBeforePercent:t.percentage.toFixed(1),usageAfterPercent:e.percentage.toFixed(1),improvement:(t.percentage-e.percentage).toFixed(1)}),n}async function He(t,n="SAFE_STORAGE_OP"){try{return t()}catch(e){if(e instanceof Error&&(e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("QuotaExceededError"))){a.warn(n,"QuotaExceededError detected, attempting cleanup",{error:e.message});const r=Ve();if(r>0){a.info(n,"Retrying operation after cleanup",{freedMB:(r/(1024*1024)).toFixed(2)});try{return t()}catch(s){throw a.error(n,"Operation failed even after cleanup",{error:s instanceof Error?s.message:String(s)}),s}}else throw a.error(n,"No space could be freed, operation failed",{error:e.message}),e}throw e}}function ze(){const t=se();t.percentage>90?a.error("STORAGE_MONITOR","Storage critically full",{percentage:t.percentage.toFixed(1),usedMB:(t.used/(1024*1024)).toFixed(2)}):t.percentage>75&&a.warn("STORAGE_MONITOR","Storage usage high",{percentage:t.percentage.toFixed(1),usedMB:(t.used/(1024*1024)).toFixed(2)})}const Ye="fastlift:userstore:main",We=()=>({getItem:t=>{try{const n=localStorage.getItem(t);return n&&ze(),n}catch(n){return a.error("STORAGE","Failed to read from localStorage",{key:t,error:n instanceof Error?n.message:String(n)}),null}},setItem:(t,n)=>He(()=>{localStorage.setItem(t,n),a.debug("STORAGE","Successfully wrote to localStorage",{key:t,sizeMB:(new Blob([n]).size/(1024*1024)).toFixed(2)})},"USERSTORE_PERSIST"),removeItem:t=>{try{localStorage.removeItem(t)}catch(n){a.error("STORAGE","Failed to remove from localStorage",{key:t,error:n instanceof Error?n.message:String(n)})}}}),$e=t=>({session:t.session,profile:t.profile?{userId:t.profile.userId,id:t.profile.id,displayName:t.profile.displayName,sex:t.profile.sex,height_cm:t.profile.height_cm,weight_kg:t.profile.weight_kg,birthdate:t.profile.birthdate,country:t.profile.country,avatarStatus:t.profile.avatarStatus,avatarUrl:t.profile.avatarUrl,health:t.profile.health}:null}),Je=(t,n)=>({...n,...t,profile:je(t?.profile),loading:n.loading,saving:n.saving}),Ke=()=>(t,n)=>{n?(a.error("USERSTORE_REHYDRATE","Failed to rehydrate store",{error:n.message}),Se("USERSTORE_REHYDRATE_ERROR")):(a.info("USERSTORE_REHYDRATE","Store rehydrated successfully"),Se("USERSTORE_REHYDRATE_SUCCESS"))};function R(t){return typeof t=="string"&&t.trim()===""?null:t}const _e=new Set(["user_id","display_name","birthdate","sex","height_cm","weight_kg","target_weight_kg","body_fat_perc","activity_level","job_category","phone_number","objective","avatar_status","avatar_url","created_at","updated_at","goals","constraints","preferences","emotion_baseline","role","emotions","nutrition","health","avatar_onboarding_completed","portrait_url","portrait_source","household_details","meal_prep_preferences","kitchen_equipment","food_preferences","sensory_preferences","macro_targets","shopping_preferences"]),Qe=new Set(["display_name","sex","activity_level","job_category","objective","avatar_status","avatar_url","portrait_url","portrait_source","phone_number"]);function Xe(t){a.info("USER_STORE_MAPPING_INPUT","mapProfileUpdatesToDb input",{inputUpdates:t,inputKeys:Object.keys(t),inputSnapshot:{phoneNumber:t.phoneNumber,activity_level:t.activity_level,objective:t.objective,job_category:t.job_category},inputUpdatesComplete:{displayName:t.displayName,phoneNumber:t.phoneNumber,birthdate:t.birthdate,sex:t.sex,height_cm:t.height_cm,weight_kg:t.weight_kg,target_weight_kg:t.target_weight_kg,activity_level:t.activity_level,objective:t.objective,job_category:t.job_category},timestamp:new Date().toISOString()});const n={};for(const[e,r]of Object.entries(t)){let s=e,i=r;e==="displayName"?s="display_name":e==="phoneNumber"?s="phone_number":e==="bodyFatPerc"?s="body_fat_perc":e==="avatarStatus"?s="avatar_status":e==="avatarUrl"?s="avatar_url":e==="avatarOnboardingCompleted"?s="avatar_onboarding_completed":e==="portraitUrl"?s="portrait_url":e==="portraitSource"?s="portrait_source":e==="emotionBaseline"?s="emotion_baseline":e==="householdDetails"?s="household_details":e==="mealPrepPreferences"?s="meal_prep_preferences":e==="kitchenEquipment"?s="kitchen_equipment":e==="foodPreferences"?s="food_preferences":e==="sensoryPreferences"?s="sensory_preferences":e==="macroTargets"?s="macro_targets":e==="shoppingPreferences"&&(s="shopping_preferences"),_e.has(s)&&(Qe.has(s)&&typeof i=="string"&&i.trim()===""&&(i=null),n[s]=i,r&&typeof r=="object"&&(r.avatar_version||r.final_shape_params||r.final_limb_masses||r.skin_tone)&&a.debug("USER_STORE","Avatar payload update detected in preferences",{avatarVersion:r.avatar_version,hasFinalShapeParams:!!r.final_shape_params,finalShapeParamsCount:r.final_shape_params?Object.keys(r.final_shape_params).length:0,hasFinalLimbMasses:!!r.final_limb_masses,finalLimbMassesCount:r.final_limb_masses?Object.keys(r.final_limb_masses).length:0,hasSkinTone:!!r.skin_tone,skinToneRGB:r.skin_tone?.rgb?`rgb(${r.skin_tone.rgb.r}, ${r.skin_tone.rgb.g}, ${r.skin_tone.rgb.b})`:"none",hasResolvedGender:!!r.resolved_gender,resolvedGender:r.resolved_gender,gltfModelId:r.gltf_model_id,materialConfigVersion:r.material_config_version,mappingVersion:r.mapping_version,philosophy:"avatar_payload_preferences_update"}))}return a.info("USER_STORE_MAPPING_OUTPUT","mapProfileUpdatesToDb output",{outputUpdates:n,outputKeys:Object.keys(n),outputSnapshot:{phone_number:n.phone_number,activity_level:n.activity_level,objective:n.objective,job_category:n.job_category},outputUpdatesComplete:{user_id:n.user_id,display_name:n.display_name,phone_number:n.phone_number,birthdate:n.birthdate,sex:n.sex,height_cm:n.height_cm,weight_kg:n.weight_kg,target_weight_kg:n.target_weight_kg,activity_level:n.activity_level,objective:n.objective,job_category:n.job_category},mappingResults:Object.entries(t).map(([e,r])=>({originalKey:e,mappedKey:e==="displayName"?"display_name":e==="phoneNumber"?"phone_number":e==="bodyFatPerc"?"body_fat_perc":e==="avatarStatus"?"avatar_status":e==="avatarUrl"?"avatar_url":e==="avatarOnboardingCompleted"?"avatar_onboarding_completed":e==="portraitUrl"?"portrait_url":e==="portraitSource"?"portrait_source":e==="emotionBaseline"?"emotion_baseline":e,originalValue:r,wasIncluded:_e.has(e==="displayName"?"display_name":e==="phoneNumber"?"phone_number":e==="bodyFatPerc"?"body_fat_perc":e==="avatarStatus"?"avatar_status":e==="avatarUrl"?"avatar_url":e==="avatarOnboardingCompleted"?"avatar_onboarding_completed":e==="portraitUrl"?"portrait_url":e==="portraitSource"?"portrait_source":e==="emotionBaseline"?"emotion_baseline":e)})),timestamp:new Date().toISOString()}),n}async function Z(t){a.info("USER_STORE_MAP_DB_TO_PROFILE_INPUT","Raw DB profile being mapped",{dbProfile:t,dbProfileKeys:Object.keys(t||{}),dbProfileSnapshot:{phone_number:t?.phone_number,activity_level:t?.activity_level,objective:t?.objective,job_category:t?.job_category},dbProfileComplete:{user_id:t?.user_id,display_name:t?.display_name,phone_number:t?.phone_number,birthdate:t?.birthdate,sex:t?.sex,height_cm:t?.height_cm,weight_kg:t?.weight_kg,target_weight_kg:t?.target_weight_kg,activity_level:t?.activity_level,objective:t?.objective,job_category:t?.job_category},timestamp:new Date().toISOString()}),a.info("USER_STORE_DB_TO_PROFILE_MAPPING","Mapping DB profile to store profile",{dbProfileSnapshot:{phone_number:t.phone_number,activity_level:t.activity_level,objective:t.objective,job_category:t.job_category},timestamp:new Date().toISOString()});const n=t.preferences||{},e={userId:t.user_id,id:t.user_id,displayName:R(t.display_name),phoneNumber:R(t.phone_number),birthdate:R(t.birthdate||t.dob),sex:R(t.sex),height_cm:t.height_cm,weight_kg:t.weight_kg,target_weight_kg:t.target_weight_kg,bodyFatPerc:t.body_fat_perc,activity_level:R(t.activity_level),job_category:R(t.job_category),objective:R(t.objective),nutrition:{...t.nutrition||{},allergies:Array.isArray(t.nutrition?.allergies)?t.nutrition.allergies:[],intolerances:Array.isArray(t.nutrition?.intolerances)?t.nutrition.intolerances:[]},householdDetails:t.household_details?{adults:t.household_details.adults??1,children:t.household_details.children??0,dietaryRestrictions:t.household_details.dietaryRestrictions||[]}:{adults:1,children:0,dietaryRestrictions:[]},mealPrepPreferences:t.meal_prep_preferences||{},kitchenEquipment:t.kitchen_equipment||{},foodPreferences:t.food_preferences||{},sensoryPreferences:t.sensory_preferences||{},macroTargets:t.macro_targets||{},shoppingPreferences:t.shopping_preferences||{},health:t.health||{},emotions:t.emotions||{},goals:t.goals||{},constraints:t.constraints||{},preferences:n,emotionBaseline:t.emotion_baseline||{},avatarStatus:R(t.avatar_status),avatarUrl:R(t.avatar_url),avatarOnboardingCompleted:t.avatar_onboarding_completed,portraitUrl:R(t.portrait_url),portraitSource:R(t.portrait_source)};return a.info("USER_STORE_MAP_DB_TO_PROFILE_OUTPUT","Final mapped profile output",{mappedProfile:e,mappedProfileKeys:Object.keys(e),mappedProfileSnapshot:{phoneNumber:e.phoneNumber,activity_level:e.activity_level,objective:e.objective,job_category:e.job_category},mappedProfileComplete:{userId:e.userId,displayName:e.displayName,phoneNumber:e.phoneNumber,birthdate:e.birthdate,sex:e.sex,height_cm:e.height_cm,weight_kg:e.weight_kg,target_weight_kg:e.target_weight_kg,activity_level:e.activity_level,objective:e.objective,job_category:e.job_category},timestamp:new Date().toISOString()}),a.info("USER_STORE_MAPPING_RESULT","Final mapped profile",{mappedProfileSnapshot:{phoneNumber:e.phoneNumber,activity_level:e.activity_level,objective:e.objective,job_category:e.job_category},mappedProfileComplete:{displayName:e.displayName,sex:e.sex,height_cm:e.height_cm,weight_kg:e.weight_kg,birthdate:e.birthdate,target_weight_kg:e.target_weight_kg,phoneNumber:e.phoneNumber,activity_level:e.activity_level,objective:e.objective,job_category:e.job_category},timestamp:new Date().toISOString()}),e}function Ze(t,n){a.info("USER_STORE_MAP_PROFILE_TO_DB_INPUT","Profile being mapped to DB format",{profile:t,profileKeys:Object.keys(t),profileSnapshot:{phoneNumber:t.phoneNumber,activity_level:t.activity_level,objective:t.objective,job_category:t.job_category},profileComplete:{userId:t.userId,displayName:t.displayName,phoneNumber:t.phoneNumber,birthdate:t.birthdate,sex:t.sex,height_cm:t.height_cm,weight_kg:t.weight_kg,target_weight_kg:t.target_weight_kg,activity_level:t.activity_level,objective:t.objective,job_category:t.job_category},timestamp:new Date().toISOString()});const e={user_id:n,display_name:t.displayName,phone_number:t.phoneNumber,birthdate:t.birthdate,sex:t.sex,height_cm:t.height_cm,weight_kg:t.weight_kg,target_weight_kg:t.target_weight_kg,activity_level:t.activity_level,job_category:t.job_category,objective:t.objective,portrait_url:t.portraitUrl,portrait_source:t.portraitSource,preferences:t.preferences||{},avatar_status:t.avatarStatus,avatar_url:t.avatarUrl,avatar_onboarding_completed:t.avatarOnboardingCompleted,role:"user"};return a.info("USER_STORE_MAP_PROFILE_TO_DB_OUTPUT","Final DB profile being returned",{dbProfile:e,dbProfileKeys:Object.keys(e),dbProfileSnapshot:{phone_number:e.phone_number,activity_level:e.activity_level,objective:e.objective,job_category:e.job_category},dbProfileComplete:{user_id:e.user_id,display_name:e.display_name,phone_number:e.phone_number,birthdate:e.birthdate,sex:e.sex,height_cm:e.height_cm,weight_kg:e.weight_kg,target_weight_kg:e.target_weight_kg,activity_level:e.activity_level,objective:e.objective,job_category:e.job_category},timestamp:new Date().toISOString()}),e}const et=(t,n)=>({setSession:e=>{t({session:e,user:e?.user||null,initialized:!0,authReady:!!e?.user,sessionInfo:e?.user?{userId:e.user.id,role:"user",email:e.user.email||void 0,displayName:e.user.user_metadata?.display_name||e.user.email?.split("@")[0]||void 0}:null}),a.debug("USER_STORE","Session updated",{hasSession:!!e,hasUser:!!e?.user,authReady:!!e?.user}),e?.user&&setTimeout(()=>{n().fetchProfile()},100)},setSessionReady:e=>{t({sessionReady:e})},setSessionInfo:e=>{t({sessionInfo:e})},setAuthReady:e=>{t({authReady:e})},setProfile:e=>{if(e===null){t({profile:null});return}t(r=>({profile:{...r.profile,...e,preferences:e.preferences?{...r.profile?.preferences,...e.preferences}:r.profile?.preferences,nutrition:e.nutrition?{...r.profile?.nutrition,...e.nutrition}:r.profile?.nutrition,householdDetails:e.householdDetails?{...r.profile?.householdDetails,...e.householdDetails}:r.profile?.householdDetails,mealPrepPreferences:e.mealPrepPreferences?{...r.profile?.mealPrepPreferences,...e.mealPrepPreferences}:r.profile?.mealPrepPreferences,kitchenEquipment:e.kitchenEquipment?{...r.profile?.kitchenEquipment,...e.kitchenEquipment}:r.profile?.kitchenEquipment,foodPreferences:e.foodPreferences?{...r.profile?.foodPreferences,...e.foodPreferences}:r.profile?.foodPreferences,sensoryPreferences:e.sensoryPreferences?{...r.profile?.sensoryPreferences,...e.sensoryPreferences}:r.profile?.sensoryPreferences,macroTargets:e.macroTargets?{...r.profile?.macroTargets,...e.macroTargets}:r.profile?.macroTargets,shoppingPreferences:e.shoppingPreferences?{...r.profile?.shoppingPreferences,...e.shoppingPreferences}:r.profile?.shoppingPreferences,fastingWindow:e.fastingWindow?{...r.profile?.fastingWindow,...e.fastingWindow}:r.profile?.fastingWindow}}))},fetchProfile:async()=>{const{session:e}=n();if(a.debug("USER_STORE","fetchProfile called",{hasSession:!!e,userId:e?.user?.id}),!!e?.user?.id){t({loading:!0});try{const{supabase:r}=await E(async()=>{const{supabase:l}=await import("./page-fridge-C1QVLxk9.js").then(c=>c.q);return{supabase:l}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));a.info("USER_STORE_FETCH_PROFILE","Starting profile fetch from database",{userId:e.user.id,timestamp:new Date().toISOString(),philosophy:"profile_fetch_audit"});const{data:s,error:i}=await r.from("user_profile").select("*").eq("user_id",e.user.id).limit(1);a.info("USER_STORE_FETCH_PROFILE","Raw DB response received",{hasData:!!s,dataLength:s?.length||0,hasError:!!i,errorMessage:i?.message,philosophy:"raw_db_response_audit"});const o=s&&s.length>0?s[0]:null;if(i||!o){a.info("USER_STORE_FETCH_PROFILE","No existing profile found, creating new profile",{userId:e.user.id,hasError:!!i,errorMessage:i?.message,philosophy:"new_profile_creation"});const l={user_id:e.user.id,display_name:e.user.user_metadata?.display_name||e.user.email?.split("@")[0]||null,sex:null,height_cm:null,weight_kg:null,target_weight_kg:null,activity_level:null,objective:null,avatar_status:"none",preferences:{onboardingCompleted:!1,onboardingSkipped:!1,profileCompletion:.1,authProvider:"email"},nutrition:{allergies:[],intolerances:[]},health:{},emotions:{}};try{const{data:c,error:d}=await r.from("user_profile").upsert(l,{onConflict:"user_id",ignoreDuplicates:!1}).select().single();if(d)a.error("USER_STORE_FETCH_PROFILE","Failed to create new profile in DB",{userId:e.user.id,createError:d.message,philosophy:"new_profile_creation_db_error"}),t({profile:{userId:e.user.id,id:e.user.id,displayName:e.user.user_metadata?.display_name||e.user.email?.split("@")[0],sex:null,height_cm:null,weight_kg:null,preferences:{onboardingCompleted:!1,onboardingSkipped:!1,profileCompletion:.1},nutrition:{allergies:[],intolerances:[]},health:{},emotions:{}}});else{const u=await Z(c);a.info("USER_STORE_FETCH_PROFILE","New profile created and mapped successfully",{userId:e.user.id,philosophy:"new_profile_creation_success"}),t({profile:u})}}catch(c){a.error("USER_STORE_FETCH_PROFILE","Exception during new profile creation",{userId:e.user.id,createError:c instanceof Error?c.message:"Unknown error",philosophy:"new_profile_creation_exception"}),t({profile:{userId:e.user.id,id:e.user.id,displayName:e.user.user_metadata?.display_name||e.user.email?.split("@")[0],sex:null,height_cm:null,weight_kg:null,preferences:{onboardingCompleted:!1,onboardingSkipped:!1,profileCompletion:.1},nutrition:{allergies:[],intolerances:[]},health:{},emotions:{}}})}}else{const l=await Z(o);a.info("USER_STORE_FETCH_PROFILE","Existing profile fetched and mapped",{userId:e.user.id,philosophy:"existing_profile_fetch_success"}),t({profile:l})}}catch(r){a.error("USER_STORE_FETCH_PROFILE","Exception during profile fetch",{error:r instanceof Error?r.message:"Unknown error",stack:r instanceof Error?r.stack:void 0,userId:e?.user?.id,philosophy:"profile_fetch_exception"})}finally{t({loading:!1})}}},saveProfile:async()=>{const{session:e,profile:r}=n();if(!(!e?.user?.id||!r)){a.info("USER_STORE_UPDATE_PROFILE","Starting profile update",{userId:e.user.id,philosophy:"profile_update_start"}),t({saving:!0});try{const{supabase:s}=await E(async()=>{const{supabase:c}=await import("./page-fridge-C1QVLxk9.js").then(d=>d.q);return{supabase:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),i=Ze(r,e.user.id),{data:o,error:l}=await s.from("user_profile").upsert(i).select().single();if(l)throw l;t({profile:await Z(o)})}catch(s){throw s}finally{t({saving:!1})}}},updateProfile:async e=>{const{session:r}=n();if(!r?.user?.id)return;a.debug("USER_STORE_UPDATE_PROFILE","Starting profile update with data",{updates:e,userId:r.user.id,philosophy:"profile_update_debug"});const s=n().profile;s&&t({profile:{...s,...e,preferences:e.preferences?{...s.preferences,...e.preferences}:s.preferences}});try{const{supabase:i}=await E(async()=>{const{supabase:d}=await import("./page-fridge-C1QVLxk9.js").then(u=>u.q);return{supabase:d}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),o=Xe(e,s);a.debug("USER_STORE_UPDATE_PROFILE","Mapped updates for database",{dbUpdates:o,userId:r.user.id,philosophy:"db_updates_mapping_debug"}),o.user_id=r.user.id;const{data:l,error:c}=await i.from("user_profile").upsert(o,{onConflict:"user_id"}).select().single();if(c)throw c;a.debug("USER_STORE_UPDATE_PROFILE","Profile update successful",{userId:r.user.id,philosophy:"profile_update_success"}),t({profile:await Z(l)})}catch(i){throw a.error("USER_STORE_UPDATE_PROFILE","Profile update failed",{error:i instanceof Error?i.message:"Unknown error",userId:r.user.id,philosophy:"profile_update_error"}),s&&t({profile:s}),i}}}),ue=y()(Y((t,n)=>({session:null,user:null,profile:null,loading:!1,saving:!1,initialized:!1,sessionReady:!1,sessionInfo:null,authReady:!1,...et(t,n)}),{name:Ye,storage:ae(We),partialize:$e,merge:Je,onRehydrateStorage:Ke})),le=Object.freeze(Object.defineProperty({__proto__:null,useUserStore:ue},Symbol.toStringTag,{value:"Module"})),tt=async(t,n)=>{console.log("🔄 STARTING generateDetailedRecipeForMeal",{dayIndex:t,mealType:n,timestamp:new Date().toISOString()});let e=C.getState().currentPlan;if(!e||!e.days[t]){console.error("MEAL_PLAN_STORE No plan or day found for detailed recipe generation"),console.error("❌ generateDetailedRecipeForMeal FAILED: No plan or day found",{dayIndex:t,mealType:n,hasPlan:!!e,daysCount:e?.days?.length||0});return}const r=e.days[t].meals[n];if(!r){console.error("MEAL_PLAN_STORE No meal found for detailed recipe generation"),console.error("❌ generateDetailedRecipeForMeal FAILED: No meal found",{dayIndex:t,mealType:n,availableMeals:Object.keys(e.days[t].meals||{})});return}try{const{data:{user:s}}=await m.auth.getUser();if(!s)throw new Error("User not authenticated");const i=ue.getState().profile;if(!i)throw new Error("User profile not found");if(e=C.getState().currentPlan,!e)return;const o={...e,days:e.days.map((p,S)=>S===t?{...p,meals:{...p.meals,[n]:{...r,status:"loading"}}}:p)};C.getState().setCurrentPlan(o),console.log("MEAL_PLAN_STORE Starting detailed recipe generation",{dayIndex:t,mealType:n,mealTitle:r.title}),console.log("📡 CALLING Edge Function: recipe-detail-generator",{userId:s.id,mealTitle:r.mealName||r.title||"Repas sans nom",targetCalories:r.calories_est,ingredientsCount:r.ingredients?.length||0});const{data:{session:l}}=await m.auth.getSession();if(!l)throw new Error("No session found");const c=await fetch("https://kwipydbtjagypocpvbwn.supabase.co/functions/v1/recipe-detail-generator",{method:"POST",headers:{Authorization:`Bearer ${l.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({user_id:s.id,meal_title:r.mealName||r.title||"Repas sans nom",main_ingredients:r.ingredients||[],user_preferences:{identity:i,nutrition:i.nutrition||{},kitchen_equipment:i.kitchen_equipment||{},food_preferences:i.food_preferences||{},sensory_preferences:i.sensory_preferences||{}},meal_type:n,target_calories:r.calories_est})});if(!c.ok)throw new Error(`Recipe generation failed: ${c.status}`);const d=await c.json();console.log("✅ Edge Function response received",{dayIndex:t,mealType:n,cached:d.cached,modelUsed:d.model_used,hasRecipe:!!d.recipe});const u=d.recipe;if(console.log("MEAL_PLAN_STORE Detailed recipe generated successfully",{dayIndex:t,mealType:n,cached:d.cached,modelUsed:d.model_used}),e=C.getState().currentPlan,!e)return;const g={...e,days:e.days.map((p,S)=>S===t?{...p,meals:{...p.meals,[n]:{...r,status:"ready",isDetailedRecipeGenerated:!0,detailedRecipe:u,imageUrl:u.imageUrl||r.imageUrl,imageGenerationError:u.imageGenerationError||r.imageGenerationError||!1,imageSignature:u.imageSignature||r.imageSignature,updatedAt:new Date().toISOString()}}}:p)};if(C.getState().setCurrentPlan(g),u&&u.id&&!u.imageUrl){const p=g.days[t].meals[n];qe(t,n,p)}}catch(s){if(console.error("MEAL_PLAN_STORE Error generating detailed recipe:",s),console.error("❌ generateDetailedRecipeForMeal FAILED with error",{dayIndex:t,mealType:n,error:s instanceof Error?s.message:"Unknown error",stack:s instanceof Error?s.stack:void 0}),e=C.getState().currentPlan,!e)return;const i={...e,days:e.days.map((o,l)=>l===t?{...o,meals:{...o.meals,[n]:{...r,status:"error",errorMessage:s instanceof Error?s.message:"Erreur lors de la génération de la recette"}}}:o)};C.getState().setCurrentPlan(i)}},Ct=async t=>{console.log("🚀 STARTING generateAllDetailedRecipesForDay",{dayIndex:t,timestamp:new Date().toISOString()});const{currentPlan:n,setIsGeneratingDetailedRecipes:e}=C.getState();if(!n||!n.days[t]){console.error("MEAL_PLAN_STORE No plan or day found for bulk recipe generation"),console.error("❌ generateAllDetailedRecipesForDay FAILED: No plan or day found",{dayIndex:t,hasPlan:!!n,daysCount:n?.days?.length||0});return}e(!0);const r=n.days[t],s=["breakfast","lunch","dinner","snack"];console.log("MEAL_PLAN_STORE Starting bulk recipe generation for day",{dayIndex:t,dayName:r.dayName,date:r.date});const i=s.filter(l=>{const c=r.meals[l];return c&&!c.isDetailedRecipeGenerated&&c.status!=="loading"});console.log("📋 Meals to generate:",{dayIndex:t,mealsToGenerate:i,totalMealsCount:s.length,mealsNeedingGeneration:i.length}),console.log("⚡ Starting concurrent recipe generation with Promise.all");const o=i.map(l=>tt(t,l).catch(c=>(console.error(`MEAL_PLAN_STORE Error generating recipe for ${l}:`,c),console.error(`❌ Individual recipe generation failed for ${l}`,{dayIndex:t,mealType:l,error:c instanceof Error?c.message:"Unknown error"}),null)));try{await Promise.all(o),console.log("✅ All recipe generations completed successfully",{dayIndex:t,dayName:r.dayName,generatedCount:i.length})}catch(l){console.error("❌ Promise.all failed in generateAllDetailedRecipesForDay",{dayIndex:t,error:l instanceof Error?l.message:"Unknown error"})}finally{e(!1)}console.log("MEAL_PLAN_STORE Bulk recipe generation completed for day",{dayIndex:t,dayName:r.dayName,generatedCount:i.length})},rt=async(t,n,e,r,s,i,o,l,c)=>{if(!e){a.error("MEAL_PLAN_STORE","No inventory selected for meal plan generation");return}try{s(0,"Initialisation","Préparation de votre plan personnalisé","Démarrage de la génération...");const d=we(t,r),u=[];for(let O=0;O<7;O++){const k=new Date(d);k.setDate(d.getDate()+O);const x=k.toISOString().split("T")[0],v=k.toLocaleDateString("fr-FR",{weekday:"long"});u.push(Ue(x,v))}const g={id:`week-${t}-skeleton`,weekNumber:t,startDate:d.toISOString().split("T")[0],days:u,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};i(g),a.info("MEAL_PLAN_STORE","Skeleton plan initialized",{weekNumber:t,skeletonDaysCount:u.length,timestamp:new Date().toISOString()}),l();const{data:{user:p}}=await m.auth.getUser();if(!p)throw new Error("User not authenticated");const S=ue.getState().profile;if(!S)throw new Error("User profile not found");a.info("MEAL_PLAN_STORE","Starting meal plan generation",{weekNumber:t,inventoryId:e,userId:p.id,timestamp:new Date().toISOString()});const N=new Date(d);N.setDate(d.getDate()+6);const{data:{session:U}}=await m.auth.getSession();if(!U)throw new Error("No session found");const L=await fetch("https://kwipydbtjagypocpvbwn.supabase.co/functions/v1/meal-plan-generator",{method:"POST",headers:{Authorization:`Bearer ${U.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({user_id:p.id,week_number:t,start_date:d.toISOString().split("T")[0],end_date:N.toISOString().split("T")[0],inventory_count:n?.length||0,has_preferences:!!S})});if(!L.ok)throw new Error(`HTTP error! status: ${L.status}`);if(!L.body)throw new Error("No response body");const B=L.body.getReader(),_=new TextDecoder;let I=[],f=`week-${t}-${Date.now()}`,P=null,b=null,w=[],h=null;try{for(;;){const{done:O,value:k}=await B.read();if(O)break;const v=_.decode(k).split(`
`);for(const V of v)if(V.startsWith("data: "))try{const D=JSON.parse(V.slice(6));if(D.type==="day"){const ie=Me(D.data);I.push(ie);const Oe=u.map(K=>I.find(Te=>Te.date===K.date)||K),De={...g,days:Oe,updatedAt:new Date().toISOString()};i(De);const ge=I.filter(K=>K.status==="ready").length,me=Math.min(90,ge/7*80);s(me),a.info("MEAL_PLAN_STORE","Day received and skeleton replaced",{date:ie.date,dayName:ie.dayName,readyDaysCount:ge,progress:me,timestamp:new Date().toISOString()})}else D.type==="complete"&&(f=D.data.id||f,P=D.data.nutritional_summary,b=D.data.estimated_weekly_cost,w=D.data.batch_cooking_days||[],h=D.data.ai_explanation||null)}catch(D){a.warn("MEAL_PLAN_STORE","Failed to parse SSE data",{line:V,error:D instanceof Error?D.message:"Unknown error",timestamp:new Date().toISOString()})}}}finally{B.releaseLock()}const J=I.filter(O=>O.status==="ready");if(J.length===0)throw new Error("No meal plan days received from generation");const F={id:f,weekNumber:t,startDate:d.toISOString().split("T")[0],days:I,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),nutritionalSummary:P,estimatedWeeklyCost:b,batchCookingDays:w,aiExplanation:h};return s(100,"Terminé !","Votre plan est prêt","Plan de repas généré avec succès"),i(F),c(),a.info("MEAL_PLAN_STORE","Meal plan generation completed",{weekNumber:t,planId:F.id,daysCount:J.length,timestamp:new Date().toISOString()}),F}catch(d){throw c(),o(d instanceof Error?d:new Error("Unknown error")),a.error("MEAL_PLAN_STORE","Meal plan generation failed",{weekNumber:t,error:d instanceof Error?d.message:"Unknown error",timestamp:new Date().toISOString()}),d}},nt=(t,n)=>({generateMealPlan:async(e,r)=>{const s=n();if(!s.referenceStartDate&&e===1){const i=new Date;i.setHours(0,0,0,0),t({referenceStartDate:i.toISOString()})}try{t({isGenerating:!0});const i=await rt(e,r,s.selectedInventoryId,s.referenceStartDate,(o,l,c,d)=>{t({generationProgress:o,currentLoadingTitle:l,currentLoadingSubtitle:c,loadingMessage:d})},o=>{t({currentPlan:o,currentWeek:e})},o=>{t({currentPlan:null,isGenerating:!1,generationProgress:0,currentLoadingTitle:"Erreur",currentLoadingSubtitle:"Échec de la génération",loadingMessage:o.message})},()=>n().startProgressSimulation(),()=>n().stopProgressSimulation());if(i){const o=[...new Set([...s.availableWeeks,e])].sort((c,d)=>c-d),l=Math.max(s.maxAvailableWeek,e);t({currentPlan:i,currentWeek:e,availableWeeks:o,maxAvailableWeek:l,isGenerating:!1})}}catch(i){t({currentPlan:null,isGenerating:!1,generationProgress:0,currentLoadingTitle:"Erreur",currentLoadingSubtitle:"Échec de la génération",loadingMessage:i instanceof Error?i.message:"Erreur inconnue"}),n().stopProgressSimulation(),a.error("MEAL_PLAN_STORE","Meal plan generation failed",{weekNumber:e,error:i instanceof Error?i.message:"Unknown error",timestamp:new Date().toISOString()})}},regenerateWeek:async e=>{a.info("MEAL_PLAN_STORE","Regenerating week",{weekNumber:e});const{selectedInventory:r}=n();await n().generateMealPlan(e,r)},generateNextWeek:async()=>{const e=n(),r=e.maxAvailableWeek+1;a.info("MEAL_PLAN_STORE","Generating next week",{nextWeek:r}),await n().generateMealPlan(r,e.selectedInventory)},generateSpecificWeek:async e=>{a.info("MEAL_PLAN_STORE","Generating specific week",{weekNumber:e});const{selectedInventory:r}=n();await n().generateMealPlan(e,r)},setIsGeneratingDetailedRecipes:e=>{t({isGeneratingDetailedRecipes:e})},cancelDetailedRecipeGeneration:()=>{const e=n();if(t({isGeneratingDetailedRecipes:!1}),e.currentPlan){const r={...e.currentPlan,days:e.currentPlan.days.map(s=>({...s,meals:{breakfast:s.meals.breakfast?.status==="loading"?{...s.meals.breakfast,status:"idle"}:s.meals.breakfast,lunch:s.meals.lunch?.status==="loading"?{...s.meals.lunch,status:"idle"}:s.meals.lunch,dinner:s.meals.dinner?.status==="loading"?{...s.meals.dinner,status:"idle"}:s.meals.dinner,snack:s.meals.snack?.status==="loading"?{...s.meals.snack,status:"idle"}:s.meals.snack}}))};t({currentPlan:r})}a.info("MEAL_PLAN_STORE","Detailed recipe generation cancelled")}}),Nt=()=>{const{setIsGenerating:t,setCurrentPlan:n}=C.getState();console.log("MEAL_PLAN_STORE Cancelling meal plan generation"),t(!1),n(null)},st=(t,n)=>({setCurrentWeek:async e=>{const r=n();if(a.info("MEAL_PLAN_STORE","Setting current week",{weekNumber:e,previousWeek:r.currentWeek,timestamp:new Date().toISOString()}),r.currentPlan&&r.currentPlan.weekNumber===e){t({currentWeek:e});return}await n().fetchMealPlanForWeek(e),t({currentWeek:e})},isWeekAvailable:e=>n().availableWeeks.includes(e),isCurrentWeekActive:e=>n().currentWeek===e,getWeekDateRange:e=>{const r=n(),s=we(e,r.referenceStartDate),i=new Date(s);return i.setDate(s.getDate()+6),Le(s,i)},canGenerateNextWeek:()=>{const e=n();return e.maxAvailableWeek>0&&!e.isGenerating}}),at=(t,n)=>({clearPlan:()=>{t({currentPlan:null,currentWeek:1,availableWeeks:[1],maxAvailableWeek:0,recipes:[]}),a.info("MEAL_PLAN_STORE","Plan cleared",{timestamp:new Date().toISOString()})},setCurrentPlan:e=>{t({currentPlan:e}),a.info("MEAL_PLAN_STORE","Current plan updated",{planId:e?.id||"null",timestamp:new Date().toISOString()})},loadRecipesForPlan:async e=>{try{const r=[];if(e.days.forEach(o=>{Object.values(o.meals).forEach(l=>{l?.recipeId&&r.push(l.recipeId)})}),r.length===0){a.info("MEAL_PLAN_STORE","No recipe IDs found in plan",{planId:e.id,timestamp:new Date().toISOString()});return}a.info("MEAL_PLAN_STORE","Loading recipes for plan",{planId:e.id,recipeIds:r,timestamp:new Date().toISOString()});const{data:s,error:i}=await m.from("recipes").select("*").in("id",r);if(i)throw new Error(`Failed to load recipes: ${i.message}`);t({recipes:s||[]}),a.info("MEAL_PLAN_STORE","Recipes loaded for plan",{planId:e.id,recipesCount:s?.length||0,timestamp:new Date().toISOString()})}catch(r){a.error("MEAL_PLAN_STORE","Failed to load recipes for plan",{planId:e.id,error:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()})}},fetchMealPlanForWeek:async e=>{try{const{data:{user:r}}=await m.auth.getUser();if(!r)return;a.info("MEAL_PLAN_STORE","Fetching meal plan for week",{weekNumber:e,userId:r.id,timestamp:new Date().toISOString()}),a.info("MEAL_PLAN_STORE","Meal plan fetch completed",{weekNumber:e,timestamp:new Date().toISOString()})}catch(r){a.error("MEAL_PLAN_STORE","Failed to fetch meal plan for week",{weekNumber:e,error:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()})}},loadAllMealPlans:async()=>{try{const{data:{user:e}}=await m.auth.getUser();if(!e)return;a.info("MEAL_PLAN_STORE","Loading all meal plans",{userId:e.id,timestamp:new Date().toISOString()});const{data:r,error:s}=await m.from("meal_plans").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(s)throw new Error(`Failed to load meal plans: ${s.message}`);const i=(r||[]).map(o=>({id:o.id,weekNumber:1,startDate:o.created_at,days:[],createdAt:o.created_at,updatedAt:o.updated_at}));t({allMealPlans:i}),a.info("MEAL_PLAN_STORE","All meal plans loaded",{count:i.length,timestamp:new Date().toISOString()})}catch(e){a.error("MEAL_PLAN_STORE","Failed to load all meal plans",{error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()}),t({allMealPlans:[]})}},saveCurrentMealPlan:async()=>{try{const{data:{user:e}}=await m.auth.getUser();if(!e)throw new Error("User not authenticated");const{currentPlan:r}=n();if(!r)throw new Error("No current plan to save");a.info("MEAL_PLAN_STORE","Saving current meal plan",{planId:r.id,weekNumber:r.weekNumber,userId:e.id,timestamp:new Date().toISOString()});const s={user_id:e.id,plan_data:{id:r.id,weekNumber:r.weekNumber,startDate:r.startDate,days:r.days,nutritionalSummary:r.nutritionalSummary,estimatedWeeklyCost:r.estimatedWeeklyCost,batchCookingDays:r.batchCookingDays,aiExplanation:r.aiExplanation},updated_at:new Date().toISOString()},{error:i}=await m.from("meal_plans").upsert(s,{onConflict:"id"});if(i)throw new Error(`Failed to save meal plan: ${i.message}`);a.info("MEAL_PLAN_STORE","Current meal plan saved successfully",{planId:r.id,weekNumber:r.weekNumber,userId:e.id,timestamp:new Date().toISOString()})}catch(e){throw a.error("MEAL_PLAN_STORE","Failed to save current meal plan",{error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()}),e}}}),it={currentPlan:null,currentWeek:1,availableWeeks:[1],maxAvailableWeek:1,referenceStartDate:null,availableInventories:[],selectedInventoryId:null,isGenerating:!1,isGeneratingDetailedRecipes:!1,generationProgress:0,loadingMessage:"",currentLoadingTitle:"",currentLoadingSubtitle:"",progressIntervalId:null,progressTimeoutId:null,simulatedStepIndex:0,lastBackendProgressUpdate:0,simulatedProgressStartTime:0,simulatedProgressCurrentStepDuration:0,simulatedProgressCurrentStepStartValue:0,simulatedProgressCurrentStepEndValue:0,recipes:[],allMealPlans:[]},C=y()(Y((t,n)=>({...it,...Fe(t,n),...ke(t,n),...nt(t,n),...st(t,n),...at(t,n),setIsGeneratingDetailedRecipes:e=>t({isGeneratingDetailedRecipes:e})}),{name:Ne,partialize:t=>({currentPlan:t.currentPlan,currentWeek:t.currentWeek,availableWeeks:t.availableWeeks,maxAvailableWeek:t.maxAvailableWeek,referenceStartDate:t.referenceStartDate,selectedInventoryId:t.selectedInventoryId,recipes:t.recipes}),merge:(t,n)=>({...n,...t,availableWeeks:Array.isArray(t?.availableWeeks)&&t.availableWeeks.length>0?t.availableWeeks:[1],maxAvailableWeek:typeof t?.maxAvailableWeek=="number"&&t.maxAvailableWeek>=1?t.maxAvailableWeek:1,isGenerating:!1,isGeneratingDetailedRecipes:!1,generationProgress:0,loadingMessage:"",currentLoadingTitle:"",currentLoadingSubtitle:"",progressIntervalId:null,progressTimeoutId:null,simulatedStepIndex:0,lastBackendProgressUpdate:0,simulatedProgressStartTime:0,simulatedProgressCurrentStepDuration:0,simulatedProgressCurrentStepStartValue:0,simulatedProgressCurrentStepEndValue:0,availableInventories:[]})})),ce=Object.freeze(Object.defineProperty({__proto__:null,useMealPlanStore:C},Symbol.toStringTag,{value:"Module"})),Lt=y((t,n)=>({isOpen:!1,title:"",message:"",processName:"",dirtyFields:[],onConfirm:null,onCancel:null,onSaveAndExit:null,showModal:e=>{a.info("EXIT_MODAL_STORE","Showing exit modal",{title:e.title,processName:e.processName,hasSaveAndExit:!!e.onSaveAndExit,dirtyFieldsCount:e.dirtyFields?.length||0,timestamp:new Date().toISOString()}),t({isOpen:!0,title:e.title,message:e.message,processName:e.processName,dirtyFields:e.dirtyFields||[],onConfirm:e.onConfirm,onCancel:e.onCancel,onSaveAndExit:e.onSaveAndExit||null}),setTimeout(()=>{const r=document.querySelector(".global-exit-modal");a.info("EXIT_MODAL_STORE","Modal DOM check after show",{modalExists:!!r,modalVisible:r?getComputedStyle(r).display!=="none":!1,timestamp:new Date().toISOString()})},10)},hideModal:()=>{a.info("EXIT_MODAL_STORE","Hiding exit modal",{wasOpen:n().isOpen,timestamp:new Date().toISOString()}),t({isOpen:!1,title:"",message:"",processName:"",dirtyFields:[],onConfirm:null,onCancel:null,onSaveAndExit:null})},saveAndExit:async()=>{const{onSaveAndExit:e}=n();if(a.info("EXIT_MODAL_STORE","Save and exit triggered",{hasOnSaveAndExit:!!e,timestamp:new Date().toISOString()}),e)try{await e(),a.info("EXIT_MODAL_STORE","Save and exit completed successfully",{timestamp:new Date().toISOString()})}catch(r){throw a.error("EXIT_MODAL_STORE","Save and exit failed",{error:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}n().hideModal()},confirmExit:()=>{const{onConfirm:e}=n();a.info("EXIT_MODAL_STORE","Exit confirmed",{hasOnConfirm:!!e,timestamp:new Date().toISOString()}),e&&e(),n().hideModal()},cancelExit:()=>{const{onCancel:e}=n();a.info("EXIT_MODAL_STORE","Exit cancelled",{hasOnCancel:!!e,timestamp:new Date().toISOString()}),e&&e(),n().hideModal()}})),W="twinforge-performance-mode-v2",Ie="twinforge-performance-mode",Mt=y((t,n)=>({isPerformanceMode:!1,mode:"balanced",isLoading:!0,recommendedMode:null,loadMode:async(e,r)=>{try{t({isLoading:!0}),r&&t({recommendedMode:r});const s=localStorage.getItem(W);if(s===null){const i=localStorage.getItem(Ie);if(i!==null){const o=i==="true",l=o?"high-performance":"balanced";localStorage.setItem(W,l),localStorage.removeItem(Ie),t({mode:l,isPerformanceMode:o,isLoading:!1}),$(l);return}}if(s!==null&&(s==="high-performance"||s==="balanced"||s==="quality")){const i=s;t({mode:i,isPerformanceMode:i==="high-performance",isLoading:!1}),$(i)}else r&&(t({mode:r,isPerformanceMode:r==="high-performance",isLoading:!1}),$(r),localStorage.setItem(W,r));if(e){const{data:i,error:o}=await m.from("user_preferences").select("performance_mode, performance_mode_enabled").eq("user_id",e).maybeSingle();if(o)a.error("PERFORMANCE_MODE","Failed to load from Supabase",{error:o});else if(i){const l=i.performance_mode||(i.performance_mode_enabled?"high-performance":"balanced");t({mode:l,isPerformanceMode:l==="high-performance",isLoading:!1}),localStorage.setItem(W,l),$(l),a.info("PERFORMANCE_MODE","Loaded from Supabase",{mode:l})}}t({isLoading:!1})}catch(s){a.error("PERFORMANCE_MODE","Error loading performance mode",{error:s}),t({isLoading:!1})}},setMode:async(e,r)=>{try{if(t({mode:e,isPerformanceMode:e==="high-performance"}),localStorage.setItem(W,e),$(e),a.info("PERFORMANCE_MODE","Mode changed",{mode:e}),r){const{error:s}=await m.from("user_preferences").upsert({user_id:r,performance_mode:e,performance_mode_enabled:e==="high-performance",updated_at:new Date().toISOString()},{onConflict:"user_id"});s?a.error("PERFORMANCE_MODE","Failed to save to Supabase",{error:s}):a.info("PERFORMANCE_MODE","Saved to Supabase",{mode:e})}}catch(s){a.error("PERFORMANCE_MODE","Error setting performance mode",{error:s})}},loadPerformanceMode:async e=>{await n().loadMode(e)},setPerformanceMode:async(e,r)=>{const s=e?"high-performance":"balanced";await n().setMode(s,r)}}));function $(t){const n=document.documentElement;n.classList.remove("performance-mode","mode-high-performance","mode-balanced","mode-quality"),n.classList.add(`mode-${t}`),t==="high-performance"&&n.classList.add("performance-mode"),n.style.setProperty("--performance-mode",t),a.debug("PERFORMANCE_MODE","Applied mode class",{mode:t})}const Ft=y((t,n)=>({dirtyTabs:{},setTabDirty:(e,r,s,i)=>{t(o=>({dirtyTabs:{...o.dirtyTabs,[e]:{isDirty:r,changedFields:s,sectionName:i}}}))},resetTabDirty:e=>{t(r=>({dirtyTabs:{...r.dirtyTabs,[e]:{isDirty:!1}}}))},isAnyTabDirty:()=>{const{dirtyTabs:e}=n();return Object.values(e).some(r=>r.isDirty===!0)},getDirtyTabs:()=>{const{dirtyTabs:e}=n();return Object.entries(e).filter(([r,s])=>s.isDirty).map(([r,s])=>({tabId:r,info:s}))},resetAllDirtyStatus:()=>{t({dirtyTabs:{}})}})),ot={transitionDelay:150,useCoordinatedTransition:!0,useGPUOptimization:!0},he=()=>{const t=window.innerWidth<768;return lt()?{transitionDelay:100,useCoordinatedTransition:!0,useGPUOptimization:!0}:t?{transitionDelay:120,useCoordinatedTransition:!0,useGPUOptimization:!0}:ot};function lt(){if("deviceMemory"in navigator){const t=navigator.deviceMemory;if(t&&t<4)return!0}if("hardwareConcurrency"in navigator){const t=navigator.hardwareConcurrency;if(t&&t<4)return!0}if("connection"in navigator){const t=navigator.connection;if(t&&t.saveData)return!0}return!1}const j=class j{constructor(){H(this,"config");H(this,"pendingTransition",null);H(this,"isTransitioning",!1);H(this,"handleResize",()=>{clearTimeout(this.pendingTransition),this.pendingTransition=setTimeout(()=>{const n=he();JSON.stringify(n)!==JSON.stringify(this.config)&&(this.config=n,a.debug("OVERLAY_TRANSITION_MANAGER","Config updated on resize",{newConfig:this.config}))},100)});this.config=he(),window.addEventListener("resize",this.handleResize),a.info("OVERLAY_TRANSITION_MANAGER","Initialized",{config:this.config,timestamp:new Date().toISOString()})}static getInstance(){return j.instance||(j.instance=new j),j.instance}async executeTransition(n,e){if(this.isTransitioning){a.warn("OVERLAY_TRANSITION_MANAGER","Transition already in progress");return}this.isTransitioning=!0;try{this.config.useGPUOptimization&&this.enableGPUOptimizations(),n(),a.debug("OVERLAY_TRANSITION_MANAGER","Closing overlay",{delay:this.config.transitionDelay}),this.config.useCoordinatedTransition&&await this.delay(this.config.transitionDelay),e(),a.debug("OVERLAY_TRANSITION_MANAGER","Opening new overlay"),this.config.useGPUOptimization&&setTimeout(()=>{this.disableGPUOptimizations()},500)}catch(r){a.error("OVERLAY_TRANSITION_MANAGER","Transition error",{error:r})}finally{this.isTransitioning=!1}}isInTransition(){return this.isTransitioning}getTransitionDelay(){return this.config.transitionDelay}enableGPUOptimizations(){document.documentElement.style.setProperty("--overlay-will-change","transform, opacity"),document.documentElement.style.setProperty("--overlay-transform","translateZ(0)")}disableGPUOptimizations(){document.documentElement.style.setProperty("--overlay-will-change","auto"),document.documentElement.style.setProperty("--overlay-transform","none")}delay(n){return new Promise(e=>setTimeout(e,n))}cleanup(){this.pendingTransition&&clearTimeout(this.pendingTransition),window.removeEventListener("resize",this.handleResize)}};H(j,"instance");let de=j;const ct=de.getInstance(),kt={FLOATING_CHAT_BUTTON:9994,CHAT_DRAWER:9995,CENTRAL_MENU:9998,MOBILE_DRAWER:9998,BACKDROP:9993},ve=y((t,n)=>({activeOverlayId:"none",previousOverlayId:"none",open:e=>{const r=n();a.debug("OVERLAY_STORE","Opening overlay",{overlayId:e,currentActiveOverlay:r.activeOverlayId,willCloseExisting:r.activeOverlayId!=="none",timestamp:new Date().toISOString()}),r.activeOverlayId!=="none"&&r.activeOverlayId!==e?(a.info("OVERLAY_STORE","Closing existing overlay before opening new one",{closingOverlay:r.activeOverlayId,openingOverlay:e,timestamp:new Date().toISOString()}),ct.executeTransition(()=>{t({previousOverlayId:r.activeOverlayId,activeOverlayId:"none"})},()=>{t({previousOverlayId:"none",activeOverlayId:e}),a.info("OVERLAY_STORE","Overlay opened successfully after transition",{overlayId:e,timestamp:new Date().toISOString()})})):(t({previousOverlayId:r.activeOverlayId,activeOverlayId:e}),a.info("OVERLAY_STORE","Overlay opened successfully",{overlayId:e,previousOverlay:r.activeOverlayId,timestamp:new Date().toISOString()}))},close:()=>{const e=n();if(e.activeOverlayId==="none"){a.debug("OVERLAY_STORE","Close called but no overlay is open",{timestamp:new Date().toISOString()});return}a.debug("OVERLAY_STORE","Closing overlay",{closingOverlay:e.activeOverlayId,timestamp:new Date().toISOString()}),t({previousOverlayId:e.activeOverlayId,activeOverlayId:"none"}),a.info("OVERLAY_STORE","Overlay closed successfully",{closedOverlay:e.previousOverlayId,timestamp:new Date().toISOString()})},toggle:e=>{n().activeOverlayId===e?n().close():n().open(e)},isOpen:e=>n().activeOverlayId===e,isAnyOpen:()=>n().activeOverlayId!=="none"})),dt={training:{id:"training",displayName:"Coach Training",systemPrompt:`Tu es un coach sportif expert et ultra-motivant. Tu accompagnes l'utilisateur pendant sa séance en lui donnant des conseils techniques précis et motivants.

## Ton de Communication:
Tu parles toujours en tant que COACH EXTERNE (jamais de "nous"). Tu es là pour guider, corriger, motiver et pousser l'utilisateur à se dépasser.

Exemples: "Concentre-toi sur ta posture", "Tu peux aller plus loin", "Je vois que tu progresses", "Fais attention à..."

## Instructions:
- Reste concis (2-3 phrases max), énergique et pratique
- Tutoie l'utilisateur
- Donne des conseils techniques concrets
- Motive et challenge sans devenir le "twin" de l'utilisateur`,capabilities:{voice:!0,suggestions:!0,exerciseFeedback:!0},color:"#FF6B35",icon:"Dumbbell"},nutrition:{id:"nutrition",displayName:"Coach Nutrition",systemPrompt:`Tu es le coach nutrition de l'utilisateur dans TwinForge. Tu formes un duo avec lui pour optimiser son alimentation.

## Modes de Communication:

### Mode TWIN (par défaut) - Utiliser "NOUS":
Utilise "nous" quand:
- L'utilisateur planifie ses repas, réfléchit à son alimentation
- Il évalue sa progression nutritionnelle
- Il est en mode co-pilotage et partage ses réflexions
- Il célèbre des victoires ("J'ai bien mangé aujourd'hui")

Exemples: "Nous avons fait de bons choix aujourd'hui", "Concentrons-nous sur les protéines", "Notre équilibre nutritionnel s'améliore"

### Mode COACH - Se détacher:
Bascule en coach externe quand:
- L'utilisateur demande des explications techniques ("Comment calculer mes macros?")
- Il a besoin de corrections ou conseils précis
- Il exprime du stress ou de la confusion
- Des explications pédagogiques sont nécessaires

Exemples: "Je t'explique comment...", "Voici ce que je te conseille...", "Laisse-moi t'aider à comprendre..."

## Instructions:
- Détecte l'intent et adapte ton mode
- Reste pédagogique, positif et pratique
- Explique clairement les concepts nutritionnels`,capabilities:{voice:!0,suggestions:!0,mealAnalysis:!0},color:"#10B981",icon:"Utensils"},fasting:{id:"fasting",displayName:"Coach Jeûne",systemPrompt:`Tu es le coach jeûne de l'utilisateur dans TwinForge. Tu formes un duo avec lui pendant sa session de jeûne.

## Modes de Communication:

### Mode TWIN (par défaut) - Utiliser "NOUS":
Utilise "nous" quand:
- L'utilisateur partage ses sensations pendant le jeûne
- Il planifie ou réfléchit à sa stratégie de jeûne
- Il est motivé et en mode co-pilotage
- Il célèbre des étapes ("J'ai tenu 16h!")

Exemples: "Nous tenons bon", "Nous avons déjà atteint 12h", "Restons concentrés sur notre objectif"

### Mode COACH - Se détacher:
Bascule en coach externe quand:
- L'utilisateur exprime du stress, de la peur ou de la faim intense
- Il demande des conseils techniques ("Comment gérer la faim?")
- Il a besoin de réassurance et d'encouragements directifs
- Des explications sur les bénéfices sont demandées

Exemples: "Je te rassure, c'est normal", "Voici comment tu peux gérer...", "Je suis là pour t'accompagner"

## Instructions:
- Détecte l'état émotionnel et adapte ton mode
- Reste rassurant et motivant
- Propose des stratégies concrètes`,capabilities:{voice:!0,suggestions:!0,fastingTips:!0},color:"#F59E0B",icon:"Timer"},general:{id:"general",displayName:"TwinCoach",systemPrompt:`Tu es TwinCoach, le compagnon de progression de l'utilisateur dans TwinForge. Tu formes un duo avec lui pour atteindre ses objectifs wellness.

## Modes de Communication:

### Mode TWIN (par défaut) - Utiliser "NOUS":
Utilise la première personne du pluriel quand:
- L'utilisateur planifie, réfléchit, évalue sa progression
- Il célèbre des victoires ou partage des réflexions
- Il est motivé et en mode co-pilotage
- Il parle d'objectifs communs ou d'actions quotidiennes

Exemples: "Nous avons bien progressé aujourd'hui", "Nous devons nous concentrer sur...", "Regardons ensemble notre évolution"

### Mode COACH - Se détacher du "NOUS":
Bascule en coach externe quand:
- L'utilisateur demande explicitement des explications, corrections ou conseils techniques
- Il exprime du stress, de la peur ou a besoin de réassurance
- Il demande "comment faire", "explique-moi", "corrige-moi"
- Des conseils objectifs et directifs sont nécessaires

Exemples: "Je te conseille de...", "Voici comment tu peux...", "Je suis là pour te guider"

## Instructions:
- Détecte automatiquement l'intent et le sentiment de l'utilisateur
- Transitions naturelles entre les deux modes
- Reste amical, clair et proactif
- Guide vers les bonnes fonctionnalités de l'app`,capabilities:{voice:!0,suggestions:!0,navigation:!0},color:"#18E3FF",icon:"MessageSquare"},"body-scan":{id:"body-scan",displayName:"Coach Corps",systemPrompt:`Tu es le coach corporel de l'utilisateur dans TwinForge. Tu formes un duo avec lui pour analyser et améliorer sa condition physique.

## Modes de Communication:

### Mode TWIN (par défaut) - Utiliser "NOUS":
Utilise "nous" quand:
- L'utilisateur découvre ses résultats et réfléchit à sa progression
- Il évalue son évolution corporelle
- Il est en mode analyse et projection
- Il célèbre des améliorations

Exemples: "Nous avons progressé sur la posture", "Analysons ensemble notre évolution", "Notre condition physique s'améliore"

### Mode COACH - Se détacher:
Bascule en coach externe quand:
- L'utilisateur demande des conseils techniques précis sur la posture ou l'alignement
- Il a besoin d'explications sur les résultats du scan
- Des corrections ou ajustements sont nécessaires
- Il demande "comment améliorer...", "que dois-je faire..."

Exemples: "Je te conseille d'ajuster...", "Voici ce que tes résultats montrent...", "Pour améliorer ta posture, je te recommande..."

## Instructions:
- Détecte l'intent et adapte ton mode
- Reste expert et bienveillant
- Explique clairement les résultats
- Propose des améliorations concrètes`,capabilities:{voice:!0,suggestions:!0},color:"#A855F7",icon:"Scan"}},Ut=y()(Y((t,n)=>({isPanelOpen:!1,communicationMode:"text",isVoiceOnlyMode:!1,currentInputMode:"text",currentMode:"general",modeConfigs:dt,conversationId:null,messages:[],currentTranscription:"",voiceState:"idle",isRecording:!1,isProcessing:!1,isSpeaking:!1,showTranscript:!1,showReadyPrompt:!1,isTyping:!1,hasUnreadMessages:!1,unreadCount:0,lastReadMessageId:null,visualization:{frequencies:[],volume:0,isActive:!1},closeOnNavigation:!0,isInStep2:!1,hasStep2Intro:!1,errorMessage:"",currentNotification:null,openPanel:e=>{const r=e||n().currentMode;t({isPanelOpen:!0,currentMode:r}),n().markAsRead(),n().hideNotification(),a.info("UNIFIED_COACH","Panel opened",{mode:r,communicationMode:n().communicationMode,timestamp:new Date().toISOString()})},closePanel:()=>{t({isPanelOpen:!1}),n().voiceState==="listening"&&n().stopListening(),a.info("UNIFIED_COACH","Panel closed",{mode:n().currentMode,timestamp:new Date().toISOString()})},togglePanel:()=>{const{isPanelOpen:e}=n();e?n().closePanel():n().openPanel()},setCommunicationMode:e=>{const r=n().communicationMode;t({communicationMode:e}),e==="text"?t({voiceState:"idle",isRecording:!1,showReadyPrompt:!1,currentTranscription:""}):e==="voice"&&t({isTyping:!1}),a.info("UNIFIED_COACH","Communication mode changed",{from:r,to:e,timestamp:new Date().toISOString()})},toggleCommunicationMode:()=>{const e=n().communicationMode;n().setCommunicationMode(e==="text"?"voice":"text")},setMode:e=>{const r=n().currentMode;t({currentMode:e}),a.info("UNIFIED_COACH","Chat mode changed",{from:r,to:e,timestamp:new Date().toISOString()})},startConversation:(e,r)=>{const s=re();t({conversationId:s,currentMode:e,messages:[],isPanelOpen:!0}),a.info("UNIFIED_COACH","Conversation started",{conversationId:s,mode:e,hasContextData:!!r,timestamp:new Date().toISOString()})},endConversation:()=>{const{conversationId:e,currentMode:r}=n();t({conversationId:null,isTyping:!1,isRecording:!1,isProcessing:!1,isSpeaking:!1,voiceState:"idle"}),a.info("UNIFIED_COACH","Conversation ended",{conversationId:e,mode:r,messageCount:n().messages.length,timestamp:new Date().toISOString()})},addMessage:e=>{const r={...e,id:re(),timestamp:new Date};t(s=>({messages:[...s.messages,r]})),r.role==="coach"&&!n().isPanelOpen&&n().incrementUnread(),a.debug("UNIFIED_COACH","Message added",{messageId:r.id,role:r.role,type:r.type,mode:n().currentMode,timestamp:new Date().toISOString()})},clearMessages:()=>{t({messages:[]}),a.debug("UNIFIED_COACH","Messages cleared",{mode:n().currentMode,timestamp:new Date().toISOString()})},setCurrentTranscription:e=>{t({currentTranscription:e})},setVoiceState:e=>{t({voiceState:e}),a.debug("UNIFIED_COACH","Voice state changed",{state:e,timestamp:new Date().toISOString()})},setRecording:e=>{t({isRecording:e})},setProcessing:e=>{t({isProcessing:e})},setSpeaking:e=>{t({isSpeaking:e})},setShowTranscript:e=>{t({showTranscript:e})},toggleTranscript:()=>{t(e=>({showTranscript:!e.showTranscript}))},setShowReadyPrompt:e=>{t({showReadyPrompt:e})},startListening:()=>{t({voiceState:"listening",isRecording:!0}),a.info("UNIFIED_COACH","Started listening",{timestamp:new Date().toISOString()})},stopListening:()=>{t({voiceState:"idle",isRecording:!1,currentTranscription:""}),a.info("UNIFIED_COACH","Stopped listening",{timestamp:new Date().toISOString()})},setTyping:e=>{t({isTyping:e})},markAsRead:()=>{const e=n().messages,r=e[e.length-1];t({hasUnreadMessages:!1,unreadCount:0,lastReadMessageId:r?.id||null}),a.debug("UNIFIED_COACH","Messages marked as read",{messageCount:e.length,timestamp:new Date().toISOString()})},incrementUnread:()=>{t(e=>({hasUnreadMessages:!0,unreadCount:e.unreadCount+1})),a.debug("UNIFIED_COACH","Unread count incremented",{newCount:n().unreadCount,timestamp:new Date().toISOString()})},resetUnread:()=>{t({hasUnreadMessages:!1,unreadCount:0}),a.debug("UNIFIED_COACH","Unread count reset",{timestamp:new Date().toISOString()})},updateVisualization:e=>{t(r=>({visualization:{...r.visualization,...e}}))},setCloseOnNavigation:e=>{t({closeOnNavigation:e})},setIsInStep2:e=>{t({isInStep2:e}),a.debug("UNIFIED_COACH","Step 2 status updated",{isInStep2:e,timestamp:new Date().toISOString()})},setHasStep2Intro:e=>{t({hasStep2Intro:e}),a.debug("UNIFIED_COACH","Step 2 intro status updated",{hasIntro:e,timestamp:new Date().toISOString()})},setError:e=>{t({errorMessage:e}),a.error("UNIFIED_COACH","Error set",{message:e,timestamp:new Date().toISOString()})},clearError:()=>{t({errorMessage:""})},showNotification:e=>{const r={...e,isVisible:!0};t({currentNotification:r}),a.debug("UNIFIED_COACH","Notification shown",{notificationId:e.id,mode:e.mode,timestamp:new Date().toISOString()})},hideNotification:()=>{const e=n().currentNotification;e&&(t({currentNotification:null}),a.debug("UNIFIED_COACH","Notification hidden",{notificationId:e.id,timestamp:new Date().toISOString()}))},enterVoiceOnlyMode:()=>{t({isVoiceOnlyMode:!0,communicationMode:"voice",currentInputMode:"realtime"}),a.info("UNIFIED_COACH","Entered voice-only mode (keeping panel open)",{timestamp:new Date().toISOString(),isPanelOpen:n().isPanelOpen})},exitVoiceOnlyMode:()=>{t({isVoiceOnlyMode:!1,currentInputMode:"text"}),a.info("UNIFIED_COACH","Exited voice-only mode (panel state unchanged)",{timestamp:new Date().toISOString(),isPanelOpen:n().isPanelOpen})},setInputMode:e=>{t({currentInputMode:e}),a.debug("UNIFIED_COACH","Input mode changed",{mode:e,timestamp:new Date().toISOString()})}}),{name:"unified-coach-store",storage:ae(()=>localStorage),partialize:t=>({currentMode:t.currentMode,communicationMode:t.communicationMode,currentInputMode:t.currentInputMode,closeOnNavigation:t.closeOnNavigation,showTranscript:t.showTranscript,messages:t.messages.slice(-50)})})),ut={type:"idle"},pt={training:{id:"training",displayName:"Coach Training",systemPrompt:"Tu es un coach sportif expert et ultra-motivant. Accompagne l'utilisateur pendant sa séance avec des conseils techniques précis et motivants. Reste concis (2-3 phrases max), énergique et pratique. Tutoie l'utilisateur.",capabilities:{voice:!0,suggestions:!0,exerciseFeedback:!0},color:"#FF6B35",icon:"Dumbbell"},nutrition:{id:"nutrition",displayName:"Coach Nutrition",systemPrompt:"Tu es un nutritionniste expert et bienveillant. Aide l'utilisateur à analyser ses repas et optimiser ses choix alimentaires. Reste pédagogue, positif et donne des conseils pratiques applicables. Explique clairement les concepts nutritionnels.",capabilities:{voice:!0,suggestions:!0,mealAnalysis:!0},color:"#10B981",icon:"Utensils"},fasting:{id:"fasting",displayName:"Coach Jeûne",systemPrompt:"Tu es un expert du jeûne intermittent. Accompagne l'utilisateur pendant sa session de jeûne avec encouragement et compréhension. Donne des astuces pour gérer la faim et explique les bénéfices. Reste rassurant et motivant.",capabilities:{voice:!0,suggestions:!0,fastingTips:!0},color:"#F59E0B",icon:"Timer"},general:{id:"general",displayName:"TwinCoach",systemPrompt:`Tu es TwinCoach, le compagnon de progression de l'utilisateur dans TwinForge. Tu formes un duo avec lui pour atteindre ses objectifs wellness.

## Modes de Communication:

### Mode TWIN (par défaut) - Utiliser "NOUS":
Utilise la première personne du pluriel quand:
- L'utilisateur planifie, réfléchit, évalue sa progression
- Il célèbre des victoires ou partage des réflexions
- Il est motivé et en mode co-pilotage
- Il parle d'objectifs communs ou d'actions quotidiennes

Exemples: "Nous avons bien progressé aujourd'hui", "Nous devons nous concentrer sur...", "Regardons ensemble notre évolution"

### Mode COACH - Se détacher du "NOUS":
Bascule en coach externe quand:
- L'utilisateur demande explicitement des explications, corrections ou conseils techniques
- Il exprime du stress, de la peur ou a besoin de réassurance
- Il demande "comment faire", "explique-moi", "corrige-moi"
- Des conseils objectifs et directifs sont nécessaires

Exemples: "Je te conseille de...", "Voici comment tu peux...", "Je suis là pour te guider"

## Instructions:
- Détecte automatiquement l'intent et le sentiment de l'utilisateur
- Transitions naturelles entre les deux modes
- Reste amical, clair et proactif
- Guide vers les bonnes fonctionnalités de l'app`,capabilities:{voice:!0,suggestions:!0,navigation:!0},color:"#18E3FF",icon:"MessageSquare"},"body-scan":{id:"body-scan",displayName:"Coach Corps",systemPrompt:"Tu es un expert en analyse corporelle et posture. Guide l'utilisateur dans son scan corporel avec expertise et bienveillance. Donne des conseils pratiques sur la posture et l'alignement.",capabilities:{voice:!0,suggestions:!0},color:"#A855F7",icon:"Scan"}},xt=y()(Y((t,n)=>({isOpen:!1,currentMode:"general",position:{side:"right",width:420,isMinimized:!1},conversationId:null,messages:[],isTyping:!1,isRecording:!1,isProcessing:!1,isSpeaking:!1,autoOpenOnRoute:!1,closeOnNavigation:!0,hasUnreadMessages:!1,unreadCount:0,lastReadMessageId:null,modeConfigs:pt,chatState:ut,isInStep2:!1,hasStep2Intro:!1,currentNotification:null,open:e=>{const r=e||n().currentMode;ve.getState().open("chatDrawer"),t({isOpen:!0,currentMode:r}),n().markAsRead(),n().hideNotification(),a.info("GLOBAL_CHAT","Chat opened",{mode:r,timestamp:new Date().toISOString()})},close:()=>{t({isOpen:!1});const e=ve.getState();e.activeOverlayId==="chatDrawer"&&e.close(),a.info("GLOBAL_CHAT","Chat closed",{mode:n().currentMode,timestamp:new Date().toISOString()})},toggle:()=>{const{isOpen:e}=n();e?n().close():n().open()},setMode:e=>{const r=n().currentMode;t({currentMode:e}),a.info("GLOBAL_CHAT","Mode changed",{from:r,to:e,timestamp:new Date().toISOString()})},setPosition:e=>{t(r=>({position:{...r.position,...e}}))},startConversation:(e,r)=>{const s=re();t({conversationId:s,currentMode:e,messages:[],isOpen:!0}),a.info("GLOBAL_CHAT","Conversation started",{conversationId:s,mode:e,hasContextData:!!r,timestamp:new Date().toISOString()})},endConversation:()=>{const{conversationId:e,currentMode:r}=n();t({conversationId:null,isTyping:!1,isRecording:!1,isProcessing:!1,isSpeaking:!1}),a.info("GLOBAL_CHAT","Conversation ended",{conversationId:e,mode:r,messageCount:n().messages.length,timestamp:new Date().toISOString()})},addMessage:e=>{const r={...e,id:re(),timestamp:new Date};t(s=>({messages:[...s.messages,r]})),r.role==="coach"&&!n().isOpen&&n().incrementUnread(),a.debug("GLOBAL_CHAT","Message added",{messageId:r.id,role:r.role,type:r.type,mode:n().currentMode,timestamp:new Date().toISOString()})},clearMessages:()=>{t({messages:[]}),a.debug("GLOBAL_CHAT","Messages cleared",{mode:n().currentMode,timestamp:new Date().toISOString()})},setTyping:e=>{t({isTyping:e})},setRecording:e=>{t({isRecording:e})},setProcessing:e=>{t({isProcessing:e})},setSpeaking:e=>{t({isSpeaking:e})},setAutoOpenOnRoute:e=>{t({autoOpenOnRoute:e})},setCloseOnNavigation:e=>{t({closeOnNavigation:e})},markAsRead:()=>{const e=n().messages,r=e[e.length-1];t({hasUnreadMessages:!1,unreadCount:0,lastReadMessageId:r?.id||null}),a.debug("GLOBAL_CHAT","Messages marked as read",{messageCount:e.length,timestamp:new Date().toISOString()})},incrementUnread:()=>{t(e=>({hasUnreadMessages:!0,unreadCount:e.unreadCount+1})),a.debug("GLOBAL_CHAT","Unread count incremented",{newCount:n().unreadCount,timestamp:new Date().toISOString()})},resetUnread:()=>{t({hasUnreadMessages:!1,unreadCount:0}),a.debug("GLOBAL_CHAT","Unread count reset",{timestamp:new Date().toISOString()})},setChatState:e=>{t({chatState:e}),a.debug("GLOBAL_CHAT","Chat state updated",{stateType:e.type,timestamp:new Date().toISOString()})},setIsInStep2:e=>{t({isInStep2:e}),a.debug("GLOBAL_CHAT","Step 2 status updated",{isInStep2:e,timestamp:new Date().toISOString()})},setHasStep2Intro:e=>{t({hasStep2Intro:e}),a.debug("GLOBAL_CHAT","Step 2 intro status updated",{hasIntro:e,timestamp:new Date().toISOString()})},showNotification:e=>{const r={...e,isVisible:!0};t({currentNotification:r}),a.debug("GLOBAL_CHAT","Notification shown",{notificationId:e.id,mode:e.mode,timestamp:new Date().toISOString()})},hideNotification:()=>{const e=n().currentNotification;e&&(t({currentNotification:null}),a.debug("GLOBAL_CHAT","Notification hidden",{notificationId:e.id,timestamp:new Date().toISOString()}))}}),{name:"global-chat-store",storage:ae(()=>localStorage),partialize:t=>({currentMode:t.currentMode,position:t.position,closeOnNavigation:t.closeOnNavigation,messages:t.messages.slice(-50)})})),gt={week:"last7Days",month:"last30Days",quarter:"last3Months"},Gt=y((t,n)=>({selectedPeriod:"week",setSelectedPeriod:e=>{t({selectedPeriod:e})},getApiPeriod:()=>{const{selectedPeriod:e}=n();return gt[e]}})),pe=10,A=[{id:"photo",title:"Capture Photos",subtitle:"Capturez vos ingrédients disponibles",icon:"Camera",color:"#EC4899",startProgress:0},{id:"analyze",title:"Analyse IA",subtitle:"La Forge Spatiale analyse vos ingrédients",icon:"Zap",color:"#18E3FF",startProgress:33},{id:"complement",title:"Suggestions IA",subtitle:"Ajoutez des ingrédients complémentaires recommandés",icon:"Plus",color:"#8B5CF6",startProgress:66},{id:"validation",title:"Validation Client",subtitle:"Confirmez et ajustez les ingrédients détectés",icon:"Edit",color:"#F59E0B",startProgress:100},{id:"generating_recipes",title:"Génération IA",subtitle:"La Forge Spatiale crée vos recettes personnalisées",icon:"Zap",color:"#10B981",startProgress:120},{id:"recipes",title:"Recettes Générées",subtitle:"Découvrez vos recettes personnalisées",icon:"ChefHat",color:"#F59E0B",startProgress:140}],mt="twinforge:fridge-scan:pipeline",ft=(t,n)=>({startProgressSimulation:(e,r,s)=>{const i=n();i.stopProgressSimulation(),a.info("FRIDGE_SCAN_PIPELINE","Starting progress simulation",{sessionId:i.currentSessionId,stepsCount:e.length,phaseStartPercentage:r,phaseEndPercentage:s,timestamp:new Date().toISOString()});let o=0;t({simulatedLoadingStep:0,simulatedScanProgress:0,simulatedOverallProgress:r});const l=()=>{if(o<e.length){const c=e[o];t({simulatedLoadingStep:o});const d=100/(c.duration/100);let u=0;const g=setInterval(()=>{u+=d;const p=Math.min(100,u),S=1/e.length,N=o/e.length*100;(o+1)/e.length*100;const U=N+p/100*S*100,L=r+U/100*(s-r);if(t({simulatedScanProgress:p,simulatedOverallProgress:Math.min(s,L)}),p>=100){clearInterval(g),o++;const B=setTimeout(()=>{l()},200);t({progressTimeoutId:B})}},100);t({progressIntervalId:g})}else t({simulatedScanProgress:100,simulatedOverallProgress:s,progressIntervalId:null,progressTimeoutId:null}),a.info("FRIDGE_SCAN_PIPELINE","Progress simulation completed",{sessionId:i.currentSessionId,finalOverallProgress:s,timestamp:new Date().toISOString()})};l()},stopProgressSimulation:()=>{const e=n();e.progressIntervalId&&clearInterval(e.progressIntervalId),e.progressTimeoutId&&clearTimeout(e.progressTimeoutId),t({progressIntervalId:null,progressTimeoutId:null,simulatedLoadingStep:0,simulatedScanProgress:0}),a.debug("FRIDGE_SCAN_PIPELINE","Progress simulation stopped",{sessionId:e.currentSessionId,timestamp:new Date().toISOString()})}}),St=(t,n)=>({addCapturedPhotos:e=>{const r=n().capturedPhotos;a.debug("FRIDGE_SCAN_PIPELINE","Adding captured photos",{sessionId:n().currentSessionId,currentPhotosCount:r.length,newPhotosCount:e.length,timestamp:new Date().toISOString()});const s=A.find(i=>i.id==="analyze");t({capturedPhotos:[...n().capturedPhotos,...e],simulatedOverallProgress:s?.startProgress||20}),a.debug("FRIDGE_SCAN_PIPELINE","Captured photos updated",{sessionId:n().currentSessionId,totalPhotosCount:n().capturedPhotos.length,timestamp:new Date().toISOString()}),a.info("FRIDGE_SCAN_PIPELINE","Photos uploaded",{sessionId:n().currentSessionId,photosCount:e.length,timestamp:new Date().toISOString()})},removeCapturedPhoto:e=>{const r=n(),s=r.capturedPhotos.filter((i,o)=>o!==e);t({capturedPhotos:s}),a.debug("FRIDGE_SCAN_PIPELINE","Photo removed",{sessionId:r.currentSessionId,photoIndex:e,remainingPhotos:s.length,timestamp:new Date().toISOString()})}}),_t=(t,n)=>({processVisionResults:(e,r)=>{n().stopProgressSimulation();const s=A.find(o=>o.id==="validation");let i="validation";e.length<pe&&r&&r.length>0&&(i="complement"),t({rawDetectedItems:e,userEditedInventory:e,suggestedComplementaryItems:r||[],currentStep:i,loadingState:"idle",loadingMessage:"Analyse terminée avec succès",simulatedOverallProgress:s?.startProgress||40,simulatedScanProgress:0,simulatedLoadingStep:0}),n().goToStep(i),a.info("FRIDGE_SCAN_PIPELINE","Vision results processed",{sessionId:n().currentSessionId,itemsDetected:e.length,suggestedItemsCount:r?.length||0,timestamp:new Date().toISOString()})},updateInventory:async e=>{t({userEditedInventory:e}),a.debug("FRIDGE_SCAN_PIPELINE","Inventory updated by user",{sessionId:n().currentSessionId,inventoryCount:e.length,timestamp:new Date().toISOString()}),await n().saveSessionToSupabase()},setSuggestedComplementaryItems:e=>{t({suggestedComplementaryItems:e}),a.debug("FRIDGE_SCAN_PIPELINE","Suggested complementary items set",{sessionId:n().currentSessionId,suggestedItemsCount:e.length,timestamp:new Date().toISOString()})},addSelectedComplementaryItems:async e=>{const s=[...n().userEditedInventory,...e];t({userEditedInventory:s}),a.info("FRIDGE_SCAN_PIPELINE","Selected complementary items added to inventory",{sessionId:n().currentSessionId,addedItemsCount:e.length,totalInventoryCount:s.length,timestamp:new Date().toISOString()}),await n().saveSessionToSupabase()}}),It=(t,n)=>({_triggerImageGenerationForRecipes:async(e,r)=>{if(!e.length)return;const i=n().recipeCandidates.map(c=>e.find(u=>u.id===c.id)?{...c,isGeneratingImage:!0}:c);t({recipeCandidates:i});const{supabase:o}=await E(async()=>{const{supabase:c}=await import("./page-fridge-C1QVLxk9.js").then(d=>d.q);return{supabase:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),{data:{session:l}}=await o.auth.getSession();if(!l?.access_token){a.error("FRIDGE_SCAN_PIPELINE","No authenticated session for image generation",{sessionId:r,timestamp:new Date().toISOString()});return}a.info("FRIDGE_SCAN_PIPELINE","Starting background image generation for recipes",{sessionId:r,recipeCount:e.length,recipeIds:e.map(c=>c.id),timestamp:new Date().toISOString()});for(const c of e)try{const d=`recipe-${c.id}-${Date.now()}`,u={user_id:l.user.id,recipe_id:c.id,image_signature:d,recipe_details:{session_id:r,title:c.title,description:c.description||"",ingredients:c.ingredients.slice(0,5).map(p=>p.name),dietary_tags:c.dietary_tags}},g=await fetch("https://kwipydbtjagypocpvbwn.supabase.co/functions/v1/image-generator",{method:"POST",headers:{Authorization:`Bearer ${l.access_token}`,"Content-Type":"application/json"},body:JSON.stringify(u)});if(g.ok){const p=await g.json();a.info("FRIDGE_SCAN_PIPELINE","Image generation initiated successfully",{sessionId:r,recipeId:c.id,imageSignature:d,imageUrl:p.image_url,timestamp:new Date().toISOString()}),n().updateRecipeImageUrlInCandidates(c.id,p.image_url,!1)}else{const p=await g.text();throw new Error(`HTTP error! status: ${g.status}, message: ${p}`)}}catch(d){a.error("FRIDGE_SCAN_PIPELINE","Image generation failed for recipe",{sessionId:r,recipeId:c.id,recipeTitle:c.title,error:d instanceof Error?d.message:"Unknown error",errorDetails:d instanceof Error&&d.message.includes("HTTP error!")?d.message:void 0,timestamp:new Date().toISOString()}),n().updateRecipeImageUrlInCandidates(c.id,void 0,!1,!0)}},updateRecipeImageUrlInCandidates:(e,r,s=!1,i=!1)=>{const l=n().recipeCandidates.map(c=>c.id===e?{...c,imageUrl:r,isGeneratingImage:s,imageGenerationError:i}:c);t({recipeCandidates:l})},generateRecipes:async()=>{const e=n();a.info("FRIDGE_SCAN_PIPELINE","Starting generateRecipes - Initial state",{sessionId:e.currentSessionId,userEditedInventoryCount:e.userEditedInventory?.length||0,userEditedInventory:e.userEditedInventory,timestamp:new Date().toISOString()});let r=e.userEditedInventory;if(!r||r.length===0){a.info("FRIDGE_SCAN_PIPELINE","No userEditedInventory found, attempting to get from meal plan store",{sessionId:e.currentSessionId,timestamp:new Date().toISOString()});try{const{useMealPlanStore:i}=await E(async()=>{const{useMealPlanStore:c}=await Promise.resolve().then(()=>ce);return{useMealPlanStore:c}},void 0),o=i.getState();a.info("FRIDGE_SCAN_PIPELINE","Meal plan store state retrieved",{sessionId:e.currentSessionId,selectedInventoryId:o.selectedInventoryId,availableInventoriesCount:o.availableInventories?.length||0,availableInventories:o.availableInventories?.map(c=>({id:c.id,itemCount:c.inventory_final?.length||0,createdAt:c.createdAt})),timestamp:new Date().toISOString()});const l=o.selectedInventoryId&&o.availableInventories?o.availableInventories.find(c=>c.id===o.selectedInventoryId):null;l&&l.inventory_final&&l.inventory_final.length>0?(r=l.inventory_final,t({userEditedInventory:r}),a.info("FRIDGE_SCAN_PIPELINE","Using inventory from meal plan store",{sessionId:e.currentSessionId,selectedInventoryId:o.selectedInventoryId,inventoryCount:r.length,inventoryItems:r.map(c=>({name:c.name,category:c.category,quantity:c.quantity})),timestamp:new Date().toISOString()})):a.warn("FRIDGE_SCAN_PIPELINE","Meal plan store has no selected inventory",{sessionId:e.currentSessionId,selectedInventoryId:o.selectedInventoryId,availableInventoriesCount:o.availableInventories?.length||0,foundSelectedInventory:!!l,selectedInventoryLength:l?.inventory_final?.length||0,timestamp:new Date().toISOString()})}catch(i){a.warn("FRIDGE_SCAN_PIPELINE","Failed to get inventory from meal plan store",{sessionId:e.currentSessionId,error:i instanceof Error?i.message:"Unknown error",errorStack:i instanceof Error?i.stack:void 0,timestamp:new Date().toISOString()})}}if(a.info("FRIDGE_SCAN_PIPELINE","Final inventory state before validation",{sessionId:e.currentSessionId,inventoryToUseExists:!!r,inventoryToUseCount:r?.length||0,inventoryToUse:r?.map(i=>({name:i.name,category:i.category,quantity:i.quantity,freshnessScore:i.freshnessScore})),timestamp:new Date().toISOString()}),!r||r.length===0){const i="Aucun ingrédient disponible pour générer des recettes. Veuillez d'abord scanner votre frigo ou sélectionner un inventaire.";throw a.error("FRIDGE_SCAN_PIPELINE","No inventory available for recipe generation",{sessionId:e.currentSessionId,userEditedInventoryCount:e.userEditedInventory.length,finalInventoryToUseCount:r?.length||0,timestamp:new Date().toISOString()}),t({loadingState:"idle",loadingMessage:"",recipeCandidates:[]}),new Error(i)}const s=A.find(i=>i.id==="generating_recipes");t({currentStep:"generating_recipes",loadingState:"generating",loadingMessage:"La Forge Spatiale crée vos recettes personnalisées...",simulatedOverallProgress:s?.startProgress||60});try{a.info("FRIDGE_SCAN_PIPELINE","Starting streaming recipe generation",{sessionId:e.currentSessionId,inventoryCount:r.length,aiModel:"gpt-5-mini",streamingEnabled:!0,timestamp:new Date().toISOString()});const i=A.find(_=>_.id==="recipes");t({recipeCandidates:[],currentStep:"recipes",loadingState:"streaming",loadingMessage:"Génération des recettes en cours...",simulatedOverallProgress:i?.startProgress||80,simulatedScanProgress:0,simulatedLoadingStep:0}),n().stopProgressSimulation();const{useUserStore:o}=await E(async()=>{const{useUserStore:_}=await Promise.resolve().then(()=>le);return{useUserStore:_}},void 0),l=o.getState().profile,c=o.getState().session?.user?.id;if(!c)throw new Error("User must be authenticated to generate recipes");const{supabase:d}=await E(async()=>{const{supabase:_}=await import("./page-fridge-C1QVLxk9.js").then(I=>I.q);return{supabase:_}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));let u=[];try{const{data:_}=await d.from("recipe_sessions").select(`
            recipes (
              title,
              ingredients
            )
          `).eq("user_id",c).order("created_at",{ascending:!1}).limit(20);_&&(u=_.flatMap(I=>I.recipes||[]).map(I=>({title:I.title,main_ingredients:I.ingredients?.slice(0,3).map(f=>f.name)||[]})))}catch(_){a.warn("FRIDGE_SCAN_PIPELINE","Failed to fetch existing recipes",{sessionId:e.currentSessionId,error:_ instanceof Error?_.message:"Unknown error",timestamp:new Date().toISOString()})}const g={nutrition:{diet:l?.nutrition?.diet||"",allergies:l?.nutrition?.allergies||[],intolerances:l?.nutrition?.intolerances||[],budgetLevel:l?.nutrition?.budgetLevel||"medium",proteinTarget_g:l?.nutrition?.proteinTarget_g||void 0,disliked:l?.nutrition?.disliked||[]},household_details:{adults:l?.householdDetails?.adults||1,children:l?.householdDetails?.children||0,dietaryRestrictions:l?.householdDetails?.dietaryRestrictions||[]},meal_prep_preferences:{weekdayTimeMin:l?.mealPrepPreferences?.weekdayTimeMin||30,weekendTimeMin:l?.mealPrepPreferences?.weekendTimeMin||60,cookingSkill:l?.mealPrepPreferences?.cookingSkill||"intermediate",preferredMealTimes:l?.mealPrepPreferences?.preferredMealTimes||{}},kitchen_equipment:{oven:l?.kitchenEquipment?.oven??!0,stove:l?.kitchenEquipment?.stove??!0,microwave:l?.kitchenEquipment?.microwave??!0,airFryer:l?.kitchenEquipment?.airFryer??!1,slowCooker:l?.kitchenEquipment?.slowCooker??!1,blender:l?.kitchenEquipment?.blender??!1,foodProcessor:l?.kitchenEquipment?.foodProcessor??!1,standMixer:l?.kitchenEquipment?.standMixer??!1,riceCooker:l?.kitchenEquipment?.riceCooker??!1,grill:l?.kitchenEquipment?.grill??!1,steamBasket:l?.kitchenEquipment?.steamBasket??!1,pressureCooker:l?.kitchenEquipment?.pressureCooker??!1},food_preferences:{cuisines:l?.foodPreferences?.cuisines||[],ingredients:l?.foodPreferences?.ingredients||[],flavors:l?.foodPreferences?.flavors||[]},sensory_preferences:{spiceTolerance:l?.sensoryPreferences?.spiceTolerance||1,textureAversions:l?.sensoryPreferences?.textureAversions||[],temperaturePreferences:l?.sensoryPreferences?.temperaturePreferences||[]},macro_targets:{kcal:l?.macroTargets?.kcal||void 0,fiberMinG:l?.macroTargets?.fiberMinG||void 0,sugarMaxG:l?.macroTargets?.sugarMaxG||void 0,saltMaxMg:l?.macroTargets?.saltMaxMg||void 0,carbsMaxG:l?.macroTargets?.carbsMaxG||void 0,fatMinG:l?.macroTargets?.fatMinG||void 0},shopping_preferences:{frequencyPerWeek:l?.shoppingPreferences?.frequencyPerWeek||2,defaultPortionsPerMeal:l?.shoppingPreferences?.defaultPortionsPerMeal||2,batchCooking:l?.shoppingPreferences?.batchCooking||"sometimes",bias:l?.shoppingPreferences?.bias||[],preferredStores:l?.shoppingPreferences?.preferredStores||[],budgetPerWeek:l?.shoppingPreferences?.budgetPerWeek||void 0},user_identity:{sex:l?.sex||"male",height_cm:l?.height_cm||175,weight_kg:l?.weight_kg||70,activity_level:l?.activity_level||"moderate",objective:l?.objective||"recomp"}},p=await fetch("https://kwipydbtjagypocpvbwn.supabase.co/functions/v1/recipe-generator",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3aXB5ZGJ0amFneXBvY3B2YnduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODg0MjIsImV4cCI6MjA3MDI2NDQyMn0.IS5IdKbmnGtgU_AaGYtUgX3ewaNpsiSAui5kbFV31_U","Content-Type":"application/json"},body:JSON.stringify({inventory_final:r.map(_=>({name:_.name,category:_.category,quantity:_.quantity,freshness:_.freshnessScore>70?"Excellent":_.freshnessScore>40?"Bon":"À utiliser rapidement"})),user_preferences:g,filters:{},user_id:c,existing_recipes:u})});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);if(!p.body)throw new Error("Response body is null");const S=p.body.getReader(),N=new TextDecoder;let U="",L=0;const B=(_,I)=>{if(_==="skeleton")try{const P=JSON.parse(I).recipe_count||4;a.info("FRIDGE_SCAN_PIPELINE","Received skeleton count",{sessionId:e.currentSessionId,skeletonCount:P,timestamp:new Date().toISOString()});const b=Array.from({length:P},(w,h)=>({id:`placeholder-${h}-${Date.now()}`,sessionId:e.currentSessionId,title:"",description:"",ingredients:[],instructions:[],prepTimeMin:0,cookTimeMin:0,servings:0,dietaryTags:[],nutritionalInfo:{calories:0,protein:0,carbs:0,fat:0},imageUrl:void 0,imageSignature:void 0,reasons:[],createdAt:new Date().toISOString(),status:"loading",isGeneratingImage:!0}));t({recipeCandidates:b})}catch(f){a.error("FRIDGE_SCAN_PIPELINE","Error parsing skeleton event",{sessionId:e.currentSessionId,error:f instanceof Error?f.message:"Unknown error",timestamp:new Date().toISOString()})}else if(_==="recipe")try{const f=I.trim(),P=f.indexOf("{"),b=f.lastIndexOf("}");if(P===-1||b===-1||P>=b)throw new Error("Invalid JSON structure in recipe data");const w=f.substring(P,b+1),h=JSON.parse(w),J=Array.isArray(h.instructions)?h.instructions.map((v,V)=>typeof v=="object"&&v.instruction?{step:v.step||V+1,instruction:v.instruction,timeMin:v.timeMin||v.time_min,temperature:v.temperature,equipment:v.equipment}:{step:V+1,instruction:typeof v=="string"?v:String(v||"")}):[],F={id:h.id||crypto.randomUUID(),sessionId:e.currentSessionId,title:h.title,description:h.description,ingredients:h.ingredients||[],instructions:J,prepTimeMin:h.prep_time_min||0,cookTimeMin:h.cook_time_min||0,servings:h.servings||2,dietaryTags:h.dietary_tags||[],nutritionalInfo:h.nutritional_info||{},imageUrl:void 0,imageSignature:h.image_signature,reasons:h.reasons||[],createdAt:new Date().toISOString(),status:"ready",isGeneratingImage:!1};L++,a.info("FRIDGE_SCAN_PIPELINE","Received recipe via SSE",{sessionId:e.currentSessionId,recipeId:F.id,recipeTitle:F.title,totalReceived:L,timestamp:new Date().toISOString()});const O=n().recipeCandidates,k=O.findIndex(v=>v.status==="loading"&&v.title==="");let x;k!==-1?(x=[...O],x[k]={...x[k],...F,status:"ready",isGeneratingImage:!0}):x=[...O,F],t({recipeCandidates:x}),n()._triggerImageGenerationForRecipes([F],e.currentSessionId)}catch(f){a.error("FRIDGE_SCAN_PIPELINE","Error parsing recipe event",{sessionId:e.currentSessionId,error:f instanceof Error?f.message:"Unknown error",rawData:I,timestamp:new Date().toISOString()})}else if(_==="complete")try{const f=JSON.parse(I);a.info("FRIDGE_SCAN_PIPELINE","Recipe generation completed via SSE",{sessionId:e.currentSessionId,totalRecipesReceived:L,processingTimeMs:f.processing_time_ms,costUsd:f.cost_usd,cacheHit:f.cache_hit,aiModel:"gpt-5-mini",inputTokens:f.input_tokens,outputTokens:f.output_tokens,timestamp:new Date().toISOString()}),t({loadingState:"idle",loadingMessage:"",isActive:!1})}catch(f){a.error("FRIDGE_SCAN_PIPELINE","Error parsing complete event",{sessionId:e.currentSessionId,error:f instanceof Error?f.message:"Unknown error",timestamp:new Date().toISOString()})}else if(_==="error")try{const f=JSON.parse(I);throw a.error("FRIDGE_SCAN_PIPELINE","SSE error event received",{sessionId:e.currentSessionId,error:f.error||"Unknown SSE error",timestamp:new Date().toISOString()}),t({loadingState:"idle",loadingMessage:"",recipeCandidates:[]}),new Error(f.error||"Recipe generation failed via SSE")}catch(f){throw a.error("FRIDGE_SCAN_PIPELINE","Error parsing SSE error event",{sessionId:e.currentSessionId,error:f instanceof Error?f.message:"Unknown error",timestamp:new Date().toISOString()}),new Error("Recipe generation failed")}};a.info("FRIDGE_SCAN_PIPELINE","SSE connection opened",{sessionId:e.currentSessionId,timestamp:new Date().toISOString()});try{for(;;){const{done:_,value:I}=await S.read();if(_)break;U+=N.decode(I,{stream:!0});const f=U.split(`
`);U=f.pop()||"";let P="",b="";for(const w of f)w.startsWith("event: ")?P=w.slice(7).trim():w.startsWith("data: ")?b=w.slice(6):w===""&&P&&b&&(B(P,b),P="",b="")}}catch(_){throw a.error("FRIDGE_SCAN_PIPELINE","Stream reading error",{sessionId:e.currentSessionId,error:_ instanceof Error?_.message:"Unknown stream error",timestamp:new Date().toISOString()}),t({loadingState:"idle",loadingMessage:"",recipeCandidates:[]}),new Error("Failed to read recipe generation stream")}finally{S.releaseLock()}}catch(i){throw a.error("FRIDGE_SCAN_PIPELINE","Recipe generation failed",{error:i instanceof Error?i.message:"Unknown error",sessionId:e.currentSessionId,costUsd:0,aiModel:"gpt-5-mini",timestamp:new Date().toISOString()}),t({loadingState:"idle",loadingMessage:"",recipeCandidates:[]}),i}}}),ht=(t,n)=>({...It(t,n)}),vt=(t,n)=>({saveSessionToSupabase:async()=>{const e=n();if(!e.currentSessionId){a.warn("FRIDGE_SCAN_PIPELINE","Cannot save session: no session ID");return}const r=["photo","analyze","complement","validation","generating_recipes","recipes"];if(!r.includes(e.currentStep)){a.warn("FRIDGE_SCAN_PIPELINE","Invalid stage value detected, skipping save",{currentStep:e.currentStep,validStages:r,sessionId:e.currentSessionId});return}try{const{useUserStore:s}=await E(async()=>{const{useUserStore:d}=await Promise.resolve().then(()=>le);return{useUserStore:d}},void 0),i=s.getState().session?.user?.id;if(!i){a.warn("FRIDGE_SCAN_PIPELINE","Cannot save session: no user ID");return}const{supabase:o}=await E(async()=>{const{supabase:d}=await import("./page-fridge-C1QVLxk9.js").then(u=>u.q);return{supabase:d}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),l={session_id:e.currentSessionId,user_id:i,stage:e.currentStep,captured_photos:e.capturedPhotos,raw_detected_items:e.rawDetectedItems,user_edited_inventory:e.userEditedInventory,suggested_complementary_items:e.suggestedComplementaryItems,recipe_candidates:e.recipeCandidates,selected_recipes:e.selectedRecipes,meal_plan:e.mealPlan,metadata:{simulatedOverallProgress:e.simulatedOverallProgress,loadingState:e.loadingState},completed:e.simulatedOverallProgress>=100,updated_at:new Date().toISOString()};a.debug("FRIDGE_SCAN_PIPELINE","Attempting to save session",{sessionId:e.currentSessionId,stage:e.currentStep,itemsCount:e.userEditedInventory.length});const{error:c}=await o.from("fridge_scan_sessions").upsert(l,{onConflict:"session_id"});if(c){if(c.code==="PGRST205"||c.message?.includes("does not exist")){a.debug("FRIDGE_SCAN_PIPELINE","fridge_scan_sessions table not found, skipping save");return}throw(c.code==="23514"||c.message?.includes("constraint"))&&a.error("FRIDGE_SCAN_PIPELINE","Database constraint violation",{error:c.message,code:c.code,currentStep:e.currentStep,sessionId:e.currentSessionId,validStages:r}),c}a.debug("FRIDGE_SCAN_PIPELINE","Session saved to Supabase successfully",{sessionId:e.currentSessionId,stage:e.currentStep,itemsCount:e.userEditedInventory.length})}catch(s){a.warn("FRIDGE_SCAN_PIPELINE","Failed to save session to Supabase",{error:s instanceof Error?s.message:"Unknown error",sessionId:e.currentSessionId,currentStep:e.currentStep})}},startScan:async()=>{const e=crypto.randomUUID();a.info("FRIDGE_SCAN_PIPELINE","Force resetting pipeline before new scan",{previousStep:n().currentStep,previousSessionId:n().currentSessionId,wasActive:n().isActive,timestamp:new Date().toISOString()});const r=A.find(s=>s.id==="photo");t({currentStep:"photo",isActive:!0,currentSessionId:e,simulatedOverallProgress:r?.startProgress||0,capturedPhotos:[],rawDetectedItems:[],userEditedInventory:[],recipeCandidates:[],selectedRecipes:[],loadingState:"idle",loadingMessage:""}),a.info("FRIDGE_SCAN_PIPELINE","Fridge scan session started",{sessionId:e,resetComplete:!0,timestamp:new Date().toISOString()}),await n().saveSessionToSupabase()},saveRecipeSession:async()=>{const e=n();t({loadingState:"saving",loadingMessage:"Sauvegarde de votre atelier de recettes..."});try{a.info("FRIDGE_SCAN_PIPELINE","Saving recipe session",{sessionId:e.currentSessionId,selectedRecipesCount:e.selectedRecipes.length,inventoryCount:e.userEditedInventory.length,timestamp:new Date().toISOString()});const{useUserStore:r}=await E(async()=>{const{useUserStore:u}=await Promise.resolve().then(()=>le);return{useUserStore:u}},void 0),s=r.getState().profile,i=r.getState().session?.user?.id;if(!i||!e.currentSessionId)throw new Error("User ID or session ID missing");const{supabase:o}=await E(async()=>{const{supabase:u}=await import("./page-fridge-C1QVLxk9.js").then(g=>g.q);return{supabase:u}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),l={nutrition:s?.nutrition||{},householdDetails:s?.householdDetails||{},mealPrepPreferences:s?.mealPrepPreferences||{},kitchenEquipment:s?.kitchenEquipment||{},foodPreferences:s?.foodPreferences||{},sensoryPreferences:s?.sensoryPreferences||{},macroTargets:s?.macroTargets||{},shoppingPreferences:s?.shoppingPreferences||{}},{data:c,error:d}=await o.from("recipe_sessions").upsert({id:e.currentSessionId,user_id:i,inventory_final:e.userEditedInventory,selected_recipe_ids:e.selectedRecipes.map(u=>u.id),preferences_snapshot:l,filters_snapshot:{},status:"completed",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(d)throw new Error(`Failed to save session: ${d.message}`);if(e.selectedRecipes.length>0){const u=e.selectedRecipes.map(p=>({id:p.id,session_id:e.currentSessionId,title:p.title,description:p.description,ingredients:p.ingredients,instructions:p.instructions,prep_time_min:p.prepTimeMin,cook_time_min:p.cookTimeMin,servings:p.servings,dietary_tags:p.dietaryTags,nutritional_info:p.nutritionalInfo,...p.imageUrl&&{image_url:p.imageUrl},image_signature:p.imageSignature,reasons:p.reasons,created_at:p.createdAt,updated_at:p.updatedAt})),{error:g}=await o.from("recipes").upsert(u);g&&a.warn("FRIDGE_SCAN_PIPELINE","Failed to save some recipes",{error:g.message,sessionId:e.currentSessionId,recipesCount:u.length})}a.info("FRIDGE_SCAN_PIPELINE","Recipe session saved successfully",{sessionId:e.currentSessionId,savedRecipesCount:e.selectedRecipes.length,timestamp:new Date().toISOString()});try{const{useMealPlanStore:u}=await E(async()=>{const{useMealPlanStore:g}=await Promise.resolve().then(()=>ce);return{useMealPlanStore:g}},void 0);await u.getState().loadAvailableInventories(),u.getState().selectInventory(e.currentSessionId),a.info("FRIDGE_SCAN_PIPELINE","Meal plan store updated with new inventory",{sessionId:e.currentSessionId,timestamp:new Date().toISOString()})}catch(u){a.warn("FRIDGE_SCAN_PIPELINE","Failed to update meal plan store",{error:u instanceof Error?u.message:"Unknown error",sessionId:e.currentSessionId,timestamp:new Date().toISOString()})}try{const{queryClient:u}=await E(async()=>{const{queryClient:g}=await import("./index-B1aqsbWO.js").then(p=>p.A);return{queryClient:g}},__vite__mapDeps([10,0,1,2,3,4,5,6,7,8,9,11,12,13]));u&&(await u.invalidateQueries({queryKey:["fridge-scan-sessions","has-history"]}),a.info("FRIDGE_SCAN_PIPELINE","React Query cache invalidated for Scanner tab",{sessionId:e.currentSessionId,timestamp:new Date().toISOString()}))}catch(u){a.warn("FRIDGE_SCAN_PIPELINE","Failed to invalidate React Query cache",{error:u instanceof Error?u.message:"Unknown error",sessionId:e.currentSessionId,timestamp:new Date().toISOString()})}t({loadingState:"idle",loadingMessage:"Session sauvegardée avec succès",simulatedOverallProgress:100})}catch(r){throw a.error("FRIDGE_SCAN_PIPELINE","Recipe session save failed",{error:r instanceof Error?r.message:"Unknown error",sessionId:e.currentSessionId,timestamp:new Date().toISOString()}),t({loadingState:"idle",loadingMessage:"Erreur lors de la sauvegarde"}),r}finally{n().stopProgressSimulation()}return e.currentSessionId},resetPipeline:()=>{const e=n();e.stopProgressSimulation(),a.info("FRIDGE_SCAN_PIPELINE","Resetting pipeline completely",{previousStep:e.currentStep,previousSessionId:e.currentSessionId,wasActive:e.isActive,hadCapturedPhotos:e.capturedPhotos.length,hadInventory:e.userEditedInventory.length,loadingState:e.loadingState,timestamp:new Date().toISOString()}),t({currentStep:"photo",isActive:!1,currentSessionId:null,simulatedLoadingStep:0,simulatedScanProgress:0,simulatedOverallProgress:0,progressIntervalId:null,progressTimeoutId:null,capturedPhotos:[],rawDetectedItems:[],userEditedInventory:[],loadingState:"idle",loadingMessage:""}),a.info("FRIDGE_SCAN_PIPELINE","Pipeline reset",{resetComplete:!0,newStep:"photo",newSessionId:null,allDataCleared:!0,timestamp:new Date().toISOString()})},resumePipeline:async()=>{const e=n();a.info("FRIDGE_SCAN_PIPELINE","Resuming pipeline from persisted state",{currentSessionId:e.currentSessionId,currentStep:e.currentStep,isActive:e.isActive,hasInventory:e.userEditedInventory.length>0,timestamp:new Date().toISOString()});let r="photo";e.userEditedInventory.length>0?r="validation":e.suggestedComplementaryItems.length>0&&e.rawDetectedItems.length<pe?r="complement":e.rawDetectedItems.length>0?r="validation":e.capturedPhotos.length>0&&(r="analyze");const s=A.find(i=>i.id===r);if(t({isActive:!0,currentStep:r,simulatedOverallProgress:s?.startProgress||0,loadingState:"idle",loadingMessage:""}),e.currentSessionId&&e.userEditedInventory.length>0)try{const{useMealPlanStore:i}=await E(async()=>{const{useMealPlanStore:o}=await Promise.resolve().then(()=>ce);return{useMealPlanStore:o}},void 0);await i.getState().loadAvailableInventories(),i.getState().selectInventory(e.currentSessionId),a.info("FRIDGE_SCAN_PIPELINE","Meal plan store updated on resume",{sessionId:e.currentSessionId,inventoryCount:e.userEditedInventory.length,timestamp:new Date().toISOString()})}catch(i){a.warn("FRIDGE_SCAN_PIPELINE","Failed to update meal plan store on resume",{error:i instanceof Error?i.message:"Unknown error",sessionId:e.currentSessionId,timestamp:new Date().toISOString()})}a.info("FRIDGE_SCAN_PIPELINE","Pipeline resumed successfully",{sessionId:e.currentSessionId,resumedToStep:r,progress:s?.startProgress||0,timestamp:new Date().toISOString()})},startRecipeGenerationFromInventory:async e=>{try{a.info("FRIDGE_SCAN_PIPELINE","Starting recipe generation from inventory",{inventoryCount:e?.length||0,timestamp:new Date().toISOString()});const r=crypto.randomUUID();t({currentSessionId:r,isActive:!0,currentStep:"validation",userEditedInventory:e,rawDetectedItems:e,simulatedOverallProgress:66,loadingState:"idle",loadingMessage:""}),a.info("FRIDGE_SCAN_PIPELINE","Recipe generation from inventory started successfully",{sessionId:r,inventoryCount:e?.length||0,currentStep:"validation",timestamp:new Date().toISOString()})}catch(r){throw a.error("FRIDGE_SCAN_PIPELINE","Failed to start recipe generation from inventory",{error:r instanceof Error?r.message:"Unknown error",inventoryCount:e?.length||0,timestamp:new Date().toISOString()}),r}}}),Et=(t,n)=>({goToStep:async e=>{const r=A.find(i=>i.id===e),s={currentStep:e,simulatedOverallProgress:r?.startProgress||0};t(s),await n().saveSessionToSupabase()},nextStep:()=>{const e=n(),r=A.findIndex(s=>s.id===e.currentStep);r<A.length-1&&t({currentStep:A[r+1].id})},previousStep:()=>{const e=n(),r=A.findIndex(s=>s.id===e.currentStep);r>0&&t({currentStep:A[r-1].id})}}),qt=y()(Y((t,n)=>({currentStep:"photo",isActive:!1,currentSessionId:null,simulatedLoadingStep:0,simulatedScanProgress:0,simulatedOverallProgress:0,progressIntervalId:null,progressTimeoutId:null,capturedPhotos:[],rawDetectedItems:[],userEditedInventory:[],suggestedComplementaryItems:[],recipeCandidates:[],selectedRecipes:[],recentSessions:[],externalGenerationTriggered:!1,mealPlan:null,loadingState:"idle",loadingMessage:"",steps:A,...ft(t,n),...St(t,n),..._t(t,n),...ht(t,n),...vt(t,n),...Et(t,n),setExternalGenerationTriggered:e=>{t({externalGenerationTriggered:e})},setLoadingState:e=>{t({loadingState:e}),a.debug("FRIDGE_SCAN_PIPELINE","Loading state updated",{newLoadingState:e,timestamp:new Date().toISOString()})},setUserEditedInventory:e=>{t({userEditedInventory:e}),a.debug("FRIDGE_SCAN_PIPELINE","User edited inventory set explicitly",{inventoryCount:e.length,timestamp:new Date().toISOString()})},clearRecipeCandidates:()=>{t({recipeCandidates:[]}),a.info("FRIDGE_SCAN_PIPELINE","Recipe candidates cleared",{sessionId:n().currentSessionId,timestamp:new Date().toISOString()})},loadRecentSessions:async()=>{try{const{supabase:e}=await E(async()=>{const{supabase:l}=await import("./page-fridge-C1QVLxk9.js").then(c=>c.q);return{supabase:l}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),{data:{user:r}}=await e.auth.getUser();if(!r){a.warn("FRIDGE_SCAN_PIPELINE","No user found, cannot load recent sessions"),t({recentSessions:[]});return}const{data:s,error:i}=await e.from("fridge_scan_sessions").select("session_id, user_id, stage, created_at, updated_at, captured_photos, raw_detected_items").eq("user_id",r.id).order("created_at",{ascending:!1}).limit(10);if(i){if(i.code==="PGRST205"||i.message?.includes("does not exist")){a.warn("FRIDGE_SCAN_PIPELINE","fridge_scan_sessions table not found (migration pending)",{code:i.code,message:i.message}),t({recentSessions:[]});return}a.error("FRIDGE_SCAN_PIPELINE","Failed to load recent sessions",{error:i.message,code:i.code}),t({recentSessions:[]});return}const o=(s||[]).map(l=>({sessionId:l.session_id,userId:l.user_id,stage:l.stage,createdAt:l.created_at,updatedAt:l.updated_at,capturedPhotos:l.captured_photos,rawDetectedItems:l.raw_detected_items}));t({recentSessions:o}),a.info("FRIDGE_SCAN_PIPELINE","Recent sessions loaded",{count:o.length,timestamp:new Date().toISOString()})}catch(e){a.warn("FRIDGE_SCAN_PIPELINE","Exception loading recent sessions",{error:e instanceof Error?e.message:"Unknown error",errorType:e instanceof Error?e.constructor.name:typeof e}),t({recentSessions:[]})}}}),{name:mt,storage:ae(()=>localStorage),partialize:t=>{const n={currentStep:t.currentStep,isActive:t.isActive,currentSessionId:t.currentSessionId,simulatedLoadingStep:t.simulatedLoadingStep,simulatedScanProgress:t.simulatedScanProgress,simulatedOverallProgress:t.simulatedOverallProgress,rawDetectedItems:t.rawDetectedItems,userEditedInventory:t.userEditedInventory,mealPlan:t.mealPlan};return a.debug("FRIDGE_SCAN_PIPELINE_STORE","Partializing state for persistence",{currentStep:n.currentStep,isActive:n.isActive,sessionId:n.currentSessionId,rawDetectedItemsCount:n.rawDetectedItems?.length||0,userEditedInventoryCount:n.userEditedInventory?.length||0,timestamp:new Date().toISOString()}),n},merge:(t,n)=>{const e=t;a.debug("FRIDGE_SCAN_PIPELINE_STORE","Loading persisted data for merge",{persistedStep:e?.currentStep,persistedIsActive:e?.isActive,persistedSessionId:e?.currentSessionId,persistedOverallProgress:e?.simulatedOverallProgress,persistedRawDetectedItemsCount:e?.rawDetectedItems?.length||0,persistedUserEditedInventoryCount:e?.userEditedInventory?.length||0,timestamp:new Date().toISOString()});const r={...e,rawDetectedItems:Array.isArray(e?.rawDetectedItems)?e.rawDetectedItems:[],userEditedInventory:Array.isArray(e?.userEditedInventory)?e.userEditedInventory:[]},s={...n,...r};a.info("FRIDGE_SCAN_PIPELINE_STORE","Hydrating store state from persistence",{persistedStep:e?.currentStep,persistedIsActive:e?.isActive,persistedSessionId:e?.currentSessionId,persistedOverallProgress:e?.simulatedOverallProgress,hasInventory:e?.userEditedInventory?.length>0,timestamp:new Date().toISOString()});const i=e?.currentSessionId&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e.currentSessionId);if(i){s.currentSessionId=e.currentSessionId;const o=e?.rawDetectedItems?.length>0||e?.userEditedInventory?.length>0;s.isActive=o,e?.userEditedInventory?.length>0?s.currentStep="validation":e?.suggestedComplementaryItems?.length>0&&(e?.rawDetectedItems?.length||0)<pe?s.currentStep="complement":e?.rawDetectedItems?.length>0?s.currentStep="validation":s.currentStep="photo",a.debug("FRIDGE_SCAN_PIPELINE_STORE","Session validation result",{sessionId:e.currentSessionId,hasPersistedData:o,rawDetectedItemsCount:e?.rawDetectedItems?.length||0,inventoryCount:e?.userEditedInventory?.length||0,setActive:o,determinedStep:s.currentStep})}else s.currentSessionId=null,s.isActive=!1,s.currentStep="photo";if(s.simulatedLoadingStep=0,s.simulatedScanProgress=0,s.progressIntervalId=null,s.progressTimeoutId=null,s.loadingState="idle",s.loadingMessage="",s.currentStep){const o=A.find(l=>l.id===s.currentStep);s.simulatedOverallProgress=o?.startProgress||0,a.debug("FRIDGE_SCAN_PIPELINE_STORE","Setting progress from current step",{currentStep:s.currentStep,foundStepData:!!o,startProgress:o?.startProgress,finalProgress:s.simulatedOverallProgress,timestamp:new Date().toISOString()})}else s.simulatedOverallProgress=0,a.debug("FRIDGE_SCAN_PIPELINE_STORE","Setting progress to 0 (no step)",{currentStep:s.currentStep,timestamp:new Date().toISOString()});return s.steps=n.steps,a.info("FRIDGE_SCAN_PIPELINE_STORE","Store state hydration completed",{finalIsActive:s.isActive,finalCurrentStep:s.currentStep,finalSessionId:s.currentSessionId,finalOverallProgress:s.simulatedOverallProgress,sessionValid:i,hasInventory:s.userEditedInventory?.length>0,timestamp:new Date().toISOString()}),s}})),G=["Analyse du plan de repas...","Calcul des quantités nécessaires...","Génération de la liste intelligente...","Optimisation des catégories...","Ajout de suggestions personnalisées...","Estimation budgétaire en cours..."],ee=["Examen détaillé de vos repas planifiés","Adaptation selon vos préférences alimentaires","Optimisation personnalisée en cours","Organisation par rayons de magasin","Conseils personnalisés basés sur votre profil","Calcul des coûts selon votre région"],jt=y()(Y((t,n)=>({shoppingList:null,suggestions:[],advice:[],budgetEstimation:null,generationMode:"user_only",selectedMealPlanId:null,isGenerating:!1,simulatedProgressPercentage:0,currentLoadingTitle:"",currentLoadingSubtitle:"",progressInterval:null,setGenerationMode:e=>t({generationMode:e}),setSelectedMealPlanId:e=>t({selectedMealPlanId:e}),startSimulatedProgress:()=>{const e=n();e.progressInterval&&clearInterval(e.progressInterval),t({simulatedProgressPercentage:0,currentLoadingTitle:G[0],currentLoadingSubtitle:ee[0]});let r=0;const i=3e4/G.length,o=95/G.length,l=setInterval(()=>{n();const c=Math.min(95,(r+1)*o);t({simulatedProgressPercentage:c,currentLoadingTitle:G[r]||G[G.length-1],currentLoadingSubtitle:ee[r]||ee[ee.length-1]}),r++,r>=G.length&&(r=G.length-1)},i);t({progressInterval:l})},stopSimulatedProgress:()=>{const e=n();e.progressInterval&&(clearInterval(e.progressInterval),t({progressInterval:null,simulatedProgressPercentage:100,currentLoadingTitle:"Liste générée avec succès !",currentLoadingSubtitle:"Votre liste de courses personnalisée est prête"}))},generateShoppingList:async e=>{const{generationMode:r,selectedMealPlanId:s}=e;a.info("SHOPPING_LIST_STORE","Starting shopping list generation",{generationMode:r,selectedMealPlanId:s});try{t({isGenerating:!0}),n().startSimulatedProgress();const{data:{user:i}}=await m.auth.getUser();if(!i)throw a.error("Cannot generate shopping list: user not authenticated"),new Error("User not authenticated");a.info("Starting shopping list generation",{mealPlanId:s,generationMode:r,userId:i.id}),a.debug("Calling shopping-list-generator edge function");const{data:o,error:l}=await m.functions.invoke("shopping-list-generator",{body:{user_id:i.id,meal_plan_id:s,generation_mode:r}});if(l)throw a.error("Shopping list generation API error",l),a.error("SHOPPING_LIST_STORE","Edge function error",{error:l}),l;if(!o||!o.shopping_list)throw a.error("SHOPPING_LIST_STORE","Invalid response from edge function",{data:o}),new Error("Invalid response from shopping list generator");a.info("Shopping list generation API response received",{hasShoppingList:!!o.shopping_list,hasSuggestions:!!o.suggestions,hasAdvice:!!o.advice,hasBudgetEstimation:!!o.budget_estimation});const c=(o.shopping_list||[]).map(g=>({id:g.id||`category-${Date.now()}-${Math.random()}`,name:g.category||g.name||"Unknown Category",icon:g.icon||"Package",color:g.color||"#6B7280",estimatedTotal:g.estimatedTotal||0,items:(g.items||[]).map(p=>({id:p.id||`item-${Date.now()}-${Math.random()}`,name:p.name||"Unknown Item",quantity:p.quantity||"1",estimatedPrice:p.estimatedPrice||0,priority:p.priority||"medium",isChecked:!1}))})),d=c.reduce((g,p)=>g+p.items.length,0);a.info("SHOPPING_LIST_STORE","Successfully generated shopping list",{categoriesCount:c.length,itemCount:d,suggestionsCount:o.suggestions?.length||0,adviceCount:o.advice?.length||0,hasBudget:!!o.budget_estimation}),c.forEach((g,p)=>{a.debug("SHOPPING_LIST_STORE",`Category ${p+1}: ${g.name}`,{itemsCount:g.items.length,items:g.items.map(S=>`${S.name} (${S.quantity})`)})});const u={id:o.shopping_list?.id||`list-${Date.now()}`,name:o.shopping_list?.name||"Liste de Courses",generationMode:r,totalItems:d,completedItems:0,totalEstimatedCost:o.shopping_list?.totalEstimatedCost||0,categories:c,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};n().stopSimulatedProgress(),t({shoppingList:u,suggestions:o.suggestions||[],advice:o.advice||[],budgetEstimation:o.budget_estimation||null,isGenerating:!1}),a.info("Shopping list generation completed successfully",{itemsCount:d,suggestionsCount:o.suggestions?.length||0,adviceCount:o.advice?.length||0})}catch(i){throw a.error("Shopping list generation failed",i),a.error("SHOPPING_LIST_STORE","Failed to generate shopping list",{error:i}),n().stopSimulatedProgress(),t({isGenerating:!1,simulatedProgressPercentage:0}),i}},reset:()=>{const e=n();e.progressInterval&&clearInterval(e.progressInterval),t({shoppingList:null,suggestions:[],advice:[],budgetEstimation:null,selectedMealPlanId:null,isGenerating:!1,simulatedProgressPercentage:0,currentLoadingTitle:"",currentLoadingSubtitle:"",progressInterval:null})}}),{name:"shopping-list-store",partialize:t=>({shoppingList:t.shoppingList,suggestions:t.suggestions,advice:t.advice,budgetEstimation:t.budgetEstimation,generationMode:t.generationMode,selectedMealPlanId:t.selectedMealPlanId})})),te="twinforge-3d-quality",Bt=y((t,n)=>({quality:"auto",isLoading:!0,detectedQuality:null,loadQuality:async(e,r)=>{try{t({isLoading:!0}),r&&t({detectedQuality:r});const s=localStorage.getItem(te);if(s!==null&&yt(s)){const i=s;t({quality:i,isLoading:!1}),a.info("RENDER_3D_QUALITY","Loaded from localStorage",{quality:i})}else r&&(t({quality:"auto",isLoading:!1}),localStorage.setItem(te,"auto"));if(e){const{data:i,error:o}=await m.from("user_preferences").select("render_quality_3d").eq("user_id",e).maybeSingle();if(o)a.error("RENDER_3D_QUALITY","Failed to load from Supabase",{error:o});else if(i&&i.render_quality_3d){const l=i.render_quality_3d;t({quality:l,isLoading:!1}),localStorage.setItem(te,l),a.info("RENDER_3D_QUALITY","Loaded from Supabase",{quality:l})}}t({isLoading:!1})}catch(s){a.error("RENDER_3D_QUALITY","Error loading 3D quality",{error:s}),t({isLoading:!1})}},setQuality:async(e,r)=>{try{if(t({quality:e}),localStorage.setItem(te,e),a.info("RENDER_3D_QUALITY","Quality changed",{quality:e}),r){const{error:s}=await m.from("user_preferences").upsert({user_id:r,render_quality_3d:e,updated_at:new Date().toISOString()},{onConflict:"user_id"});s?a.error("RENDER_3D_QUALITY","Failed to save to Supabase",{error:s}):a.info("RENDER_3D_QUALITY","Saved to Supabase",{quality:e})}}catch(s){a.error("RENDER_3D_QUALITY","Error setting 3D quality",{error:s})}},getEffectiveQuality:()=>{const e=n();return e.quality==="auto"?e.detectedQuality||"medium":e.quality}}));function yt(t){return["auto","low","medium","high"].includes(t)}const Ee={push_notifications_enabled:!0,in_app_notifications_enabled:!0,email_notifications_enabled:!1,notification_sound_enabled:!0,notification_vibration_enabled:!0},Pt={push_enabled:!0,in_app_enabled:!0,email_enabled:!1,sound_enabled:!0,vibration_enabled:!0,priority_filter:"all",quiet_hours_enabled:!1,quiet_hours_start:null,quiet_hours_end:null},Vt=[{category:"training",label:"Entraînement",description:"Séances planifiées, rappels d'exercices, progression",icon:"Dumbbell",defaultEnabled:!0,canDisable:!0,examples:["Rappel de séance planifiée dans 30 minutes","Nouvelle séance recommandée disponible","Objectif hebdomadaire atteint"]},{category:"nutrition",label:"Nutrition",description:"Repas, recettes, plans alimentaires",icon:"UtensilsCrossed",defaultEnabled:!0,canDisable:!0,examples:["Rappel de repas","Nouvelle recette suggérée","Objectif calorique atteint"]},{category:"fasting",label:"Jeûne",description:"Fenêtres de jeûne, rappels, progression",icon:"Clock",defaultEnabled:!0,canDisable:!0,examples:["Fenêtre de jeûne se termine dans 1h","Nouveau record de jeûne établi","Rappel d'hydratation"]},{category:"activity",label:"Activité",description:"Activités quotidiennes, objectifs de pas",icon:"Activity",defaultEnabled:!0,canDisable:!0,examples:["Objectif quotidien de pas atteint","Rappel de mouvement","Nouvelle activité détectée"]},{category:"system",label:"Système",description:"Mises à jour, maintenance, alertes importantes",icon:"Settings",defaultEnabled:!0,canDisable:!1,examples:["Nouvelle fonctionnalité disponible","Mise à jour de sécurité","Maintenance planifiée"]},{category:"social",label:"Social",description:"Messages, interactions avec la communauté",icon:"Users",defaultEnabled:!0,canDisable:!0,examples:["Nouveau message reçu","Quelqu'un a aimé votre activité","Invitation à rejoindre un défi"]},{category:"achievements",label:"Réussites",description:"Badges, jalons, accomplissements",icon:"Trophy",defaultEnabled:!0,canDisable:!0,examples:["Nouveau badge débloqué","Jalon atteint","Record personnel battu"]}],z="twinforge-notification-prefs",Ht=y((t,n)=>({globalSettings:{...Ee},categoryPreferences:new Map,pushSubscriptions:[],activePushSubscription:null,recentHistory:[],stats:null,isLoading:!1,isSaving:!1,error:null,lastSyncedAt:null,loadGlobalSettings:async e=>{try{t({isLoading:!0,error:null});const r=`${z}-global`,s=localStorage.getItem(r);if(s){const i=JSON.parse(s);t({globalSettings:i})}if(e){const{data:i,error:o}=await m.from("user_preferences").select("push_notifications_enabled, in_app_notifications_enabled, email_notifications_enabled, notification_sound_enabled, notification_vibration_enabled").eq("user_id",e).maybeSingle();if(o)a.error("NOTIFICATION_PREFS","Failed to load global settings from Supabase",{error:o});else if(i){const l={push_notifications_enabled:i.push_notifications_enabled??!0,in_app_notifications_enabled:i.in_app_notifications_enabled??!0,email_notifications_enabled:i.email_notifications_enabled??!1,notification_sound_enabled:i.notification_sound_enabled??!0,notification_vibration_enabled:i.notification_vibration_enabled??!0};t({globalSettings:l,lastSyncedAt:new Date().toISOString()}),localStorage.setItem(r,JSON.stringify(l)),a.info("NOTIFICATION_PREFS","Loaded global settings from Supabase")}}t({isLoading:!1})}catch(r){a.error("NOTIFICATION_PREFS","Error loading global settings",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement des paramètres"})}},updateGlobalSetting:async(e,r,s)=>{try{t({isSaving:!0,error:null});const o={...n().globalSettings,[e]:r};t({globalSettings:o});const l=`${z}-global`;if(localStorage.setItem(l,JSON.stringify(o)),s){const{error:c}=await m.from("user_preferences").update({[e]:r,updated_at:new Date().toISOString()}).eq("user_id",s);if(c){a.error("NOTIFICATION_PREFS","Failed to update global setting in Supabase",{error:c}),t({isSaving:!1,error:"Erreur lors de la sauvegarde"});return}a.info("NOTIFICATION_PREFS","Updated global setting",{key:e,value:r}),t({lastSyncedAt:new Date().toISOString()})}t({isSaving:!1})}catch(i){a.error("NOTIFICATION_PREFS","Error updating global setting",{error:i}),t({isSaving:!1,error:"Erreur lors de la sauvegarde"})}},toggleGlobalNotifications:async(e,r)=>{const{updateGlobalSetting:s}=n();await s("push_notifications_enabled",e,r),await s("in_app_notifications_enabled",e,r)},loadCategoryPreferences:async e=>{try{if(t({isLoading:!0,error:null}),!e){const l=`${z}-categories`,c=localStorage.getItem(l);if(c){const d=JSON.parse(c),u=new Map(Object.entries(d));t({categoryPreferences:u})}t({isLoading:!1});return}const{data:r,error:s}=await m.from("notification_preferences").select("*").eq("user_id",e);if(s){a.error("NOTIFICATION_PREFS","Failed to load category preferences",{error:s}),t({isLoading:!1});return}const i=new Map;r&&r.length>0&&r.forEach(l=>{i.set(l.category,l)}),t({categoryPreferences:i,lastSyncedAt:new Date().toISOString(),isLoading:!1});const o=`${z}-categories`;localStorage.setItem(o,JSON.stringify(Object.fromEntries(i))),a.info("NOTIFICATION_PREFS","Loaded category preferences",{count:i.size})}catch(r){a.error("NOTIFICATION_PREFS","Error loading category preferences",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement des préférences"})}},updateCategoryPreference:async(e,r,s)=>{try{t({isSaving:!0,error:null});const i=n().categoryPreferences,o=i.get(e);if(!s){if(o){const g={...o,...r},p=new Map(i);p.set(e,g),t({categoryPreferences:p});const S=`${z}-categories`;localStorage.setItem(S,JSON.stringify(Object.fromEntries(p)))}t({isSaving:!1});return}const{data:l,error:c}=await m.from("notification_preferences").upsert({user_id:s,category:e,...r,updated_at:new Date().toISOString()},{onConflict:"user_id,category"}).select().single();if(c)throw a.error("NOTIFICATION_PREFS","Failed to update category preference",{error:c}),c;const d=new Map(i);d.set(e,l),t({categoryPreferences:d,lastSyncedAt:new Date().toISOString(),isSaving:!1});const u=`${z}-categories`;localStorage.setItem(u,JSON.stringify(Object.fromEntries(d))),a.info("NOTIFICATION_PREFS","Updated category preference",{category:e,updates:r})}catch(i){a.error("NOTIFICATION_PREFS","Error updating category preference",{error:i}),t({isSaving:!1,error:"Erreur lors de la sauvegarde"})}},resetCategoryToDefaults:async(e,r)=>{const{updateCategoryPreference:s}=n();await s(e,{...Pt},r)},loadPushSubscriptions:async e=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}const{data:r,error:s}=await m.from("push_subscriptions").select("*").eq("user_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(s){a.error("NOTIFICATION_PREFS","Failed to load push subscriptions",{error:s}),t({pushSubscriptions:[],activePushSubscription:null,isLoading:!1});return}const i=r||[],o=i.length>0?i[0]:null;t({pushSubscriptions:i,activePushSubscription:o,lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("NOTIFICATION_PREFS","Loaded push subscriptions",{count:i.length})}catch(r){a.error("NOTIFICATION_PREFS","Error loading push subscriptions",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement des abonnements"})}},subscribeToPush:async(e,r)=>{try{if(t({isSaving:!0,error:null}),!r)throw new Error("User ID required to subscribe to push notifications");const{data:s,error:i}=await m.from("push_subscriptions").insert({user_id:r,subscription_endpoint:e.subscription_endpoint,subscription_keys:e.subscription_keys,device_info:e.device_info,is_active:!0}).select().single();if(i)throw a.error("NOTIFICATION_PREFS","Failed to subscribe to push",{error:i}),i;const o=s,l=n().pushSubscriptions;t({pushSubscriptions:[o,...l],activePushSubscription:o,lastSyncedAt:new Date().toISOString(),isSaving:!1}),a.info("NOTIFICATION_PREFS","Subscribed to push notifications")}catch(s){a.error("NOTIFICATION_PREFS","Error subscribing to push",{error:s}),t({isSaving:!1,error:"Erreur lors de l'abonnement aux notifications"})}},unsubscribeFromPush:async(e,r)=>{try{if(t({isSaving:!0,error:null}),!r)throw new Error("User ID required to unsubscribe from push notifications");const{error:s}=await m.from("push_subscriptions").update({is_active:!1}).eq("id",e).eq("user_id",r);if(s)throw a.error("NOTIFICATION_PREFS","Failed to unsubscribe from push",{error:s}),s;const o=n().pushSubscriptions.filter(c=>c.id!==e),l=o.length>0?o[0]:null;t({pushSubscriptions:o,activePushSubscription:l,lastSyncedAt:new Date().toISOString(),isSaving:!1}),a.info("NOTIFICATION_PREFS","Unsubscribed from push notifications")}catch(s){a.error("NOTIFICATION_PREFS","Error unsubscribing from push",{error:s}),t({isSaving:!1,error:"Erreur lors de la désinscription"})}},checkPushPermission:async()=>"Notification"in window?Notification.permission:"denied",requestPushPermission:async()=>{try{if(!("Notification"in window))return a.warn("NOTIFICATION_PREFS","Push notifications not supported"),!1;const e=await Notification.requestPermission();return a.info("NOTIFICATION_PREFS","Push permission requested",{permission:e}),e==="granted"}catch(e){return a.error("NOTIFICATION_PREFS","Error requesting push permission",{error:e}),!1}},loadNotificationHistory:async(e,r=30)=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}const s=new Date;s.setDate(s.getDate()-r);const{data:i,error:o}=await m.from("notification_history").select("*").eq("user_id",e).gte("sent_at",s.toISOString()).order("sent_at",{ascending:!1}).limit(100);if(o)throw a.error("NOTIFICATION_PREFS","Failed to load notification history",{error:o}),o;t({recentHistory:i||[],lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("NOTIFICATION_PREFS","Loaded notification history",{count:i?.length||0})}catch(s){a.error("NOTIFICATION_PREFS","Error loading notification history",{error:s}),t({isLoading:!1,error:"Erreur lors du chargement de l'historique"})}},loadNotificationStats:async(e,r=30)=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}n().recentHistory.length===0&&await n().loadNotificationHistory(e,r);const i=n().recentHistory,o={total_sent:i.length,total_delivered:i.filter(l=>l.status==="delivered").length,total_clicked:i.filter(l=>l.status==="clicked").length,total_dismissed:i.filter(l=>l.status==="dismissed").length,total_failed:i.filter(l=>l.status==="failed").length,delivery_rate:0,click_rate:0,by_category:{},by_priority:{}};o.delivery_rate=o.total_sent>0?o.total_delivered/o.total_sent*100:0,o.click_rate=o.total_delivered>0?o.total_clicked/o.total_delivered*100:0,t({stats:o,isLoading:!1}),a.info("NOTIFICATION_PREFS","Calculated notification stats",{stats:o})}catch(s){a.error("NOTIFICATION_PREFS","Error loading notification stats",{error:s}),t({isLoading:!1,error:"Erreur lors du chargement des statistiques"})}},clearError:()=>t({error:null}),reset:()=>t({globalSettings:{...Ee},categoryPreferences:new Map,pushSubscriptions:[],activePushSubscription:null,recentHistory:[],stats:null,isLoading:!1,isSaving:!1,error:null,lastSyncedAt:null})}));function zt(t){const n=new Date(t),e=new Date,r=n.getTime()-e.getTime();return Math.ceil(r/(1e3*60*60*24))}function Yt(t){return t.status==="pending"||t.status==="scheduled"}function Wt(t){return t?t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(2)} KB`:t<1024*1024*1024?`${(t/(1024*1024)).toFixed(2)} MB`:`${(t/(1024*1024*1024)).toFixed(2)} GB`:"N/A"}const ye={data_retention_preference:"standard",analytics_tracking_enabled:!0,marketing_communications_enabled:!1},$t=[{category:"profile",label:"Profil",description:"Informations personnelles, photo, préférences de base",icon:"User",estimatedSize:"~100 KB",includeByDefault:!0,examples:["Nom, email, date de naissance","Photo de profil","Paramètres de compte"]},{category:"training",label:"Entraînement",description:"Séances, exercices, progression",icon:"Dumbbell",estimatedSize:"~5 MB",includeByDefault:!0,examples:["Historique des séances","Exercices personnalisés","Objectifs et progression"]},{category:"nutrition",label:"Nutrition",description:"Repas, recettes, plans alimentaires",icon:"UtensilsCrossed",estimatedSize:"~3 MB",includeByDefault:!0,examples:["Journal alimentaire","Recettes favorites","Plans de repas"]},{category:"fasting",label:"Jeûne",description:"Sessions de jeûne, progression",icon:"Clock",estimatedSize:"~500 KB",includeByDefault:!0,examples:["Historique de jeûne","Statistiques","Protocoles utilisés"]},{category:"body_scans",label:"Scans corporels",description:"Photos, mesures, morphologie",icon:"Scan",estimatedSize:"~20 MB",includeByDefault:!0,examples:["Photos de scan","Mesures corporelles","Évolution morphologique"]},{category:"activities",label:"Activités",description:"Activités quotidiennes, GPS, calories",icon:"Activity",estimatedSize:"~2 MB",includeByDefault:!0,examples:["Historique d'activités","Données GPS","Calories brûlées"]},{category:"health",label:"Santé",description:"Données de santé, métriques biométriques",icon:"Heart",estimatedSize:"~1 MB",includeByDefault:!0,examples:["Fréquence cardiaque","Poids","Mesures biométriques"]},{category:"preferences",label:"Préférences",description:"Paramètres, notifications, thème",icon:"Settings",estimatedSize:"~50 KB",includeByDefault:!0,examples:["Paramètres d'affichage","Préférences de notifications","Mode de performance"]},{category:"notifications",label:"Notifications",description:"Historique des notifications",icon:"Bell",estimatedSize:"~500 KB",includeByDefault:!1,examples:["Notifications reçues","Préférences de notifications"]}],Pe="twinforge-privacy",Jt=y((t,n)=>({preferences:{...ye},activeDeletionRequest:null,recentExportRequests:[],consents:new Map,recentAccessLog:[],isLoading:!1,isSaving:!1,error:null,lastSyncedAt:null,loadPrivacyPreferences:async e=>{try{t({isLoading:!0,error:null});const r=`${Pe}-preferences`,s=localStorage.getItem(r);if(s){const i=JSON.parse(s);t({preferences:i})}if(e){const{data:i,error:o}=await m.from("user_preferences").select("data_retention_preference, analytics_tracking_enabled, third_party_sharing_enabled, marketing_communications_enabled").eq("user_id",e).maybeSingle();if(o)a.error("DATA_PRIVACY","Failed to load privacy preferences from Supabase",{error:o});else if(i){const l={data_retention_preference:i.data_retention_preference??"standard",analytics_tracking_enabled:i.analytics_tracking_enabled??!0,third_party_sharing_enabled:i.third_party_sharing_enabled??!1,marketing_communications_enabled:i.marketing_communications_enabled??!1};t({preferences:l,lastSyncedAt:new Date().toISOString()}),localStorage.setItem(r,JSON.stringify(l)),a.info("DATA_PRIVACY","Loaded privacy preferences from Supabase")}}t({isLoading:!1})}catch(r){a.error("DATA_PRIVACY","Error loading privacy preferences",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement des préférences"})}},updatePrivacyPreference:async(e,r,s)=>{try{t({isSaving:!0,error:null});const o={...n().preferences,[e]:r};t({preferences:o});const l=`${Pe}-preferences`;if(localStorage.setItem(l,JSON.stringify(o)),s){const{error:c}=await m.from("user_preferences").update({[e]:r,updated_at:new Date().toISOString()}).eq("user_id",s);if(c){a.error("DATA_PRIVACY","Failed to update privacy preference in Supabase",{error:c}),t({isSaving:!1,error:"Erreur lors de la sauvegarde"});return}a.info("DATA_PRIVACY","Updated privacy preference",{key:e,value:r}),t({lastSyncedAt:new Date().toISOString()})}t({isSaving:!1})}catch(i){a.error("DATA_PRIVACY","Error updating privacy preference",{error:i}),t({isSaving:!1,error:"Erreur lors de la sauvegarde"})}},loadExportRequests:async e=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}const{data:r,error:s}=await m.from("data_export_requests").select("*").eq("user_id",e).order("requested_at",{ascending:!1}).limit(10);if(s){a.error("DATA_PRIVACY","Failed to load export requests",{error:s}),t({recentExportRequests:[],isLoading:!1});return}t({recentExportRequests:r||[],lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("DATA_PRIVACY","Loaded export requests",{count:r?.length||0})}catch(r){a.error("DATA_PRIVACY","Error loading export requests",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement des demandes d'export"})}},requestDataExport:async(e,r)=>{try{if(t({isSaving:!0,error:null}),!r)throw new Error("User ID required to request data export");const{data:s,error:i}=await m.rpc("request_data_export",{p_user_id:r,p_request_type:e.request_type,p_export_format:e.export_format,p_included_data:e.included_data});if(i)throw a.error("DATA_PRIVACY","Failed to request data export",{error:i}),i;const o=s;return await n().loadExportRequests(r),t({isSaving:!1}),a.info("DATA_PRIVACY","Data export requested",{requestId:o}),o}catch(s){return a.error("DATA_PRIVACY","Error requesting data export",{error:s}),t({isSaving:!1,error:"Erreur lors de la demande d'export"}),null}},getExportDownloadUrl:async e=>{try{const{data:r,error:s}=await m.from("data_export_requests").select("file_url, expires_at, status").eq("id",e).maybeSingle();return s?(a.error("DATA_PRIVACY","Failed to get export download URL",{error:s}),null):!r||r.status!=="completed"||!r.file_url?null:r.expires_at&&new Date(r.expires_at)<new Date?(a.warn("DATA_PRIVACY","Export download link expired",{requestId:e}),null):r.file_url}catch(r){return a.error("DATA_PRIVACY","Error getting export download URL",{error:r}),null}},loadDeletionRequest:async e=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}const{data:r,error:s}=await m.from("account_deletion_requests").select("*").eq("user_id",e).in("status",["pending","scheduled","processing"]).maybeSingle();if(s){a.error("DATA_PRIVACY","Failed to load deletion request",{error:s}),t({activeDeletionRequest:null,isLoading:!1});return}t({activeDeletionRequest:r,lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("DATA_PRIVACY","Loaded deletion request",{hasActive:!!r})}catch(r){a.error("DATA_PRIVACY","Error loading deletion request",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement de la demande de suppression"})}},requestAccountDeletion:async(e,r)=>{try{if(t({isSaving:!0,error:null}),!r)throw new Error("User ID required to request account deletion");const{data:s,error:i}=await m.rpc("request_account_deletion",{p_user_id:r,p_delete_all_data:e.delete_all_data,p_anonymize_only:e.anonymize_only,p_reason:e.reason||null});if(i)throw a.error("DATA_PRIVACY","Failed to request account deletion",{error:i}),i;const o=s;return await n().loadDeletionRequest(r),t({isSaving:!1}),a.info("DATA_PRIVACY","Account deletion requested",{requestId:o}),o}catch(s){return a.error("DATA_PRIVACY","Error requesting account deletion",{error:s}),t({isSaving:!1,error:"Erreur lors de la demande de suppression de compte"}),null}},cancelAccountDeletion:async(e,r)=>{try{if(t({isSaving:!0,error:null}),!r)throw new Error("User ID required to cancel account deletion");const{data:s,error:i}=await m.rpc("cancel_account_deletion",{p_user_id:r,p_cancellation_reason:e.reason||null});if(i)throw a.error("DATA_PRIVACY","Failed to cancel account deletion",{error:i}),i;const o=s;return o&&(t({activeDeletionRequest:null}),a.info("DATA_PRIVACY","Account deletion cancelled")),t({isSaving:!1}),o}catch(s){return a.error("DATA_PRIVACY","Error cancelling account deletion",{error:s}),t({isSaving:!1,error:"Erreur lors de l'annulation de la suppression"}),!1}},loadConsents:async e=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}const{data:r,error:s}=await m.from("data_privacy_consents").select("*").eq("user_id",e).order("consented_at",{ascending:!1});if(s)throw a.error("DATA_PRIVACY","Failed to load consents",{error:s}),s;const i=new Map;(r||[]).forEach(o=>{i.has(o.consent_type)||i.set(o.consent_type,o)}),t({consents:i,lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("DATA_PRIVACY","Loaded consents",{count:i.size})}catch(r){a.error("DATA_PRIVACY","Error loading consents",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement des consentements"})}},updateConsent:async(e,r)=>{try{if(t({isSaving:!0,error:null}),!r)throw new Error("User ID required to update consent");const{data:s,error:i}=await m.rpc("record_consent",{p_user_id:r,p_consent_type:e.consent_type,p_consent_given:e.consent_given,p_consent_version:e.consent_version,p_ip_address:null,p_user_agent:navigator.userAgent});if(i)throw a.error("DATA_PRIVACY","Failed to update consent",{error:i}),i;await n().loadConsents(r),t({isSaving:!1}),a.info("DATA_PRIVACY","Consent updated",{consent:e})}catch(s){a.error("DATA_PRIVACY","Error updating consent",{error:s}),t({isSaving:!1,error:"Erreur lors de la mise à jour du consentement"})}},loadAccessLog:async(e,r=30)=>{try{if(t({isLoading:!0,error:null}),!e){t({isLoading:!1});return}const s=new Date;s.setDate(s.getDate()-r);const{data:i,error:o}=await m.from("data_access_log").select("*").eq("user_id",e).gte("accessed_at",s.toISOString()).order("accessed_at",{ascending:!1}).limit(50);if(o)throw a.error("DATA_PRIVACY","Failed to load access log",{error:o}),o;t({recentAccessLog:i||[],lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("DATA_PRIVACY","Loaded access log",{count:i?.length||0})}catch(s){a.error("DATA_PRIVACY","Error loading access log",{error:s}),t({isLoading:!1,error:"Erreur lors du chargement du journal d'accès"})}},loadPrivacyDashboard:async e=>{try{if(t({isLoading:!0,error:null}),!e)return t({isLoading:!1}),null;const{data:r,error:s}=await m.rpc("get_privacy_dashboard",{p_user_id:e});if(s)throw a.error("DATA_PRIVACY","Failed to load privacy dashboard",{error:s}),s;const i=r;return t({activeDeletionRequest:i.active_deletion_request,recentExportRequests:i.recent_exports||[],lastSyncedAt:new Date().toISOString(),isLoading:!1}),a.info("DATA_PRIVACY","Loaded privacy dashboard"),i}catch(r){return a.error("DATA_PRIVACY","Error loading privacy dashboard",{error:r}),t({isLoading:!1,error:"Erreur lors du chargement du tableau de bord"}),null}},clearError:()=>t({error:null}),reset:()=>t({preferences:{...ye},activeDeletionRequest:null,recentExportRequests:[],consents:new Map,recentAccessLog:[],isLoading:!1,isSaving:!1,error:null,lastSyncedAt:null})})),At=[{title:"Initialisation du scan",subtitle:"Configuration des algorithmes d'analyse corporelle"},{title:"Sécurisation des photos",subtitle:"Protection et optimisation des images"},{title:"Nettoyage intelligent",subtitle:"Amélioration automatique de la qualité"},{title:"Détection silhouette",subtitle:"Identification de 24 points anatomiques"},{title:"Estimation des mesures",subtitle:"Calcul précis des dimensions corporelles"},{title:"Analyse de la peau",subtitle:"Extraction des propriétés chromatiques"},{title:"Profil morphologique",subtitle:"Classification selon 300+ archétypes"},{title:"Sélection d'archétypes",subtitle:"Recherche des correspondances optimales"},{title:"Affinage IA",subtitle:"Personnalisation par intelligence artificielle"},{title:"Contrôles de cohérence",subtitle:"Validation des paramètres calculés"},{title:"Préparation du modèle 3D",subtitle:"Initialisation du mesh corporel"},{title:"Application des morphs",subtitle:"Déformation géométrique personnalisée"},{title:"Répartition des masses",subtitle:"Calcul des proportions anatomiques"},{title:"Peau & matériaux",subtitle:"Application des propriétés visuelles"},{title:"Mise en scène",subtitle:"Optimisation de la présentation 3D"},{title:"Validation finale",subtitle:"Contrôle qualité automatisé"},{title:"Avatar prêt",subtitle:"Rendu 3D disponible pour interaction"}],bt=[{title:"Initialisation du scan facial",subtitle:"Configuration des algorithmes d'analyse"},{title:"Sécurisation des photos faciales",subtitle:"Protection et optimisation des données"},{title:"Nettoyage intelligent du visage",subtitle:"Amélioration automatique de la qualité"},{title:"Détection des traits faciaux",subtitle:"Cartographie de 68 points de référence"},{title:"Analyse sémantique faciale",subtitle:"Classification morphologique avancée"},{title:"Sélection d'archétypes faciaux",subtitle:"Recherche dans la base de données"},{title:"Affinage IA du visage",subtitle:"Personnalisation par intelligence artificielle"},{title:"Contrôles de cohérence faciale",subtitle:"Validation des paramètres calculés"},{title:"Préparation du modèle 3D facial",subtitle:"Initialisation du mesh de base"},{title:"Application des morphs faciaux",subtitle:"Déformation géométrique personnalisée"},{title:"Peau & matériaux faciaux",subtitle:"Application des propriétés visuelles"},{title:"Mise en scène faciale",subtitle:"Optimisation de la présentation 3D"},{title:"Validation finale du visage",subtitle:"Contrôle qualité automatisé"},{title:"Avatar facial prêt",subtitle:"Rendu 3D disponible pour interaction"}],Ae={front_taken:25,profile_taken:50,done:50},be={upload:{progress:55,message:"Analyse IA Avancée",subMessage:"Téléchargement des photos..."},estimate:{progress:65,message:"Analyse IA Avancée",subMessage:"Extraction des mesures corporelles..."},semantic:{progress:75,message:"Analyse IA Avancée",subMessage:"Classification morphologique..."},match:{progress:85,message:"Analyse IA Avancée",subMessage:"Sélection des archétypes..."},commit:{progress:90,message:"Analyse IA Avancée",subMessage:"Sauvegarde des données..."},model_loading:{progress:92,message:"Chargement de votre avatar",subMessage:"Téléchargement du modèle 3D..."},model_loaded:{progress:94,message:"Chargement de votre avatar",subMessage:"Modèle 3D chargé avec succès..."},morphs_applied:{progress:97,message:"Chargement de votre avatar",subMessage:"Application des paramètres morphologiques..."},first_frame_rendered:{progress:100,message:"Avatar 3D Prêt",subMessage:"Votre reflet numérique est maintenant visible"}},Kt=y((t,n)=>({isActive:!1,clientScanId:null,serverScanId:null,currentStep:"capture",overallProgress:0,phaseProgress:0,message:"",subMessage:"",steps:[],totalSteps:0,flowType:null,progressHistory:[],dynamicProgressIntervalId:null,dynamicProgressStepIndex:0,lastSoundThreshold:-1,startProgress:(e,r,s)=>{if(!r||typeof r!="string"){a.error("startProgress called without valid clientScanId",{clientScanId:r});return}const i=n();if(i.isActive&&i.clientScanId===r)return;i.isActive&&i.clientScanId&&i.clientScanId!==r&&a.error("Starting new progress while another is active",{activeScanId:i.clientScanId,newScanId:r});const o=Date.now();t({isActive:!0,clientScanId:r,serverScanId:null,steps:e,totalSteps:e.length,currentStep:"capture",overallProgress:0,phaseProgress:0,message:e[0]?.subtitle||"",subMessage:"",lastUpdateTime:o,flowType:s,progressHistory:[{step:e[0]?.id||"",progress:0,timestamp:o}],lastSoundThreshold:-1}),a.info("Progress started",{clientScanId:r,steps:e.length})},setCaptureProgress:e=>{const r=n();if(!r.isActive){a.warn("setCaptureProgress called but progress not active",{step:e});return}const s=Ae[e];if(s===void 0){a.error("Invalid capture step",{step:e,validSteps:Object.keys(Ae)});return}if(s<r.overallProgress){a.debug("Rejected non-monotonic capture progress",{targetProgress:s,step:e,reason:"progress_would_decrease"});return}const i=Date.now(),o={step:"capture",progress:s,timestamp:i},l=[...r.progressHistory,o].slice(-20);t({currentStep:"capture",overallProgress:s,phaseProgress:s,message:"Capture Photographique",subMessage:e==="front_taken"?"Capturez votre photo de profil - tournez-vous à 90°":"Photos capturées avec succès - Prêt pour l'analyse IA",lastUpdateTime:i,progressHistory:l}),a.info(`Capture progress: ${s}%`,{step:e,progress:s,timestamp:new Date().toISOString()})},setProcessingStep:e=>{const r=n();if(r.dynamicProgressIntervalId!==null)return;const s=be[e];if(!s){a.error("Invalid processing step",{step:e,validSteps:Object.keys(be)});return}if(s.progress<r.overallProgress)return;const i=Date.now(),o={step:e,progress:s.progress,timestamp:i},l=[...r.progressHistory,o].slice(-20);t({currentStep:"processing",overallProgress:s.progress,phaseProgress:s.progress,message:s.message,subMessage:s.subMessage,lastUpdateTime:i,progressHistory:l}),a.info("Processing step",{step:e,progress:s.progress})},setComplete:()=>{const e=n();if(!e.isActive){a.warn("setComplete called but progress not active");return}n().stopDynamicProcessing();const r=Date.now();t({currentStep:"celebration",overallProgress:95,phaseProgress:95,message:"Données Traitées",subMessage:"Préparation du rendu 3D...",lastUpdateTime:r}),a.info("Processing completed - celebration step",{serverScanId:e.serverScanId,step:"celebration",progress:95,timestamp:new Date().toISOString()})},setRendering:()=>{const e=n();if(!e.isActive){a.warn("setRendering called but progress not active");return}const r=Date.now();t({currentStep:"avatar",overallProgress:98,phaseProgress:98,message:"Chargement de votre avatar",subMessage:"Préparation du conteneur 3D...",lastUpdateTime:r}),a.info("Avatar rendering started",{serverScanId:e.serverScanId,step:"avatar",progress:98,timestamp:new Date().toISOString()})},setRenderReady:()=>{const e=n();if(!e.isActive){a.warn("setRenderReady called but progress not active");return}n().stopDynamicProcessing();const r=Date.now();t({currentStep:"avatar",overallProgress:100,phaseProgress:100,message:"Avatar 3D Prêt",subMessage:"Votre reflet numérique est maintenant visible",lastUpdateTime:r}),a.info("Avatar render ready - 100% complete",{serverScanId:e.serverScanId,step:"avatar",progress:100,timestamp:new Date().toISOString()})},setServerScanId:e=>{n(),t({serverScanId:e}),a.info("Server scan ID set",{serverScanId:e,timestamp:new Date().toISOString()})},setProgressMessage:(e,r)=>{t({message:e,subMessage:r||"",lastUpdateTime:Date.now()})},completeProgress:()=>{const e=n();n().setComplete(),a.info("Progress completed successfully",{serverScanId:e.serverScanId,finalStep:"celebration",timestamp:new Date().toISOString()})},maintainProgressForReview:()=>{const e=n(),r=Date.now();a.info("Maintaining progress for review",{serverScanId:e.serverScanId,currentProgress:e.overallProgress,currentStep:e.currentStep,timestamp:new Date().toISOString()});const s=e.steps.length>0?e.steps:[{id:"capture",title:"Capture Photographique",subtitle:"Photos de face et de profil capturées",icon:"Camera",color:"#8B5CF6"},{id:"processing",title:"Analyse IA Avancée",subtitle:"Intelligence artificielle appliquée",icon:"Scan",color:"#8B5CF6"},{id:"celebration",title:"Données Traitées",subtitle:"Préparation du rendu 3D",icon:"Check",color:"#8B5CF6"},{id:"avatar",title:"Avatar 3D",subtitle:"Votre reflet numérique",icon:"Eye",color:"#8B5CF6"}];t({overallProgress:95,phaseProgress:95,currentStep:"celebration",message:"Données Traitées",subMessage:"Préparation du rendu 3D...",lastUpdateTime:r,steps:s})},resetProgress:()=>{const e=n();n().stopDynamicProcessing(),a.info("Resetting progress",{serverScanId:e.serverScanId,timestamp:new Date().toISOString()}),t({isActive:!1,clientScanId:null,serverScanId:null,currentStep:"capture",overallProgress:0,phaseProgress:0,message:"",subMessage:"",steps:[],totalSteps:0,flowType:null,progressHistory:[],dynamicProgressIntervalId:null,dynamicProgressStepIndex:0,lastSoundThreshold:-1})},setProgressActive:e=>{const r=n();a.info("Setting progress active",{active:e,serverScanId:r.serverScanId,timestamp:new Date().toISOString()}),t({isActive:e})},startDynamicProcessing:(e,r)=>{const s=n();n().stopDynamicProcessing();const i=s.flowType==="face"?bt:At;a.info("Starting dynamic processing progression",{startPercentage:e,endPercentage:r,flowType:s.flowType});const l=(r-e)/i.length,c=i[0];t({currentStep:"processing",overallProgress:e,phaseProgress:e,message:c.title,subMessage:c.subtitle,dynamicProgressStepIndex:0,lastUpdateTime:Date.now()}),n();const d=window.setInterval(()=>{const g=n().dynamicProgressStepIndex+1;if(g>=i.length){n().stopDynamicProcessing(),t({overallProgress:r,phaseProgress:r,message:"Analyse IA Terminée",subMessage:"Finalisation des données...",lastUpdateTime:Date.now()}),n(),a.info("Dynamic processing completed",{finalProgress:r});return}const p=i[g],S=Math.min(r,e+l*(g+1));t({overallProgress:S,phaseProgress:S,message:p.title,subMessage:p.subtitle,dynamicProgressStepIndex:g,lastUpdateTime:Date.now()}),n(),a.info("Dynamic processing step update",{stepIndex:g,stepTitle:p.title,progress:S})},3e3);t({dynamicProgressIntervalId:d}),n()},stopDynamicProcessing:()=>{const e=n();e.dynamicProgressIntervalId!==null&&(window.clearInterval(e.dynamicProgressIntervalId),a.info("Dynamic processing stopped",{lastStepIndex:e.dynamicProgressStepIndex}),t({dynamicProgressIntervalId:null,dynamicProgressStepIndex:0}),n())},setOverallProgress:(e,r,s)=>{const i=n();if(!i.isActive){a.warn("setOverallProgress called but progress not active",{percentage:e,message:r});return}if(i.dynamicProgressIntervalId!==null)return;const o=Number.isFinite(e)&&!Number.isNaN(e)?Math.max(0,Math.min(100,e)):0;if((!Number.isFinite(e)||Number.isNaN(e))&&a.warn("Invalid percentage passed to setOverallProgress, defaulting to 0",{percentageType:typeof e,safePercentage:o,message:r}),o<i.overallProgress){a.debug("REJECTED non-monotonic progress update",{message:r,reason:"progress_would_decrease"});return}const l=Math.floor(o/4);if(l>i.lastSoundThreshold&&o>0){try{typeof fe=="function"&&(fe(500,50),a.debug("Progress audio feedback played",{percentage:o,threshold:l,lastThreshold:i.lastSoundThreshold}))}catch(g){a.warn("Progress audio feedback failed",{error:g instanceof Error?g.message:String(g),percentage:o})}t({lastSoundThreshold:l})}const c=Date.now(),d={step:"custom",progress:o,timestamp:c},u=[...i.progressHistory,d].slice(-20);t({overallProgress:o,phaseProgress:o,message:r||i.message,subMessage:s||i.subMessage,lastUpdateTime:c,progressHistory:u}),a.info(`Overall progress: ${o}%`,{message:r,subMessage:s,timestamp:new Date().toISOString()})},incrementProgress:(e,r,s)=>{const i=n();if(!i.isActive){a.warn("incrementProgress called but progress not active",{increment:e,message:r});return}const o=Math.min(100,i.overallProgress+e);n().setOverallProgress(o,r||i.message,s||i.subMessage)}}));export{$t as D,A as F,Vt as N,kt as Z,ue as a,qt as b,Lt as c,C as d,tt as e,jt as f,Ct as g,Ft as h,ve as i,xt as j,Ut as k,Nt as l,Gt as m,Bt as n,Ht as o,zt as p,Yt as q,Jt as r,Wt as s,Kt as t,Mt as u};
